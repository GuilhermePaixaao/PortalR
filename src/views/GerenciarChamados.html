<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Chamados - Portal</title>

    <script>
        // --- IN√çCIO DO PROTETOR DE P√ÅGINA (ANTI-FLICKER) ---
        const userDataString = localStorage.getItem("userData");
        
        if (!userDataString) {
            window.location.replace("Login.html"); 
            throw new Error("Usu√°rio n√£o autenticado.");
        }
        try {
            const userData = JSON.parse(userDataString);
            
            const userId = userData?.data?.id || userData?.id; 
            
            if (!userId) {
                throw new Error("Dados de usu√°rio inv√°lidos (ID n√£o encontrado).");
            }
            
            const userPerfil = userData?.data?.perfil || userData?.perfil;
            if (userPerfil === 'REQUISITANTE') {
                alert("Acesso negado. Esta p√°gina √© para gerenciamento. Redirecionando...");
                window.location.replace("Chamado.html"); 
                throw new Error("Acesso negado.");
            }

        } catch (error) {
            console.error("Sess√£o inv√°lida:", error.message);
            if (error.message !== "Acesso negado.") {
                localStorage.removeItem("userData"); 
                window.location.replace("Login.html"); 
                throw new Error("Sess√£o inv√°lida.");
            }
        }
        // --- FIM DO PROTETOR DE P√ÅGINA ---
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/chamado.css">
    <link rel="stylesheet" href="css/ticket.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS DO MODAL DE DETALHES --- */
        dialog:not([open]) { display: none; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.6); }
        dialog {
            border: none;
            border-radius: 8px;
            padding: 1.5rem 2rem; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 800px; /* Mais largo */
            width: calc(100% - 2rem);
        }
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .form-actions button {
            padding: 0.6rem 1.2rem; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        #fecharModalDetalhes {
            background-color: #6c757d;
            color: white;
        }
        #modalDetalhes h2 {
            font-size: 1.75rem; 
            font-weight: 600;
            margin-bottom: 1rem;
        }
        #modalDetalhes .detalhe-grupo { 
            margin-bottom: 1.25rem; 
        }
        #modalDetalhes .detalhe-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.85rem; 
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: block;
        }
        #modalDetalhes .detalhe-valor,
        #modalDetalhes .detalhe-valor-select {
            font-size: 1.1rem; 
            padding: 0.5rem;
            background-color: #f4f5f7; 
            border-radius: 5px;
            word-wrap: break-word;
            min-height: 42px; 
            display: flex;
            align-items: center;
        }
        #modalDetalhes .detalhe-valor-select {
            padding: 0.375rem 0.5rem; 
            width: 100%;
            border: 1px solid #ced4da;
            background-color: #fff; 
            font-size: 1.1rem;
            height: 42px; 
        }
        #modalDetalhes .detalhe-descricao {
            font-size: 1.1rem;
            padding: 0.5rem;
            background-color: #f4f5f7;
            border-radius: 5px;
            white-space: pre-wrap;
            min-height: 100px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        /* --- ESTILOS DO HIST√ìRICO DE COMENT√ÅRIOS --- */
        #listaComentariosContainer {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 1rem;
            min-height: 100px;
            max-height: 300px; 
            overflow-y: auto;
        }
        .comment-item {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .comment-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .comment-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        .comment-header .comment-date {
            font-weight: 400;
            color: #6c757d;
            margin-left: 0.5rem;
        }
        .comment-body {
            font-size: 1rem;
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        .comment-empty-state {
            color: #6c757d;
            font-style: italic;
        }
        /* --- FIM ESTILOS MODAL --- */


        .main-content {
            grid-area: main;
            overflow-y: auto;
            padding: 2rem;
            background-color: #f8f9fa;
        }

        .alert { padding: 1rem; margin-top: 1rem; border-radius: 4px; }
        .alert-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .alert-danger { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .alert-warning { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }

        .ticket-list { display: flex; flex-direction: column; }
        .ticket-row { display: flex; border-bottom: 1px solid #eee; padding: 1rem 0.5rem; align-items: center; }
        .ticket-row.header { background-color: #f8f9fa; font-weight: bold; border-bottom: 2px solid #dee2e6; }
        .ticket-cell { padding: 0 0.5rem; }
        .ticket-id { flex: 0 0 80px; text-align: center; }
        .ticket-priority { flex: 0 0 100px; text-align: center; }
        .ticket-subject { flex: 1 1 auto; min-width: 200px; }
        .ticket-category { flex: 3 0 150px; }
        .ticket-status { flex: 0 0 80px; text-align: center; }
        
        .ticket-requisitante { flex: 0 0 120px; } 
        .ticket-operator { flex: 0 0 120px; }
        
        .ticket-created { flex: 0 0 100px; text-align: center; }
        .ticket-actions { flex: 0 0 90px; text-align: center; cursor: pointer; } 

        .priority-badge, .status-badge {
            padding: 0.2em 0.6em;
            border-radius: 0.25rem;
            font-size: 0.85em;
            font-weight: 600;
        }
        .priority-badge.alta, .priority-badge.high { background-color: #f8d7da; color: #842029; }
        .priority-badge.m√©dia, .priority-badge.medium, .priority-badge.media { background-color: #fff3cd; color: #664d03; }
        .priority-badge.baixa, .priority-badge.low { background-color: #cfe2ff; color: #084298; }
        .priority-badge.planejado { background-color: #e2d1e7; color: #510f32; } 
        
        /* --- Bloco de Status (Modo Claro) --- */
        .status-badge.aberto, .status-badge.open { background-color: #7d7d7d; color: #3f3f3f; }
        .status-badge.conclu√≠do, .status-badge.completed { background-color: #d1e7dd; color: #0f5132; }
        .status-badge.em-andamento { background-color: #cfe2ff; color: #084298; }
        .status-badge.pausado { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
        #loadingIndicator { padding: 2rem; text-align: center; color: #6c757d; }

        .btn-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            margin-left: 8px;
        }
        .btn-concluir { color: green; }
        .btn-iniciar, .btn-retomar { color: #0d6efd; }
        .btn-pausar { color: #fd7e14; }
        .btn-excluir { color: #dc3545; }
        .btn-excluir:hover { color: #bb2d3b; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0.75rem 2rem;
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0d6efd;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
            white-space: nowrap;
        }
        .search-bar {
            margin-left: 2rem;
            margin-right: 2rem;
            width: 100%;
            max-width: 450px;
        }
        .search-bar input {
            width: 100%;
            padding: 0.6rem 1rem;
            border: 1px solid #ced4da;
            border-radius: 20px;
            font-size: 0.95rem;
        }
        .search-bar input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
            outline: none;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem; 
        }
        #userNameDisplay {
            font-weight: 500;
            color: #495057;
            white-space: nowrap; 
        }
        .btn-logout {
            background-color: #dc3545; 
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-logout:hover {
            background-color: #bb2d3b;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center; 
            text-decoration: none;
            padding: 10px 15px; 
            width: 100%;
            height: auto; 
        }
        .sidebar .icon {
            margin-right: 10px; 
            min-width: 20px; 
            text-align: center;
            flex-shrink: 0; 
            align-self: center; 
        }
        .sidebar .text {
            flex-grow: 1; 
            white-space: normal; 
            line-height: 1.2; 
        }
        
        .btn-theme-toggle {
            background: none;
            border: 1px solid #ced4da;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            color: #495057;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .btn-theme-toggle:hover {
            background-color: #f1f3f5;
        }

        /* --- (NOVO) ESTILOS DO MODO ESCURO --- */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .dark-mode .main-content {
            background-color: #181818;
        }
        .dark-mode .sidebar {
            background-color: #212121;
            border-right-color: #333;
        }
        .dark-mode .sidebar a {
            color: #777676;
        }
        .dark-mode .sidebar li.active a,
        .dark-mode .sidebar a:hover {
            background-color: #333;
            color: #525252;
        }
        .dark-mode .header,
        .dark-mode .widget,
        .dark-mode .card,
        .dark-mode .ticket-row.header {
            background-color: #2a2a2a;
            border-color: #383838;
            color: #787878;
        }
        .dark-mode .ticket-row.data-row {
            background-color: #2a2a2a; 
            border-bottom-color: #383838;
        }
        .dark-mode .ticket-row.data-row:hover {
            background-color: #333;
        }
        .dark-mode h1,
        .dark-mode label,
        .dark-mode .ticket-cell,
        .dark-mode .logo {
            color: #f1f1f1;
        }
        .dark-mode #userNameDisplay {
            color: #f1f1f1;
        }

        .dark-mode .form-control,
        .dark-mode .form-select,
        .dark-mode dialog,
        .dark-mode #modalDetalhes .detalhe-valor,
        .dark-mode #modalDetalhes .detalhe-descricao,
        .dark-mode #listaComentariosContainer {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        .dark-mode #modalDetalhes .detalhe-valor-select {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        .dark-mode .form-control::placeholder {
            color: #999;
        }
        .dark-mode #modalDetalhes .detalhe-label,
        .dark-mode #modalDetalhes h2,
        .dark-mode #modalDetalhes h3 {
            color: #f1f1f1;
        }

        .dark-mode .comment-item {
            border-bottom-color: #444;
        }
        .dark-mode .comment-header {
            color: #f1f1f1;
        }
        .dark-mode .comment-header .comment-date {
            color: #aaa;
        }
        .dark-mode .comment-empty-state {
            color: #aaa;
        }

        .dark-mode .priority-badge.alta { background-color: #842029; color: #f8d7da; }
        .dark-mode .priority-badge.media { background-color: #664d03; color: #fff3cd; }
        .dark-mode .priority-badge.baixa { background-color: #084298; color: #cfe2ff; }
        .dark-mode .priority-badge.planejado { background-color: #510f32; color: #e2d1e7; }
        
        .dark-mode .status-badge.aberto { background-color: #5a6268; color: #e0e0e0; }
        .dark-mode .status-badge.conclu√≠do { background-color: #0f5132; color: #d1e7dd; }
        .dark-mode .status-badge.em-andamento { background-color: #084298; color: #cfe2ff; }
        .dark-mode .status-badge.pausado { background-color: #664d03; color: #fff3cd; } 
        
        .dark-mode .btn-theme-toggle {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .btn-theme-toggle:hover {
            background-color: #444;
        }

        .logo {
            display: flex;
            align-items: center; 
            gap: 10px;
        }
        .logo-icon {
            height: 30px; 
            width: auto;  
        }

        /* --- CLASSE GEN√âRICA PARA CONTAINERS DE EDI√á√ÉO (NOVO) --- */
        .edit-container {
            display: none; /* Oculto por padr√£o */
            margin-top: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .dark-mode .edit-container {
            background-color: #2b2b2b;
            border-color: #444;
            color: #e0e0e0;
        }
        .dark-mode .edit-container .text-muted {
            color: #adb5bd !important;
        }
        .btn-edit-icon {
            padding: 0px 5px; 
            font-size: 0.8rem; 
            border: none; 
            background: transparent;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo">
            <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
           
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>

        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado" class="active"><a href="GerenciarChamados.html" title="Gerenciar Chamados"><span class="icon">‚úîÔ∏è</span><span class="text">Gerenciar Chamados</span></a></li>
                    <li><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
                    <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li>
                        <a href="Categorias.html" title="Categorias">
                            <span class="icon">üè∑Ô∏è</span>
                            <span class="text">Categorias</span>
                        </a>
                    </li>    
                    <li><a href="GerenciarLojas.html"><span class="icon">üè¢</span> Lojas e Deptos</a></li>

                </ul>
            </nav>
        </aside>

        <dialog id="modalDetalhes" aria-labelledby="modalDetalhesTitle">
            <h2 id="modalDetalhesTitle">Detalhes do Chamado</h2>
            
            <div id="modalDetalhesConteudo">
                <div class="row">
                    <div class="col-md-4">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Ticket ID</span>
                            <div id="detalheId" class="detalhe-valor">#...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Status</span>
                            <select id="detalheStatusSelect" class="detalhe-valor-select form-select">
                                <option value="Aberto">Aberto</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Pausado">Pausado</option> 
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Prioridade</span>
                            <select id="detalhePrioridadeSelect" class="detalhe-valor-select form-select">
                                <option value="Baixa">Baixa</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Alta">Alta</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Assunto</span>
                            <div id="viewAssuntoContainer" class="d-flex justify-content-between align-items-center detalhe-valor">
                                <span id="detalheAssunto">...</span>
                                <button type="button" class="btn-edit-icon" id="btnEditarAssunto" title="Editar Assunto">‚úèÔ∏è</button>
                            </div>
                            <div id="editAssuntoContainer" class="edit-container">
                                <input type="text" id="inputEditAssunto" class="form-control mb-2">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-secondary" id="btnCancelarAssunto">Cancelar</button>
                                    <button type="button" class="btn btn-sm btn-success" id="btnSalvarAssunto">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-5">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Categoria</span>
                            <div id="viewCategoriaContainer" class="d-flex justify-content-between align-items-center detalhe-valor">
                                <span id="detalheCategoriaText">...</span>
                                <button type="button" class="btn-edit-icon" id="btnEditarCategoria" title="Alterar Categoria">‚úèÔ∏è</button>
                            </div>
                            <div id="editCategoriaContainer" class="edit-container">
                                <small class="text-muted d-block mb-2">Selecione a nova categoria:</small>
                                <div id="cascataEdicaoWrapper"></div> 
                                <div class="mt-2 d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-secondary" id="btnCancelarEdicaoCategoria">Cancelar</button>
                                    <button type="button" class="btn btn-sm btn-success" id="btnSalvarCategoria">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detalhe-grupo">
                    <span class="detalhe-label">Descri√ß√£o</span>
                    <div id="viewDescricaoContainer" class="position-relative">
                        <div id="detalheDescricao" class="detalhe-descricao">Carregando...</div>
                        <button type="button" class="btn-edit-icon position-absolute top-0 end-0 m-2" id="btnEditarDescricao" title="Editar Descri√ß√£o">‚úèÔ∏è</button>
                    </div>
                    <div id="editDescricaoContainer" class="edit-container">
                        <textarea id="inputEditDescricao" class="form-control mb-2" rows="5"></textarea>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-sm btn-secondary" id="btnCancelarDescricao">Cancelar</button>
                            <button type="button" class="btn btn-sm btn-success" id="btnSalvarDescricao">Salvar</button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Requisitante</span>
                            <div id="viewRequisitanteContainer" class="d-flex justify-content-between align-items-center detalhe-valor">
                                <span id="detalheRequisitante">...</span>
                                <button type="button" class="btn-edit-icon" id="btnEditarRequisitante" title="Alterar Requisitante">‚úèÔ∏è</button>
                            </div>
                            <div id="editRequisitanteContainer" class="edit-container">
                                <select id="selectEditRequisitante" class="form-select mb-2">
                                    <option value="">Carregando usu√°rios...</option>
                                </select>
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-secondary" id="btnCancelarRequisitante">Cancelar</button>
                                    <button type="button" class="btn btn-sm btn-success" id="btnSalvarRequisitante">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Operador (Atendente)</span>
                            <select id="detalheAtendenteSelect" class="detalhe-valor-select form-select" disabled>
                                <option value="">-- Carregando operadores --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                         <div class="detalhe-grupo">
                            <span class="detalhe-label">Loja / Departamento</span>
                             <div id="viewLojaDeptoContainer" class="d-flex justify-content-between align-items-center detalhe-valor">
                                <div>
                                    <span id="detalheLoja">...</span> / <span id="detalheDepartamento">...</span>
                                </div>
                                <button type="button" class="btn-edit-icon" id="btnEditarLojaDepto" title="Alterar Local">‚úèÔ∏è</button>
                            </div>
                             <div id="editLojaDeptoContainer" class="edit-container">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small">Loja</label>
                                        <select id="selectEditLoja" class="form-select"></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Departamento</label>
                                        <select id="selectEditDepartamento" class="form-select">
                                            <option value="">Selecione a Loja primeiro</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2 d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-sm btn-secondary" id="btnCancelarLojaDepto">Cancelar</button>
                                    <button type="button" class="btn btn-sm btn-success" id="btnSalvarLojaDepto">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Criado em</span>
                            <div id="detalheData" class="detalhe-valor">...</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Tempo Aberto</span>
                            <div id="detalheTempoAberto" class="detalhe-valor" style="color: #666;">--</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="detalhe-grupo">
                            <span class="detalhe-label">Tempo em Andamento</span>
                            <div id="detalheTempoAndamento" class="detalhe-valor" style="color: #0d6efd;">--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr style="margin-top: 1rem; margin-bottom: 1.25rem;">
            
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Hist√≥rico de Coment√°rios</h3>
    
            <div id="listaComentariosContainer" class="comment-empty-state">
                Carregando coment√°rios...
            </div>
            
            <hr style="margin-top: 1.5rem; margin-bottom: 1.25rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Adicionar Coment√°rio</h3>
            <div id="formComentario">
                <div class="grupo-form" style="margin-bottom: 0.5rem;">
                    <textarea id="novoComentario" name="novoComentario" rows="3" class="form-control" placeholder="Digite seu coment√°rio..." style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem;"></textarea>
                </div>
                <div id="comentarioResposta" class="mt-2"></div>
                <div class="form-actions" style="margin-top: 0.5rem; padding-top: 0; justify-content: flex-end;">
                     <button type="button" id="enviarComentario" style="padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; background-color: #198754; color: white;">Enviar Coment√°rio</button>
                </div>
            </div>
            
            <div id="modalDetalhesResposta" class="mt-3"></div>
            
            <div class="form-actions">
                <button type="button" id="fecharModalDetalhes">Fechar</button>
            </div>
        </dialog>
        
        <main class="main-content">
            <h1>Gerenciar Chamados</h1>
            <hr>

            <div id="divRespostaGeral" class="mb-3"></div>

            <div class="widget card shadow-sm">
                <div class="card-body">
                    <div class="filters mb-3 row g-2">
                        <div class="col-md-3">
                            <label for="filtroAssunto" class="form-label">Filtrar por Assunto</label>
                            <input type="text" id="filtroAssunto" class="form-control" placeholder="Digite o assunto...">
                        </div>

                        <div class="col-md-2">
                            <label for="filtroPrioridade" class="form-label">Prioridade</label>
                            <select id="filtroPrioridade" class="form-select">
                                <option value="">Todas</option>
                                <option value="Alta">Alta</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="filtroStatus" class="form-label">Status</label>
                            <select id="filtroStatus" class="form-select">
                                <option value="">Todos</option>
                                <option value="Aberto">Aberto</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Pausado">Pausado</option> 
                                <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="filtroLoja" class="form-label">Loja</label>
                            <select id="filtroLoja" class="form-select">
                                <option value="">Todas</option>
                                </select>
                        </div>

                        <div class="col-md-3">
                            <label for="filtroCategoria" class="form-label">Categoria</label>
                            <select id="filtroCategoria" class="form-select">
                                <option value="">Todas</option>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button>
                        </div>
                        
                    </div>

                    <div id="ticketList" class="ticket-list">
                        <div class="ticket-row header">
                            <div class="ticket-cell ticket-id">Ticket</div>
                            <div class="ticket-cell ticket-priority">Prioridade</div>
                            <div class="ticket-cell ticket-subject">Assunto</div>
                            <div class="ticket-cell ticket-category">Categoria</div>
                            <div class="ticket-cell ticket-status">Status</div>
                            <div class="ticket-cell ticket-requisitante">Requisitante</div>
                            <div class="ticket-cell ticket-operator">Operador</div>
                            <div class="ticket-cell ticket-created">Criado em</div>
                            <div class="ticket-cell ticket-actions">A√ß√£o</div>
                        </div>
                        <div id="loadingIndicator"><p>Carregando chamados...</p></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
        const API_URL = ""; 
        let currentTicketId = null; 
        
        // VARI√ÅVEIS GLOBAIS
        let listaOperadores = [];
        let allCategories = []; 
        let categoriaSelecionadaEdicaoId = null; 
        
        // NOVAS VARI√ÅVEIS GLOBAIS PARA EDI√á√ÉO
        let listaTodosUsuarios = []; 
        let listaLojasCache = [];    
        
        let chartInstance = null;

        function fazerLogout() {
            localStorage.removeItem("userData"); 
            window.location.href = "Login.html"; 
        }

        let userData, userId, userPerfil, userCategoriaAtendimento;

        try {
            userData = JSON.parse(userDataString); 
            
            userId = userData?.data?.id || userData?.id; 
            userPerfil = userData?.data?.perfil || userData?.perfil;
            userCategoriaAtendimento = userData?.data?.categoria_id_atendimento || userData?.categoria_id_atendimento;

            const userNameDisplay = document.getElementById('userNameDisplay');
            if (userNameDisplay && userData?.data?.nomeFuncionario) {
                userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
            } else if (userNameDisplay && userData?.nomeFuncionario) {
                 userNameDisplay.textContent = `Ol√°, ${userData.nomeFuncionario.split(' ')[0]}`;
            }

            const linkChamado = document.getElementById("menu-link-chamado");
            if (linkChamado) {
                const a = linkChamado.querySelector('a');
                const textSpan = a.querySelector('.text'); 
                textSpan.innerHTML = "Gerenciar<br>Chamados";
                a.querySelector('.icon').textContent = "‚úîÔ∏è";
                a.title = "Gerenciar Chamados";
            }

        } catch (error) {
            console.error("Erro ao configurar a p√°gina:", error);
            fazerLogout();
        }

        // --- REFER√äNCIAS ---
        const ticketList = document.getElementById("ticketList");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const divRespostaGeral = document.getElementById("divRespostaGeral");
        const filtroAssunto = document.getElementById("filtroAssunto");
        const filtroPrioridade = document.getElementById("filtroPrioridade");
        const filtroStatus = document.getElementById("filtroStatus");
        const filtroCategoria = document.getElementById("filtroCategoria");
        const filtroLoja = document.getElementById("filtroLoja"); 
        
        const btnFiltrar = document.getElementById("btnFiltrar");
        const btnLogout = document.getElementById("logoutButton");
        const modalDetalhes = document.getElementById("modalDetalhes");
        const btnFecharModalDetalhes = document.getElementById("fecharModalDetalhes");
        const modalDetalhesConteudo = document.getElementById("modalDetalhesConteudo");
        const modalDetalhesResposta = document.getElementById("modalDetalhesResposta");
        const detalheId = document.getElementById("detalheId");
        
        const detalheAssunto = document.getElementById("detalheAssunto");
        const detalheDescricao = document.getElementById("detalheDescricao");
        const detalheRequisitante = document.getElementById("detalheRequisitante");
        const detalheLoja = document.getElementById("detalheLoja");
        const detalheDepartamento = document.getElementById("detalheDepartamento");
        
        const detalheCategoriaText = document.getElementById("detalheCategoriaText");
        
        const detalheData = document.getElementById("detalheData");
        const detalheStatusSelect = document.getElementById("detalheStatusSelect");
        const detalhePrioridadeSelect = document.getElementById("detalhePrioridadeSelect");
        const listaComentariosContainer = document.getElementById("listaComentariosContainer");
        const btnThemeToggle = document.getElementById("themeToggle");
        const detalheAtendenteSelect = document.getElementById("detalheAtendenteSelect");
        const btnEnviarComentario = document.getElementById("enviarComentario");
        const textareaComentario = document.getElementById("novoComentario");
        const comentarioResposta = document.getElementById("comentarioResposta");

        // Refer√™ncias para Edi√ß√£o de Categoria
        const btnEditarCategoria = document.getElementById("btnEditarCategoria");
        const btnCancelarEdicaoCategoria = document.getElementById("btnCancelarEdicaoCategoria");
        const btnSalvarCategoria = document.getElementById("btnSalvarCategoria");
        const viewCategoriaContainer = document.getElementById("viewCategoriaContainer");
        const editCategoriaContainer = document.getElementById("editCategoriaContainer");
        const cascataEdicaoWrapper = document.getElementById("cascataEdicaoWrapper");

        function exibirMensagem(el, msg, sucesso = true) {
            el.textContent = msg;
            el.className = sucesso ? 'alert alert-success' : 'alert alert-danger';
        }

        function limparMensagem(el) { el.textContent = ''; el.className = ''; }

        function escapeHtml(t) {
            if (!t) return '';
            return t.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
        }

        function formatarData(d) {
            if (!d) return 'N/A';
            try {
                const dt = new Date(d);
                return dt.toLocaleString('pt-BR', { 
                    timeZone: 'America/Sao_Paulo',
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch { return 'Data inv√°lida'; }
        }

        async function carregarCategorias() {
            try {
                filtroCategoria.parentElement.style.display = 'block'; 
                const r = await fetch(`${API_URL}/categorias`);
                if (!r.ok) throw new Error("Erro ao carregar categorias.");
                
                allCategories = await r.json(); 
                
                filtroCategoria.innerHTML = '<option value="">Todas</option>';
                allCategories.forEach(cat => {
                    const opt = document.createElement("option");
                    opt.value = cat.id;
                    opt.textContent = cat.nome;
                    filtroCategoria.appendChild(opt);
                });
            } catch {
                filtroCategoria.parentElement.innerHTML = '<p class="text-danger">Falha ao carregar categorias.</p>';
            }
        }
        
        async function carregarFiltroLojas() {
            try {
                const r = await fetch(`${API_URL}/chamados/dados/lojas`);
                const lojas = await r.json();
                
                filtroLoja.innerHTML = '<option value="">Todas as Lojas</option>';
                lojas.forEach(l => {
                    filtroLoja.add(new Option(l.nome, l.id));
                });
            } catch (e) {
                console.error("Erro ao carregar lojas para filtro", e);
            }
        }

        async function carregarOperadores() {
            if (listaOperadores.length > 0) return; 
            try {
                const response = await fetch(`${API_URL}/usuarios`); 
                if (!response.ok) throw new Error("Falha ao carregar operadores.");
                const todosFuncionarios = await response.json();
                listaOperadores = todosFuncionarios.filter(f => f.perfil === 'AGENTE' || f.perfil === 'ADMIN');

                detalheAtendenteSelect.innerHTML = ''; 
                detalheAtendenteSelect.add(new Option("-- N√£o Atribu√≠do --", "")); 
                listaOperadores.forEach(op => {
                    detalheAtendenteSelect.add(new Option(op.nomeFuncionario, op.id));
                });
            } catch (error) {
                console.error(error); 
                detalheAtendenteSelect.innerHTML = `<option value="">Erro ao carregar</option>`;
            }
        }
        
        // --- FUN√á√ïES NOVAS DE CARREGAMENTO PARA EDI√á√ÉO ---
        async function carregarTodosUsuarios() {
            try {
                const r = await fetch(`${API_URL}/usuarios`);
                if(r.ok) {
                    listaTodosUsuarios = await r.json();
                    const select = document.getElementById('selectEditRequisitante');
                    select.innerHTML = '<option value="">Selecione...</option>';
                    listaTodosUsuarios.forEach(u => {
                        select.add(new Option(u.nomeFuncionario, u.id));
                    });
                }
            } catch(e) { console.error("Erro ao carregar usu√°rios para edi√ß√£o", e); }
        }

        async function carregarLojasEdicao() {
            try {
                const r = await fetch(`${API_URL}/chamados/dados/lojas`);
                if(r.ok) {
                    listaLojasCache = await r.json();
                    const select = document.getElementById('selectEditLoja');
                    select.innerHTML = '<option value="">Selecione a Loja...</option>';
                    listaLojasCache.forEach(l => select.add(new Option(l.nome, l.id)));
                }
            } catch(e) { console.error(e); }
        }

        // --- L√ìGICA DE EDI√á√ÉO (CATEGORIA) ---
        function ativarEdicaoCategoria() {
            viewCategoriaContainer.style.display = 'none';
            editCategoriaContainer.style.display = 'block';
            cascataEdicaoWrapper.innerHTML = '';
            categoriaSelecionadaEdicaoId = null;
            criarDropdownEdicao(null, 0);
        }

        function cancelarEdicaoCategoria() {
            viewCategoriaContainer.style.display = 'flex'; 
            editCategoriaContainer.style.display = 'none';
        }

        function criarDropdownEdicao(parentId, level) {
            const children = allCategories.filter(c => c.parent_id == parentId);
            if (children.length === 0) {
                categoriaSelecionadaEdicaoId = parentId;
                return;
            }
            categoriaSelecionadaEdicaoId = null;

            const div = document.createElement('div');
            div.className = 'mb-2'; 
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm'; 
            select.dataset.level = level;
            const placeholder = level === 0 ? '-- Selecione a Categoria --' : '-- Selecione a Subcategoria --';
            select.add(new Option(placeholder, ""));

            children.forEach(cat => {
                select.add(new Option(cat.nome, cat.id));
            });

            select.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                const currentLevel = parseInt(e.target.dataset.level);
                const allDivs = cascataEdicaoWrapper.querySelectorAll('div');
                allDivs.forEach(d => {
                    const s = d.querySelector('select');
                    if (s && parseInt(s.dataset.level) > currentLevel) {
                        d.remove();
                    }
                });
                if (selectedId) {
                    criarDropdownEdicao(selectedId, currentLevel + 1);
                } else {
                    categoriaSelecionadaEdicaoId = null;
                }
            });

            div.appendChild(select);
            cascataEdicaoWrapper.appendChild(div);
        }

        async function salvarNovaCategoria() {
            const selects = cascataEdicaoWrapper.querySelectorAll('select');
            let idFinal = null;
            selects.forEach(s => { if(s.value) idFinal = s.value; });

            if (!idFinal) {
                alert("Por favor, selecione uma categoria v√°lida at√© o final.");
                return;
            }
            if (!currentTicketId) return;

            limparMensagem(modalDetalhesResposta);

            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/categoria`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categoriaId: idFinal })
                });
                const result = await r.json();

                if (r.ok) {
                    exibirMensagem(modalDetalhesResposta, "Categoria atualizada com sucesso!", true);
                    const nomeExibicao = montarCaminhoCategoria(idFinal);
                    detalheCategoriaText.textContent = nomeExibicao;
                    cancelarEdicaoCategoria();
                    listarChamados(); 
                } else {
                    exibirMensagem(modalDetalhesResposta, `Erro: ${result.message}`, false);
                }
            } catch (error) {
                console.error(error);
                exibirMensagem(modalDetalhesResposta, "Erro de comunica√ß√£o ao salvar categoria.", false);
            }
        }
        
        function montarCaminhoCategoria(categoriaId) {
            if (!categoriaId) return 'N/A';
            let caminho = [];
            let currentId = categoriaId;
            let attempts = 0;
            while (currentId && attempts < 20) {
                const cat = allCategories.find(c => c.id == currentId);
                if (cat) {
                    caminho.unshift(cat.nome); 
                    currentId = cat.parent_id; 
                } else {
                    break;
                }
                attempts++;
            }
            return caminho.join(' / ') || 'N/A';
        }

        function renderizarChamados(chamados) {
            loadingIndicator.style.display = 'none';
            ticketList.querySelectorAll('.data-row').forEach(r => r.remove());

            if (!chamados?.length) {
                ticketList.insertAdjacentHTML('beforeend', `
                <div class="ticket-row data-row">
                    <div class="ticket-cell" style="grid-column: 1 / -1; text-align: center; padding: 1rem;">
                    Nenhum chamado encontrado.
                    </div>
                </div>`);
                return;
            }

            chamados.forEach(ch => {
                const prioridadeClass = (ch.prioridade || 'M√©dia').toLowerCase().replace('√©', 'e');
                const statusClass = (ch.status || 'Aberto').toLowerCase().replace(/\s+/g, '-');
                
                let actionButtons = `<span class="view-icon" title="Visualizar">üëÅÔ∏è</span>`;

                if (ch.status === 'Aberto') {
                    actionButtons += ` <button class="btn-action btn-iniciar" data-id="${ch.id}" title="Iniciar Atendimento">‚ñ∂Ô∏è</button>`;
                } else if (ch.status === 'Em Andamento') {
                    actionButtons += ` <button class="btn-action btn-pausar" data-id="${ch.id}" title="Pausar Atendimento">‚è∏Ô∏è</button>`;
                } else if (ch.status === 'Pausado') {
                    actionButtons += ` <button class="btn-action btn-retomar" data-id="${ch.id}" title="Retomar Atendimento">‚ñ∂Ô∏è</button>`;
                }

                if (ch.status !== 'Conclu√≠do') {
                    actionButtons += ` <button class="btn-action btn-concluir" data-id="${ch.id}" title="Marcar como Conclu√≠do">‚úîÔ∏è</button>`;
                }
                
                actionButtons += ` <button class="btn-action btn-excluir" data-id="${ch.id}" title="Excluir Chamado">üóëÔ∏è</button>`;
                
                let nomeExibicao = 'N/A';
                if (ch.Categorias && ch.Categorias.id) {
                    nomeExibicao = montarCaminhoCategoria(ch.Categorias.id);
                } else if (ch.Categorias) {
                    if (ch.Categorias.nomePai) {
                        nomeExibicao = `${ch.Categorias.nomePai} / ${ch.Categorias.nome}`;
                    } else {
                        nomeExibicao = ch.Categorias.nome;
                    }
                }

                ticketList.insertAdjacentHTML('beforeend', `
                <div class="ticket-row data-row" data-ticket-id="${ch.id}">
                    <div class="ticket-cell ticket-id">#${ch.id}</div>
                    <div class="ticket-cell ticket-priority">
                        <span class="priority-badge ${prioridadeClass}">${escapeHtml(ch.prioridade)}</span>
                    </div>
                    <div class="ticket-cell ticket-subject">${escapeHtml(ch.assunto)}</div>
                    <div class="ticket-cell ticket-category">${escapeHtml(nomeExibicao)}</div>
                    <div class="ticket-cell ticket-status">
                        <span class="status-badge ${statusClass}">${escapeHtml(ch.status)}</span>
                    </div>
                    <div class="ticket-cell ticket-requisitante">${escapeHtml(ch.Funcionario?.nomeFuncionario || 'Desconhecido')}</div>
                    <div class="ticket-cell ticket-operator">${escapeHtml(ch.Atendente?.nomeFuncionario || 'N/A')}</div>
                    <div class="ticket-cell ticket-created">${formatarData(ch.created_at)}</div>
                    <div class="ticket-cell ticket-actions">
                        ${actionButtons}
                    </div>
                </div>`);
            });
        }

        async function listarChamados() {
            limparMensagem(divRespostaGeral);
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());
            if (loadingIndicator) loadingIndicator.style.display = 'block';

            const p = new URLSearchParams();
            if (filtroAssunto.value.trim()) p.append('assunto', filtroAssunto.value.trim());
            if (filtroPrioridade.value) p.append('prioridade', filtroPrioridade.value);
            if (filtroStatus.value) p.append('status', filtroStatus.value);
            if (filtroCategoria.value) p.append('categoria_id', filtroCategoria.value);
            if (filtroLoja && filtroLoja.value) p.append('loja_id', filtroLoja.value);

            try {
                const r = await fetch(`${API_URL}/chamados?${p.toString()}`);
                if (!r.ok) throw new Error("Erro ao buscar chamados.");
                const dados = await r.json(); 
                renderizarChamados(dados);              
            } catch (e) {
                exibirMensagem(divRespostaGeral, e.message, false);
                loadingIndicator.innerHTML = '<p style="color:red;">Falha ao carregar.</p>';
            }
        }
        
        async function atualizarStatusChamado(id, status) {
            try {
                const r = await fetch(`${API_URL}/chamados/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status, atendenteId: userId })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.message);
                exibirMensagem(divRespostaGeral, "Chamado atualizado com sucesso!", true);
                listarChamados(); 
            } catch (e) {
                exibirMensagem(divRespostaGeral, `Erro: ${e.message}`, false);
            }
        }
        
        async function excluirChamado(id) {
            try {
                const r = await fetch(`${API_URL}/chamados/${id}`, {
                    method: 'DELETE'
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.message || "Erro ao excluir.");
                exibirMensagem(divRespostaGeral, "Chamado exclu√≠do permanentemente!", true);
                listarChamados(); 
            } catch (e) {
                exibirMensagem(divRespostaGeral, `Erro ao excluir: ${e.message}`, false);
            }
        }

        async function abrirModalDetalhes(chamadoId) {
            limparMensagem(modalDetalhesResposta);
            listaComentariosContainer.innerHTML = '<span class="comment-empty-state">Carregando coment√°rios...</span>';
            textareaComentario.value = '';
            limparMensagem(comentarioResposta);

            modalDetalhes.showModal();
            currentTicketId = null; 
            detalheAtendenteSelect.disabled = true; 
            
            // RESET DOS CAMPOS E CONTE√öDO EDIT√ÅVEL
            detalheId.textContent = `#${chamadoId}`;
            detalheAssunto.textContent = 'Carregando...';
            detalheDescricao.textContent = 'Carregando...';
            detalheRequisitante.textContent = 'Carregando...';
            detalheLoja.textContent = '...'; 
            detalheDepartamento.textContent = '...';

            const elTempoAberto = document.getElementById('detalheTempoAberto');
            const elTempoAndamento = document.getElementById('detalheTempoAndamento');
            if(elTempoAberto) elTempoAberto.textContent = "Calculando...";
            if(elTempoAndamento) elTempoAndamento.textContent = "Calculando...";

            // Reseta visualiza√ß√µes de edi√ß√£o
            cancelarEdicaoCategoria();
            document.getElementById('btnCancelarAssunto').click();
            document.getElementById('btnCancelarDescricao').click();
            document.getElementById('btnCancelarRequisitante').click();
            document.getElementById('btnCancelarLojaDepto').click();

            modalDetalhesConteudo.style.opacity = '0.5';

            try {
                const response = await fetch(`${API_URL}/chamados/${chamadoId}`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || `Erro ao buscar dados do chamado #${chamadoId}`);
                }
                
                const chamado = await response.json(); 

                detalheAssunto.textContent = chamado.assunto;
                detalheDescricao.textContent = chamado.descricao;
                
                // REQUISITANTE
                const reqNome = chamado.Funcionario?.nomeFuncionario || 'Desconhecido';
                const reqTel = chamado.Funcionario?.telefone;
                const reqEmail = chamado.Funcionario?.email;
                let reqTexto = reqNome;
                if (reqTel) reqTexto += ` - Tel: ${reqTel}`;
                if (reqEmail) reqTexto += `\n(${reqEmail})`; 
                detalheRequisitante.textContent = reqTexto;
                detalheRequisitante.style.whiteSpace = 'pre-line'; 

                // LOJA E DEPARTAMENTO
                detalheLoja.textContent = chamado.loja || 'N/A';
                detalheDepartamento.textContent = chamado.departamento || 'N/A';

                // TEMPOS
                if (chamado.Tempos) {
                    if(elTempoAberto) elTempoAberto.textContent = chamado.Tempos.tempoAbertoFormatado;
                    if(elTempoAndamento) elTempoAndamento.textContent = chamado.Tempos.tempoAndamentoFormatado;
                } else {
                    if(elTempoAberto) elTempoAberto.textContent = "0m";
                    if(elTempoAndamento) elTempoAndamento.textContent = "0m";
                }

                // CATEGORIA
                let nomeCat = 'N/A';
                if (chamado.Categorias && chamado.Categorias.id) {
                     nomeCat = montarCaminhoCategoria(chamado.Categorias.id);
                } else if (chamado.Categorias) {
                    nomeCat = chamado.Categorias.nome;
                    if(chamado.Categorias.nomePai) nomeCat = `${chamado.Categorias.nomePai} / ${nomeCat}`;
                }
                detalheCategoriaText.textContent = nomeCat;
                
                detalheData.textContent = formatarData(chamado.created_at);
                
                detalheStatusSelect.value = chamado.status;
                detalhePrioridadeSelect.value = chamado.prioridade;
                
                detalheAtendenteSelect.value = chamado.atendente_id || ""; 
                detalheAtendenteSelect.disabled = false; 
                
                currentTicketId = chamadoId; 
                modalDetalhesConteudo.style.opacity = '1';

                await carregarComentarios(chamadoId);

            } catch (error) {
                exibirMensagem(modalDetalhesResposta, error.message, false);
                modalDetalhesConteudo.style.opacity = '1';
                listaComentariosContainer.innerHTML = `<span class="comment-empty-state" style="color: red;">${error.message}</span>`;
            }
        }
        
        async function handlePrioridadeChange() {
            if (!currentTicketId) return;
            const novaPrioridade = detalhePrioridadeSelect.value;
            limparMensagem(modalDetalhesResposta);
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/prioridade`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prioridade: novaPrioridade })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.message);
                exibirMensagem(modalDetalhesResposta, "Prioridade atualizada!", true);
                listarChamados(); 
            } catch (e) {
                exibirMensagem(modalDetalhesResposta, `Erro: ${e.message}`, false);
            }
        }
        
        async function handleStatusChange() {
            if (!currentTicketId) return;
            const novaStatus = detalheStatusSelect.value;
            limparMensagem(modalDetalhesResposta);
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: novoStatus, atendenteId: userId })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.message);
                
                if (userId) detalheAtendenteSelect.value = userId;
                
                exibirMensagem(modalDetalhesResposta, "Status atualizado!", true);
                listarChamados(); 
            } catch (e) {
                exibirMensagem(modalDetalhesResposta, `Erro: ${e.message}`, false);
            }
        }
        
        async function handleAtendenteChange() {
            if (!currentTicketId) return;
            const novaAtendenteId = detalheAtendenteSelect.value ? parseInt(detalheAtendenteSelect.value) : null;
            limparMensagem(modalDetalhesResposta);
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/atendente`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ atendenteId: novaAtendenteId })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.message);
                exibirMensagem(modalDetalhesResposta, "Atendente atualizado!", true);
                listarChamados(); 
            } catch (e) {
                exibirMensagem(modalDetalhesResposta, `Erro: ${e.message}`, false);
            }
        }

        // --- Fun√ß√µes para LER Coment√°rios ---
        function renderizarComentarios(comentarios) {
            listaComentariosContainer.innerHTML = ''; 
            listaComentariosContainer.classList.remove('comment-empty-state');
            if (!comentarios || comentarios.length === 0) {
                listaComentariosContainer.classList.add('comment-empty-state');
                listaComentariosContainer.innerHTML = '<span>Nenhum coment√°rio encontrado.</span>';
                return;
            }
            comentarios.forEach(comentario => {
                const nome = comentario.nomeFuncionario || 'Usu√°rio desconhecido';
                const data = formatarData(comentario.created_at);
                const texto = escapeHtml(comentario.texto);
                const commentHtml = `
                    <div class="comment-item">
                        <div class="comment-header">
                            ${escapeHtml(nome)}
                            <span class="comment-date">em ${data}</span>
                        </div>
                        <div class="comment-body">${texto}</div>
                    </div>`;
                listaComentariosContainer.insertAdjacentHTML('beforeend', commentHtml);
            });
        }

        async function carregarComentarios(ticketId) {
            try {
                const response = await fetch(`${API_URL}/chamados/${ticketId}/comentarios`); 
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || "Falha ao carregar coment√°rios.");
                }
                const comentarios = await response.json();
                renderizarComentarios(comentarios);
            } catch (error) {
                listaComentariosContainer.innerHTML = `<span class="comment-empty-state" style="color: red;">${error.message}</span>`;
            }
        }

        async function enviarNovoComentario() {
            limparMensagem(comentarioResposta);
            const ticketId = currentTicketId; 
            const texto = textareaComentario.value.trim();
            if (!texto) {
                exibirMensagem(comentarioResposta, "Por favor, digite um coment√°rio.", false);
                return;
            }
            if (!ticketId) {
                exibirMensagem(comentarioResposta, "Erro: ID do chamado n√£o encontrado.", false);
                return;
            }
            const body = { texto: texto, chamado_id: parseInt(ticketId), user_id: userId };

            try {
                const response = await fetch(`${API_URL}/chamados/${ticketId}/comentarios`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!response.ok) {
                    const erro = await response.json();
                    throw new Error(erro.message || "Falha ao enviar coment√°rio.");
                }
                textareaComentario.value = ''; 
                limparMensagem(comentarioResposta); 
                await carregarComentarios(ticketId); 
            } catch (error) {
                exibirMensagem(comentarioResposta, error.message, false);
            }
        }
        
        function toggleTheme() {
            document.body.classList.toggle("dark-mode");
            let isDark = document.body.classList.contains("dark-mode");
            localStorage.setItem("theme", isDark ? "dark" : "light");
            btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                btnThemeToggle.textContent = "‚òÄÔ∏è";
            } else {
                document.body.classList.remove("dark-mode");
                btnThemeToggle.textContent = "üåô";
            }
        }

        // ====================================================
        // ======== EVENT LISTENERS GERAIS ========
        // ====================================================
        btnFiltrar.addEventListener('click', listarChamados);
        btnLogout.addEventListener('click', fazerLogout);
        btnThemeToggle.addEventListener('click', toggleTheme);

        ticketList.addEventListener('click', e => {
            const t = e.target;
            const id = t.dataset.id; 
            if (t.classList.contains('view-icon')) {
                const rowId = t.closest('.ticket-row').dataset.ticketId;
                abrirModalDetalhes(rowId);
            }
            else if (t.classList.contains('btn-iniciar')) {
                if (confirm(`Iniciar atendimento do chamado #${id}?\nIsto ir√° atribuir o chamado a voc√™.`)) {
                    atualizarStatusChamado(id, 'Em Andamento');
                }
            }
            else if (t.classList.contains('btn-retomar')) {
                 if (confirm(`Retomar atendimento do chamado #${id}?`)) {
                    atualizarStatusChamado(id, 'Em Andamento');
                }
            }
            else if (t.classList.contains('btn-pausar')) {
                if (confirm(`Pausar atendimento do chamado #${id}?`)) {
                    atualizarStatusChamado(id, 'Pausado');
                }
            }
            else if (t.classList.contains('btn-concluir')) {
                if (confirm(`Deseja realmente marcar o chamado #${id} como "Conclu√≠do"?`)) {
                    atualizarStatusChamado(id, 'Conclu√≠do');
                }
            }
            else if (t.classList.contains('btn-excluir')) {
                if (confirm(`ATEN√á√ÉO: Deseja realmente EXCLUIR o chamado #${id}?\n\nEsta a√ß√£o √© irrevers√≠vel e apagar√° todos os coment√°rios vinculados.`)) {
                    excluirChamado(id);
                }
            }
        });

        btnFecharModalDetalhes.addEventListener('click', () => {
            listaComentariosContainer.innerHTML = '';
            textareaComentario.value = '';
            limparMensagem(comentarioResposta);
            modalDetalhes.removeAttribute('data-current-ticket-id'); 
            modalDetalhes.close();
        });
        
        detalhePrioridadeSelect.addEventListener('change', handlePrioridadeChange);
        detalheStatusSelect.addEventListener('change', handleStatusChange);
        detalheAtendenteSelect.addEventListener('change', handleAtendenteChange);
        btnEnviarComentario.addEventListener('click', enviarNovoComentario);
        
        // Listeners de Edi√ß√£o de Categoria
        btnEditarCategoria.addEventListener('click', ativarEdicaoCategoria);
        btnCancelarEdicaoCategoria.addEventListener('click', cancelarEdicaoCategoria);
        btnSalvarCategoria.addEventListener('click', salvarNovaCategoria);

        // ====================================================
        // ======== NOVOS EVENT LISTENERS (EDI√á√ÉO CAMPOS) ========
        // ====================================================

        // --- ASSUNTO ---
        document.getElementById('btnEditarAssunto').addEventListener('click', () => {
            document.getElementById('viewAssuntoContainer').style.display = 'none';
            document.getElementById('editAssuntoContainer').style.display = 'block';
            document.getElementById('inputEditAssunto').value = detalheAssunto.textContent;
        });
        document.getElementById('btnCancelarAssunto').addEventListener('click', () => {
            document.getElementById('viewAssuntoContainer').style.display = 'flex';
            document.getElementById('editAssuntoContainer').style.display = 'none';
        });
        document.getElementById('btnSalvarAssunto').addEventListener('click', async () => {
            const novoAssunto = document.getElementById('inputEditAssunto').value;
            if(!novoAssunto) return alert("Digite um assunto.");
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/assunto`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ assunto: novoAssunto })
                });
                if(r.ok) {
                    detalheAssunto.textContent = novoAssunto;
                    document.getElementById('btnCancelarAssunto').click();
                    listarChamados();
                } else alert("Erro ao salvar.");
            } catch(e) { alert("Erro de conex√£o."); }
        });

        // --- DESCRI√á√ÉO ---
        document.getElementById('btnEditarDescricao').addEventListener('click', () => {
            document.getElementById('viewDescricaoContainer').style.display = 'none';
            document.getElementById('editDescricaoContainer').style.display = 'block';
            document.getElementById('inputEditDescricao').value = detalheDescricao.textContent;
        });
        document.getElementById('btnCancelarDescricao').addEventListener('click', () => {
            document.getElementById('viewDescricaoContainer').style.display = 'block';
            document.getElementById('editDescricaoContainer').style.display = 'none';
        });
        document.getElementById('btnSalvarDescricao').addEventListener('click', async () => {
            const novaDesc = document.getElementById('inputEditDescricao').value;
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/descricao`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ descricao: novaDesc })
                });
                if(r.ok) {
                    detalheDescricao.textContent = novaDesc;
                    document.getElementById('btnCancelarDescricao').click();
                } else alert("Erro ao salvar.");
            } catch(e) { alert("Erro de conex√£o."); }
        });

        // --- REQUISITANTE ---
        document.getElementById('btnEditarRequisitante').addEventListener('click', () => {
            document.getElementById('viewRequisitanteContainer').style.display = 'none';
            document.getElementById('editRequisitanteContainer').style.display = 'block';
        });
        document.getElementById('btnCancelarRequisitante').addEventListener('click', () => {
            document.getElementById('viewRequisitanteContainer').style.display = 'flex';
            document.getElementById('editRequisitanteContainer').style.display = 'none';
        });
        document.getElementById('btnSalvarRequisitante').addEventListener('click', async () => {
            const novoId = document.getElementById('selectEditRequisitante').value;
            if(!novoId) return alert("Selecione um usu√°rio.");
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/requisitante`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ requisitanteId: novoId })
                });
                if(r.ok) {
                    const sel = document.getElementById('selectEditRequisitante');
                    // Simplesmente atualiza visualmente com o nome do select, 
                    // ao recarregar (listarChamados) os dados reais vir√£o.
                    detalheRequisitante.textContent = sel.options[sel.selectedIndex].text;
                    document.getElementById('btnCancelarRequisitante').click();
                    listarChamados();
                } else alert("Erro ao salvar.");
            } catch(e) { alert("Erro de conex√£o."); }
        });

        // --- LOJA / DEPARTAMENTO ---
        const selLoja = document.getElementById('selectEditLoja');
        const selDepto = document.getElementById('selectEditDepartamento');

        selLoja.addEventListener('change', async () => {
            selDepto.innerHTML = '<option value="">Carregando...</option>';
            if(!selLoja.value) { selDepto.innerHTML = ''; return; }
            try {
                const r = await fetch(`${API_URL}/chamados/dados/lojas/${selLoja.value}/departamentos`);
                const deptos = await r.json();
                selDepto.innerHTML = '<option value="">Selecione o Departamento</option>';
                deptos.forEach(d => selDepto.add(new Option(d.nome, d.id)));
            } catch { selDepto.innerHTML = '<option>Erro</option>'; }
        });

        document.getElementById('btnEditarLojaDepto').addEventListener('click', () => {
            document.getElementById('viewLojaDeptoContainer').style.display = 'none';
            document.getElementById('editLojaDeptoContainer').style.display = 'block';
        });
        document.getElementById('btnCancelarLojaDepto').addEventListener('click', () => {
            document.getElementById('viewLojaDeptoContainer').style.display = 'flex';
            document.getElementById('editLojaDeptoContainer').style.display = 'none';
        });
        document.getElementById('btnSalvarLojaDepto').addEventListener('click', async () => {
            const lId = selLoja.value;
            const dId = selDepto.value;
            if(!lId || !dId) return alert("Selecione Loja e Departamento.");
            try {
                const r = await fetch(`${API_URL}/chamados/${currentTicketId}/loja-departamento`, {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lojaId: lId, departamentoId: dId })
                });
                if(r.ok) {
                    detalheLoja.textContent = selLoja.options[selLoja.selectedIndex].text;
                    detalheDepartamento.textContent = selDepto.options[selDepto.selectedIndex].text;
                    document.getElementById('btnCancelarLojaDepto').click();
                } else alert("Erro ao salvar.");
            } catch(e) { alert("Erro de conex√£o."); }
        });


        async function init() {
            loadTheme(); 
            await Promise.all([
                carregarCategorias(),
                carregarOperadores(),
                carregarFiltroLojas(),
                carregarTodosUsuarios(), 
                carregarLojasEdicao()    
            ]);
            await listarChamados(); 
        }
        
        init(); 

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>