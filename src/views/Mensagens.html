<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensagens - Portal</title>
    
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* (Estilos do Header/Sidebar copiados do Dashboard) */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-logout:hover { background-color: #bb2d3b; }
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { height: 30px; width: auto; }

        /* --- (IN√çCIO) ESTILOS DA NOVA INTERFACE DE CHAT --- */
        
        /* Remove o padding padr√£o do main-content */
        .main-content {
            padding: 0 !important;
            /* Altura total menos o header */
            height: calc(100vh - 60px); 
            overflow: hidden;
        }

        .chat-app-container {
            display: flex;
            height: 100%;
        }

        /* Painel da Esquerda (Lista de Chats) */
        .chat-list-panel {
            width: 30%;
            min-width: 280px;
            max-width: 400px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background-color: var(--light-bg);
        }

        .chat-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .chat-list-header h5 {
            margin: 0;
            color: var(--text-dark);
        }

        #connectionStatus {
            font-size: 0.8rem;
        }

        #chatListContainer {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-list-item:hover {
            background-color: var(--main-bg);
        }
        .chat-list-item.active {
            background-color: var(--primary-blue);
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: grid;
            place-items: center;
            font-size: 1.2rem;
            font-weight: 500;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .chat-list-item.active .chat-avatar {
            background-color: #fff;
            color: var(--primary-blue);
        }

        .chat-info {
            overflow: hidden; /* Para o text-overflow funcionar */
        }
        .chat-info .chat-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-list-item.active .chat-info .chat-name {
            color: #fff;
        }
        .chat-info .chat-id {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-list-item.active .chat-info .chat-id {
            color: #eee;
        }


        /* Painel da Direita (Mensagens) */
        .chat-messages-panel {
            width: 70%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--main-bg);
        }
        
        /* Boas-vindas (quando nenhum chat est√° aberto) */
        #welcomePanel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #777;
            text-align: center;
        }
        #welcomePanel .icon { font-size: 4rem; }
        
        /* Painel de chat ativo (escondido por padr√£o) */
        #chatActivePanel {
            display: none; /* Come√ßa escondido */
            flex-direction: column;
            height: 100%;
        }

        #chatHeader {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        #chatHeader .chat-avatar {
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }
        #chatHeader .chat-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        #messageHistory {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .message-bubble {
            padding: 0.6rem 1rem;
            border-radius: 18px;
            max-width: 70%;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message-bubble.from-them {
            background-color: var(--light-bg);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        .message-bubble.from-me {
            background-color: #dcf8c6;
            color: #333;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        
        #messageInputArea {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-bg);
            flex-shrink: 0;
        }
        #messageInput {
            flex-grow: 1;
            border-radius: 20px;
            border: 1px solid #ccc;
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
        }
        #sendButton {
            margin-left: 0.75rem;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            border: none;
            background-color: var(--primary-blue);
            color: white;
            font-size: 1.2rem;
        }
        
        /* Modo Escuro (Ajustes) */
        .dark-mode .chat-list-panel {
            background-color: #2a2a2a;
            border-right-color: #383838;
        }
        .dark-mode .chat-list-header { border-bottom-color: #383838; }
        .dark-mode .chat-list-header h5 { color: #f1f1f1; }
        .dark-mode .chat-list-item { border-bottom-color: #383838; }
        .dark-mode .chat-list-item:hover { background-color: #333; }
        .dark-mode .chat-list-item.active { background-color: var(--primary-blue); }
        .dark-mode .chat-info .chat-name { color: #f1f1f1; }
        .dark-mode .chat-list-item.active .chat-info .chat-name { color: #fff; }
        .dark-mode .chat-info .chat-id { color: #888; }
        .dark-mode .chat-list-item.active .chat-info .chat-id { color: #eee; }
        .dark-mode .chat-messages-panel { background-color: #181818; }
        .dark-mode #welcomePanel { color: #888; }
        .dark-mode #chatHeader { background-color: #2a2a2a; border-bottom-color: #383838; }
        .dark-mode #chatHeader .chat-name { color: #f1f1f1; }
        .dark-mode .message-bubble.from-them { background-color: #333; color: #f1f1f1; }
        .dark-mode .message-bubble.from-me { background-color: #056162; color: #f1f1f1; }
        .dark-mode #messageInputArea { background-color: #2a2a2a; border-top-color: #383838; }
        .dark-mode #messageInput { background-color: #333; border-color: #555; color: #f1f1f1; }
        
        /* --- (FIM) ESTILOS DA NOVA INTERFACE DE CHAT --- */
    </style>
</head>
<body>
    <div class="dashboard-container">
        
        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado"><a href="Chamado.html"><span class="icon">‚ûï</span><span class="text">Chamado</span></a></li>
                    <li><a href="Chatbot.html"><span class="icon">ü§ñ</span><span class="text">Chatbot</span></a></li>
                    <li><a href="Funcionarios.html"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li><a href="Categorias.html"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
                    <li><a href="Whatsapp.html"><span class="icon">üí¨</span><span class="text">Conex√£o</span></a></li>
                    <li class="active"><a href="Mensagens.html"><span class="icon">‚úâÔ∏è</span><span class="text">Mensagens</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="chat-app-container">
                
                <div class="chat-list-panel">
                    <div class="chat-list-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Conversas</h5>
                            <span id="connectionStatus" class="badge bg-secondary">Carregando...</span>
                        </div>
                    </div>
                    <div id="chatListContainer">
                        </div>
                </div>

                <div class="chat-messages-panel">

                    <div id="welcomePanel">
                        <span class="icon">üí¨</span>
                        <h4>Selecione um chat</h4>
                        <p>Clique em uma conversa ao lado para carregar o hist√≥rico.</p>
                    </div>

                    <div id="chatActivePanel">
                        <div id="chatHeader">
                            <div id="chatHeaderAvatar" class="chat-avatar">?</div>
                            <div class="chat-info">
                                <div id="chatHeaderName" class="chat-name">Carregando...</div>
                            </div>
                        </div>
                        
                        <div id="messageHistory">
                            </div>

                        <div id="messageInputArea">
                            <input type="text" id="messageInput" class="form-control" placeholder="Digite uma mensagem...">
                            <button id="sendButton" title="Enviar">‚û§</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        </div>

    <script type="module">
        // --- (IN√çCIO) FUN√á√ïES PADR√ÉO (Logout, Tema, Menu) ---
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        const userDataString = localStorage.getItem("userData");
        try {
            const userData = JSON.parse(userDataString); 
            const userNameDisplay = document.getElementById('userNameDisplay'); 
            if (userNameDisplay && userData?.data?.nomeFuncionario) {
                userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
            }
            const userPerfil = userData?.data?.perfil; 
            const linkChamadoLi = document.getElementById("menu-link-chamado"); 
            if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
                const a = linkChamadoLi.querySelector('a');
                const textSpan = a.querySelector('.text');
                a.href = "GerenciarChamados.html"; 
                a.title = "Gerenciar Chamados";
                a.querySelector('.icon').textContent = "‚úîÔ∏è"; 
                textSpan.innerHTML = "Gerenciar<br>Chamados";
            }
        } catch (error) { console.error("Erro ao configurar p√°gina:", error.message); }
        document.getElementById("logoutButton").addEventListener('click', fazerLogout);
        const btnThemeToggle = document.getElementById("themeToggle");
        function toggleTheme() {
            document.body.classList.toggle("dark-mode");
            let isDark = document.body.classList.contains("dark-mode");
            localStorage.setItem("theme", isDark ? "dark" : "light");
            if (btnThemeToggle) btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "dark") {
                document.body.classList.add("dark-mode");
                if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è";
            } else {
                document.body.classList.remove("dark-mode");
                if (btnThemeToggle) btnThemeToggle.textContent = "üåô";
            }
        }
        if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
        loadTheme();
        // --- (FIM) FUN√á√ïES PADR√ÉO ---

        // --- (IN√çCIO) L√ìGICA DA INTERFACE DE CHAT ---

        // Refer√™ncias
        const chatListContainer = document.getElementById('chatListContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const welcomePanel = document.getElementById('welcomePanel');
        const chatActivePanel = document.getElementById('chatActivePanel');
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const messageHistory = document.getElementById('messageHistory');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        let currentChatId = null;
        let allChats = []; // Cache local dos chats

        /**
         * 1. Carrega a lista de chats (e grupos) do backend
         */
        async function carregarChats() {
            try {
                const response = await fetch('/whatsapp/chats');
                const data = await response.json();

                // Atualiza o status
                connectionStatus.textContent = data.status;
                connectionStatus.className = 'badge ' + (data.status === "Conectado!" ? 'bg-success' : 'bg-danger');

                chatListContainer.innerHTML = ''; // Limpa a lista antiga
                allChats = data.chats || [];

                if (allChats.length > 0) {
                    allChats.forEach(chat => {
                        const chatName = chat.name || 'Desconhecido';
                        // (NOVO) Avatar: √çcone de grupo ou letra
                        const avatarIcon = chat.isGroup ? 'üë•' : chatName.charAt(0).toUpperCase();

                        const chatHtml = `
                        <div class="chat-list-item" data-id="${chat.id}" data-name="${escapeHtml(chatName)}" data-avatar="${avatarIcon}">
                            <div class="chat-avatar">${avatarIcon}</div>
                            <div class="chat-info">
                                <div class="chat-name">${escapeHtml(chatName)}</div>
                                <div class="chat-id">${chat.id.split('@')[0]}</div>
                            </div>
                        </div>
                        `;
                        chatListContainer.insertAdjacentHTML('beforeend', chatHtml);
                    });
                } else if (data.status === "Conectado!") {
                    chatListContainer.innerHTML = '<p class="p-3 text-center text-muted">Nenhuma conversa encontrada.</p>';
                } else {
                    chatListContainer.innerHTML = '<p class="p-3 text-center text-muted">Aguardando conex√£o...</p>';
                }

            } catch (error) {
                console.error("Erro ao carregar chats:", error);
                connectionStatus.textContent = 'Erro de Rede';
                connectionStatus.className = 'badge bg-danger';
            }
        }

        /**
         * 2. Lida com o clique em um chat da lista
         */
        function handleChatClick(event) {
            const chatItem = event.target.closest('.chat-list-item');
            if (!chatItem) return;

            // Remove o 'active' de chats antigos
            document.querySelectorAll('.chat-list-item.active').forEach(item => {
                item.classList.remove('active');
            });
            // Adiciona 'active' no chat clicado
            chatItem.classList.add('active');

            // Pega os dados do chat
            const chatId = chatItem.dataset.id;
            const chatName = chatItem.dataset.name;
            const chatAvatar = chatItem.dataset.avatar;

            currentChatId = chatId; // Define o chat atual

            // Atualiza o cabe√ßalho do painel da direita
            chatHeaderAvatar.textContent = chatAvatar;
            chatHeaderName.textContent = chatName;

            // Mostra o painel de chat e esconde as boas-vindas
            welcomePanel.style.display = 'none';
            chatActivePanel.style.display = 'flex';

            // Carrega as mensagens
            carregarMensagens(chatId);
        }

        /**
         * 3. Carrega o hist√≥rico de mensagens de um chat
         */
        async function carregarMensagens(chatId) {
            messageHistory.innerHTML = '<p class="text-center text-muted">Carregando hist√≥rico...</p>';
            
            try {
                const response = await fetch(`/whatsapp/messages/${chatId}`);
                if (!response.ok) throw new Error('Falha ao buscar mensagens.');
                
                const data = await response.json();
                renderizarMensagens(data.messages);
                
            } catch (error) {
                messageHistory.innerHTML = `<p class="text-center text-danger">${error.message}</p>`;
            }
        }

        /**
         * 4. Renderiza as mensagens no painel
         */
        function renderizarMensagens(messages) {
            messageHistory.innerHTML = ''; // Limpa o "carregando"
            
            if (!messages || messages.length === 0) {
                messageHistory.innerHTML = '<p class="text-center text-muted">Nenhuma mensagem no hist√≥rico.</p>';
                return;
            }

            messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                // (NOVO) Adiciona a classe 'from-me' ou 'from-them'
                bubble.classList.add(msg.fromMe ? 'from-me' : 'from-them');
                bubble.textContent = msg.body;
                messageHistory.appendChild(bubble);
            });

            // Rola para o final
            messageHistory.scrollTop = messageHistory.scrollHeight;
        }
        
        /**
         * 5. Envia uma nova mensagem
         */
        async function enviarMensagem() {
            const messageText = messageInput.value.trim();
            if (!messageText || !currentChatId) return;

            // Limpa o input
            messageInput.value = '';

            // Adiciona a mensagem na tela (Otimista)
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble from-me';
            bubble.textContent = messageText;
            messageHistory.appendChild(bubble);
            messageHistory.scrollTop = messageHistory.scrollHeight;

            try {
                // Envia para o backend
                const response = await fetch('/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        message: messageText
                    })
                });

                if (!response.ok) {
                    // Se falhar, mostra um erro
                    bubble.textContent = messageText + " (Falha ao enviar)";
                    bubble.style.backgroundColor = '#f8d7da';
                    bubble.style.color = '#842029';
                }
                
                // (Opcional) Recarregar a lista de chats para atualizar o timestamp
                carregarChats();

            } catch (error) {
                bubble.textContent = messageText + " (Erro de rede)";
                bubble.style.backgroundColor = '#f8d7da';
                bubble.style.color = '#842029';
            }
        }

        // --- Inicializa√ß√£o e Event Listeners ---
        function init() {
            carregarChats();
            
            // Adiciona o listener na LISTA (delega√ß√£o de evento)
            chatListContainer.addEventListener('click', handleChatClick);
            
            // Listeners do input de envio
            sendButton.addEventListener('click', enviarMensagem);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enviarMensagem();
            });
            
            // (Opcional) Atualiza a lista de chats a cada 30 segundos
            setInterval(carregarChats, 30000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        init();
        
        // --- (FIM) L√ìGICA DA INTERFACE DE CHAT ---

    </script>
</body>
</html>