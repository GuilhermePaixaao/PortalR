<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>

    <script>
        // --- PROTETOR DE P√ÅGINA ---
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) {
            window.location.replace("Login.html"); 
            throw new Error("Usu√°rio n√£o autenticado.");
        }
        try {
            const userData = JSON.parse(userDataString);
            const userId = userData?.data?.id || userData?.id; 
            if (!userId) throw new Error("Dados inv√°lidos.");
            if (userData?.data?.perfil === 'REQUISITANTE') window.location.replace("Chamado.html");
        } catch (error) {
            localStorage.removeItem("userData"); 
            window.location.replace("Login.html"); 
        }
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- ESTILOS ESPEC√çFICOS PARA FICAR BONITO (WhatsApp Style) --- */
        :root {
            --wa-green: #00a884;
            --wa-bg: #efeae2;
            --wa-header: #f0f2f5;
            --wa-incoming: #ffffff;
            --wa-outgoing: #d9fdd3;
            --border-light: #e9edef;
        }

        /* Layout Principal */
        .main-content {
            padding: 0;
            height: calc(100vh - 60px); /* Tira a altura do header */
            background-color: #fff;
            display: flex;
            overflow: hidden;
        }

        /* Barra Lateral (Lista de Contatos) */
        .sidebar-chat {
            width: 350px;
            background-color: #fff;
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 10px 16px;
            background-color: var(--wa-header);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .connection-status {
            font-size: 0.85rem;
            font-weight: 600;
            color: #54656f;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; background-color: #ccc;
        }
        .status-dot.online { background-color: var(--wa-green); }
        .status-dot.offline { background-color: #ea0038; }

        .btn-conectar {
            background-color: var(--wa-green);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* Lista de Conversas */
        #filaAtendimento {
            flex: 1;
            overflow-y: auto;
            background-color: #fff;
        }

        .contact-item {
            display: flex;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f2f5;
            transition: background 0.2s;
            position: relative;
        }
        .contact-item:hover { background-color: #f5f6f6; }
        .contact-item.active { background-color: #f0f2f5; }

        .avatar-placeholder {
            width: 45px; height: 45px;
            background-color: #dfe5e7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #fff;
            margin-right: 15px;
        }

        .contact-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .contact-name { font-size: 1rem; color: #111b21; font-weight: 500; }
        .contact-last-msg { font-size: 0.85rem; color: #667781; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        .badge-unread {
            background-color: #25d366;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* √Årea Principal (Chat) */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--wa-bg);
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            position: relative;
        }

        /* Telas de Estado (QR Code / Bem-vindo) */
        .overlay-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            text-align: center;
            border-bottom: 6px solid var(--wa-green);
        }
        
        .overlay-screen img { width: 280px; height: 280px; border: 8px solid #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .overlay-screen h2 { margin-top: 30px; color: #41525d; font-weight: 300; font-size: 2rem; }
        .overlay-screen p { margin-top: 10px; color: #667781; font-size: 0.9rem; max-width: 500px; line-height: 1.5; }

        /* Mensagens */
        .messages-container {
            flex: 1;
            padding: 20px 60px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .msg {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 7.5px;
            margin-bottom: 8px;
            position: relative;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 1px 0.5px rgba(11,20,26,.13);
            word-wrap: break-word;
        }
        .msg-in { align-self: flex-start; background-color: var(--wa-incoming); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background-color: var(--wa-outgoing); border-top-right-radius: 0; }
        
        .msg-time {
            font-size: 0.7rem;
            color: #667781;
            float: right;
            margin-top: 5px;
            margin-left: 10px;
        }
        
        .msg-sender {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--wa-green); /* Cor diferente para diferenciar */
            display: block;
            margin-bottom: 4px;
        }

        /* Input Area */
        .input-area {
            height: 60px;
            background-color: var(--wa-header);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 20; /* Ficar acima da imagem de fundo */
        }
        
        .input-field {
            flex: 1;
            background-color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 0.95rem;
            outline: none;
        }
        
        .btn-send {
            background: none; border: none; color: #54656f; font-size: 1.5rem; cursor: pointer;
        }
        .btn-send:hover { color: var(--wa-green); }

        /* CSS do Header original */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .logo-icon { height: 30px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        
        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            <div class="header-actions">
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado"><a href="GerenciarChamados.html" title="Gerenciar Chamados"><span class="icon">‚úîÔ∏è</span><span class="text">Gerenciar Chamados</span></a></li>
                    <li><a href="Chatbot.html" title="Chatbot"><span class="icon">ü§ñ</span><span class="text">Chatbot</span></a></li>
                    <li class="active"><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
                    <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            
            <div class="sidebar-chat">
                <div class="sidebar-header">
                    <div class="connection-status">
                        <div id="statusDot" class="status-dot offline"></div>
                        <span id="statusText">Desconectado</span>
                    </div>
                    <button id="btnConectarWhats" class="btn-conectar">CONECTAR</button>
                </div>
                <div id="filaAtendimento">
                    </div>
            </div>

            <div class="chat-area">
                
                <div id="qrCodeScreen" class="overlay-screen" style="display:none;">
                    <div id="qrCodeContainer"></div>
                    <h2>Conectar WhatsApp</h2>
                    <p>Abra o WhatsApp no seu celular, toque em <strong>Mais op√ß√µes</strong> ou <strong>Configura√ß√µes</strong> e selecione <strong>Aparelhos conectados</strong>. Aponte seu celular para esta tela para capturar o c√≥digo.</p>
                </div>

                <div id="welcomeScreen" class="overlay-screen">
                    <img src="https://img.freepik.com/vetores-gratis/ilustracao-do-conceito-de-chat-bot_114360-5522.jpg" alt="Conectado" style="border:none; box-shadow:none; width: 300px;">
                    <h2>Portal Rosalina Conectado</h2>
                    <p>Envie e receba mensagens do WhatsApp diretamente por aqui.<br>Selecione um contato na lista √† esquerda para iniciar o atendimento.</p>
                </div>

                <div id="activeChatScreen" style="display:none; width:100%; height:100%; flex-direction:column;">
                    <div class="messages-container" id="messagesContainer">
                        </div>
                    <div class="input-area">
                        <input type="text" id="chatInput" class="input-field" placeholder="Digite uma mensagem" disabled>
                        <button id="sendButton" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- L√ìGICA DE AUTH E LOGOUT ---
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        const btnLogout = document.getElementById("logoutButton");
        if (btnLogout) btnLogout.addEventListener('click', fazerLogout);
        
        try { 
            const u = JSON.parse(userDataString); 
            const d = document.getElementById('userNameDisplay'); 
            if (d && u?.data?.nomeFuncionario) d.textContent = `Ol√°, ${u.data.nomeFuncionario.split(' ')[0]}`; 
            // Ajuste de menu baseado no perfil
            const p = u?.data?.perfil; 
            const l = document.getElementById("menu-link-chamado"); 
            if (l && (p === 'AGENTE' || p === 'ADMIN')) { 
                const a = l.querySelector('a'); const t = a.querySelector('.text'); 
                a.href = "GerenciarChamados.html"; a.title = "Gerenciar Chamados"; 
                a.querySelector('.icon').textContent = "‚úîÔ∏è"; t.innerHTML = "Gerenciar<br>Chamados"; 
            } 
        } catch (e) { console.error('Erro auth:', e); }

        // --- VARI√ÅVEIS ---
        const qrScreen = document.getElementById('qrCodeScreen');
        const qrContainer = document.getElementById('qrCodeContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const activeChatScreen = document.getElementById('activeChatScreen');
        const messagesContainer = document.getElementById('messagesContainer');
        const filaAtendimento = document.getElementById('filaAtendimento');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConectar = document.getElementById('btnConectarWhats');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        let activeNumber = null;
        let conversations = {}; // { "55129...": [ {msg}, {msg} ] }
        let contactNames = {};

        // --- SOCKET.IO ---
        const socket = io("https://portal.smrosalina.com.br", { transports: ['polling'] });

        socket.on('connect', () => {
            console.log("Socket conectado.");
            // Ao recarregar, assumimos que pode estar conectado at√© a API dizer o contr√°rio
            // Mas por seguran√ßa, mostramos a Welcome Screen
            showScreen('welcome');
        });

        // --- RECEBE QR CODE ---
        socket.on('qrCodeRecebido', (data) => {
            if (data.qr) {
                exibirQRCode(data.qr);
            }
        });

        function exibirQRCode(base64) {
            qrContainer.innerHTML = `<img src="${base64}" alt="QR Code">`;
            statusText.textContent = "Escaneie o QR Code";
            statusDot.className = "status-dot offline";
            showScreen('qr');
        }

        // --- RECEBE STATUS DA CONEX√ÉO ---
        socket.on('statusConexao', (data) => {
            console.log("Status:", data.status);
            if (data.status === 'open') {
                setConnectedState();
            } else if (data.status === 'connecting') {
                statusText.textContent = "Conectando...";
                statusDot.className = "status-dot offline";
            } else {
                statusText.textContent = "Desconectado";
                statusDot.className = "status-dot offline";
                btnConectar.style.display = 'block';
            }
        });

        function setConnectedState() {
            statusText.textContent = "Online";
            statusDot.className = "status-dot online";
            btnConectar.style.display = 'none'; // Esconde bot√£o conectar
            if (!activeNumber) showScreen('welcome');
        }

        // --- RECEBE MENSAGENS ---
        socket.on('novaMensagemWhatsapp', (data) => {
            const number = data.de;
            const name = data.nome || number;
            const text = data.texto;
            const time = new Date();

            // Salva na mem√≥ria
            if (!conversations[number]) conversations[number] = [];
            conversations[number].push({ fromMe: false, text, time, name });
            contactNames[number] = name;

            // Atualiza a lista lateral
            updateContactList(number, name, text, true);

            // Se for o chat aberto, adiciona na tela
            if (activeNumber === number) {
                appendMessageToView(text, false, name, time);
                markAsRead(number); // Remove a bolinha se tiver aberto
            }
        });

        // --- ATUALIZAR LISTA LATERAL ---
        function updateContactList(number, name, lastMsg, unread = false) {
            // Remove item existente se houver (para mover pro topo)
            const existingItem = document.querySelector(`.contact-item[data-number="${number}"]`);
            if (existingItem) existingItem.remove();

            const div = document.createElement('div');
            div.className = `contact-item ${activeNumber === number ? 'active' : ''}`;
            div.dataset.number = number;
            
            // Avatar (Iniciais ou √çcone)
            const initial = name ? name.charAt(0).toUpperCase() : '#';

            div.innerHTML = `
                <div class="avatar-placeholder">${initial}</div>
                <div class="contact-info">
                    <div class="contact-name">${name}</div>
                    <div class="contact-last-msg">${lastMsg}</div>
                </div>
                ${unread && activeNumber !== number ? '<div class="badge-unread">!</div>' : ''}
            `;

            div.addEventListener('click', () => openChat(number));
            
            filaAtendimento.prepend(div); // Adiciona no topo
        }

        // --- ABRIR CHAT ---
        function openChat(number) {
            activeNumber = number;
            showScreen('chat');
            
            // Ativa visualmente
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            const item = document.querySelector(`.contact-item[data-number="${number}"]`);
            if(item) {
                item.classList.add('active');
                // Remove badge
                const badge = item.querySelector('.badge-unread');
                if(badge) badge.remove();
            }

            // Limpa e preenche mensagens
            messagesContainer.innerHTML = '';
            const msgs = conversations[number] || [];
            msgs.forEach(m => appendMessageToView(m.text, m.fromMe, m.name, m.time));
            
            chatInput.disabled = false;
            chatInput.focus();
        }

        function markAsRead(number) {
             const item = document.querySelector(`.contact-item[data-number="${number}"]`);
             if(item) {
                const badge = item.querySelector('.badge-unread');
                if(badge) badge.remove();
             }
        }

        // --- RENDERIZAR MENSAGEM NA TELA ---
        function appendMessageToView(text, fromMe, senderName, timeObj) {
            const div = document.createElement('div');
            div.className = `msg ${fromMe ? 'msg-out' : 'msg-in'}`;
            
            const timeStr = new Date(timeObj).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Se for grupo ou cliente, mostra nome. Se for eu, n√£o precisa.
            const nameHtml = (!fromMe && senderName) ? `<span class="msg-sender">${senderName}</span>` : '';

            div.innerHTML = `
                ${nameHtml}
                <div>${text}</div>
                <span class="msg-time">${timeStr}</span>
            `;
            
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- ENVIAR MENSAGEM ---
        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !activeNumber) return;

            // Otimista: adiciona na tela logo
            appendMessageToView(text, true, null, new Date());
            
            // Salva mem√≥ria
            if (!conversations[activeNumber]) conversations[activeNumber] = [];
            conversations[activeNumber].push({ fromMe: true, text, time: new Date() });
            
            // Atualiza lateral
            updateContactList(activeNumber, contactNames[activeNumber] || activeNumber, `Voc√™: ${text}`, false);

            chatInput.value = '';

            try {
                await fetch('/api/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero: activeNumber, mensagem: text })
                });
            } catch (error) {
                console.error("Erro ao enviar:", error);
                alert("Erro ao enviar mensagem.");
            }
        }

        // --- BOT√ÉO CONECTAR ---
        btnConectar.addEventListener('click', async () => {
            statusText.textContent = "Solicitando QR Code...";
            showScreen('qr');
            qrContainer.innerHTML = '<p style="padding:20px;">Carregando...</p>';
            
            try {
                const resp = await fetch('/api/whatsapp/connect');
                const data = await resp.json();
                // Se a API j√° devolver o base64 na resposta, exibe direto
                if(data.data?.qrcode?.base64 || data.data?.base64) {
                    exibirQRCode(data.data?.qrcode?.base64 || data.data?.base64);
                }
            } catch (e) {
                qrContainer.innerHTML = '<p style="color:red">Erro ao solicitar conex√£o.</p>';
            }
        });

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // --- GERENCIADOR DE TELAS ---
        function showScreen(screenName) {
            qrScreen.style.display = 'none';
            welcomeScreen.style.display = 'none';
            activeChatScreen.style.display = 'none';

            if (screenName === 'qr') qrScreen.style.display = 'flex';
            if (screenName === 'welcome') welcomeScreen.style.display = 'flex';
            if (screenName === 'chat') activeChatScreen.style.display = 'flex';
        }

        // Estado Inicial
        showScreen('welcome'); // Ou 'qr' se soubermos que est√° desconectado
    });
    </script>
</body>
</html>