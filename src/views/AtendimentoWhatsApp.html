<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>
    <script>
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) window.location.replace("Login.html");
        try {
            const userData = JSON.parse(userDataString);
            if (userData?.data?.perfil === 'REQUISITANTE') window.location.replace("Chamado.html");
        } catch (e) { localStorage.removeItem("userData"); window.location.replace("Login.html"); }
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --wa-bg-color: #efeae2; --wa-header-bg: #f0f2f5; --wa-sidebar-bg: #ffffff;
            --wa-border: #e9edef; --wa-msg-in: #ffffff; --wa-msg-out: #d9fdd3;
            --wa-primary: #00a884; --text-primary: #111b21; --text-secondary: #667781;
            --input-bg: #ffffff; --hover-bg: #f5f6f6; --active-bg: #f0f2f5;
        }
        body.dark-mode {
            --wa-bg-color: #0b141a; --wa-header-bg: #202c33; --wa-sidebar-bg: #111b21;
            --wa-border: #2f3b43; --wa-msg-in: #202c33; --wa-msg-out: #005c4b;
            --wa-primary: #00a884; --text-primary: #e9edef; --text-secondary: #8696a0;
            --input-bg: #2a3942; --hover-bg: #202c33; --active-bg: #2a3942;
        }
        body.dark-mode .main-content { background-color: var(--wa-sidebar-bg); }
        body.dark-mode .header { background-color: var(--wa-header-bg); border-bottom-color: var(--wa-border); }
        body.dark-mode .logo, body.dark-mode #userNameDisplay { color: #e9edef; }
        
        .main-content { padding: 0; height: calc(100vh - 60px); background-color: var(--wa-sidebar-bg); display: flex; overflow: hidden; }
        .sidebar-chat { width: 350px; background-color: var(--wa-sidebar-bg); border-right: 1px solid var(--wa-border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 16px; background-color: var(--wa-header-bg); border-bottom: 1px solid var(--wa-border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        
        #filaHeader { font-size: 0.9rem; font-weight: bold; color: var(--wa-primary); padding: 10px 15px; border-bottom: 1px solid var(--wa-border); background: var(--wa-sidebar-bg); }
        #filaAtendimento { flex: 1; overflow-y: auto; }
        .loading-fila { padding: 20px; text-align: center; color: var(--text-secondary); font-style: italic; }

        .contact-item { display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--wa-border); position: relative; }
        .contact-item:hover { background-color: var(--hover-bg); }
        .contact-item.active { background-color: var(--active-bg); }
        .avatar-placeholder { width: 45px; height: 45px; background-color: #667781; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #fff; margin-right: 15px; }
        .contact-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .contact-name { font-size: 1rem; color: var(--text-primary); font-weight: 500; }
        .contact-last-msg { font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge-unread { background-color: #25d366; color: white; font-size: 0.75rem; font-weight: bold; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }

        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg-color); position: relative; z-index: 0; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); opacity: 0.4; z-index: -1; pointer-events: none; }
        body.dark-mode .chat-area::before { opacity: 0.08; }

        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--wa-header-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; text-align: center; border-bottom: 6px solid var(--wa-primary); }
        .overlay-screen img { width: 280px; height: 280px; border: 8px solid #fff; border-radius: 8px; }
        .overlay-screen h2 { margin-top: 30px; color: var(--text-primary); font-weight: 300; font-size: 2rem; }
        .overlay-screen p { margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem; max-width: 500px; }

        .messages-container { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 7.5px; margin-bottom: 8px; position: relative; font-size: 0.9rem; line-height: 1.4; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word; color: var(--text-primary); }
        .msg-in { align-self: flex-start; background-color: var(--wa-msg-in); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background-color: var(--wa-msg-out); border-top-right-radius: 0; }
        .msg-time { font-size: 0.7rem; color: var(--text-secondary); float: right; margin-top: 5px; margin-left: 10px; }
        .msg-sender { font-size: 0.75rem; font-weight: bold; color: var(--wa-primary); display: block; margin-bottom: 4px; }

        .input-area { height: 60px; background-color: var(--wa-header-bg); padding: 10px 16px; display: flex; align-items: center; gap: 15px; z-index: 20; border-top: 1px solid var(--wa-border); }
        .input-field { flex: 1; background-color: var(--input-bg); color: var(--text-primary); border: none; border-radius: 8px; padding: 12px 15px; font-size: 0.95rem; outline: none; }
        .btn-send { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .btn-send:hover { color: var(--wa-primary); }
        
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .logo-icon { height: 30px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
        .btn-theme-toggle { background: none; border: 1px solid #ced4da; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; color: #495057; display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-theme-toggle:hover { background-color: #f1f3f5; }
        body.dark-mode .btn-theme-toggle { border-color: #555; color: #e9edef; }
        body.dark-mode .btn-theme-toggle:hover { background-color: #2a3942; }

        .connection-status { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; }
        .status-dot.online { background-color: var(--wa-primary); }
        .status-dot.offline { background-color: #ea0038; }
        .btn-conectar { background-color: var(--wa-primary); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }

        /* === NOVO: ESTILO DO PAINEL DE ATENDIMENTO (BOT√ÉO ASSUMIR) === */
        #painelAtendimento {
            display: none; /* Come√ßa escondido */
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ffeeba;
            animation: fadeIn 0.5s;
            width: 100%;
        }
        
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        
        .btn-assumir {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .btn-assumir:hover { background-color: #218838; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado"><a href="GerenciarChamados.html" title="Gerenciar Chamados"><span class="icon">‚úîÔ∏è</span><span class="text">Gerenciar Chamados</span></a></li>
                    <li class="active"><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
<li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="sidebar-chat">
                <div class="sidebar-header">
                    <div class="connection-status">
                        <div id="statusDot" class="status-dot offline"></div>
                        <span id="statusText">Desconectado</span>
                    </div>
                    <button id="btnConectarWhats" class="btn-conectar">CONECTAR</button>
                </div>
                <div id="filaHeader">Fila de Atendimento</div>
                <div id="filaAtendimento">
                    <div class="loading-fila" id="loadingFila" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando conversas...
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div id="qrCodeScreen" class="overlay-screen" style="display:none;">
                    <div id="qrCodeContainer"></div>
                    <h2>Conectar WhatsApp</h2>
                    <p>Abra o WhatsApp no seu celular e escaneie.</p>
                </div>

                <div id="welcomeScreen" class="overlay-screen">
                    <img src="https://img.freepik.com/vetores-gratis/ilustracao-do-conceito-de-chat-bot_114360-5522.jpg" alt="Conectado" style="border:none; box-shadow:none; width: 300px; background:transparent;">
                    <h2>Portal Conectado</h2>
                    <p>Selecione uma conversa ao lado para come√ßar.</p>
                </div>

                <div id="activeChatScreen" style="display:none; width:100%; height:100%; flex-direction:column;">
                    
                    <div id="painelAtendimento">
                        <span>üîî <b>Aten√ß√£o:</b> Este cliente entrou na fila de T.I.</span>
                        <button id="btnAssumirChamado" class="btn-assumir">‚úÖ ASSUMIR ATENDIMENTO</button>
                    </div>
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="input-area">
                        <input type="text" id="chatInput" class="input-field" placeholder="Digite uma mensagem" disabled>
                        <button id="sendButton" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- Fun√ß√µes de Sistema (Logout, Tema) ---
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        document.getElementById("logoutButton").addEventListener('click', fazerLogout);

        const btnThemeToggle = document.getElementById("themeToggle");
        function toggleTheme() { document.body.classList.toggle("dark-mode"); let d = document.body.classList.contains("dark-mode"); localStorage.setItem("theme", d ? "dark" : "light"); btnThemeToggle.textContent = d ? "‚òÄÔ∏è" : "üåô"; }
        function loadTheme() { const t = localStorage.getItem("theme"); if (t === "dark") { document.body.classList.add("dark-mode"); btnThemeToggle.textContent = "‚òÄÔ∏è"; } else { document.body.classList.remove("dark-mode"); btnThemeToggle.textContent = "üåô"; } }
        btnThemeToggle.addEventListener('click', toggleTheme);
        loadTheme();
        
        try { 
            const u = JSON.parse(localStorage.getItem("userData")); 
            const d = document.getElementById('userNameDisplay'); 
            if (d && u?.data?.nomeFuncionario) d.textContent = `Ol√°, ${u.data.nomeFuncionario.split(' ')[0]}`; 
            if (u?.data?.perfil === 'AGENTE' || u?.data?.perfil === 'ADMIN') { 
                const l = document.getElementById("menu-link-chamado"); 
                if(l) { l.querySelector('a').href = "GerenciarChamados.html"; l.querySelector('.text').innerHTML = "Gerenciar<br>Chamados"; }
            } 
        } catch (e) {}

        // --- Elementos ---
        const qrScreen = document.getElementById('qrCodeScreen');
        const qrContainer = document.getElementById('qrCodeContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const activeChatScreen = document.getElementById('activeChatScreen');
        const messagesContainer = document.getElementById('messagesContainer');
        const filaAtendimento = document.getElementById('filaAtendimento');
        const loadingFila = document.getElementById('loadingFila');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConectar = document.getElementById('btnConectarWhats');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const filaHeader = document.getElementById('filaHeader');
        const painelAtendimento = document.getElementById('painelAtendimento'); // Novo

        // --- Estado ---
        let activeNumber = null;
        let conversas = {}; 
        let contactNames = {};

        const socket = io(); 
        
        // ====================================================
        // ======== (NOVO) L√ìGICA DE PERSIST√äNCIA (localStorage) ========
        // ====================================================

        function saveConversas() {
            try {
                localStorage.setItem('wa_conversas', JSON.stringify(conversas));
                localStorage.setItem('wa_contactNames', JSON.stringify(contactNames));
            } catch (e) {
                console.error("Falha ao salvar conversas no localStorage:", e);
            }
        }

        function loadConversas() {
            try {
                const savedConversas = localStorage.getItem('wa_conversas');
                const savedNames = localStorage.getItem('wa_contactNames');
                if (savedConversas) conversas = JSON.parse(savedConversas);
                if (savedNames) contactNames = JSON.parse(savedNames);
            } catch (e) {
                console.warn("Nenhum hist√≥rico de conversas encontrado ou JSON corrompido.");
                conversas = {};
                contactNames = {};
            }
        }

        // ====================================================
        // ======== FIM L√ìGICA DE PERSIST√äNCIA ========
        // ====================================================

        socket.on('connect', () => {
            console.log("‚úÖ Socket conectado!");
            loadConversas(); // <--- CARREGA OS DADOS AO CONECTAR
            verificarStatusInicial();
        });

        // --- L√≥gica Principal ---

        async function verificarStatusInicial() {
            try {
                const resp = await fetch('/api/whatsapp/status');
                const json = await resp.json();
                const state = json.data?.instance?.state || json.data?.state || json.instance?.state;

                if (state === 'open') {
                    setConnectedState();
                    carregarConversas();
                } else {
                    showScreen('welcome');
                    statusText.textContent = "Desconectado"; 
                    statusDot.className = "status-dot offline"; 
                    btnConectar.style.display = 'block';
                }
            } catch (e) { console.error(e); }
        }

        async function carregarConversas() {
            if (filaAtendimento.children.length <= 1) {
                loadingFila.style.display = 'block';
            }
            try {
                const resp = await fetch('/api/whatsapp/chats');
                const json = await resp.json();
                
                let listaDeChats = [];
                if (Array.isArray(json)) listaDeChats = json;
                else if (json.success && Array.isArray(json.data)) listaDeChats = json.data;
                else if (Array.isArray(json.data)) listaDeChats = json.data;

                listaDeChats.forEach(chat => {
                    const numero = chat.numero || chat.id || chat.key?.remoteJid;
                    const nome = chat.nome || chat.pushName || chat.name || chat.verifiedName || numero.split('@')[0];
                    const ultimaMensagem = chat.ultimaMensagem || chat.conversation || chat.lastMessage?.conversation || "...";
                    const unread = (chat.unreadCount > 0 || chat.unread === true);

                    if (numero) {
                        if (!conversas[numero]) {
                             // Se a conversa for nova, inicializa. Se for antiga, mant√©m o que veio do loadConversas
                             if(!conversas[numero]) conversas[numero] = []; 
                        }
                        contactNames[numero] = nome;
                        updateContactList(numero, nome, ultimaMensagem, unread);
                    }
                });
                
                atualizarContadorFila();
            } catch (e) {
                console.error("Erro ao carregar chats:", e);
            } finally {
                loadingFila.style.display = 'none';
            }
        }

        function atualizarContadorFila() {
            const qtd = document.querySelectorAll('.contact-item').length;
            filaHeader.textContent = `Fila de Atendimento (${qtd})`;
        }

        // --- Socket Events ---

        socket.on('qrCodeRecebido', (data) => { 
            if (data.qr) exibirQRCode(data.qr); 
        });
        
        socket.on('statusConexao', (data) => {
            if (data.status === 'open') { setConnectedState(); carregarConversas(); }
            else if (data.status === 'connecting') { statusText.textContent = "Conectando..."; statusDot.className = "status-dot offline"; }
            else { statusText.textContent = "Desconectado"; statusDot.className = "status-dot offline"; btnConectar.style.display = 'block'; }
        });

        // === SOCKET: NOTIFICA√á√ÉO DE CHAMADO (O CLIENTE APERTOU 1) ===
        socket.on('notificacaoChamado', (data) => {
            // Se o chat estiver aberto, mostra o painel
            if (activeNumber === data.chatId) {
                painelAtendimento.style.display = 'block';
            }
            
            // Marca visualmente na lista lateral (Borda Amarela)
            const itemLista = document.querySelector(`.contact-item[data-number="${data.chatId}"]`);
            if (itemLista) {
                itemLista.style.borderLeft = "5px solid #ffc107";
                itemLista.dataset.pending = "true"; // Marca flag
                const lastMsgDiv = itemLista.querySelector('.contact-last-msg');
                if(lastMsgDiv) lastMsgDiv.innerHTML = "<b>üîî Aguardando Atendimento...</b>";
            }
        });

        // === SOCKET: NOVA MENSAGEM (COM PROTE√á√ÉO VISUAL) ===
        socket.on('novaMensagemWhatsapp', (data) => {
            const chatId = data.chatId; 
            const msgId = data.id; 
            const text = data.texto;
            const isFromMe = data.fromMe;

            // 1. Prote√ß√£o Visual: Se a mensagem j√° existe na tela (pelo ID), n√£o faz nada.
            if (msgId && document.getElementById(`msg-${msgId}`)) return;

            // 2. Hist√≥rico Local
            if (!conversas[chatId]) conversas[chatId] = [];
            
            // Verifica√ß√£o simples de duplica√ß√£o no array (caso venha sem ID do backend antigo)
            const existe = conversas[chatId].some(m => m.text === text && m.time > new Date(Date.now() - 5000));
            
            if (!existe) {
                let displayName = contactNames[chatId];
                if (!isFromMe) {
                    displayName = data.nome || chatId.split('@')[0];
                    contactNames[chatId] = displayName;
                }
                
                conversas[chatId].push({ 
                    id: msgId, 
                    fromMe: isFromMe, 
                    text: text, 
                    time: new Date(), 
                    name: isFromMe ? "Eu" : displayName 
                });

                saveConversas(); // <--- ADICIONADO AQUI: Salva a nova mensagem

                const previewMsg = isFromMe ? `Voc√™: ${text}` : text;
                updateContactList(chatId, displayName, previewMsg, !isFromMe);

                if (activeNumber === chatId) {
                    appendMessageToView(text, isFromMe, isFromMe ? null : displayName, new Date(), msgId);
                    markAsRead(chatId);
                }
            }
        });

        // === BOT√ÉO: ASSUMIR CHAMADO ===
        document.getElementById('btnAssumirChamado').addEventListener('click', async () => {
            if (!activeNumber) return;

            const userData = JSON.parse(localStorage.getItem("userData"));
            const nomeAgente = userData?.data?.nomeFuncionario || "Suporte T.I";

            try {
                const response = await fetch('/api/whatsapp/atender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero: activeNumber, nomeAgente: nomeAgente })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Esconde o painel
                    painelAtendimento.style.display = 'none';
                    
                    // Remove borda amarela da lista
                    const itemLista = document.querySelector(`.contact-item[data-number="${activeNumber}"]`);
                    if (itemLista) {
                        itemLista.style.borderLeft = "none";
                        delete itemLista.dataset.pending;
                    }

                    appendMessageToView(`‚úÖ Voc√™ assumiu este chamado. O Bot foi pausado.`, true, "Sistema", new Date());
                }
            } catch (e) {
                alert("Erro ao assumir chamado.");
            }
        });

        // --- UI Helpers ---

        function setConnectedState() {
            statusText.textContent = "Online"; statusDot.className = "status-dot online";
            btnConectar.style.display = 'none';
            if (!activeNumber) showScreen('welcome');
        }

        function exibirQRCode(base64) {
            qrContainer.innerHTML = `<img src="${base64}" alt="QR Code">`;
            statusText.textContent = "Escaneie o QR Code";
            showScreen('qr');
        }

        function updateContactList(number, name, lastMsg, unread = false) {
            // Preserva se estava marcado como pendente
            let isPending = false;
            let existingItem = document.querySelector(`.contact-item[data-number="${number}"]`);
            if (existingItem && existingItem.dataset.pending === "true") isPending = true;
            if (existingItem) existingItem.remove();

            const initial = name ? name.charAt(0).toUpperCase() : '#';
            
            let item = document.createElement('div');
            item.className = `contact-item ${activeNumber === number ? 'active' : ''}`;
            item.dataset.number = number;
            if (isPending) {
                item.dataset.pending = "true";
                item.style.borderLeft = "5px solid #ffc107";
            }
            
            const showBadge = unread && activeNumber !== number;

            item.innerHTML = `
                <div class="avatar-placeholder">${initial}</div>
                <div class="contact-info">
                    <div class="contact-name">${name}</div>
                    <div class="contact-last-msg">${lastMsg}</div>
                </div>
                ${showBadge ? '<div class="badge-unread">!</div>' : ''}
            `;

            item.addEventListener('click', () => openChat(number));
            filaAtendimento.prepend(item); 
            
            if (filaAtendimento.querySelectorAll('.contact-item').length > 0) {
                loadingFila.style.display = 'none';
            }
            atualizarContadorFila();
        }

        function openChat(number) {
            activeNumber = number;
            showScreen('chat');
            
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            const item = document.querySelector(`.contact-item[data-number="${number}"]`);
            
            // Reseta UI
            painelAtendimento.style.display = 'none';
            
            if(item) { 
                item.classList.add('active'); 
                markAsRead(number); 
                
                // SE O ITEM TIVER A MARCA DE PENDENTE, MOSTRA O BOT√ÉO ASSUMIR
                if (item.dataset.pending === "true" || item.style.borderLeft.includes("ffc107")) {
                    painelAtendimento.style.display = 'block';
                }
            }
            
            messagesContainer.innerHTML = '';
            const msgs = conversas[number] || [];
            
            if (msgs.length === 0) {
                 messagesContainer.innerHTML = '<div style="text-align:center; margin-top:20px; color:#999;">Sem hist√≥rico local.<br>Novas mensagens aparecer√£o aqui.</div>';
            } else {
                msgs.forEach(m => appendMessageToView(m.text, m.fromMe, m.name, m.time, m.id));
            }
            
            chatInput.disabled = false; chatInput.focus();
        }

        function markAsRead(number) {
            const item = document.querySelector(`.contact-item[data-number="${number}"]`);
            if(item) { const b = item.querySelector('.badge-unread'); if(b) b.remove(); }
        }

        // ATUALIZADO: Aceita msgId para evitar duplicatas
        function appendMessageToView(text, fromMe, senderName, timeObj, msgId) {
            if (msgId && document.getElementById(`msg-${msgId}`)) return;

            const div = document.createElement('div');
            if (msgId) div.id = `msg-${msgId}`;
            
            div.className = `msg ${fromMe ? 'msg-out' : 'msg-in'}`;
            const timeStr = new Date(timeObj).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const nameHtml = (!fromMe && senderName) ? `<span class="msg-sender">${senderName}</span>` : '';
            div.innerHTML = `${nameHtml}<div>${text}</div><span class="msg-time">${timeStr}</span>`;
            
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !activeNumber) return;
            
            // Cria ID tempor√°rio para a mensagem enviada
            const tempId = 'sent-' + Date.now();

            appendMessageToView(text, true, null, new Date(), tempId);
            
            if (!conversas[activeNumber]) conversas[activeNumber] = [];
            conversas[activeNumber].push({ id: tempId, fromMe: true, text, time: new Date() });
            
            saveConversas(); // <--- ADICIONADO AQUI: Salva a mensagem enviada

            const displayName = contactNames[activeNumber] || activeNumber;
            updateContactList(activeNumber, displayName, `Voc√™: ${text}`, false);

            chatInput.value = '';
            
            try {
                // Obter o nome do agente para que o backend possa formatar a mensagem
                const userData = JSON.parse(localStorage.getItem("userData"));
                const nomeAgente = userData?.data?.nomeFuncionario || "Atendente";

                await fetch('/api/whatsapp/send', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        numero: activeNumber, 
                        mensagem: text,
                        nomeAgenteTemporario: nomeAgente // <--- ADICIONADO AQUI
                    })
                });
            } catch (e) { 
                console.error(e); 
                alert("Erro ao enviar. Verifique a conex√£o."); 
            }
        }

        btnConectar.addEventListener('click', async () => {
            statusText.textContent = "Solicitando..."; showScreen('qr');
            try {
                const r = await fetch('/api/whatsapp/connect');
                const d = await r.json();
                if(d.data?.qrcode?.base64 || d.data?.base64) exibirQRCode(d.data?.qrcode?.base64 || d.data?.base64);
            } catch (e) { qrContainer.innerHTML = '<p style="color:red">Erro.</p>'; }
        });

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

        function showScreen(screenName) {
            qrScreen.style.display = 'none'; welcomeScreen.style.display = 'none'; activeChatScreen.style.display = 'none';
            if (screenName === 'qr') qrScreen.style.display = 'flex';
            if (screenName === 'welcome') welcomeScreen.style.display = 'flex';
            if (screenName === 'chat') activeChatScreen.style.display = 'flex';
        }
    });
    </script>
</body>
</html>