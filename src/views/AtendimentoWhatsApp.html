<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>
    <script>
        // Auth Check
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) window.location.replace("Login.html");
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Estilos B√°sicos do Chat */
        :root { --wa-bg: #efeae2; --wa-out: #d9fdd3; --wa-in: #fff; }
        body.dark-mode { --wa-bg: #0b141a; --wa-out: #005c4b; --wa-in: #202c33; }
        
        .main-content { display: flex; height: calc(100vh - 60px); overflow: hidden; background: #fff; }
        .sidebar-chat { width: 350px; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--wa-bg); position: relative; }
        
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 70%; font-size: 0.9rem; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-in { align-self: flex-start; background: var(--wa-in); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background: var(--wa-out); border-top-right-radius: 0; }
        .msg-time { font-size: 0.7rem; color: #999; float: right; margin-left: 10px; margin-top: 5px; }
        
        .contact-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .contact-item:hover { background: #f5f5f5; }
        .contact-item.active { background: #e9edef; }
        .avatar { width: 40px; height: 40px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: white; }
        
        .input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        .input-field { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        .btn-conectar { background: #00a884; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO ROSALINA</div>
            <div class="header-actions"><button id="logoutButton">Sair</button></div>
        </header>
        
        <aside class="sidebar">
            <nav><ul>
                <li><a href="Dashboard.html">üè† In√≠cio</a></li>
                <li class="active"><a href="#">üí¨ WhatsApp</a></li>
            </ul></nav>
        </aside>
        
        <main class="main-content">
            <div class="sidebar-chat">
                <div style="padding:10px; display:flex; justify-content:space-between;">
                    <span id="statusText">Offline</span>
                    <button id="btnConectarWhats" class="btn-conectar">Conectar</button>
                </div>
                <div id="filaAtendimento" style="flex:1; overflow-y:auto;"></div>
            </div>

            <div class="chat-area">
                <div id="qrCodeScreen" style="display:none; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                    <div id="qrCodeContainer"></div>
                    <h3>Escaneie o QR Code</h3>
                </div>

                <div id="welcomeScreen" style="display:flex; justify-content:center; align-items:center; height:100%;">
                    <p>Selecione uma conversa</p>
                </div>

                <div id="activeChatScreen" style="display:none; flex-direction:column; height:100%;">
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="input-area">
                        <input type="text" id="chatInput" class="input-field" placeholder="Digite uma mensagem...">
                        <button id="sendButton">Enviar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS ---
        const statusText = document.getElementById('statusText');
        const btnConectar = document.getElementById('btnConectarWhats');
        const qrScreen = document.getElementById('qrCodeScreen');
        const qrContainer = document.getElementById('qrCodeContainer');
        const filaAtendimento = document.getElementById('filaAtendimento');
        const messagesContainer = document.getElementById('messagesContainer');
        const activeChatScreen = document.getElementById('activeChatScreen');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');

        let activeNumber = null;
        const socket = io(); 

        document.getElementById('logoutButton').onclick = () => { localStorage.removeItem("userData"); window.location.href="Login.html"; };

        // --- INICIALIZA√á√ÉO ---
        socket.on('connect', () => {
            console.log("‚úÖ Socket conectado!");
            carregarStatusEConversas();
        });

        async function carregarStatusEConversas() {
            try {
                const s = await fetch('/api/whatsapp/status').then(r => r.json());
                if (s.data?.instance?.state === 'open') {
                    statusText.textContent = "Online ‚úÖ";
                    statusText.style.color = "green";
                    btnConectar.style.display = 'none';
                    showScreen('welcome');
                    carregarChats();
                } else {
                    statusText.textContent = "Desconectado ‚ùå";
                    statusText.style.color = "red";
                    btnConectar.style.display = 'block';
                }
            } catch(e) { console.error(e); }
        }

        async function carregarChats() {
            try {
                const r = await fetch('/api/whatsapp/chats').then(res => res.json());
                filaAtendimento.innerHTML = '';
                
                (r.data || []).forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'contact-item';
                    div.dataset.number = c.numero;
                    div.innerHTML = `
                        <div class="avatar">${c.nome.charAt(0)}</div>
                        <div>
                            <div style="font-weight:bold">${c.nome}</div>
                            <div style="font-size:0.8rem; color:#666">${c.ultimaMensagem}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(c.numero, c.nome);
                    filaAtendimento.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }

        // --- FUN√á√ÉO PRINCIPAL DE ABRIR CHAT (COM HIST√ìRICO) ---
        window.openChat = async (number, name) => {
            activeNumber = number;
            showScreen('chat');
            messagesContainer.innerHTML = '<p style="text-align:center; padding:20px;">Carregando hist√≥rico...</p>';

            try {
                // 1. BUSCA O HIST√ìRICO NA API
                const r = await fetch(`/api/whatsapp/messages/${number}`);
                const json = await r.json();
                
                messagesContainer.innerHTML = '';
                const msgs = json.data || [];

                if(msgs.length === 0) {
                    messagesContainer.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">Nenhuma mensagem anterior.</p>';
                } else {
                    msgs.forEach(m => appendMessage(m.text, m.fromMe, m.time));
                }
                scrollToBottom();

            } catch (e) {
                messagesContainer.innerHTML = '<p style="color:red; text-align:center;">Erro ao carregar hist√≥rico.</p>';
            }
        };

        // --- ENVIAR MENSAGEM ---
        async function sendMessage() {
            const text = chatInput.value.trim();
            if(!text || !activeNumber) return;

            appendMessage(text, true, new Date()); // Mostra na hora
            chatInput.value = '';
            scrollToBottom();

            try {
                await fetch('/api/whatsapp/send', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ numero: activeNumber, mensagem: text })
                });
            } catch(e) { alert("Erro ao enviar"); }
        }

        // --- RECEBER MENSAGEM INSTANT√ÇNEA (SOCKET) ---
        socket.on('novaMensagemWhatsapp', (data) => {
            // Se for o chat que est√° aberto agora, adiciona o bal√£o
            if (activeNumber === data.chatId) {
                appendMessage(data.texto, data.fromMe, new Date());
                scrollToBottom();
            } else {
                // Se n√£o, mostra uma notifica√ß√£o visual na lista (opcional)
                // Aqui voc√™ poderia recarregar a lista de chats para atualizar a √∫ltima mensagem
                carregarChats(); 
            }
        });
        
        socket.on('qrCodeRecebido', (d) => {
            if(d.qr) {
                qrContainer.innerHTML = `<img src="${d.qr}" width="250">`;
                showScreen('qr');
            }
        });

        socket.on('statusConexao', (d) => {
            if(d.status === 'open') window.location.reload(); // Recarrega para pegar chats
        });

        // --- HELPERS ---
        function appendMessage(text, fromMe, time) {
            const div = document.createElement('div');
            div.className = `msg ${fromMe ? 'msg-out' : 'msg-in'}`;
            const t = new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            div.innerHTML = `<div>${text}</div><span class="msg-time">${t}</span>`;
            messagesContainer.appendChild(div);
        }

        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }

        function showScreen(s) {
            qrScreen.style.display = 'none'; welcomeScreen.style.display = 'none'; activeChatScreen.style.display = 'none';
            if(s==='qr') qrScreen.style.display = 'flex';
            if(s==='welcome') welcomeScreen.style.display = 'flex';
            if(s==='chat') activeChatScreen.style.display = 'flex';
        }

        btnConectar.onclick = async () => {
            statusText.textContent = "Gerando QR...";
            try { await fetch('/api/whatsapp/connect'); } catch(e){}
        };
        sendButton.onclick = sendMessage;
        chatInput.onkeypress = (e) => { if(e.key==='Enter') sendMessage(); }
    });
    </script>
</body>
</html>