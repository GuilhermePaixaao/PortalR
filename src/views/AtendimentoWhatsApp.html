<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>
    <script>
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) window.location.replace("Login.html");
        try {
            const userData = JSON.parse(userDataString);
            if (userData?.data?.perfil === 'REQUISITANTE') window.location.replace("Chamado.html");
        } catch (e) { localStorage.removeItem("userData"); window.location.replace("Login.html"); }
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --wa-bg-color: #efeae2; --wa-header-bg: #f0f2f5; --wa-sidebar-bg: #ffffff; --wa-border: #e9edef; --wa-msg-in: #ffffff; --wa-msg-out: #d9fdd3; --wa-primary: #00a884; --text-primary: #111b21; --text-secondary: #667781; --input-bg: #ffffff; }
        body.dark-mode { --wa-bg-color: #0b141a; --wa-header-bg: #202c33; --wa-sidebar-bg: #111b21; --wa-border: #2f3b43; --wa-msg-in: #202c33; --wa-msg-out: #005c4b; --wa-primary: #00a884; --text-primary: #e9edef; --text-secondary: #8696a0; --input-bg: #2a3942; }
        body.dark-mode .main-content { background-color: var(--wa-sidebar-bg); }
        .main-content { padding: 0; height: calc(100vh - 60px); background-color: var(--wa-sidebar-bg); display: flex; overflow: hidden; }
        .sidebar-chat { width: 350px; background-color: var(--wa-sidebar-bg); border-right: 1px solid var(--wa-border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 16px; background-color: var(--wa-header-bg); border-bottom: 1px solid var(--wa-border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        #filaHeader { font-size: 0.9rem; font-weight: bold; color: var(--wa-primary); padding: 10px 15px; border-bottom: 1px solid var(--wa-border); background: var(--wa-sidebar-bg); }
        #filaAtendimento { flex: 1; overflow-y: auto; }
        .contact-item { display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--wa-border); }
        .contact-item:hover { background-color: var(--wa-header-bg); }
        .contact-item.active { background-color: #f0f2f5; }
        body.dark-mode .contact-item.active { background-color: #202c33; }
        .avatar-placeholder { width: 45px; height: 45px; background-color: #667781; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; margin-right: 15px; }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-weight: 500; color: var(--text-primary); }
        .contact-last-msg { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg-color); position: relative; }
        .chat-area::before { content: ""; position: absolute; width: 100%; height: 100%; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); opacity: 0.4; z-index: 0; pointer-events: none; }
        body.dark-mode .chat-area::before { opacity: 0.08; }
        .messages-container { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; z-index: 1; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 7.5px; margin-bottom: 8px; position: relative; font-size: 0.9rem; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); color: var(--text-primary); }
        .msg-in { align-self: flex-start; background-color: var(--wa-msg-in); }
        .msg-out { align-self: flex-end; background-color: var(--wa-msg-out); }
        .msg-sender { font-size: 0.75rem; font-weight: bold; color: var(--wa-primary); display: block; }
        .input-area { height: 60px; background-color: var(--wa-header-bg); padding: 10px 16px; display: flex; align-items: center; gap: 15px; z-index: 20; border-top: 1px solid var(--wa-border); }
        .input-field { flex: 1; background-color: var(--input-bg); border: none; border-radius: 8px; padding: 12px; outline: none; color: var(--text-primary); }
        .btn-send { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        #painelAtendimento { display: none; background-color: #fff3cd; color: #856404; padding: 15px; text-align: center; width: 100%; z-index: 5; }
        .btn-assumir { background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight: bold; }
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--wa-header-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        
        /* Badge e Status */
        .badge-unread { background-color: #25d366; color: white; font-size: 0.75rem; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .connection-status { font-size: 0.85rem; font-weight: bold; color: var(--text-secondary); display: flex; gap: 8px; align-items: center; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.online { background-color: #00a884; } .status-dot.offline { background-color: #ea0038; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo"><img src="/img.png" style="height:30px;margin-right:10px;"> PORTAL ROSALINA</div>
            <div class="header-actions">
                <button id="themeToggle" style="background:none;border:none;font-size:1.2rem;cursor:pointer;">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html">üè† In√≠cio</a></li>
                    <li id="menu-link-chamado"><a href="GerenciarChamados.html">‚úîÔ∏è Gerenciar Chamados</a></li>
                    <li><a href="Chatbot.html">ü§ñ Chatbot</a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="sidebar-chat">
                <div class="sidebar-header">
                    <div class="connection-status">
                        <div id="statusDot" class="status-dot offline"></div>
                        <span id="statusText">Desconectado</span>
                    </div>
                    <button id="btnConectarWhats" style="display:none;background:#00a884;color:white;border:none;padding:5px 10px;border-radius:15px;">CONECTAR</button>
                </div>
                <div id="filaHeader">Fila de Atendimento (0)</div>
                <div id="filaAtendimento"></div>
            </div>

            <div class="chat-area">
                <div id="qrCodeScreen" class="overlay-screen" style="display:none;">
                    <div id="qrCodeContainer"></div>
                    <h2>Conectar WhatsApp</h2>
                </div>
                <div id="welcomeScreen" class="overlay-screen">
                    <h2>Portal Conectado</h2>
                    <p>Selecione uma conversa da fila para atender.</p>
                </div>
                <div id="activeChatScreen" style="display:none; width:100%; height:100%; flex-direction:column;">
                    <div id="painelAtendimento">
                        <span>üîî <b>Aten√ß√£o:</b> Cliente na fila de espera.</span>
                        <button id="btnAssumirChamado" class="btn-assumir">‚úÖ ASSUMIR</button>
                    </div>
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="input-area">
                        <input type="text" id="chatInput" class="input-field" placeholder="Digite uma mensagem" disabled>
                        <button id="sendButton" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        document.getElementById("logoutButton").addEventListener('click', fazerLogout);
        
        try { 
            const u = JSON.parse(localStorage.getItem("userData")); 
            document.getElementById('userNameDisplay').textContent = `Ol√°, ${u.data.nomeFuncionario.split(' ')[0]}`;
        } catch (e) {}

        // --- ESTADO DO APLICATIVO (SINGLE SOURCE OF TRUTH) ---
        let AppState = {
            activeNumber: null,
            conversas: {},      
            contactNames: {},   
            chatList: []        
        };

        const socket = io();
        const filaAtendimento = document.getElementById('filaAtendimento');
        const messagesContainer = document.getElementById('messagesContainer');
        const painelAtendimento = document.getElementById('painelAtendimento');
        const chatInput = document.getElementById('chatInput');

        // --- PERSIST√äNCIA ---
        function saveState() { localStorage.setItem('wa_app_state', JSON.stringify(AppState)); }
        function loadState() {
            const saved = localStorage.getItem('wa_app_state');
            if (saved) AppState = { ...AppState, ...JSON.parse(saved) };
        }

        // --- RENDERIZA√á√ÉO DA FILA ---
        function renderSidebar() {
            filaAtendimento.innerHTML = '';
            
            // FILTRO CRUCIAL: MOSTRA APENAS QUEM EST√Å NA FILA (visivel = true)
            // A propriedade 'visivel' vem do backend ou √© setada quando recebe msg com flag
            const chatsFiltrados = AppState.chatList.filter(c => c.visivel === true || c.pending === true);
            
            chatsFiltrados.forEach(chat => {
                const name = AppState.contactNames[chat.numero] || chat.nome || chat.numero;
                const div = document.createElement('div');
                div.className = `contact-item ${AppState.activeNumber === chat.numero ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="avatar-placeholder">${name.charAt(0).toUpperCase()}</div>
                    <div class="contact-info">
                        <div class="contact-name">${name}</div>
                        <div class="contact-last-msg">${chat.ultimaMensagem}</div>
                    </div>
                    ${chat.unreadCount > 0 ? '<div class="badge-unread">!</div>' : ''}
                `;
                if(chat.pending) div.style.borderLeft = "5px solid #ffc107";
                div.addEventListener('click', () => openChat(chat.numero));
                filaAtendimento.appendChild(div);
            });
            document.getElementById('filaHeader').textContent = `Fila de Atendimento (${chatsFiltrados.length})`;
        }

        // --- INICIALIZA√á√ÉO ---
        loadState();
        renderSidebar();
        if(AppState.activeNumber) openChat(AppState.activeNumber);
        else document.getElementById('welcomeScreen').style.display = 'flex';

        socket.on('connect', () => {
            console.log("Conectado");
            document.getElementById('statusText').textContent = "Online";
            document.getElementById('statusDot').className = "status-dot online";
            syncChats();
        });

        // --- SYNC COM SERVIDOR (MESCLAGEM) ---
        async function syncChats() {
            try {
                const r = await fetch('/api/whatsapp/chats');
                const res = await r.json();
                if(!res.success || !res.data) return;

                const listaServer = res.data; // O backend agora manda com a flag 'visivel'

                // Atualiza a lista local preservando nomes
                AppState.chatList = listaServer.map(serverChat => {
                    const num = serverChat.numero;
                    // Preserva nome se j√° tivermos um bom
                    if (!AppState.contactNames[num] && serverChat.nome && !serverChat.nome.includes('@')) {
                        AppState.contactNames[num] = serverChat.nome;
                    }
                    
                    // Verifica se estava pendente localmente
                    const localChat = AppState.chatList.find(c => c.numero === num);
                    
                    return {
                        numero: num,
                        nome: AppState.contactNames[num] || serverChat.nome,
                        ultimaMensagem: serverChat.ultimaMensagem,
                        unreadCount: serverChat.unread,
                        // A flag 'visivel' vem do backend (userContext)
                        // Se n√£o vier do backend (ex: msg nova antes do sync), mant√©m local
                        visivel: serverChat.visivel !== undefined ? serverChat.visivel : (localChat?.visivel || false),
                        pending: localChat?.pending || false
                    };
                });
                
                saveState();
                renderSidebar();
            } catch(e) { console.error(e); }
        }

        // --- SOCKET EVENTS ---
        socket.on('novaMensagemWhatsapp', (data) => {
            const { chatId, texto, fromMe, nome, mostrarNaFila } = data;
            
            // Salva msg
            if(!AppState.conversas[chatId]) AppState.conversas[chatId] = [];
            AppState.conversas[chatId].push({ fromMe, text: texto, time: new Date(), name: nome || "Eu" });

            // Salva nome
            if(nome && !fromMe) AppState.contactNames[chatId] = nome;

            // Atualiza lista
            const idx = AppState.chatList.findIndex(c => c.numero === chatId);
            if(idx > -1) AppState.chatList.splice(idx, 1);
            
            // L√≥gica de visibilidade:
            // Se veio 'mostrarNaFila' do socket, usa. Se n√£o, usa o que j√° tinha.
            // Se for msg minha (fromMe), e o chat j√° estava vis√≠vel, mant√©m vis√≠vel.
            let isVisivel = mostrarNaFila;
            if (isVisivel === undefined) { // Se o socket n√£o mandou nada sobre isso
                 // Se j√° estava na lista, mant√©m.
                 isVisivel = (AppState.chatList.find(c => c.numero === chatId)?.visivel) || false;
            }
            
            AppState.chatList.unshift({
                numero: chatId,
                nome: AppState.contactNames[chatId] || nome,
                ultimaMensagem: fromMe ? `Voc√™: ${texto}` : texto,
                unreadCount: fromMe ? 0 : 1,
                visivel: isVisivel,
                pending: isVisivel // Se apareceu na fila agora, pode marcar como pendente visualmente
            });

            saveState();
            renderSidebar();
            if(AppState.activeNumber === chatId) renderMessages(chatId);
        });

        socket.on('notificacaoChamado', (data) => {
            // For√ßa visibilidade
            const idx = AppState.chatList.findIndex(c => c.numero === data.chatId);
            if(idx > -1) AppState.chatList[idx].visivel = true;
            else AppState.chatList.unshift({ numero: data.chatId, nome: data.nome, ultimaMensagem: "üîî Chamando...", visivel: true, pending: true });
            
            saveState();
            renderSidebar();
        });

        // --- UI ACTIONS ---
        function openChat(number) {
            AppState.activeNumber = number;
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('activeChatScreen').style.display = 'flex';
            
            // Verifica se √© pendente para mostrar bot√£o assumir
            const chat = AppState.chatList.find(c => c.numero === number);
            painelAtendimento.style.display = (chat && chat.visivel) ? 'block' : 'none';
            
            renderMessages(number);
            saveState();
        }

        function renderMessages(number) {
            messagesContainer.innerHTML = '';
            const msgs = AppState.conversas[number] || [];
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.fromMe ? 'msg-out' : 'msg-in'}`;
                div.innerHTML = `<b>${m.fromMe ? 'Voc√™' : m.name}</b><br>${m.text}<br><small>${new Date(m.time).toLocaleTimeString()}</small>`;
                messagesContainer.appendChild(div);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            chatInput.disabled = false;
        }

        document.getElementById('sendButton').addEventListener('click', async () => {
            const text = chatInput.value;
            if(!text || !AppState.activeNumber) return;
            
            // Otimista
            if(!AppState.conversas[AppState.activeNumber]) AppState.conversas[AppState.activeNumber] = [];
            AppState.conversas[AppState.activeNumber].push({ fromMe: true, text, time: new Date(), name: "Eu" });
            renderMessages(AppState.activeNumber);
            chatInput.value = '';
            
            await fetch('/api/whatsapp/send', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ numero: AppState.activeNumber, mensagem: text, nomeAgenteTemporario: "Agente" })
            });
        });
        
        document.getElementById('btnAssumirChamado').addEventListener('click', async () => {
             await fetch('/api/whatsapp/atender', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ numero: AppState.activeNumber, nomeAgente: "Agente" })
            });
            painelAtendimento.style.display = 'none';
            // Mant√©m vis√≠vel na lista pois agora √© atendimento humano
        });
    });
    </script>
</body>
</html>