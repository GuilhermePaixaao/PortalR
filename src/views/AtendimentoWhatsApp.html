<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>

    <script>
        // --- PROTETOR DE P√ÅGINA ---
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) {
            window.location.replace("Login.html"); 
            throw new Error("Usu√°rio n√£o autenticado.");
        }
        try {
            const userData = JSON.parse(userDataString);
            const userId = userData?.data?.id || userData?.id; 
            if (!userId) {
                throw new Error("Dados de usu√°rio inv√°lidos (ID n√£o encontrado).");
            }
            const userPerfil = userData?.data?.perfil || userData?.perfil;
            if (userPerfil === 'REQUISITANTE') {
                 window.location.replace("Chamado.html"); 
                 throw new Error("Acesso negado.");
            }
        } catch (error) {
            console.error("Sess√£o inv√°lida:", error.message);
            if (error.message !== "Acesso negado.") {
                localStorage.removeItem("userData"); 
                window.location.replace("Login.html"); 
                throw new Error("Sess√£o inv√°lida.");
            }
        }
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    
    <link rel="stylesheet" href="css/whatsapp-style.css"> 
    <style>
        /* --- ESTILOS GERAIS (Layout) --- */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .logo-icon { height: 30px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-logout:hover { background-color: #bb2d3b; }
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
        .btn-theme-toggle { background: none; border: 1px solid #ced4da; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; color: #495057; display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-theme-toggle:hover { background-color: #f1f3f5; }

        /* --- CSS Espec√≠fico desta p√°gina --- */
        .main-content { padding: 0; display: flex; flex-direction: column; height: calc(100vh - 60px); }
        .main-content h1 { padding: 1rem 2rem; margin: 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        
        #btnConectarWhats { background-color: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 0.9rem; }
        #btnConectarWhats:hover { background-color: #218838; }
        #statusConexao { font-size: 0.9rem; font-weight: bold; }
        #statusConexao.connected { color: #198754; }
        #statusConexao.disconnected { color: #dc3545; }

        .chat-container-flex { display: flex; height: 100%; flex-grow: 1; overflow: hidden; }

        /* Coluna da Fila (Esquerda) */
        .chat-list-column { flex: 0 0 300px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background-color: #fcfcfc; }
        .chat-list-column h3 { font-size: 1.1rem; font-weight: 600; padding: 1rem; margin: 0; border-bottom: 1px solid var(--border-color); }
        #filaAtendimento { flex-grow: 1; overflow-y: auto; }
        .fila-item { padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; position: relative; }
        .fila-item:hover { background-color: #f0f0f0; }
        .fila-item.active { background-color: #e6e6e6; color: inherit; }
        .fila-item .nome { font-weight: bold; display: block; }
        .fila-item .numero { font-size: 0.9rem; color: #555; }
        .fila-item.active .numero { color: #333; }
        .fila-item .badge-nao-lido { background-color: #dc3545; color: white; font-size: 0.75rem; font-weight: bold; padding: 3px 8px; border-radius: 10px; position: absolute; top: 10px; right: 10px; display: none; }
        .fila-item.unread .badge-nao-lido { display: block; }

        /* Coluna do Chat (Direita) */
        .chat-widget-column { flex: 1; display: flex; flex-direction: column; }
        .chat-widget-column .chat-widget { height: 100%; border-radius: 0; box-shadow: none; border: none; }
        
        /* Mensagem do sistema (Carregando, Erro, etc.) */
        .system-message { font-size: 0.9rem; font-style: italic; text-align: center; color: #6c757d; margin: 10px 0; }

        #qrCodeContainer { padding: 20px; text-align: center; }
        #qrCodeContainer img { width: 300px; height: 300px; border: 5px solid var(--primary-blue); border-radius: 8px; }

        /* --- CSS MODO ESCURO --- */
        body.dark-mode .main-content { background-color: #181818; border-color: #383838; }
        body.dark-mode .main-content h1 { border-color: #383838; }
        body.dark-mode .chat-list-column { background-color: #2a2a2a; border-color: #383838; }
        body.dark-mode .fila-item { border-color: #383838; }
        body.dark-mode .fila-item:hover { background-color: #333; }
        body.dark-mode .fila-item.active { background-color: #444; }
        body.dark-mode .fila-item .numero { color: #aaa; }
        body.dark-mode .fila-item.active .numero { color: #ccc; }
        body.dark-mode .chat-widget-column .chat-widget { background-color: #2a2a2a; }
        
        /* Fundo modo escuro */
        body.dark-mode .chat-history {
            background-color: #0d1418; /* Cor escura do WhatsApp */
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            opacity: 0.6;
        }
        
        /* Bal√µes modo escuro */
        body.dark-mode .message-bubble {
            color: #e0e0e0;
        }
        body.dark-mode .chat-message.message-bot .message-bubble {
            background-color: #262d31; /* Cinza escuro */
        }
        body.dark-mode .chat-message.message-user .message-bubble {
            background-color: #005c4b; /* Verde escuro */
        }
        body.dark-mode .message-sender-name {
            color: #339d6f;
        }
        body.dark-mode .message-bubble .timestamp {
            color: #a1a1a1;
        }

        /* Input modo escuro */
        body.dark-mode .chat-input-area { background-color: #202c33; border-color: #383838; }
        body.dark-mode .chat-input-area input[type="text"] {
            background-color: #2a3942;
            border-color: #2a3942;
            color: #e0e0e0;
        }
        body.dark-mode .chat-input-area .send-btn {
            background-color: #008069;
        }

    </style>
</head>

<body>
    <div class="dashboard-container">
        
        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado"><a href="GerenciarChamados.html" title="Gerenciar Chamados"><span class="icon">‚úîÔ∏è</span><span class="text">Gerenciar Chamados</span></a></li>
                    <li><a href="Chatbot.html" title="Chatbot"><span class="icon">ü§ñ</span><span class="text">Chatbot</span></a></li>
                    <li class="active"><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
                    <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <h1>
                <span>Atendimento WhatsApp</span>
                <div>
                    <span id="statusConexao" class="disconnected">Desconectado</span>
                    <button id="btnConectarWhats">Conectar</button>
                </div>
            </h1>
            
            <div class="chat-container-flex">
                
                <div class="chat-list-column">
                    <h3>Fila de Atendimento</h3>
                    <div id="filaAtendimento">
                        </div>
                </div>
                
                <div class="chat-widget-column">
                    <div class="chat-widget widget">
                        
                        <div id="qrCodeContainer">
                            <p class="system-message">Clique em "Conectar" para gerar o QR Code.</p>
                        </div>
                        
                        <div class="chat-history" id="chatHistory">
                            </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            </div>
                        
                        <div class="chat-input-area">
                            <input type="text" id="chatInput" class="form-control" placeholder="Digite sua resposta...">
                            <button id="sendButton" class="send-btn" title="Enviar">
                                <span class="icon">‚û§</span>
                            </button>
                        </div>
                        
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- FUN√á√ïES DE LOGOUT, TEMA E AUTH (MANTIDAS) ---
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        const btnThemeToggle = document.getElementById("themeToggle");
        function toggleTheme() { document.body.classList.toggle("dark-mode"); let d = document.body.classList.contains("dark-mode"); localStorage.setItem("theme", d ? "dark" : "light"); if (btnThemeToggle) btnThemeToggle.textContent = d ? "‚òÄÔ∏è" : "üåô"; }
        function loadTheme() { const t = localStorage.getItem("theme"); if (t === "dark") { document.body.classList.add("dark-mode"); if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è"; } else { document.body.classList.remove("dark-mode"); if (btnThemeToggle) btnThemeToggle.textContent = "üåô"; } }
        if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
        loadTheme();
        let nomeAtendente = "Atendente"; 
        try { 
            const u = JSON.parse(userDataString); 
            const d = document.getElementById('userNameDisplay'); 
            if (d && u?.data?.nomeFuncionario) { 
                const primeiroNome = u.data.nomeFuncionario.split(' ')[0];
                d.textContent = `Ol√°, ${primeiroNome}`; 
                nomeAtendente = primeiroNome; 
            } 
            const p = u?.data?.perfil; const l = document.getElementById("menu-link-chamado"); if (l && (p === 'AGENTE' || p === 'ADMIN')) { const a = l.querySelector('a'); const t = a.querySelector('.text'); a.href = "GerenciarChamados.html"; a.title = "Gerenciar Chamados"; a.querySelector('.icon').textContent = "‚úîÔ∏è"; t.innerHTML = "Gerenciar<br>Chamados"; } 
        } catch (e) { console.error('Erro:', e); fazerLogout(); }
        const btnLogout = document.getElementById("logoutButton");
        if (btnLogout) btnLogout.addEventListener('click', fazerLogout);
        
        // --- L√ìGICA DO CHAT WHATSAPP ---
        
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const filaAtendimento = document.getElementById('filaAtendimento');
        const btnConectarWhats = document.getElementById('btnConectarWhats');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const statusConexao = document.getElementById('statusConexao');
        
        let conversaAtiva = null; 
        let conversas = {}; 
        let nomesClientes = {}; 

        // --- CONEX√ÉO SOCKET.IO ---
        const socket = io("https://portal.smrosalina.com.br", { 
            transports: ['polling'] 
        });

        socket.on('connect', () => {
            console.log('Socket CONECTADO com sucesso! ID:', socket.id);
            statusConexao.textContent = "Sistema Online"; // Feedback que o socket est√° ok
            statusConexao.className = "connected";
        });

        socket.on('connect_error', (err) => console.error('Socket FALHOU:', err.message));

        // --- FUN√á√ÉO PARA EXIBIR O QR CODE ---
        function mostrarQRCode(base64) {
            if (!base64) return;
            console.log("Exibindo QR Code na tela!");
            qrCodeContainer.innerHTML = `<img src="${base64}" alt="Escaneie o QR Code">`;
            statusConexao.textContent = "Escaneie o QR Code";
            statusConexao.className = "disconnected";
            qrCodeContainer.style.display = 'block';
            chatHistory.style.display = 'none';
        }

        // --- EVENTOS DO SOCKET (Backup) ---
        socket.on('qrCodeRecebido', (data) => {
            console.log("Socket: QR Code recebido via evento!"); 
            mostrarQRCode(data.qr);
        });
        
        socket.on('statusConexao', (data) => {
            if (data.status === 'open') {
                statusConexao.textContent = "WhatsApp Conectado";
                statusConexao.className = "connected";
                qrCodeContainer.innerHTML = '<p class="system-message">WhatsApp Conectado!</p>';
                chatInput.disabled = false;
                setTimeout(() => {
                    if (!conversaAtiva) {
                        qrCodeContainer.style.display = 'none';
                        chatHistory.style.display = 'flex';
                        chatHistory.innerHTML = '<p class="system-message">Selecione uma conversa.</p>';
                    }
                }, 1500);
            } else if (data.status === 'connecting') {
                statusConexao.textContent = "Conectando...";
            } else {
                statusConexao.textContent = "WhatsApp Desconectado";
                statusConexao.className = "disconnected";
            }
        });

        // --- EVENTOS DE MENSAGEM ---
        function criarHtmlMensagem(message, sender, nome, dateObj) {
            const msgWrap = document.createElement('div');
            msgWrap.classList.add('chat-message');
            const time = dateObj ? new Date(dateObj) : new Date();
            
            const msgBubble = document.createElement('div');
            msgBubble.classList.add('message-bubble');

            if (sender === 'bot') {
                msgWrap.classList.add('message-bot');
                if (nome) {
                    const nomeEl = document.createElement('span');
                    nomeEl.className = 'message-sender-name';
                    nomeEl.textContent = nome;
                    msgBubble.appendChild(nomeEl);
                }
            } else {
                msgWrap.classList.add('message-user');
            }

            const p = document.createElement('p');
            p.textContent = message;
            msgBubble.appendChild(p);

            const timeEl = document.createElement('span');
            timeEl.className = 'timestamp';
            timeEl.textContent = time.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            msgBubble.appendChild(timeEl);

            msgWrap.appendChild(msgBubble);
            return msgWrap;
        }

        socket.on('novaMensagemWhatsapp', (data) => {
            const msgData = { texto: data.texto, sender: 'bot', nome: data.nome, time: new Date() };
            if (!conversas[data.de]) conversas[data.de] = [];
            if (data.nome) nomesClientes[data.de] = data.nome;
            conversas[data.de].push(msgData);
            atualizarFila(data.de, data.nome || nomesClientes[data.de] || data.de.split('@')[0], true); 
            if (data.de === conversaAtiva) {
                chatHistory.appendChild(criarHtmlMensagem(msgData.texto, msgData.sender, msgData.nome, msgData.time));
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });

        // --- CONECTAR (COM TRUQUE DE EXIBI√á√ÉO IMEDIATA) ---
        async function conectarWhatsApp() {
            qrCodeContainer.innerHTML = '<p class="system-message">Gerando QR Code...</p>';
            qrCodeContainer.style.display = 'block';
            chatHistory.style.display = 'none';
            
            try {
                const response = await fetch('/api/whatsapp/connect'); 
                const dados = await response.json();

                if (!response.ok) throw new Error(dados.message || "Erro ao conectar");

                // *** O TRUQUE EST√Å AQUI ***
                // A Evolution devolve o QR Code no JSON da resposta tamb√©m!
                // Vamos peg√°-lo e mostrar NA HORA, sem esperar o socket.
                const qrCodeDaResposta = dados.data?.qrcode?.base64 || dados.data?.base64;
                
                if (qrCodeDaResposta) {
                    mostrarQRCode(qrCodeDaResposta);
                } else {
                    console.log("QR Code n√£o veio na resposta imediata, aguardando socket...");
                }
                
            } catch (error) {
                qrCodeContainer.innerHTML = `<p class="system-message" style="color:red;">Erro: ${error.message}</p>`;
            }
        }
        
        btnConectarWhats.addEventListener('click', conectarWhatsApp);

        // --- OUTRAS FUN√á√ïES (FILA, ENVIAR) ---
        function atualizarFila(numero, nome, marcarNaoLida = false) {
            let item = document.querySelector(`.fila-item[data-numero="${numero}"]`);
            if (!item) {
                item = document.createElement('div');
                item.className = 'fila-item';
                item.dataset.numero = numero;
                
                item.innerHTML = `
                    <span class="close-chat-btn" title="Fechar">&times;</span>
                    <span class="badge-nao-lido">!</span>
                    <span class="nome">${nome}</span>
                    <span class="numero">${numero.split('@')[0]}</span>
                `;
                
                item.querySelector('.close-chat-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    encerrarConversa(numero);
                });
                
                item.addEventListener('click', () => selecionarConversa(numero));
                filaAtendimento.prepend(item);
            }
            if (marcarNaoLida && conversaAtiva !== numero) item.classList.add('unread');
        }

        function encerrarConversa(numero) {
            const item = document.querySelector(`.fila-item[data-numero="${numero}"]`);
            if (item) filaAtendimento.removeChild(item);
            delete conversas[numero];
            if (conversaAtiva === numero) {
                conversaAtiva = null;
                chatHistory.innerHTML = '<p class="system-message">Atendimento encerrado.</p>';
                qrCodeContainer.style.display = 'none';
            }
        }
        
        function selecionarConversa(numero) {
            if (conversaAtiva === numero) return;
            conversaAtiva = numero;
            document.querySelectorAll('.fila-item').forEach(i => {
                i.classList.toggle('active', i.dataset.numero === numero);
                if (i.dataset.numero === numero) i.classList.remove('unread');
            });
            qrCodeContainer.style.display = 'none';
            chatHistory.style.display = 'flex';
            chatHistory.innerHTML = "";
            (conversas[numero] || []).forEach(msg => {
                chatHistory.appendChild(criarHtmlMensagem(msg.texto, msg.sender, msg.nome, msg.time));
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
            chatInput.focus();
        }

        async function handleSendMessage() {
            const msg = chatInput.value.trim();
            if (!msg || !conversaAtiva) return;
            
            const msgData = { texto: msg, sender: 'user', nome: null, time: new Date() };
            chatHistory.appendChild(criarHtmlMensagem(msgData.texto, msgData.sender, msgData.nome, msgData.time));
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            if (!conversas[conversaAtiva]) conversas[conversaAtiva] = [];
            conversas[conversaAtiva].push(msgData);
            
            chatInput.value = '';
            try {
                await fetch('/api/whatsapp/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero: conversaAtiva, mensagem: msg })
                });
            } catch (e) { console.error(e); }
        }

        sendButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSendMessage(); }
        });
        
        chatInput.disabled = true; 
        chatHistory.style.display = 'none';
    });
</script>
</body>
</html>