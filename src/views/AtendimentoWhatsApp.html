<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atendimento WhatsApp - Portal</title>
    <script>
        const userDataString = localStorage.getItem("userData");
        if (!userDataString) window.location.replace("Login.html");
        try {
            const userData = JSON.parse(userDataString);
            if (userData?.data?.perfil === 'REQUISITANTE') window.location.replace("Chamado.html");
        } catch (e) { localStorage.removeItem("userData"); window.location.replace("Login.html"); }
    </script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/whatsapp-style.css"> 
    <style>
        :root {
            --wa-bg-color: #efeae2; --wa-header-bg: #f0f2f5; --wa-sidebar-bg: #ffffff;
            --wa-border: #e9edef; --wa-msg-in: #ffffff; --wa-msg-out: #d9fdd3;
            --wa-primary: #00a884; --text-primary: #111b21; --text-secondary: #667781;
            --input-bg: #ffffff; --hover-bg: #f5f6f6; --active-bg: #f0f2f5;
        }
        body.dark-mode {
            --wa-bg-color: #0b141a; --wa-header-bg: #202c33; --wa-sidebar-bg: #111b21;
            --wa-border: #2f3b43; --wa-msg-in: #202c33; --wa-msg-out: #005c4b;
            --wa-primary: #00a884; --text-primary: #e9edef; --text-secondary: #8696a0;
            --input-bg: #2a3942; --hover-bg: #202c33; --active-bg: #2a3942;
        }
        body.dark-mode .main-content { background-color: var(--wa-sidebar-bg); }
        body.dark-mode .header { background-color: var(--wa-header-bg); border-bottom-color: var(--wa-border); }
        body.dark-mode .logo, body.dark-mode #userNameDisplay { color: #e9edef; }
        
        .main-content { padding: 0; height: calc(100vh - 60px); background-color: var(--wa-sidebar-bg); display: flex; overflow: hidden; }
        .sidebar-chat { width: 350px; background-color: var(--wa-sidebar-bg); border-right: 1px solid var(--wa-border); display: flex; flex-direction: column; }
        
        .sidebar-header { 
            padding: 10px 16px; 
            background-color: var(--wa-header-bg); 
            border-bottom: 1px solid var(--wa-border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 60px; 
            gap: 10px; 
        }
        .connection-status { flex-shrink: 0; } 
        #connectionActions { display: flex; gap: 5px; } 

        #filaHeader { 
            font-size: 0.9rem; 
            font-weight: bold; 
            color: var(--wa-primary); 
            padding: 10px 15px; 
            border-bottom: 1px solid var(--wa-border); 
            background: var(--wa-sidebar-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-mini-history {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }
        .btn-mini-history:hover { color: var(--wa-primary); }

        #filaAtendimento { flex: 1; overflow-y: auto; }
        .loading-fila { padding: 20px; text-align: center; color: var(--text-secondary); font-style: italic; }

        .contact-item { display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--wa-border); position: relative; }
        .contact-item:hover { background-color: var(--hover-bg); }
        .contact-item.active { background-color: var(--active-bg); }
        .avatar-placeholder { width: 45px; height: 45px; background-color: #667781; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #fff; margin-right: 15px; }
        .contact-info { flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .contact-name { font-size: 1rem; color: var(--text-primary); font-weight: 500; }
        .contact-last-msg { font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge-unread { background-color: #25d366; color: white; font-size: 0.75rem; font-weight: bold; min-width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }

        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--wa-bg-color); position: relative; z-index: 0; }
        .chat-area::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); opacity: 0.4; z-index: -1; pointer-events: none; }
        body.dark-mode .chat-area::before { opacity: 0.08; }

        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--wa-header-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; text-align: center; border-bottom: 6px solid var(--wa-primary); }
        .overlay-screen img { width: 280px; height: 280px; border: 8px solid #fff; border-radius: 8px; }
        .overlay-screen h2 { margin-top: 30px; color: var(--text-primary); font-weight: 300; font-size: 2rem; }
        .overlay-screen p { margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem; max-width: 500px; }

        .messages-container { flex: 1; padding: 20px 60px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 7.5px; margin-bottom: 8px; position: relative; font-size: 0.9rem; line-height: 1.4; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word; color: var(--text-primary); }
        .msg-in { align-self: flex-start; background-color: var(--wa-msg-in); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background-color: var(--wa-msg-out); border-top-right-radius: 0; }
        .msg-time { font-size: 0.7rem; color: var(--text-secondary); float: right; margin-top: 5px; margin-left: 10px; }

        .input-area { height: 60px; background-color: var(--wa-header-bg); padding: 10px 16px; display: flex; align-items: center; gap: 15px; z-index: 20; border-top: 1px solid var(--wa-border); }
        .input-field { flex: 1; background-color: var(--input-bg); color: var(--text-primary); border: none; border-radius: 8px; padding: 12px 15px; font-size: 0.95rem; outline: none; }
        .btn-send { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .btn-send:hover { color: var(--wa-primary); }
        
        /* NOVO: Bot√£o de Anexo */
        .btn-attach { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; transform: rotate(45deg); display:flex; align-items:center; justify-content:center; }
        .btn-attach:hover { color: var(--wa-primary); }
        
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .logo-icon { height: 30px; width: auto; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-logout:hover { background-color: #bb2d3b; }
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
        .btn-theme-toggle { background: none; border: 1px solid #ced4da; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer; color: #495057; display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-theme-toggle:hover { background-color: #f1f3f5; }
        body.dark-mode .btn-theme-toggle { border-color: #555; color: #e9edef; }
        body.dark-mode .btn-theme-toggle:hover { background-color: #2a3942; }

        .connection-status { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; }
        .status-dot.online { background-color: var(--wa-primary); }
        .status-dot.offline { background-color: #ea0038; }
        .btn-conectar { background-color: var(--wa-primary); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }
        
        .btn-desconectar { background-color: #ffc107; color: #333; border: none; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; }
        .btn-desconectar:hover { background-color: #e0a800; }
        
        .chat-header {
            padding: 8px 16px; 
            background-color: var(--wa-header-bg); 
            border-bottom: 1px solid var(--wa-border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            height: 65px;
        }

        .header-user-info { display: flex; flex-direction: column; }
        #chatTitle { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .chat-actions-toolbar { display: flex; gap: 10px; }

        .action-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ccc; background-color: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: all 0.2s ease; color: #555; }
        .action-btn:hover { transform: scale(1.1); background-color: rgba(0,0,0,0.05); }

        .btn-associar { border-color: #6f42c1; color: #6f42c1; }
        .btn-associar:hover { background-color: #f3e5f5; }
        .btn-criar { border-color: #20c997; color: #20c997; }
        .btn-criar:hover { background-color: #e6fffa; }
        .btn-assumir { border-color: #ffc107; color: #ffc107; }
        .btn-assumir:hover { background-color: #fff3cd; }
        .btn-transfer { border-color: #0d6efd; color: #0d6efd; }
        .btn-close { border-color: #dc3545; color: #dc3545; }
        .btn-close:hover { background-color: #f8d7da; }

        .action-btn:disabled, .action-btn.disabled { opacity: 0.3; cursor: not-allowed; transform: none !important; filter: grayscale(100%); border-color: #ccc !important; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 8px; width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--text-primary); margin-bottom: 5px; }
        .modal-form-group { margin-bottom: 10px; text-align: left; }
        .modal-label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-primary); font-size: 0.9rem; }
        .modal-input, .modal-select, .modal-textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: var(--input-bg); color: var(--text-primary); font-size: 0.95rem; box-sizing: border-box; }
        .modal-textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn-cancelar { background: #ccc; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .btn-confirmar-transfer { background: #0d6efd; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .btn-confirmar-transfer:hover { background: #0b5ed7; }
        
        body.dark-mode .modal-content { background-color: var(--wa-sidebar-bg); border: 1px solid var(--wa-border); }
        body.dark-mode .btn-cancelar { background: #444; color: #fff; }

        /* --- HIST√ìRICO GLOBAL --- */
        .modal-history-layout { display: flex; flex-direction: column; height: 500px; overflow: hidden; }
        .history-search-bar { padding: 10px; border-bottom: 1px solid #ddd; display: flex; gap: 10px; }
        .history-list-view { flex: 1; overflow-y: auto; }
        .history-msg-view { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { background-color: #f5f5f5; }
        body.dark-mode .history-item:hover { background-color: #2a3942; }
        .history-item-name { font-weight: bold; font-size: 0.95rem; color: var(--text-primary); }
        .history-item-sub { font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .btn-back-history { background: none; border: none; color: #0d6efd; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        
        .hist-msg { padding: 8px 12px; border-radius: 7.5px; font-size: 0.9rem; max-width: 80%; word-wrap: break-word; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); margin-bottom: 5px; }
        .hist-in { align-self: flex-start; background-color: var(--wa-msg-in); border-top-left-radius: 0; color: var(--text-primary); }
        .hist-out { align-self: flex-end; background-color: var(--wa-msg-out); border-top-right-radius: 0; color: var(--text-primary); }
        .hist-time { font-size: 0.7rem; color: var(--text-secondary); display: block; text-align: right; margin-top: 3px; }

        /* --- PREVIEW DE M√çDIA (CSS NOVO) --- */
        #previewContainer { text-align: center; margin-bottom: 15px; background: #f0f2f5; padding: 10px; border-radius: 8px; }
        #previewImage { max-width: 100%; max-height: 200px; border-radius: 5px; display: none; margin: 0 auto; }
        #previewFileIcon { font-size: 3rem; color: #555; display: none; margin-bottom: 5px; }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
                    <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
                    <li id="menu-link-chamado"><a href="GerenciarChamados.html" title="Gerenciar Chamados"><span class="icon">‚úîÔ∏è</span><span class="text">Gerenciar Chamados</span></a></li>
                    <li class="active"><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
                    <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
                    <li><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
                    <li><a href="GerenciarLojas.html"><span class="icon">üè¢</span> Lojas e Deptos</a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="sidebar-chat">
                <div class="sidebar-header">
                    <div class="connection-status">
                        <div id="statusDot" class="status-dot offline"></div>
                        <span id="statusText">Desconectado</span>
                    </div>
                    <div id="connectionActions">
                        <button id="btnConectarWhats" class="btn-conectar">CONECTAR</button>
                        <button id="btnDesconectarWhats" class="btn-desconectar" style="display: none;">DESCONECTAR</button>
                    </div>
                </div>
                
                <div id="filaHeader">
                    <span>Fila de Atendimento</span>
                    <button id="btnGlobalHistory" class="btn-mini-history" title="Ver Hist√≥rico de Todas as Conversas">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
                
                <div id="filaAtendimento">
                    <div class="loading-fila" id="loadingFila" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> Carregando conversas...
                    </div>
                </div>
            </div>

            <div class="chat-area">
                <div id="qrCodeScreen" class="overlay-screen" style="display:none;">
                    <div id="qrCodeContainer"></div>
                    <h2>Conectar WhatsApp</h2>
                    <p>Abra o WhatsApp no seu celular e escaneie.</p>
                </div>

                <div id="welcomeScreen" class="overlay-screen">
                    <img src="https://img.freepik.com/vetores-gratis/ilustracao-do-conceito-de-chat-bot_114360-5522.jpg" alt="Conectado" style="border:none; box-shadow:none; width: 300px; background:transparent;">
                    <h2>Portal Conectado</h2>
                    <p>Selecione uma conversa ao lado para come√ßar.</p>
                </div>

                <div id="activeChatScreen" style="display:none; width:100%; height:100%; flex-direction:column;">
                    
                    <div class="chat-header">
                        <div class="header-user-info">
                            <span id="chatTitle">Nome do Cliente</span>
                            <small id="chatStatusText" style="display:block; font-size:0.75rem; color:#666;">Carregando...</small>
                        </div>
                        
                        <div class="chat-actions-toolbar">
                            <button id="btnAssociarTicket" class="action-btn btn-associar" title="Associar a Ticket Existente">
                                <i class="fas fa-link"></i>
                            </button>

                            <button id="btnCriarChamado" class="action-btn btn-criar" title="Criar Chamado do Chat">
                                <i class="fas fa-plus"></i>
                            </button>

                            <button id="btnAssumir" class="action-btn btn-assumir" title="Assumir Atendimento">
                                <i class="fas fa-user-plus"></i>
                            </button>

                            <button id="btnTransferir" class="action-btn btn-transfer" title="Transferir">
                                <i class="fas fa-share-square"></i>
                            </button>

                            <button id="btnFinalizar" class="action-btn btn-close" title="Encerrar Atendimento">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer"></div>
                    
                    <div class="input-area">
                        <input type="file" id="inputArquivo" style="display:none;" />
                        <button id="btnAnexo" class="btn-attach" title="Anexar Arquivo">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <input type="text" id="chatInput" class="input-field" placeholder="Digite uma mensagem" disabled>
                        <button id="sendButton" class="btn-send"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalTransferencia" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">üîÑ Transferir Atendimento</div>
            <p style="color:var(--text-secondary); font-size:0.9rem;">Selecione o agente para transferir:</p>
            
            <select id="selectAgentes" class="modal-select">
                <option value="">Carregando agentes...</option>
            </select>

            <div class="modal-actions">
                <button id="btnCancelarTransfer" class="btn-cancelar">Cancelar</button>
                <button id="btnConfirmarTransfer" class="btn-confirmar-transfer">Transferir</button>
            </div>
        </div>
    </div>

    <div id="modalAssociarTicket" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">üîó Associar Ticket</div>
            <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:10px;">Vincule este chat a um chamado existente.</p>
            
            <div class="modal-form-group">
                <label class="modal-label">ID do Chamado</label>
                <input type="number" id="inputTicketId" class="modal-input" placeholder="Ex: 123">
            </div>
            
            <div id="associarResult" style="margin-bottom:10px; font-size:0.85rem; min-height: 20px;"></div>

            <div class="modal-actions">
                <button id="btnCancelarAssociar" class="btn-cancelar">Cancelar</button>
                <button id="btnConfirmarAssociar" class="btn-confirmar-transfer">Verificar & Associar</button>
            </div>
        </div>
    </div>

    <div id="modalCriarChamado" class="modal-overlay">
        <div class="modal-content" style="width: 450px;">
            <div class="modal-title">üìù Novo Chamado (WhatsApp)</div>
            
            <div class="modal-form-group">
                <label class="modal-label">Loja</label>
                <select id="selectLoja" class="modal-select">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <div class="modal-form-group">
                <label class="modal-label">Departamento</label>
                <select id="selectDepartamento" class="modal-select" disabled>
                    <option value="">Selecione a Loja primeiro</option>
                </select>
            </div>
            <div class="modal-form-group">
                <label class="modal-label">Assunto</label>
                <input type="text" id="inputAssunto" class="modal-input" placeholder="Resumo do problema">
            </div>

            <div class="modal-form-group">
                <label class="modal-label">Categoria</label>
                <div id="containerCascataCategorias">
                    <span style="font-size:0.9rem; color: #666;">Carregando...</span>
                </div>
            </div>

            <div class="modal-form-group">
                <label class="modal-label">Prioridade</label>
                <select id="selectPrioridade" class="modal-select">
                    <option value="Baixa">Baixa</option>
                    <option value="M√©dia" selected>M√©dia</option>
                    <option value="Alta">Alta</option>
                    <option value="Cr√≠tica">Cr√≠tica</option>
                </select>
            </div>

            <div class="modal-form-group">
                <label class="modal-label">Descri√ß√£o</label>
                <textarea id="inputDescricao" class="modal-textarea" placeholder="Detalhes do chamado..."></textarea>
            </div>

            <div class="modal-actions">
                <button id="btnCancelarCriar" class="btn-cancelar">Cancelar</button>
                <button id="btnSalvarChamado" class="btn-confirmar-transfer">Criar Chamado</button>
            </div>
        </div>
    </div>

    <div id="modalHistorico" class="modal-overlay">
        <div class="modal-content" style="width: 600px; max-width: 95%; padding: 0;">
            <div style="padding: 15px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div class="modal-title" style="margin:0;">üìú Hist√≥rico Global</div>
                <button id="btnFecharHistorico" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-history-layout">
                
                <div id="viewHistoryList" style="display: flex; flex-direction: column; height: 100%;">
                    <div class="history-search-bar">
                        <input type="text" id="inputSearchHistory" class="modal-input" placeholder="Buscar por nome ou telefone..." style="margin:0;">
                    </div>
                    <div id="historyListContainer" class="history-list-view">
                        <div style="text-align:center; padding:20px; color:#666;">Carregando conversas...</div>
                    </div>
                </div>

                <div id="viewHistoryMessages" class="history-msg-view">
                    <div style="padding: 10px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; align-items: center;">
                        <button id="btnVoltarListaHistory" class="btn-back-history">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                        <span id="historyChatTitle" style="margin-left: 15px; font-weight: bold; color: #333;">Nome do Cliente</span>
                    </div>
                    <div id="historyMsgsContainer" style="flex:1; overflow-y: auto; padding: 15px; background-color: var(--wa-bg-color); display:flex; flex-direction:column; gap:8px;">
                        </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modalPreview" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">üìé Enviar Arquivo</div>
            <div id="previewContainer">
                <i id="previewFileIcon" class="fas fa-file-alt"></i>
                <img id="previewImage" src="" alt="Preview">
                <p id="previewFileName" style="font-size: 0.9rem; color: #666; margin-top:5px; word-break: break-all;"></p>
            </div>
            
            <div class="modal-form-group">
                <label class="modal-label">Legenda (Opcional)</label>
                <input type="text" id="inputLegendaArquivo" class="modal-input" placeholder="Adicione uma legenda...">
            </div>

            <div class="modal-actions">
                <button id="btnCancelarEnvioMidia" class="btn-cancelar">Cancelar</button>
                <button id="btnConfirmarEnvioMidia" class="btn-confirmar-transfer">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
        document.getElementById("logoutButton").addEventListener('click', fazerLogout);

        const btnThemeToggle = document.getElementById("themeToggle");
        function toggleTheme() { document.body.classList.toggle("dark-mode"); let d = document.body.classList.contains("dark-mode"); localStorage.setItem("theme", d ? "dark" : "light"); btnThemeToggle.textContent = d ? "‚òÄÔ∏è" : "üåô"; }
        function loadTheme() { const t = localStorage.getItem("theme"); if (t === "dark") { document.body.classList.add("dark-mode"); btnThemeToggle.textContent = "‚òÄÔ∏è"; } else { document.body.classList.remove("dark-mode"); btnThemeToggle.textContent = "üåô"; } }
        btnThemeToggle.addEventListener('click', toggleTheme);
        loadTheme();
        
        try { 
            const u = JSON.parse(localStorage.getItem("userData")); 
            const d = document.getElementById('userNameDisplay'); 
            if (d && u?.data?.nomeFuncionario) d.textContent = `Ol√°, ${u.data.nomeFuncionario.split(' ')[0]}`; 
            if (u?.data?.perfil === 'AGENTE' || u?.data?.perfil === 'ADMIN') { 
                const l = document.getElementById("menu-link-chamado"); 
                if(l) { l.querySelector('a').href = "GerenciarChamados.html"; l.querySelector('.text').innerHTML = "Gerenciar<br>Chamados"; }
            } 
        } catch (e) {}

        const qrScreen = document.getElementById('qrCodeScreen');
        const qrContainer = document.getElementById('qrCodeContainer');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const activeChatScreen = document.getElementById('activeChatScreen');
        const messagesContainer = document.getElementById('messagesContainer');
        const filaAtendimento = document.getElementById('filaAtendimento');
        const loadingFila = document.getElementById('loadingFila');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConectar = document.getElementById('btnConectarWhats');
        const btnDesconectarWhats = document.getElementById('btnDesconectarWhats');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const filaHeader = document.getElementById('filaHeader');
        const chatTitle = document.getElementById('chatTitle'); 
        
        // Refer√™ncias aos bot√µes da Toolbar
        const btnAssumir = document.getElementById('btnAssumir');
        const btnFinalizar = document.getElementById('btnFinalizar');
        const btnTransferir = document.getElementById('btnTransferir');
        const btnAssociarTicket = document.getElementById('btnAssociarTicket'); 
        const btnCriarChamado = document.getElementById('btnCriarChamado'); 

        // Refer√™ncias ao Modal de Transfer√™ncia
        const modalTransfer = document.getElementById('modalTransferencia');
        const selectAgentes = document.getElementById('selectAgentes');
        const btnCancelarTransfer = document.getElementById('btnCancelarTransfer');
        const btnConfirmarTransfer = document.getElementById('btnConfirmarTransfer');

        // Refer√™ncias ao Modal Associar
        const modalAssociar = document.getElementById('modalAssociarTicket');
        const inputTicketId = document.getElementById('inputTicketId');
        const btnCancelarAssociar = document.getElementById('btnCancelarAssociar');
        const btnConfirmarAssociar = document.getElementById('btnConfirmarAssociar');
        const associarResult = document.getElementById('associarResult');

        // Refer√™ncias ao Modal Criar Chamado
        const modalCriar = document.getElementById('modalCriarChamado');
        const inputAssunto = document.getElementById('inputAssunto');
        const containerCascata = document.getElementById('containerCascataCategorias');
        const selectPrioridade = document.getElementById('selectPrioridade');
        const inputDescricao = document.getElementById('inputDescricao');
        const btnCancelarCriar = document.getElementById('btnCancelarCriar');
        const btnSalvarChamado = document.getElementById('btnSalvarChamado');
        const selectLoja = document.getElementById('selectLoja'); // NOVO
        const selectDepartamento = document.getElementById('selectDepartamento'); // NOVO
        
        // --- NOVAS REFER√äNCIAS AO HIST√ìRICO GLOBAL ---
        const btnGlobalHistory = document.getElementById('btnGlobalHistory'); 
        const modalHistorico = document.getElementById('modalHistorico');
        const btnFecharHistorico = document.getElementById('btnFecharHistorico');
        const viewHistoryList = document.getElementById('viewHistoryList');
        const viewHistoryMessages = document.getElementById('viewHistoryMessages');
        const historyListContainer = document.getElementById('historyListContainer');
        const historyMsgsContainer = document.getElementById('historyMsgsContainer');
        const btnVoltarListaHistory = document.getElementById('btnVoltarListaHistory');
        const historyChatTitle = document.getElementById('historyChatTitle');
        const inputSearchHistory = document.getElementById('inputSearchHistory');

        // --- NOVAS REFER√äNCIAS: M√çDIA ---
        const btnAnexo = document.getElementById('btnAnexo');
        const inputArquivo = document.getElementById('inputArquivo');
        const modalPreview = document.getElementById('modalPreview');
        const previewImage = document.getElementById('previewImage');
        const previewFileIcon = document.getElementById('previewFileIcon');
        const previewFileName = document.getElementById('previewFileName');
        const inputLegendaArquivo = document.getElementById('inputLegendaArquivo');
        const btnCancelarEnvioMidia = document.getElementById('btnCancelarEnvioMidia');
        const btnConfirmarEnvioMidia = document.getElementById('btnConfirmarEnvioMidia');

        // Vari√°veis tempor√°rias para arquivo
        let arquivoSelecionadoBase64 = null;
        let arquivoSelecionadoNome = "";
        let arquivoSelecionadoTipo = ""; // 'image', 'video', 'document'

        let allHistoryChats = []; 

        let allCategories = []; 
        let categoriaSelecionadaId = null;

        let AppState = {
            activeNumber: null,
            conversas: {},      
            contactNames: {},   
            chatList: []        
        };

        const socket = io();

        function saveState() {
            try { localStorage.setItem('wa_app_state', JSON.stringify(AppState)); } catch (e) { console.error(e); }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('wa_app_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    AppState = { ...AppState, ...parsed };
                }
            } catch (e) { console.warn("Erro ao carregar:", e); }
        }

        function renderSidebar() {
            filaAtendimento.innerHTML = '';
            
            const chatsFiltrados = AppState.chatList.filter(c => c.visivel === true || c.pending === true);
            
            chatsFiltrados.forEach(chat => {
                const displayName = AppState.contactNames[chat.numero] || chat.nome || chat.numero;
                createSidebarItem(chat.numero, displayName, chat.ultimaMensagem, chat.unreadCount > 0, chat.pending);
            });
            
            loadingFila.style.display = (AppState.chatList.length === 0 && !chatsFiltrados.length) ? 'block' : 'none';
        }

        function atualizarBotoesToolbar(chat) {
            const chatStatusText = document.getElementById('chatStatusText');

            btnAssumir.disabled = true;
            btnFinalizar.disabled = true;
            btnTransferir.disabled = true;
            btnAssociarTicket.disabled = true; 
            btnCriarChamado.disabled = true;   
            chatStatusText.textContent = "";

            if (!chat) return;

            const emAtendimentoHumano = chat.etapa === 'ATENDIMENTO_HUMANO';
            const temAgente = !!chat.nomeAgente;
            
            let usuarioLogado = "";
            try {
                const u = JSON.parse(localStorage.getItem("userData"));
                usuarioLogado = u?.data?.nomeFuncionario || "";
            } catch(e){}

            const souOAgente = (chat.nomeAgente === usuarioLogado);

            if (!temAgente) {
                btnAssumir.disabled = false;
                btnAssumir.title = "Assumir este chamado";
                chatStatusText.textContent = "Aguardando atendimento...";
                chatStatusText.style.color = "#ffc107"; 
            } else {
                btnAssumir.disabled = true;
                chatStatusText.textContent = `Em atendimento por: ${chat.nomeAgente}`;
                chatStatusText.style.color = "#28a745"; 
            }

            if (souOAgente || (!temAgente && emAtendimentoHumano)) {
                btnFinalizar.disabled = false;
                btnTransferir.disabled = false;
                btnAssociarTicket.disabled = false; 
                btnCriarChamado.disabled = false;   
            } 
            else if (temAgente && !souOAgente) {
                btnFinalizar.disabled = true;
                btnTransferir.disabled = true;
                btnAssociarTicket.disabled = true;
                btnCriarChamado.disabled = true;
            } 
            if (chat.etapa === 'MENU' || chat.etapa === 'INICIO') {
                 btnFinalizar.disabled = false; 
            }
        }

        function createSidebarItem(number, name, lastMsg, unread, isPending) {
            const initial = name ? name.charAt(0).toUpperCase() : '#';
            const div = document.createElement('div');
            div.className = `contact-item ${AppState.activeNumber === number ? 'active' : ''}`;
            div.dataset.number = number;
            
            if (isPending) {
                div.style.borderLeft = "5px solid #ffc107";
                div.dataset.pending = "true";
            }

            div.innerHTML = `
                <div class="avatar-placeholder">${initial}</div>
                <div class="contact-info">
                    <div class="contact-name">${name}</div>
                    <div class="contact-last-msg">${lastMsg}</div>
                </div>
                ${unread && AppState.activeNumber !== number ? '<div class="badge-unread">!</div>' : ''}
            `;
            div.addEventListener('click', () => openChat(number));
            filaAtendimento.appendChild(div);
        }

        loadState();
        renderSidebar();
        
        if (AppState.activeNumber) openChat(AppState.activeNumber);
        else showScreen('welcome');

        socket.on('connect', () => {
            console.log("‚úÖ Conectado");
            syncChatsWithServer();
        });

        async function syncChatsWithServer() {
            try {
                const rStatus = await fetch('/api/whatsapp/status');
                const statusJson = await rStatus.json();
                
                const state = statusJson.data?.instance?.state || statusJson.data?.state;
                if (state !== 'open') {
                    resetConnectionState();
                    return;
                }
                setConnectedState();

                const rChats = await fetch('/api/whatsapp/chats');
                const json = await rChats.json();
                
                if (!json.success || !json.data) {
                    return; 
                }

                let meuNome = "";
                try { 
                    const userData = JSON.parse(localStorage.getItem("userData"));
                    meuNome = userData?.data?.nomeFuncionario;
                } catch(e) { console.error("Erro ao ler dados do usu√°rio", e); }

                const listaServer = json.data;
                const novosChats = [];
                const mapaLocal = new Map(AppState.chatList.map(c => [c.numero, c]));

                listaServer.forEach(serverChat => {
                    const num = serverChat.numero;
                    
                    const agenteDoChat = serverChat.nomeAgente; 
                    const souOAgente = (agenteDoChat === meuNome); 
                    const estaLivre = !agenteDoChat; 

                    let deveAparecer = false;

                    if (souOAgente) {
                        deveAparecer = true;
                    } else if (estaLivre) {
                        if (serverChat.visivel !== false) deveAparecer = true;
                    } else {
                        deveAparecer = false;
                    }

                    const isAtendimentoHumano = serverChat.etapa === 'ATENDIMENTO_HUMANO';
                    const serverPendingStatus = (deveAparecer && !isAtendimentoHumano && !serverChat.nomeAgente);

                    if (mapaLocal.has(num)) {
                        const localChat = mapaLocal.get(num);
                        localChat.ultimaMensagem = serverChat.ultimaMensagem;
                        localChat.unreadCount = serverChat.unreadCount;
                        if (serverChat.nome && serverChat.nome !== num) {
                            localChat.nome = serverChat.nome;
                            AppState.contactNames[num] = serverChat.nome;
                        }
                        localChat.pending = serverPendingStatus; 
                        localChat.etapa = serverChat.etapa; 
                        localChat.nomeAgente = serverChat.nomeAgente;
                        localChat.visivel = deveAparecer;

                    } else {
                        let nomeFinal = AppState.contactNames[num];
                        if (!nomeFinal && serverChat.nome && !serverChat.nome.includes('@')) {
                            nomeFinal = serverChat.nome;
                            AppState.contactNames[num] = serverChat.nome;
                        }
                        
                        novosChats.push({
                            numero: num,
                            nome: nomeFinal || num,
                            ultimaMensagem: serverChat.ultimaMensagem,
                            unreadCount: serverChat.unreadCount,
                            visivel: deveAparecer, 
                            pending: serverPendingStatus,
                            etapa: serverChat.etapa,
                            nomeAgente: serverChat.nomeAgente
                        });
                    }
                });

                if (novosChats.length > 0) {
                    AppState.chatList = [...novosChats, ...AppState.chatList];
                }
                
                saveState();
                renderSidebar();
                
                if (AppState.activeNumber) {
                    const activeChat = AppState.chatList.find(c => c.numero === AppState.activeNumber);
                    if (activeChat) {
                        if (activeChat.visivel) {
                            atualizarBotoesToolbar(activeChat);
                        }
                    }
                }

            } catch (e) { 
                console.error("Erro na sincroniza√ß√£o:", e); 
            }
        }

        socket.on('qrCodeRecebido', (data) => {
            if (data && data.qr) {
                exibirQRCode(data.qr);
            }
        });

        socket.on('statusConexao', (data) => {
            if (data.status === 'open' || data.status === 'connecting') {
                setConnectedState();
            } else {
                resetConnectionState();
            }
        });
        
        socket.on('novaMensagemWhatsapp', (data) => {
            const { chatId, texto, fromMe, nome, mostrarNaFila } = data;
            
            if (!AppState.conversas[chatId]) AppState.conversas[chatId] = [];
            AppState.conversas[chatId].push({ fromMe, text: texto, time: new Date(), name: nome || "Eu" });
            if (nome && !fromMe) AppState.contactNames[chatId] = nome;

            const idx = AppState.chatList.findIndex(c => c.numero === chatId);
            let currentChat = null;
            if (idx > -1) { currentChat = AppState.chatList[idx]; AppState.chatList.splice(idx, 1); }

            let isVisivel = false;
            if (mostrarNaFila !== undefined) isVisivel = mostrarNaFila;
            else if (currentChat) isVisivel = currentChat.visivel;
            
            if(fromMe && currentChat && currentChat.visivel) isVisivel = true;

            let isPending = (mostrarNaFila === true);
            if (currentChat && !currentChat.pending && isVisivel) isPending = false;

            AppState.chatList.unshift({
                numero: chatId,
                nome: AppState.contactNames[chatId] || nome,
                ultimaMensagem: fromMe ? `Voc√™: ${texto}` : texto,
                unreadCount: fromMe ? 0 : 1,
                visivel: isVisivel,
                pending: isPending,
                etapa: currentChat ? currentChat.etapa : 'INICIO' 
            });

            saveState();
            renderSidebar();

            if (AppState.activeNumber === chatId) {
                appendMessageToView(texto, fromMe, null, new Date());
                markAsRead(chatId);
            }
        });

        socket.on('notificacaoChamado', (data) => {
            const idx = AppState.chatList.findIndex(c => c.numero === data.chatId);
            if (idx > -1) AppState.chatList.splice(idx, 1);

            AppState.chatList.unshift({
                numero: data.chatId, nome: data.nome, ultimaMensagem: "üîî Chamando...", 
                unreadCount: 1, visivel: true, pending: true, etapa: 'SUBMENU_TI'
            });
            AppState.contactNames[data.chatId] = data.nome;
            
            saveState();
            renderSidebar();
            if (AppState.activeNumber === data.chatId) {
                const chat = AppState.chatList.find(c => c.numero === data.chatId);
                atualizarBotoesToolbar(chat);
            }
        });

        socket.on('transferenciaChamado', (data) => {
            const chat = AppState.chatList.find(c => c.numero === data.chatId);
            if (chat) {
                chat.nomeAgente = data.novoAgente;
                
                let souEu = false;
                try { 
                    const u = JSON.parse(localStorage.getItem("userData"));
                    if (data.novoAgente === u.data.nomeFuncionario) souEu = true;
                } catch(e){}

                if (souEu) {
                    chat.visivel = true; 
                    chat.pending = false; 
                } else {
                    chat.visivel = false; 
                }
                
                saveState();
                renderSidebar();
                
                if (AppState.activeNumber === data.chatId) {
                    if (!souEu) {
                        alert(`Este atendimento foi transferido para ${data.novoAgente}.`);
                        showScreen('welcome');
                        AppState.activeNumber = null;
                    } else {
                        atualizarBotoesToolbar(chat);
                    }
                }
            } else {
                syncChatsWithServer(); 
            }
        });

        socket.on('atendimentoAssumido', (data) => {
            const chat = AppState.chatList.find(c => c.numero === data.chatId);
            if (chat) {
                chat.nomeAgente = data.nomeAgente;
                chat.etapa = 'ATENDIMENTO_HUMANO';
                
                let meuNome = "";
                try { 
                    const u = JSON.parse(localStorage.getItem("userData"));
                    meuNome = u?.data?.nomeFuncionario;
                } catch(e){}

                if (data.nomeAgente === meuNome) {
                    chat.visivel = true; 
                } else {
                    chat.visivel = false; 
                }
                
                saveState();
                renderSidebar();
                
                if (AppState.activeNumber === data.chatId && data.nomeAgente !== meuNome) {
                    alert(`O atendente ${data.nomeAgente} acabou de assumir este chamado.`);
                    showScreen('welcome');
                    AppState.activeNumber = null;
                } else if (AppState.activeNumber === data.chatId) {
                    atualizarBotoesToolbar(chat);
                }
            } else {
                syncChatsWithServer();
            }
        });

        async function openChat(number) {
            AppState.activeNumber = number;
            const chat = AppState.chatList.find(c => c.numero === number);
            if(chat) chat.unreadCount = 0;
            
            saveState();
            renderSidebar(); 
            showScreen('chat');

            chatTitle.textContent = chat ? chat.nome : number; 
            
            atualizarBotoesToolbar(chat);
            
            messagesContainer.innerHTML = '';
            const localMsgs = AppState.conversas[number] || [];
            localMsgs.forEach(m => appendMessageToView(m.text, m.fromMe, m.name, new Date(m.time)));
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'msg-time';
            loadingDiv.style.textAlign = 'center';
            loadingDiv.style.padding = '10px';
            loadingDiv.innerText = 'Sincronizando mensagens...';
            messagesContainer.appendChild(loadingDiv);

            try {
                const response = await fetch('/api/whatsapp/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero: number })
                });
                
                const json = await response.json();
                
                if (json.success && json.data.length > 0) {
                    AppState.conversas[number] = json.data;
                    saveState();

                    messagesContainer.innerHTML = '';
                    json.data.forEach(m => appendMessageToView(m.text, m.fromMe, m.name, new Date(m.time)));
                } else {
                    loadingDiv.remove();
                }
            } catch (e) {
                console.error("Erro ao sincronizar mensagens:", e);
                loadingDiv.remove();
            }
            
            chatInput.disabled = false; 
            chatInput.focus();
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function markAsRead(number) {
            const chat = AppState.chatList.find(c => c.numero === number);
            if(chat) chat.unreadCount = 0;
        }

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !AppState.activeNumber) return;
            
            appendMessageToView(text, true, null, new Date());
            chatInput.value = '';
            
            if (!AppState.conversas[AppState.activeNumber]) AppState.conversas[AppState.activeNumber] = [];
            AppState.conversas[AppState.activeNumber].push({ fromMe: true, text, time: new Date(), name: "Eu" });
            
            const idx = AppState.chatList.findIndex(c => c.numero === AppState.activeNumber);
            if(idx > -1) {
                const c = AppState.chatList[idx];
                c.ultimaMensagem = `Voc√™: ${text}`;
                c.visivel = true; 
                AppState.chatList.splice(idx, 1);
                AppState.chatList.unshift(c);
            }
            
            saveState();
            renderSidebar();

            try {
                const user = JSON.parse(localStorage.getItem("userData"));
                await fetch('/api/whatsapp/send', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero: AppState.activeNumber, mensagem: text, nomeAgenteTemporario: user?.data?.nomeFuncionario })
                });
            } catch (e) { console.error(e); }
        }

        async function finalizarChat() {
            if (!AppState.activeNumber) return;
            if (document.getElementById('btnFinalizar').disabled) return;

            if (!confirm(`Tem certeza que deseja encerrar o atendimento?`)) return;

            try {
                const numero = AppState.activeNumber;
                
                const response = await fetch('/api/whatsapp/finalizar', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero: numero })
                });

                if (!response.ok) throw new Error('Erro ao finalizar.');
                
                const chat = AppState.chatList.find(c => c.numero === numero);
                if (chat) chat.visivel = false;
                
                AppState.activeNumber = null;
                saveState();
                renderSidebar();
                showScreen('welcome');
                alert("Atendimento finalizado com sucesso!");

            } catch (e) { alert(`Erro ao finalizar: ${e.message}`); }
        }
        
        async function desconectarWhats() {
            if (!confirm("Aten√ß√£o! Desconectar a inst√¢ncia ir√° encerrar o WhatsApp Web e exigir um novo escaneamento de QR Code.")) return;
            try {
                await fetch('/api/whatsapp/disconnect', { method: 'POST' }); 
                alert("Comando de desconex√£o enviado.");
                resetConnectionState();
            } catch (e) { alert(`Erro ao tentar desconectar.`); }
        }

        function appendMessageToView(text, fromMe, name, time) {
            const div = document.createElement('div');
            div.className = `msg ${fromMe ? 'msg-out' : 'msg-in'}`;
            div.innerHTML = `<div>${text}</div><span class="msg-time">${time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        btnAssumir.addEventListener('click', async () => {
            if (!AppState.activeNumber) return;
            if (btnAssumir.disabled) return;

            try {
                const user = JSON.parse(localStorage.getItem("userData"));
                const nomeAgente = user?.data?.nomeFuncionario || "Suporte";

                const response = await fetch('/api/whatsapp/atender', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero: AppState.activeNumber, nomeAgente: nomeAgente })
                });
                
                const json = await response.json();

                if (!response.ok || !json.success) {
                    throw new Error(json.message || "Erro desconhecido ao assumir.");
                }
                
                const chat = AppState.chatList.find(c => c.numero === AppState.activeNumber);
                if(chat) {
                    chat.pending = false;
                    chat.etapa = 'ATENDIMENTO_HUMANO'; 
                    chat.nomeAgente = nomeAgente; 
                    chat.visivel = true;
                }
                
                saveState();
                renderSidebar();
                atualizarBotoesToolbar(chat);

                appendMessageToView("‚úÖ Voc√™ assumiu este chamado.", true, "Sistema", new Date());
            } catch (e) { 
                alert(`N√£o foi poss√≠vel assumir: ${e.message}`);
                syncChatsWithServer();
            }
        });

        btnFinalizar.addEventListener('click', finalizarChat);

        btnTransferir.addEventListener('click', async () => {
            if (btnTransferir.disabled) return;
            if (!AppState.activeNumber) return;

            modalTransfer.style.display = 'flex';
            selectAgentes.innerHTML = '<option value="">Carregando...</option>';

            try {
                const resp = await fetch('/usuarios'); 
                const json = await resp.json();
                
                let meuNome = "";
                try { meuNome = JSON.parse(localStorage.getItem("userData")).data.nomeFuncionario; } catch(e){}

                selectAgentes.innerHTML = '<option value="">Selecione um agente...</option>';
                
                const lista = Array.isArray(json) ? json : (json.data || []);
                
                lista.forEach(func => {
                    if (func.nomeFuncionario !== meuNome && (func.perfil === 'AGENTE' || func.perfil === 'ADMIN')) {
                        const opt = document.createElement('option');
                        opt.value = func.nomeFuncionario; 
                        opt.textContent = func.nomeFuncionario;
                        selectAgentes.appendChild(opt);
                    }
                });

            } catch (e) {
                console.error(e);
                selectAgentes.innerHTML = '<option value="">Erro ao carregar lista</option>';
            }
        });

        btnAssociarTicket.addEventListener('click', () => {
            if(btnAssociarTicket.disabled) return;
            modalAssociar.style.display = 'flex';
            inputTicketId.value = '';
            associarResult.innerHTML = '';
            associarResult.style.color = 'black';
        });

        btnCancelarAssociar.addEventListener('click', () => {
            modalAssociar.style.display = 'none';
        });

        btnConfirmarAssociar.addEventListener('click', async () => {
            const id = inputTicketId.value.trim();
            if(!id) return alert("Digite um ID!");

            associarResult.innerHTML = 'Verificando <i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const res = await fetch('/api/whatsapp/ticket/verificar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const json = await res.json();

                if(json.success && json.data) {
                    const t = json.data;
                    associarResult.innerHTML = `‚úÖ <b>Ticket Encontrado:</b><br>#${t.id} - ${t.assunto} (${t.status})`;
                    associarResult.style.color = 'green';
                } else {
                    associarResult.innerHTML = '‚ùå Ticket n√£o encontrado.';
                    associarResult.style.color = 'red';
                }
            } catch(e) {
                associarResult.textContent = 'Erro ao verificar.';
            }
        });

        // --- FUN√á√ïES DE CARREGAMENTO DE LOJAS E DEPTOS ---
        async function carregarLojasSelect() {
            try {
                // Utilizando a rota /chamados/dados/lojas conforme padr√£o em Chamado.html
                const response = await fetch('/chamados/dados/lojas');
                if (!response.ok) throw new Error("Erro ao carregar lojas.");
                const lojas = await response.json();
                selectLoja.innerHTML = '<option value="">-- Selecione a Loja --</option>';
                lojas.forEach(loja => {
                    const opt = document.createElement('option');
                    opt.value = loja.id;
                    opt.textContent = loja.nome;
                    selectLoja.appendChild(opt);
                });
            } catch (error) {
                console.error(error);
                selectLoja.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarDepartamentosSelect(lojaId) {
            selectDepartamento.innerHTML = '<option value="">Carregando...</option>';
            selectDepartamento.disabled = true;
            if (!lojaId) {
                selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
                return;
            }
            try {
                const response = await fetch(`/chamados/dados/lojas/${lojaId}/departamentos`);
                if (!response.ok) throw new Error("Erro ao carregar departamentos.");
                const departamentos = await response.json();
                selectDepartamento.innerHTML = '<option value="">-- Selecione o Departamento --</option>';
                if (departamentos.length === 0) selectDepartamento.add(new Option("Nenhum vinculado", ""));
                else departamentos.forEach(dept => selectDepartamento.add(new Option(dept.nome, dept.id)));
                selectDepartamento.disabled = false; 
            } catch (error) {
                console.error(error);
                selectDepartamento.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Event listener para carregar departamentos quando a loja mudar
        selectLoja.addEventListener('change', () => carregarDepartamentosSelect(selectLoja.value));

        btnCriarChamado.addEventListener('click', async () => {
            if(btnCriarChamado.disabled) return;
            if(!AppState.activeNumber) return;

            modalCriar.style.display = 'flex';
            
            const contatoNome = AppState.contactNames[AppState.activeNumber] || AppState.activeNumber;
            inputAssunto.value = `Atendimento WhatsApp - ${contatoNome}`;
            
            inputDescricao.value = '';
            
            selectPrioridade.value = 'M√©dia'; 

            // Carrega as lojas e reseta os departamentos
            carregarLojasSelect();
            selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
            selectDepartamento.disabled = true;

            if(allCategories.length === 0) {
                containerCascata.innerHTML = 'Carregando...';
                try {
                    const res = await fetch('/categorias'); 
                    allCategories = await res.json(); 
                    containerCascata.innerHTML = ''; 
                    montarSelectCategoria(null); 
                } catch(e) { 
                    console.error("Erro ao carregar categorias", e); 
                    containerCascata.innerHTML = '<span style="color:red">Erro ao carregar.</span>';
                }
            } else {
                containerCascata.innerHTML = '';
                categoriaSelecionadaId = null;
                montarSelectCategoria(null);
            }
        });

        function montarSelectCategoria(parentId) {
            const filhos = allCategories.filter(c => c.parent_id == parentId);
            
            if (filhos.length === 0) {
                categoriaSelecionadaId = parentId;
                const cat = allCategories.find(c => c.id == parentId);
                if (cat && cat.prioridade_padrao) {
                    const map = {
                        'BAIXA': 'Baixa', 'LOW': 'Baixa', 'baixa': 'Baixa',
                        'MEDIA': 'M√©dia', 'M√âDIA': 'M√©dia', 'MEDIUM': 'M√©dia', 'media': 'M√©dia',
                        'ALTA': 'Alta', 'HIGH': 'Alta', 'alta': 'Alta',
                        'CRITICA': 'Cr√≠tica', 'CR√çTICA': 'Cr√≠tica', 'CRITICAL': 'Cr√≠tica', 'critica': 'Cr√≠tica'
                    };
                    const p = cat.prioridade_padrao.toUpperCase();
                    if (map[p]) selectPrioridade.value = map[p];
                    else selectPrioridade.value = cat.prioridade_padrao;
                }
                return;
            }

            categoriaSelecionadaId = null;

            const select = document.createElement('select');
            select.className = 'modal-select';
            select.style.marginTop = '5px';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = parentId === null ? "-- Selecione a Categoria --" : "-- Selecione a Subcategoria --";
            select.appendChild(defaultOption);

            filhos.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.nome;
                select.appendChild(opt);
            });

            select.addEventListener('change', (e) => {
                const val = e.target.value;
                
                let next = select.nextElementSibling;
                while (next) {
                    const toRemove = next;
                    next = next.nextElementSibling;
                    toRemove.remove();
                }

                if (val) {
                    montarSelectCategoria(val);
                } else {
                    categoriaSelecionadaId = null;
                }
            });

            containerCascata.appendChild(select);
        }

        btnCancelarCriar.addEventListener('click', () => {
            modalCriar.style.display = 'none';
        });

        btnSalvarChamado.addEventListener('click', async () => {
            const assunto = inputAssunto.value.trim();
            const descricao = inputDescricao.value.trim();
            const prioridade = selectPrioridade.value;
            const loja = selectLoja.value; // Novo campo
            const departamento = selectDepartamento.value; // Novo campo

            if(!assunto) return alert("Preencha o Assunto.");
            
            const selects = containerCascata.querySelectorAll('select');
            let pendente = false;
            selects.forEach(s => { if(!s.value) pendente = true; });

            if (!categoriaSelecionadaId || pendente) {
                return alert("Por favor, selecione a categoria at√© o final (subcategorias).");
            }

            if(!loja || !departamento) {
                return alert("Por favor, selecione a Loja e o Departamento.");
            }

            if(!descricao) return alert("A descri√ß√£o √© obrigat√≥ria.");

            const btnOriginalText = btnSalvarChamado.textContent;
            btnSalvarChamado.disabled = true;
            btnSalvarChamado.textContent = "Criando...";
            btnSalvarChamado.style.cursor = "wait";

            // [NOVO] Captura o nome do contato para enviar
            const nomeContato = AppState.contactNames[AppState.activeNumber] || AppState.activeNumber;

            try {
                const userDataString = localStorage.getItem("userData");
                let agenteId = 1; 

                if (userDataString) {
                    const userData = JSON.parse(userDataString);
                    if (userData.data && userData.data.id) {
                        agenteId = userData.data.id;
                    } else if (userData.id) {
                        agenteId = userData.id;
                    }
                }

                const payload = {
                    chamado: {
                        assunto,
                        descricao,
                        categoria_id: categoriaSelecionadaId, 
                        prioridade,
                        requisitante_id: agenteId, 
                        status: 'Aberto',
                        loja: loja, // Enviando ID da loja
                        departamento: departamento, // Enviando ID do departamento
                        
                        // [NOVO] Enviando dados manuais do contato
                        nome_requisitante_manual: nomeContato,
                        telefone_requisitante_manual: AppState.activeNumber
                    },
                    numero: AppState.activeNumber 
                };

                const res = await fetch('/api/whatsapp/ticket/criar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if(json.success) {
                    modalCriar.style.display = 'none';
                    appendMessageToView(`üé´ Chamado #${json.id} criado com sucesso!\nAssunto: ${assunto}`, true, "Sistema", new Date());
                    alert(`‚úÖ Chamado #${json.id} criado com sucesso!`);
                } else {
                    alert("Erro ao criar chamado: " + (json.message || "Erro desconhecido"));
                }

            } catch(e) {
                alert("Erro de conex√£o ao tentar criar o chamado.");
                console.error(e);
            } finally {
                btnSalvarChamado.disabled = false;
                btnSalvarChamado.textContent = btnOriginalText;
                btnSalvarChamado.style.cursor = "pointer";
            }
        });

        btnCancelarTransfer.addEventListener('click', () => {
            modalTransfer.style.display = 'none';
        });

        btnConfirmarTransfer.addEventListener('click', async () => {
            const novoAgente = selectAgentes.value;
            if (!novoAgente) return alert("Selecione um agente!");
            if (!AppState.activeNumber) return;

            if(!confirm(`Confirma a transfer√™ncia deste chat para ${novoAgente}?`)) return;

            try {
                const userData = JSON.parse(localStorage.getItem("userData"));
                const meuNome = userData?.data?.nomeFuncionario || "Admin";

                const response = await fetch('/api/whatsapp/transferir', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        numero: AppState.activeNumber, 
                        novoAgente: novoAgente,
                        nomeAgenteAtual: meuNome
                    })
                });

                const resJson = await response.json();

                if (resJson.success) {
                    alert("Transfer√™ncia realizada com sucesso!");
                    modalTransfer.style.display = 'none';
                    
                    const chat = AppState.chatList.find(c => c.numero === AppState.activeNumber);
                    if(chat) {
                        chat.visivel = false; 
                        chat.nomeAgente = novoAgente;
                    }
                    AppState.activeNumber = null;
                    saveState();
                    renderSidebar();
                    showScreen('welcome');
                } else {
                    alert("Erro ao transferir: " + (resJson.message || "Erro desconhecido"));
                }

            } catch (e) {
                alert("Erro de conex√£o ao transferir.");
            }
        });

        // --- L√ìGICA DO HIST√ìRICO GLOBAL (NOVO) ---
        
        btnGlobalHistory.addEventListener('click', async () => {
            modalHistorico.style.display = 'flex';
            
            // Reseta para a vista da lista
            viewHistoryList.style.display = 'flex';
            viewHistoryMessages.style.display = 'none';
            inputSearchHistory.value = '';
            historyListContainer.innerHTML = '<div style="text-align:center; padding:20px;"><i class="fas fa-spinner fa-spin"></i> Buscando todas as conversas...</div>';

            try {
                // Busca com mode=history para pegar TUDO
                const response = await fetch('/api/whatsapp/chats?mode=history');
                const json = await response.json();

                if (json.success) {
                    allHistoryChats = json.data;
                    renderHistoryList(allHistoryChats);
                } else {
                    historyListContainer.innerHTML = '<div style="text-align:center; color:red;">Erro ao buscar hist√≥rico.</div>';
                }
            } catch (e) {
                console.error(e);
                historyListContainer.innerHTML = '<div style="text-align:center; color:red;">Erro de conex√£o.</div>';
            }
        });

        function renderHistoryList(lista) {
            historyListContainer.innerHTML = '';
            
            if (lista.length === 0) {
                historyListContainer.innerHTML = '<div style="text-align:center; padding:20px;">Nenhuma conversa encontrada.</div>';
                return;
            }

            lista.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div style="flex:1; overflow:hidden;">
                        <div class="history-item-name">${chat.nome || chat.numero}</div>
                        <div class="history-item-sub">${chat.ultimaMensagem}</div>
                    </div>
                    <div style="font-size:1.2rem; color:#ccc; margin-left:10px;">&rsaquo;</div>
                `;
                
                div.addEventListener('click', () => openHistoryChatMessages(chat.numero, chat.nome));
                historyListContainer.appendChild(div);
            });
        }

        inputSearchHistory.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            const filtrados = allHistoryChats.filter(c => 
                (c.nome && c.nome.toLowerCase().includes(termo)) || 
                c.numero.includes(termo)
            );
            renderHistoryList(filtrados);
        });

        async function openHistoryChatMessages(numero, nome) {
            viewHistoryList.style.display = 'none';
            viewHistoryMessages.style.display = 'flex';
            historyChatTitle.textContent = nome || numero;
            historyMsgsContainer.innerHTML = '<div style="text-align:center; padding:20px;">Carregando mensagens...</div>';

            try {
                const response = await fetch('/api/whatsapp/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero: numero, limit: 100 }) 
                });
                const json = await response.json();

                if (json.success) {
                    historyMsgsContainer.innerHTML = '';
                    if(json.data.length === 0) {
                        historyMsgsContainer.innerHTML = '<div style="text-align:center; padding:20px;">Sem mensagens registradas.</div>';
                        return;
                    }

                    json.data.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `hist-msg ${msg.fromMe ? 'hist-out' : 'hist-in'}`;
                        const hora = new Date(msg.time).toLocaleString('pt-BR');
                        div.innerHTML = `<div>${msg.text}</div><span class="hist-time">${hora}</span>`;
                        historyMsgsContainer.appendChild(div);
                    });
                    historyMsgsContainer.scrollTop = historyMsgsContainer.scrollHeight;
                } else {
                    historyMsgsContainer.innerHTML = '<div style="color:red; text-align:center;">Erro ao carregar mensagens.</div>';
                }

            } catch (e) {
                historyMsgsContainer.innerHTML = '<div style="color:red; text-align:center;">Erro ao carregar mensagens.</div>';
            }
        }

        btnVoltarListaHistory.addEventListener('click', () => {
            viewHistoryMessages.style.display = 'none';
            viewHistoryList.style.display = 'flex';
        });

        btnFecharHistorico.addEventListener('click', () => {
            modalHistorico.style.display = 'none';
        });

        // --- MANIPULA√á√ÉO DO ARQUIVO (NOVO C√ìDIGO) ---
        
        btnAnexo.addEventListener('click', () => {
            if(!AppState.activeNumber) return;
            inputArquivo.value = ''; // Reseta para garantir evento change
            inputArquivo.click();
        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                // Pega apenas a parte do base64 (depois da v√≠rgula)
                const result = reader.result;
                const base64Clean = result.split(',')[1];
                resolve(base64Clean);
            };
            reader.onerror = error => reject(error);
        });

        inputArquivo.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            // Define tipo
            if (file.type.startsWith('image/')) arquivoSelecionadoTipo = 'image';
            else if (file.type.startsWith('video/')) arquivoSelecionadoTipo = 'video';
            else arquivoSelecionadoTipo = 'document';

            arquivoSelecionadoNome = file.name;
            previewFileName.textContent = file.name;
            inputLegendaArquivo.value = '';

            // Configura preview visual
            if(arquivoSelecionadoTipo === 'image') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewFileIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = 'none';
                previewFileIcon.style.display = 'block';
                if(arquivoSelecionadoTipo === 'video') previewFileIcon.className = 'fas fa-video';
                else previewFileIcon.className = 'fas fa-file-alt';
            }

            try {
                arquivoSelecionadoBase64 = await toBase64(file);
                modalPreview.style.display = 'flex';
                inputLegendaArquivo.focus();
            } catch(err) {
                alert("Erro ao ler arquivo.");
            }
        });

        btnCancelarEnvioMidia.addEventListener('click', () => {
            modalPreview.style.display = 'none';
            arquivoSelecionadoBase64 = null;
            inputArquivo.value = '';
        });

        // No seu <script> do HTML...
        
        btnConfirmarEnvioMidia.addEventListener('click', async () => {
            // ... (c√≥digo anterior) ...

            try {
                // ...
                const response = await fetch('/api/whatsapp/send-media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        numero: AppState.activeNumber,
                        midia: arquivoSelecionadoBase64,
                        nomeArquivo: arquivoSelecionadoNome,
                        legenda: legenda,
                        
                        // ESSA LINHA √â CRUCIAL:
                        tipo: arquivoSelecionadoTipo, // Tem que estar enviando 'image', 'video' ou 'document'
                        
                        nomeAgenteTemporario: user?.data?.nomeFuncionario
                    })
                });
                // ...

                const data = await response.json();

                if (data.success) {
                    modalPreview.style.display = 'none';
                    // Adiciona na tela como mensagem enviada (simplificado como texto para feedback)
                    const msgDisplay = `üìé [Arquivo Enviado] ${arquivoSelecionadoNome}\n${legenda}`;
                    appendMessageToView(msgDisplay, true, "Eu", new Date());
                    
                    // Adiciona ao hist√≥rico local
                    if (!AppState.conversas[AppState.activeNumber]) AppState.conversas[AppState.activeNumber] = [];
                    AppState.conversas[AppState.activeNumber].push({ fromMe: true, text: msgDisplay, time: new Date(), name: "Eu" });
                    
                    // Atualiza sidebar
                    const idx = AppState.chatList.findIndex(c => c.numero === AppState.activeNumber);
                    if(idx > -1) {
                        const c = AppState.chatList[idx]; c.ultimaMensagem = `Voc√™: üìé Arquivo`;
                        AppState.chatList.splice(idx, 1); AppState.chatList.unshift(c);
                        saveState(); renderSidebar();
                    }
                } else {
                    alert("Erro ao enviar: " + (data.message || "Desconhecido"));
                }
            } catch (error) {
                console.error(error);
                alert("Erro de conex√£o ao enviar arquivo.");
            } finally {
                btnConfirmarEnvioMidia.disabled = false;
                btnConfirmarEnvioMidia.innerHTML = btnOriginalText;
                // Limpeza
                arquivoSelecionadoBase64 = null;
                inputArquivo.value = '';
            }
        });

        function resetConnectionState() {
            statusText.textContent = "Desconectado";
            statusDot.className = "status-dot offline";
            btnConectar.style.display = 'block';
            btnDesconectarWhats.style.display = 'none';
            showScreen('welcome');
        }

        function setConnectedState() {
            statusText.textContent = "Online"; statusDot.className = "status-dot online";
            btnConectar.style.display = 'none';
            btnDesconectarWhats.style.display = 'block';
            if (!AppState.activeNumber) showScreen('welcome');
        }

        function showScreen(name) {
            qrScreen.style.display = 'none'; welcomeScreen.style.display = 'none'; activeChatScreen.style.display = 'none';
            if (name === 'qr') qrScreen.style.display = 'flex';
            if (name === 'welcome') welcomeScreen.style.display = 'flex';
            if (name === 'chat') activeChatScreen.style.display = 'flex';
        }
        
        function exibirQRCode(b64) { 
            const cleanedB64 = b64.replace(/^data:image\/[a-z]+;base64,/, '');
            qrContainer.innerHTML = `<img src="data:image/png;base64,${cleanedB64}">`; 
            statusText.textContent="Escaneie"; 
            showScreen('qr'); 
        }

        btnConectar.addEventListener('click', async () => {
            statusText.textContent = "Solicitando..."; 
            showScreen('qr'); 
            
            try {
                const response = await fetch('/api/whatsapp/connect');
                const json = await response.json();
                
                console.log("Resposta do Connect:", json);

                if (json.data && json.data.qrcode) {
                    const qrRaw = json.data.qrcode.base64 || json.data.qrcode;
                    if (qrRaw) {
                        console.log("QR Code recebido diretamente via API (bypass Webhook).");
                        exibirQRCode(qrRaw);
                    }
                }
            } catch(e) { 
                console.error("Erro no connect", e); 
                statusText.textContent = "Erro ao conectar.";
            }

            fetch('/api/whatsapp/configure-webhook').catch(e => { console.error("Erro webhook", e); });
        });
        
        if (btnDesconectarWhats) {
            btnDesconectarWhats.addEventListener('click', desconectarWhats);
        }
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                if (!socket.connected) socket.connect();
                syncChatsWithServer();
                if (AppState.activeNumber) openChat(AppState.activeNumber);
            }
        });
    });
    </script>
</body>
</html>