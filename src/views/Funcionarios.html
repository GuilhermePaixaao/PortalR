<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>Funcion√°rios - Portal Supermercado</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <script>
            // --- IN√çCIO DO PROTETOR DE P√ÅGINA (ANTI-FLICKER) ---
            // Esta vari√°vel agora √© global para esta p√°gina
            const userDataString = localStorage.getItem("userData");
            
            if (!userDataString) {
                window.location.replace("Login.html"); 
                throw new Error("Usu√°rio n√£o autenticado.");
            }
            try {
                const userData = JSON.parse(userDataString);
                if (!userData?.data?.id) {
                    throw new Error("Dados de usu√°rio inv√°lidos.");
                }
            } catch (error) {
                console.error("Sess√£o inv√°lida:", error.message);
                localStorage.removeItem("userData"); 
                window.location.replace("Login.html"); 
                throw new Error("Sess√£o inv√°lida.");
            }
            // --- FIM DO PROTETOR DE P√ÅGINA ---
        </script>
        <link href="css/dashboard.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="icon" type="image/png" href="/logo.png">
        
        <style>
            .header {
                display: flex;
                align-items: center;
                justify-content: space-between; /* Alinha itens */
                padding: 0.75rem 2rem;
                background-color: #ffffff;
                border-bottom: 1px solid #dee2e6;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                position: sticky;
                top: 0;
                z-index: 1030;
            }
            .logo {
                font-size: 1.4rem;
                font-weight: 700;
                color: #0d6efd;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin: 0;
                white-space: nowrap;
            }
            .search-bar {
                margin-left: 2rem;
                margin-right: 2rem;
                width: 100%;
                max-width: 450px;
            }
            .search-bar input {
                width: 100%;
                padding: 0.6rem 1rem;
                border: 1px solid #ced4da;
                border-radius: 20px;
                font-size: 0.95rem;
            }
            .search-bar input:focus {
                border-color: #86b7fe;
                box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
                outline: none;
            }
            
            /* Estilos para Logout */
            .header-actions {
                display: flex;
                align-items: center;
                gap: 1rem; 
            }
            #userNameDisplay {
                font-weight: 500;
                color: #495057;
                white-space: nowrap; 
            }
            .btn-logout {
                background-color: #dc3545; 
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }
            .btn-logout:hover {
                background-color: #bb2d3b;
            }

            /* AJUSTES DA SIDEBAR PARA ALINHAMENTO E SUPORTE A QUEBRA DE LINHA */
            .sidebar nav ul li a {
                display: flex;
                align-items: center; 
                text-decoration: none;
                padding: 10px 15px; 
                width: 100%;
                height: auto; 
            }

            .sidebar .icon {
                margin-right: 10px; 
                min-width: 20px; 
                text-align: center;
                flex-shrink: 0; 
                align-self: center; 
            }

            .sidebar .text {
                flex-grow: 1; 
                white-space: normal; 
                line-height: 1.2; 
            }
            /* --- FIM DOS ESTILOS DE AJUSTE --- */

        </style>
    </head>

    <body>
        <div class="dashboard-container">
            <header class="header">
                <div class="logo">PORTAL SUPERMERCADO</div>
                <div class="search-bar">
                    <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
                </div>
                
                <div class="header-actions">
                    <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                    <span id="userNameDisplay"></span>
                    <button id="logoutButton" class="btn-logout">Sair</button>
                </div>
            </header>

            <aside class="sidebar">
                <nav>
                    <ul>
                        <li>
                            <a href="Dashboard.html" title="In√≠cio">
                                <span class="icon">üè†</span>
                                <span class="text">In√≠cio</span>
                            </a>
                        </li>
                        <li>
                            <a href="Imprimir.html" title="Impress√£o de Pre√ßos">
                                <span class="icon">üñ®Ô∏è</span>
                                <span class="text">Imprimir</span>
                            </a>
                        </li>
                        <li class="ticket-item" id="menu-link-chamado">
                            <a href="Chamado.html" title="Abrir Chamado (Airus)">
                                <span class="icon">‚ûï</span>
                                <span class="text">Chamado</span>
                            </a>
                        </li>
                        <li>
                            <a href="Chatbot.html" title="Chatbot">
                                <span class="icon">ü§ñ</span>
                                <span class="text">Chatbot</span>
                            </a>
                        </li>
                            
                        <li class="active">
                            <a href="Funcionarios.html" title="Funcion√°rios">
                                <span class="icon">üíº</span>
                                <span class="text">Funcion√°rios</span>
                            </a>
                        </li>
                        <li>
                        <a href="Categorias.html" title="Categorias">
                            <span class="icon">üè∑Ô∏è</span>
                            <span class="text">Categorias</span>
                        </a>
                        </li>
                        <li style="margin-top: 30px;">
                           
                        </li>
                    </ul>
                </nav>
            </aside>

            <main class="main-content container-fluid">
                <h2>Gerenciamento de Funcion√°rios</h2>
                <hr>

                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card shadow-sm widget">
                            <div class="card-header">
                                <strong>Cadastro / Edi√ß√£o</strong>
                            </div>
                            <div class="card-body">
                                <form id="formFuncionario">
                                    <div class="mb-3">
                                        <label for="txtId" class="form-label">ID</label>
                                        <input type="text" id="txtId" class="form-control" disabled>
                                    </div>

                                    <div class="mb-3">
                                        <label for="txtNomeFuncionario" class="form-label">Nome Completo</label>
                                        <input type="text" id="txtNomeFuncionario" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="txtUsuario" class="form-label">Usu√°rio (para login)</label>
                                        <input type="text" id="txtUsuario" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="txtEmail" class="form-label">E-mail</label>
                                        <input type="email" id="txtEmail" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label for="txtSenha" class="form-label">Senha</label>
                                        <input type="password" id="txtSenha" class="form-control" placeholder="Deixe em branco para n√£o alterar">
                                        <div class="form-text">M√≠nimo 6 caracteres, 1 mai√∫scula, 1 n√∫mero, 1 especial.</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="cboCargos" class="form-label">Cargo</label>
                                        <select id="cboCargos" class="form-select" required>
                                            <option value="-1" disabled selected>Carregando...</option>
                                        </select>
                                    </div>
                                </form>

                                <div id="divBotoes" class="d-grid gap-2 d-md-flex"></div>
                                <div id="divResposta" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card shadow-sm mb-4 widget">
                            <div class="card-header">
                                <strong>Filtros</strong>
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label for="txtFiltroNome" class="form-label">Filtrar por Nome ou Usu√°rio</label>
                                        <input type="text" id="txtFiltroNome" class="form-control" placeholder="Digite um nome ou usu√°rio...">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="cboCargosFiltro" class="form-label">Filtrar por Cargo</label>
                                        <select id="cboCargosFiltro" class="form-select">
                                            <option value="-1" selected>Todos os cargos</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow-sm widget">
                            <div class="card-header">
                                <strong>Funcion√°rios Cadastrados</strong>
                            </div>
                            <div class="card-body">
                                <div id="divTabela" class="table-responsive">
                                    <p>Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <script type="module">
            const API_URL = "";

            // --- FUN√á√ÉO DE LOGOUT ---
            function fazerLogout() {
                localStorage.removeItem("userData"); 
                window.location.href = "Login.html"; 
            }

            // --- (NOVO) L√ìGICA DO TEMA ESCURO ---
            const btnThemeToggle = document.getElementById("themeToggle");
            const linkThemeToggle = document.getElementById("themeToggleLink");
            
            function toggleTheme() {
                document.body.classList.toggle("dark-mode");
                let isDark = document.body.classList.contains("dark-mode");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                if (btnThemeToggle) {
                    btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
                }
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem("theme");
                if (savedTheme === "dark") {
                    document.body.classList.add("dark-mode");
                    if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è";
                } else {
                    document.body.classList.remove("dark-mode");
                    if (btnThemeToggle) btnThemeToggle.textContent = "üåô";
                }
            }
            
            // Adiciona os gatilhos
            if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
            if (linkThemeToggle) linkThemeToggle.addEventListener('click', toggleTheme);

            // Carrega o tema salvo IMEDIATAMENTE
            loadTheme();
            // --- FIM L√ìGICA DO TEMA ---


            // --- L√ìGICA INSERIDA PARA O NOME DO USU√ÅRIO E AJUSTE DE MENU ---
            // O script do <head> j√° validou. Apenas lemos os dados.
            try {
                // Usamos a vari√°vel 'userDataString' global definida no <head>
                const userData = JSON.parse(userDataString);
                const userNameDisplay = document.getElementById('userNameDisplay');
                if (userNameDisplay && userData?.data?.nomeFuncionario) {
                    userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
                }

                // L√ìGICA DE AJUSTE DIN√ÇMICO DO MENU
                const userPerfil = userData?.data?.perfil; 
                const linkChamadoLi = document.getElementById("menu-link-chamado"); 
                
                if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
                    const a = linkChamadoLi.querySelector('a');
                    const textSpan = a.querySelector('.text');

                    a.href = "GerenciarChamados.html"; 
                    a.title = "Gerenciar Chamados";
                    a.querySelector('.icon').textContent = "‚úîÔ∏è"; 
                    
                    // Aplica o novo formato de duas linhas para o texto
                    textSpan.innerHTML = "Gerenciar<br>Chamados";
                }
            } catch (error) {
                console.error("Erro ao tentar exibir o nome do usu√°rio:", error);
                // N√£o √© necess√°rio deslogar se a falha for apenas na exibi√ß√£o do nome/menu
            }
            // --- FIM DA L√ìGICA INSERIDA ---


            let API_DATA_FUNCIONARIOS; 
            let LISTA_CARGOS; 

            // Refer√™ncias aos elementos HTML
            const txtId = document.getElementById("txtId");
            const txtNomeFuncionario = document.getElementById("txtNomeFuncionario");
            const txtUsuario = document.getElementById("txtUsuario");
            const txtEmail = document.getElementById("txtEmail");
            const txtSenha = document.getElementById("txtSenha");
            const cboCargos = document.getElementById("cboCargos");

            const divBotoes = document.getElementById("divBotoes");
            const divResposta = document.getElementById("divResposta");
            const divTabela = document.getElementById("divTabela");
            const btnLogout = document.getElementById("logoutButton");

            function createButton(text, id, className) {
                const btn = document.createElement("button");
                btn.textContent = text;
                btn.id = id;
                btn.className = `btn ${className} flex-fill`;
                return btn;
            }

            function limparFormulario(message = "") {
                if (message) {
                    divResposta.textContent = message;
                    divResposta.className = "alert alert-success mt-3";
                } else {
                    divResposta.textContent = "";
                    divResposta.className = "";
                }
                txtId.value = "";
                txtNomeFuncionario.value = "";
                txtUsuario.value = "";
                txtEmail.value = "";
                txtSenha.value = "";
                cboCargos.value = "-1";
            }

            function exibirErro(mensagem) {
                divResposta.textContent = mensagem;
                divResposta.className = 'alert alert-danger mt-3';
            }

            // BOT√ïES CRUD
            const btnCriar = createButton("Criar", "btnCriar", "btn-success");
            btnCriar.onclick = async () => {
                if (txtNomeFuncionario.value.trim() === "" || txtUsuario.value.trim() === "" || txtEmail.value.trim() === "" || txtSenha.value.trim() === "" || cboCargos.value === "-1") {
                    exibirErro("Por favor, preencha todos os campos (Nome, Usu√°rio, Email, Senha e Cargo).");
                    return;
                }

                const senhaRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/\?]).{6,}$/;
                if (!senhaRegex.test(txtSenha.value)) {
                    exibirErro("Senha inv√°lida: deve ter no m√≠nimo 6 caracteres, 1 n√∫mero, 1 mai√∫scula e 1 caractere especial.");
                    return;
                }

                const dadosCadastro = {
                    funcionario: {
                        nomeFuncionario: txtNomeFuncionario.value.trim(),
                        usuario: txtUsuario.value.trim(),
                        email: txtEmail.value.trim(),
                        senha: txtSenha.value.trim(),
                        cargo: { idCargo: parseInt(cboCargos.value) }
                    }
                };

                try {
                    const response = await fetch(`${API_URL}/usuarios`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dadosCadastro)
                    });
                    const respostaAPI = await response.json();
                    if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");

                    limparFormulario("Funcion√°rio criado com sucesso!");
                    listAll();
                } catch (error) {
                    exibirErro(error.message);
                }
            };
            divBotoes.appendChild(btnCriar);

            const btnAtualizar = createButton("Atualizar", "btnAtualizar", "btn-warning");
            btnAtualizar.onclick = async () => {
                const id = txtId.value;
                if (!id) {
                    exibirErro("Selecione um funcion√°rio da lista para atualizar.");
                    return;
                }

                if (txtNomeFuncionario.value.trim() === "" || txtUsuario.value.trim() === "" || txtEmail.value.trim() === "" || cboCargos.value === "-1") {
                    exibirErro("Nome, Usu√°rio, Email e Cargo s√£o obrigat√≥rios para atualizar.");
                    return;
                }

                const dadosAtualizar = {
                    funcionario: {
                        nomeFuncionario: txtNomeFuncionario.value.trim(),
                        usuario: txtUsuario.value.trim(),
                        email: txtEmail.value.trim(),
                        senha: txtSenha.value.trim(),
                        cargo: { idCargo: parseInt(cboCargos.value) }
                    }
                };

                try {
                    const response = await fetch(`${API_URL}/usuarios/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dadosAtualizar)
                    });
                    const respostaAPI = await response.json();
                    if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");

                    limparFormulario("Funcion√°rio atualizado com sucesso!");
                    listAll();
                } catch (error) {
                    exibirErro(error.message);
                }
            };
            divBotoes.appendChild(btnAtualizar);

            const btnExcluir = createButton("Excluir", "btnExcluir", "btn-danger");
            btnExcluir.onclick = async () => {
                const id = txtId.value;
                if (!id) {
                    exibirErro("Selecione um funcion√°rio da lista para excluir.");
                    return;
                }

                if (confirm("Tem certeza que deseja excluir este funcion√°rio?")) {
                    try {
                        const response = await fetch(`${API_URL}/usuarios/${id}`, { method: 'DELETE' });
                        const respostaAPI = await response.json();
                        if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");

                        limparFormulario("Funcion√°rio exclu√≠do com sucesso!");
                        listAll();
                    } catch (error) {
                        exibirErro(error.message);
                    }
                }
            };
            divBotoes.appendChild(btnExcluir);

            async function listAll() {
                try {
                    const response = await fetch(`${API_URL}/usuarios`);
                    if (!response.ok) throw new Error("Erro ao buscar funcion√°rios.");
                    API_DATA_FUNCIONARIOS = await response.json();
                    renderTable(API_DATA_FUNCIONARIOS);
                } catch (error) {
                    exibirErro(error.message);
                }
            }

            function renderTable(funcionarios) {
                divTabela.innerHTML = "";

                const table = document.createElement("table");
                table.className = "table table-bordered table-striped table-hover";
                table.innerHTML = `
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Usu√°rio</th>
                            <th>Email</th>
                            <th>Cargo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector("tbody");

                if (funcionarios && funcionarios.length > 0) {
                    funcionarios.forEach(func => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${func.id}</td>
                            <td>${func.nomeFuncionario}</td>
                            <td>${func.usuario}</td>
                            <td>${func.email}</td>
                            <td>${func.cargo?.nome ?? ''}</td>
                            <td>
                                <button class="btn btn-sm btn-info btn-selecionar">Selecionar</button>
                            </td>
                        `;

                        tr.querySelector('.btn-selecionar').addEventListener('click', () => {
                            txtId.value = func.id;
                            txtNomeFuncionario.value = func.nomeFuncionario || '';
                            txtUsuario.value = func.usuario || '';
                            txtEmail.value = func.email || '';
                            cboCargos.value = func.cargo?.idCargo ?? "-1";
                            txtSenha.value = "";
                            divResposta.innerHTML = "";
                        });

                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum funcion√°rio encontrado.</td></tr>';
                }

                divTabela.appendChild(table);
            }

            async function preencherSelectCargos() {
                try {
                    const response = await fetch(`${API_URL}/cargos`);
                    if (!response.ok) throw new Error("Erro ao carregar cargos.");
                    LISTA_CARGOS = await response.json();

                    const selects = [cboCargos, document.getElementById("cboCargosFiltro")];
                    selects.forEach(cbo => {
                        if (cbo) {
                            const primeiroValor = cbo.options[0]?.value ?? "-1";
                            const primeiroTexto = cbo.options[0]?.text ?? "";
                            cbo.innerHTML = `<option value="${primeiroValor}">${primeiroTexto}</option>`;

                            LISTA_CARGOS.forEach(cargo => {
                                const option = document.createElement("option");
                                option.value = cargo.idCargo;
                                option.textContent = cargo.nome;
                                cbo.appendChild(option);
                            });
                        }
                    });
                } catch (error) {
                    exibirErro(error.message);
                }
            }

            const txtFiltroNome = document.getElementById("txtFiltroNome");
            const cboCargosFiltro = document.getElementById("cboCargosFiltro");

            function filterData() {
                if (!API_DATA_FUNCIONARIOS) return;

                const nomeFiltro = txtFiltroNome.value.trim().toLowerCase();
                const cargoFiltro = parseInt(cboCargosFiltro.value, 10);

                const dadosFiltrados = API_DATA_FUNCIONARIOS.filter(f => {
                    let match = true;
                    if (nomeFiltro) {
                        match = match && (f.nomeFuncionario.toLowerCase().includes(nomeFiltro) || f.usuario.toLowerCase().includes(nomeFiltro));
                    }
                    if (!isNaN(cargoFiltro) && cargoFiltro !== -1) {
                        match = match && (f.cargo?.idCargo === cargoFiltro);
                    }
                    return match;
                });

                renderTable(dadosFiltrados);
            }

            if (txtFiltroNome) txtFiltroNome.addEventListener("input", filterData);
            if (cboCargosFiltro) cboCargosFiltro.addEventListener("change", filterData);
            if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

            async function init() {
                await preencherSelectCargos();
                await listAll();
            }

            init();
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>