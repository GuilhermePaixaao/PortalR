<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Funcion√°rios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="css/dashboard.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="/logo.png">
  <script src="/js/bootstrap.bundle.min.js"></script>

 
</head>
<div class="dashboard-container">
        
        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO</div>
            
            <div class="search-bar">
                <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
            </div>
            
            <div class="user-profile">
                <span class="icon">üîî</span> <span class="icon">üë§</span> </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li>
                        <a href="dashboard.html" title="In√≠cio">
                            <span class="icon">üè†</span>
                            <span class="text">In√≠cio</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="Imprimir.html" title="Impress√£o de Pre√ßos">
                            <span class="icon">üñ®Ô∏è</span>
                            <span class="text">Imprimir</span>
                        </a>
                    </li>

                    <li class="ticket-item">
                        <a href="Chamado.html" title="Abrir Chamado (Airus)">
                            <span class="icon">‚ûï</span>
                            <span class="text">Chamado</span>
                        </a>
                    </li>

                    <li>
                        <a href="Chatbot.html" title="Chatbot">
                            <span class="icon">ü§ñ</span>
                            <span class="text">Chatbot</span>
                        </a>
                    </li>

                    <li class="active">
                        <a href="Funcionarios.html" title="funcionario">
                            <span class="icon">üíº</span>
                            <span class="text">Funcion√°rios</span>
                        </a>
                    </li>

                    <li style="margin-top: 30px;">
                        <a href="#" title="Configura√ß√µes">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="text">Ajustes</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>



                                             

  <script type="module">
    import ApiService from './ApiService.js'; // Importa uma classe auxiliar que faz as requisi√ß√µes HTTP

    // ======================== AUTENTICA√á√ÉO E CONFIGURA√á√ÉO INICIAL ========================
    // Recupera os dados do usu√°rio logado (armazenados no localStorage ap√≥s o login)
    let userData = localStorage.getItem("userData");
    if (userData) userData = JSON.parse(userData);
    else window.location.href = "login.html"; // Se n√£o estiver logado, volta para a p√°gina de login

    const token = userData.data.token; // Pega o token JWT do usu√°rio autenticado
    const api = new ApiService(token); // Cria um objeto para fazer chamadas autenticadas √† API

    let API_DATA; // Vari√°vel global que guarda os dados dos funcion√°rios retornados pela API

    // ======================== REFER√äNCIAS AOS ELEMENTOS HTML ========================
    const txtId = document.getElementById("txtId");
    const txtNomeFuncionario = document.getElementById("txtNomeFuncionario");
    const txtEmail = document.getElementById("txtEmail");
    const txtSenha = document.getElementById("txtSenha");
    const cboCargos = document.getElementById("cboCargos");
    const chkValeTransporte = document.getElementById("chkValeTransporte");

    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");

    // Campos do filtro
    const cboCargosFiltro = document.getElementById("cboCargosFiltro");
    const txtFiltroNome = document.getElementById("txtFiltroNome");
    const chkValeTransporteFiltro = document.getElementById("chkValeTransporteFiltro");

    // ======================== FUN√á√ÉO AUXILIAR PARA CRIAR BOT√ïES ========================
    function createButton(text, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = `btn ${className} flex-fill`; // Ocupa toda a largura dentro do container flex
      return btn;
    }

    // ======================== BOT√ïES CRUD ========================

    // BOT√ÉO LISTAR: carrega todos os funcion√°rios e renderiza a tabela
    const btnListar = createButton("Listar", "btn-primary");
    btnListar.onclick = listAll;
    divBotoes.appendChild(btnListar);

    // BOT√ÉO CRIAR: envia um novo funcion√°rio para a API
    const btnCriar = createButton("Criar", "btn-success");
    btnCriar.onclick = async () => {
      // Valida√ß√µes b√°sicas de entrada
      if (txtNomeFuncionario.value.trim() === "") {
        divResposta.textContent = "Nome inv√°lido";
        divResposta.className = "alert alert-warning";
        return;

      }


      // Regex simples para verificar formato de email: algo@dominio.com
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!emailRegex.test(txtEmail.value)) {
        divResposta.textContent = "Email inv√°lido. Exemplo: usuario@dominio.com";
        divResposta.className = "alert alert-warning";
        return;
      }
      // Regex (express√£o regular) que verifica:
      // - Pelo menos 6 caracteres
      // - Pelo menos 1 n√∫mero
      // - Pelo menos 1 letra mai√∫scula
      // - Pelo menos 1 caractere especial
      const senhaRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{6,}$/;

      if (!senhaRegex.test(txtSenha.value)) {
        // Se n√£o passar na valida√ß√£o, exibe mensagem no divResposta
        divResposta.textContent = "Senha inv√°lida: deve ter no m√≠nimo 6 caracteres, 1 n√∫mero, 1 letra mai√∫scula e 1 caractere especial";
        divResposta.className = "alert alert-warning";
        return; // interrompe a execu√ß√£o para evitar envio inv√°lido
      }
      if (cboCargos.value == -1) {
        divResposta.textContent = "Selecione um cargo";
        divResposta.className = "alert alert-warning";
        return;
      }

      const recebeVale = chkValeTransporte.checked ? 1 : 0;

      // Monta o objeto que ser√° enviado para a API
      const objetoCriar = {
        "funcionario": {
          "nomeFuncionario": txtNomeFuncionario.value.trim(),
          "email": txtEmail.value.trim(),
          "senha": txtSenha.value.trim(),
          "recebeValeTransporte": recebeVale,
          "cargo": { "idCargo": parseInt(cboCargos.value) }
        }
      };

      // Envia o POST para a API
      const resposta = await api.post("/api/v1/funcionarios", objetoCriar);
      if (resposta.success) {
        divResposta.textContent = "Criado com sucesso!";
        divResposta.className = "alert alert-success";
        listAll(); // Atualiza a tabela
      } else {
        divResposta.textContent = resposta.error.message;
        divResposta.className = "alert alert-danger d-inline-block p-2";
      }
    };
    divBotoes.appendChild(btnCriar);

    // BOT√ÉO ATUALIZAR: altera os dados de um funcion√°rio existente
    const btnAtualizar = createButton("Atualizar", "btn-warning");
    btnAtualizar.onclick = async () => {
      const id = txtId.value.trim();
      if (!id) {
        divResposta.textContent = "Selecione um funcion√°rio para atualizar";
        divResposta.className = "alert alert-danger";
        return;
      }

      const recebeVale = chkValeTransporte.checked ? 1 : 0;

      const objetoAtualizar = {
        "funcionario": {
          "nomeFuncionario": txtNomeFuncionario.value.trim(),
          "email": txtEmail.value.trim(),
          "senha": txtSenha.value.trim(),
          "recebeValeTransporte": recebeVale,
          "cargo": { "idCargo": parseInt(cboCargos.value) }
        }
      };

      // Chama a API com m√©todo PUT
      const resposta = await api.put("/api/v1/funcionarios", id, objetoAtualizar);
      if (!resposta.success) {
        divResposta.textContent = resposta.error.message;
        divResposta.className = "alert alert-danger";
      } else limparFormulario();
      listAll(); // Atualiza tabela
    };
    divBotoes.appendChild(btnAtualizar);

    // BOT√ÉO EXCLUIR: deleta um funcion√°rio pelo ID informado
    const btnExcluir = createButton("Excluir", "btn-danger");

    btnExcluir.onclick = function () {
      const id = txtId.value.trim();

      if (!id) {
        divResposta.textContent = "Informe o ID.";
        divResposta.className = "alert alert-danger";
        return;
      }

      // Mostra o modal de confirma√ß√£o
      const modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
      modal.show();

      // Bot√£o de confirma√ß√£o dentro do modal
      const btnConfirmDelete = document.getElementById("btnConfirmDelete");

      // Remove listeners antigos antes de adicionar um novo
      btnConfirmDelete.replaceWith(btnConfirmDelete.cloneNode(true));
      const newBtnConfirm = document.getElementById("btnConfirmDelete");

      newBtnConfirm.onclick = async function () {
        try {
          await api.delete("/api/v1/funcionarios", id);
          listAll(); // Atualiza tabela ap√≥s exclus√£o
          divResposta.textContent = `Funcion√°rio ID ${id} exclu√≠do com sucesso.`;
          divResposta.className = "alert alert-success";
          limparFormulario();
        } catch (error) {
          divResposta.textContent = `Erro ao excluir funcion√°rio: ${error.message}`;
          divResposta.className = "alert alert-danger";
        } finally {
          modal.hide(); // Fecha o modal
        }
      };
    };
    divBotoes.appendChild(btnExcluir);

    // ======================== FUN√á√ïES DE SUPORTE ========================

    // Busca todos os funcion√°rios na API e chama a renderiza√ß√£o
    async function listAll() {
      API_DATA = await api.get("/api/v1/funcionarios");
      if (API_DATA.success) renderTable(filterData());
    }

    // Limpa o formul√°rio ap√≥s uma opera√ß√£o
    function limparFormulario(message) {
      // Exibe a mensagem recebida
      divResposta.textContent = message || "Opera√ß√£o realizada com sucesso!";
      divResposta.className = "alert alert-success";

      // Limpa os campos do formul√°rio
      txtId.value = "";
      txtNomeFuncionario.value = "";
      txtEmail.value = "";
      txtSenha.value = "";
      cboCargos.value = -1;
      chkValeTransporte.checked = false;
    }


    // -----------------------------------------------------------------------------
    // Fun√ß√£o respons√°vel por criar dinamicamente a tabela HTML com os dados
    // dos funcion√°rios vindos da API (ou filtrados).
    // -----------------------------------------------------------------------------
    function renderTable(dados) {

      // Obt√©m a refer√™ncia da div onde a tabela ser√° exibida.
      const divTabela = document.getElementById("divTabela");

      // Limpa o conte√∫do anterior da div (caso j√° exista uma tabela renderizada).
      // Isso garante que uma nova tabela ser√° criada do zero a cada atualiza√ß√£o.
      divTabela.innerHTML = "";

      // ---------------------------------------------------------------------------
      // 1Ô∏è‚É£ Cria√ß√£o do elemento <table> e configura√ß√£o b√°sica de estilo.
      // ---------------------------------------------------------------------------
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped"; // Usa classes Bootstrap

      // ---------------------------------------------------------------------------
      // 2Ô∏è‚É£ Cria√ß√£o do cabe√ßalho da tabela (<thead>).
      // ---------------------------------------------------------------------------

      const thead = document.createElement("thead");
      thead.className = "table-light"; // Cor de fundo clara para destacar o cabe√ßalho

      // Cria uma linha de cabe√ßalho (<tr>) com os nomes das colunas.
      const trHead = document.createElement("tr");

      // Lista de t√≠tulos das colunas que aparecer√£o no topo da tabela.
      ["ID", "Nome", "Email", "Vale Transporte", "Cargo", "A√ß√µes"].forEach(text => {
        const th = document.createElement("th"); // Cria um cabe√ßalho de coluna
        th.textContent = text; // Define o texto da coluna (ex: "Nome", "Email")
        trHead.appendChild(th); // Adiciona o <th> dentro da linha <tr>
      });

      // Adiciona a linha com os t√≠tulos dentro do cabe√ßalho e depois na tabela.
      thead.appendChild(trHead);
      table.appendChild(thead);

      // ---------------------------------------------------------------------------
      // 3Ô∏è‚É£ Cria√ß√£o do corpo da tabela (<tbody>) que conter√° os dados.
      // ---------------------------------------------------------------------------

      const tbody = document.createElement("tbody");

      // Para cada funcion√°rio recebido nos dados, cria uma nova linha (<tr>).
      dados.data.funcionarios.forEach(funcionario => {
        const tr = document.createElement("tr"); // Cria uma linha da tabela

        // -------------------------------------------------------
        // 3.1Ô∏è‚É£ Colunas b√°sicas: ID, Nome e Email.
        // -------------------------------------------------------
        // Percorre essas tr√™s propriedades e cria uma c√©lula (<td>) para cada uma.
        ["idFuncionario", "nomeFuncionario", "email"].forEach(key => {
          const td = document.createElement("td");
          td.textContent = funcionario[key]; // Pega o valor direto do objeto
          tr.appendChild(td); // Adiciona a c√©lula √† linha atual
        });

        // -------------------------------------------------------
        // 3.2Ô∏è‚É£ Coluna que mostra se o funcion√°rio recebe vale-transporte.
        // -------------------------------------------------------
        const tdVale = document.createElement("td");
        // Converte o valor num√©rico (1/0) para texto ("Sim"/"N√£o")
        tdVale.textContent = funcionario.recebeValeTransporte == 1 ? "Sim" : "N√£o";
        tr.appendChild(tdVale);

        // -------------------------------------------------------
        // 3.3Ô∏è‚É£ Coluna que mostra o nome do cargo do funcion√°rio.
        // -------------------------------------------------------
        const tdCargo = document.createElement("td");
        tdCargo.textContent = funcionario.cargo.nomeCargo; // Acessa o nome dentro do objeto "cargo"
        tr.appendChild(tdCargo);

        // -------------------------------------------------------
        // 3.4Ô∏è‚É£ Coluna de a√ß√µes (bot√µes Selecionar e Excluir).
        // -------------------------------------------------------

        // Cria um container flex√≠vel para os bot√µes
        const divBotoes = document.createElement("div");
        divBotoes.className = "d-flex gap-2"; // Flex horizontal com espa√ßamento

        const tdAcoes = document.createElement("td");

        // =======================================================
        // Bot√£o ‚ÄúSelecionar‚Äù ‚Äî preenche o formul√°rio com os dados do funcion√°rio
        // quando o usu√°rio deseja atualizar ou consultar detalhes.
        // =======================================================
        const btnSel = createButton("Selecionar", "btn-info");

        // Quando clicado, os campos do formul√°rio s√£o preenchidos automaticamente.
        btnSel.onclick = () => {
          txtId.value = funcionario.idFuncionario;
          txtNomeFuncionario.value = funcionario.nomeFuncionario;
          txtEmail.value = funcionario.email;
          txtSenha.value = ""; // Por seguran√ßa, a senha n√£o √© exibida
          cboCargos.value = funcionario.cargo.idCargo;
          chkValeTransporte.checked = funcionario.recebeValeTransporte == 1;

          // Limpa mensagens de status (sucesso/erro) da tela.
          divResposta.textContent = "";
          divResposta.className = "";
        };
        divBotoes.appendChild(btnSel)
        // Adiciona o bot√£o ‚ÄúSelecionar‚Äù dentro da c√©lula de a√ß√µes.
        tdAcoes.appendChild(divBotoes);



        // Por fim, adiciona a c√©lula de a√ß√µes √† linha do funcion√°rio.
        tr.appendChild(tdAcoes);

        // E adiciona a linha completa (<tr>) ao corpo da tabela (<tbody>).
        tbody.appendChild(tr);
      });

      // Adiciona o corpo √† tabela.
      table.appendChild(tbody);

      // ---------------------------------------------------------------------------
      // 4Ô∏è‚É£ Exibe a tabela completa dentro da div principal (divTabela).
      // Isso substitui qualquer conte√∫do anterior (gra√ßas ao innerHTML = "").
      // ---------------------------------------------------------------------------
      divTabela.appendChild(table);
    }


    // Preenche os dois selects (cadastro e filtro) com os cargos vindos da API
    function preencherSelectCargos(dados) {
      cboCargos.innerHTML = '<option value="-1">Selecione um cargo</option>';
      dados.data.cargos.forEach(cargo => {
        const option = document.createElement("option");
        option.value = cargo.idCargo;
        option.textContent = cargo.nomeCargo;
        cboCargos.appendChild(option);
      });

      cboCargosFiltro.innerHTML = '<option value="-1">Selecione um cargo</option>';
      dados.data.cargos.forEach(cargo => {
        const option = document.createElement("option");
        option.value = cargo.idCargo;
        option.textContent = cargo.nomeCargo;
        cboCargosFiltro.appendChild(option);
      });
    }

    // Busca a lista de cargos na API logo que a p√°gina √© carregada
    const cargos = await api.get("/api/v1/cargos");
    preencherSelectCargos(cargos);

    // ======================== FILTROS EM TEMPO REAL ========================
    // A cada digita√ß√£o ou mudan√ßa em um campo, a tabela √© filtrada
    [txtFiltroNome, cboCargosFiltro, chkValeTransporteFiltro].forEach(el => {
      if (el.type === "checkbox") {
        el.addEventListener("change", () => renderTable(filterData()));
      } else {
        el.addEventListener("input", () => renderTable(filterData()));
      }
    });

    // -----------------------------------------------------------------------------
    // Fun√ß√£o que aplica os filtros de nome, cargo e vale-transporte aos funcion√°rios
    // -----------------------------------------------------------------------------
    function filterData() {

      // Verifica se os dados da API ainda n√£o foram carregados ou est√£o incompletos.
      // Se n√£o houver dados v√°lidos, simplesmente retorna o que tiver em API_DATA
      // (evita erros ao tentar acessar propriedades indefinidas).
      if (!API_DATA || !API_DATA.data || !API_DATA.data.funcionarios) return API_DATA;

      // ---------------------------------------------------------------------------
      // Captura os valores digitados ou selecionados nos filtros:
      // ---------------------------------------------------------------------------

      // Pega o texto do campo de nome, remove espa√ßos extras e converte para min√∫sculas.
      // Isso garante que a busca n√£o seja sens√≠vel a mai√∫sculas/min√∫sculas.
      const nomeFiltro = txtFiltroNome.value.trim().toLowerCase();

      // Converte o valor selecionado no combo de cargos (que vem como string) em n√∫mero.
      // Se nenhum cargo for escolhido, o valor ser√° -1.
      const cargoFiltro = parseInt(cboCargosFiltro.value);

      // Se a caixa de vale-transporte estiver marcada, valeFiltro = 1; caso contr√°rio, 0.
      // Isso √© √∫til porque o campo na API provavelmente √© num√©rico (1 = sim, 0 = n√£o).
      const valeFiltro = chkValeTransporteFiltro.checked ? 1 : 0;

      // ValeFiltroAtivo indica se o usu√°rio realmente quer filtrar por vale-transporte.
      // Ou seja, s√≥ aplicaremos esse filtro se a caixa estiver marcada.
      const valeFiltroAtivo = chkValeTransporteFiltro.checked;

      // ---------------------------------------------------------------------------
      // Cria uma nova lista com apenas os funcion√°rios que atendem aos filtros:
      // ---------------------------------------------------------------------------

      const dadosFiltrados = API_DATA.data.funcionarios.filter(f => {
        // Come√ßamos assumindo que o funcion√°rio ser√° exibido.
        let match = true;

        // 1Ô∏è‚É£ Filtro por nome:
        // Se o campo de nome n√£o estiver vazio, verifica se o nome do funcion√°rio cont√©m
        // o texto digitado (compara√ß√£o em min√∫sculas para evitar diferen√ßas de mai√∫sculas/min√∫sculas).
        if (nomeFiltro) {
          match = match && f.nomeFuncionario.toLowerCase().includes(nomeFiltro);
        }

        // 2Ô∏è‚É£ Filtro por cargo:
        // S√≥ aplica o filtro se um cargo espec√≠fico tiver sido escolhido (diferente de -1).
        // Compara o id do cargo do funcion√°rio com o cargo selecionado.
        if (!isNaN(cargoFiltro) && cargoFiltro != -1) {
          match = match && f.cargo.idCargo === cargoFiltro;
        }

        // 3Ô∏è‚É£ Filtro por vale-transporte:
        // S√≥ aplica se o usu√°rio tiver marcado a op√ß√£o "Recebe Vale Transporte".
        // Assim, apenas funcion√°rios com recebeValeTransporte === 1 ser√£o mostrados.
        if (valeFiltroAtivo) {
          match = match && f.recebeValeTransporte === valeFiltro;
        }

        // Retorna true se o funcion√°rio passou em todos os filtros aplic√°veis.
        return match;
      });

      // ---------------------------------------------------------------------------
      // Retorna um novo objeto no mesmo formato do original (API_DATA),
      // mas substitui a lista completa de funcion√°rios pela lista filtrada.
      // Isso permite que a fun√ß√£o renderTable() use o mesmo formato sempre.
      // ---------------------------------------------------------------------------
      return {
        data: {
          funcionarios: dadosFiltrados
        }
      };
    }

    // Ao carregar a p√°gina, faz a primeira listagem
    listAll();
  </script>
</body>

</html>