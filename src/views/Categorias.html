<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Categorias - Portal Supermercado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>
    // --- PROTETOR DE P√ÅGINA (Permanece igual) ---
    const userDataString = localStorage.getItem("userData");
    if (!userDataString) {
      window.location.replace("Login.html");
      throw new Error("Usu√°rio n√£o autenticado.");
    }
    try {
      const userData = JSON.parse(userDataString);
      if (!userData?.data?.id) {
        throw new Error("Dados de usu√°rio inv√°lidos.");
      }
    } catch (error) {
      console.error("Sess√£o inv√°lida:", error.message);
      localStorage.removeItem("userData");
      window.location.replace("Login.html");
      throw new Error("Sess√£o inv√°lida.");
    }
  </script>
  <link href="css/dashboard.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/logo.png">

  <style>
    /* (Estilos CSS permanecem os mesmos) */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
    .logo { font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
    .search-bar { margin-left: 2rem; margin-right: 2rem; width: 100%; max-width: 450px; }
    .search-bar input { width: 100%; padding: 0.6rem 1rem; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.95rem; }
    .search-bar input:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); outline: none; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
    .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
    .btn-logout:hover { background-color: #bb2d3b; }
    .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
    .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
    .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <header class="header">
      <div class="logo">PORTAL SUPERMERCADO</div>
      <div class="search-bar">
        <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
        <span id="userNameDisplay"></span>
        <button id="logoutButton" class="btn-logout">Sair</button>
      </div>
    </header>
    <aside class="sidebar">
      <nav>
        <ul>
          <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
          <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
          <li class="ticket-item" id="menu-link-chamado"><a href="Chamado.html" title="Abrir Chamado (Airus)"><span class="icon">‚ûï</span><span class="text">Chamado</span></a></li>
          <li><a href="Chatbot.html" title="Chatbot"><span class="icon">ü§ñ</span><span class="text">Chatbot</span></a></li>
          <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
          <li class="active"><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
         
        </ul>
      </nav>
    </aside>

    <main class="main-content container-fluid">
      <h2>Gerenciamento de Categorias</h2>
      <hr>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm widget">
            <div class="card-header">
              <strong>Cadastro / Edi√ß√£o (Categoria Pai)</strong>
            </div>
            <div class="card-body">
              <form id="formCategoria">
                <div class="mb-3">
                  <label for="txtId" class="form-label">ID</label>
                  <input type="text" id="txtId" class="form-control" disabled>
                </div>
                <div class="mb-3">
                  <label for="txtNomeCategoria" class="form-label">Nome da Categoria</label>
                  <input type="text" id="txtNomeCategoria" class="form-control" required>
                </div>
              </form>
              <div id="divBotoes" class="d-grid gap-2 d-md-flex"></div>
              <div id="divResposta" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm mb-4 widget">
            <div class="card-header"><strong>Filtros</strong></div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-12">
                  <label for="txtFiltroCategoria" class="form-label">Filtrar por Nome</label>
                  <input type="text" id="txtFiltroCategoria" class="form-control" placeholder="Digite o nome da categoria...">
                </div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm widget">
            <div class="card-header"><strong>Categorias Cadastradas</strong></div>
            <div class="card-body">
              <div id="divTabela" class="table-responsive">
                <p>Carregando...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal fade" id="modalSubcategoria" tabindex="-1" aria-labelledby="modalSubcategoriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content widget">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="modalSubcategoriaLabel">Subcategorias</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div class="row">
            
            <div class="col-md-5">
              <h5>Cadastro / Edi√ß√£o</h5>
              <form id="formSubcategoria">
                <div class="mb-3">
                  <label for="txtIdSub" class="form-label">ID</label>
                  <input type="text" id="txtIdSub" class="form-control" disabled>
                </div>
                <div class="mb-3">
                  <label for="txtNomeSub" class="form-label">Nome da Subcategoria</label>
                  <input type="text" id="txtNomeSub" class="form-control" required>
                </div>
              </form>
              <div id="divBotoesModal" class="d-grid gap-2 d-md-flex">
                </div>
              <div id="divRespostaModal" class="mt-3"></div>
            </div>

            <div class="col-md-7">
              <h5>Subcategorias Atuais</h5>
              <div id="divTabelaModal" class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>


  <script type="module">
    const API_URL = "";

    // --- FUN√á√ïES DE LOGOUT E NOME/MENU ---
    function fazerLogout() {
      localStorage.removeItem("userData");
      window.location.href = "Login.html";
    }

    // --- (NOVO) L√ìGICA DO TEMA ESCURO ---
    const btnThemeToggle = document.getElementById("themeToggle");
    const linkThemeToggle = document.getElementById("themeToggleLink");
    
    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        let isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        if (btnThemeToggle) {
            btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è";
        } else {
            document.body.classList.remove("dark-mode");
            if (btnThemeToggle) btnThemeToggle.textContent = "üåô";
        }
    }
    
    // Adiciona os gatilhos
    if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
    if (linkThemeToggle) linkThemeToggle.addEventListener('click', toggleTheme);

    // Carrega o tema salvo IMEDIATAMENTE
    loadTheme();
    // --- FIM L√ìGICA DO TEMA ---


    try {
      const userData = JSON.parse(userDataString);
      const userNameDisplay = document.getElementById('userNameDisplay');
      if (userNameDisplay && userData?.data?.nomeFuncionario) {
        userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
      }
      const userPerfil = userData?.data?.perfil;
      const linkChamadoLi = document.getElementById("menu-link-chamado");
      if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
        const a = linkChamadoLi.querySelector('a');
        const textSpan = a.querySelector('.text');
        a.href = "GerenciarChamados.html";
        a.title = "Gerenciar Chamados";
        a.querySelector('.icon').textContent = "‚úîÔ∏è";
        textSpan.innerHTML = "Gerenciar<br>Chamados";
      }
    } catch (error) {
      console.error("Erro ao tentar exibir o nome do usu√°rio:", error);
    }

    // --- VARI√ÅVEIS GLOBAIS ---
    let API_DATA_CATEGORIAS;
    let idCategoriaPaiAtual = null; 

    // --- REFER√äNCIAS (CATEGORIA) ---
    const txtId = document.getElementById("txtId");
    const txtNomeCategoria = document.getElementById("txtNomeCategoria");
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");
    const divTabela = document.getElementById("divTabela");
    const btnLogout = document.getElementById("logoutButton");
    const txtFiltroCategoria = document.getElementById("txtFiltroCategoria");

    // --- REFER√äNCIAS (MODAL) ---
    const modalSubcategoria = new bootstrap.Modal('#modalSubcategoria');
    const modalTitulo = document.getElementById('modalSubcategoriaLabel');
    const txtIdSub = document.getElementById('txtIdSub');
    const txtNomeSub = document.getElementById('txtNomeSub');
    const divBotoesModal = document.getElementById('divBotoesModal');
    const divRespostaModal = document.getElementById('divRespostaModal');
    const divTabelaModal = document.getElementById('divTabelaModal');

    // --- FUN√á√ïES HELPER ---
    function createButton(text, id, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.id = id;
      btn.className = `btn ${className} flex-fill`;
      return btn;
    }

    // Limpar formul√°rio PRINCIPAL
    function limparFormulario(message = "") {
      if (message) {
        divResposta.textContent = message;
        divResposta.className = "alert alert-success mt-3";
      } else {
        divResposta.textContent = "";
        divResposta.className = "";
      }
      txtId.value = "";
      txtNomeCategoria.value = "";
    }

    // Erro formul√°rio PRINCIPAL
    function exibirErro(mensagem) {
      divResposta.textContent = mensagem;
      divResposta.className = 'alert alert-danger mt-3';
    }

    // --- NOVAS FUN√á√ïES HELPER PARA O MODAL ---
    function limparFormularioSub(message = "") {
      if (message) {
        divRespostaModal.textContent = message;
        divRespostaModal.className = "alert alert-success mt-3";
      } else {
        divRespostaModal.textContent = "";
        divRespostaModal.className = "";
      }
      txtIdSub.value = "";
      txtNomeSub.value = "";
    }

    function exibirErroModal(mensagem) {
      divRespostaModal.textContent = mensagem;
      divRespostaModal.className = 'alert alert-danger mt-2 p-2';
    }


    // --- CRUD DE CATEGORIAS (PRINCIPAL) ---
    const btnCriar = createButton("Criar", "btnCriar", "btn-success");
    btnCriar.onclick = async () => {
      if (txtNomeCategoria.value.trim() === "") {
        exibirErro("Por favor, preencha o nome da categoria.");
        return;
      }
      const dadosCadastro = { categoria: { nome: txtNomeCategoria.value.trim() } };
      try {
        const response = await fetch(`${API_URL}/categorias`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosCadastro) });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
        limparFormulario("Categoria criada com sucesso!");
        await listAll();
      } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnCriar);

    const btnAtualizar = createButton("Atualizar", "btnAtualizar", "btn-warning");
    btnAtualizar.onclick = async () => {
      const id = txtId.value;
      if (!id) { exibirErro("Selecione uma categoria da lista para atualizar."); return; }
      if (txtNomeCategoria.value.trim() === "") { exibirErro("O nome da categoria √© obrigat√≥rio para atualizar."); return; }
      const dadosAtualizar = { categoria: { nome: txtNomeCategoria.value.trim() } };
      try {
        const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAtualizar) });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
        limparFormulario("Categoria atualizada com sucesso!");
        await listAll();
      } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnAtualizar);

    const btnExcluir = createButton("Excluir", "btnExcluir", "btn-danger");
    btnExcluir.onclick = async () => {
      const id = txtId.value;
      if (!id) { exibirErro("Selecione uma categoria da lista para excluir."); return; }
      if (confirm("Tem certeza que deseja excluir esta categoria? Isso pode afetar subcategorias.")) {
        try {
          const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'DELETE' });
          const respostaAPI = await response.json();
          if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
          limparFormulario("Categoria exclu√≠da com sucesso!");
          await listAll();
        } catch (error) { exibirErro(error.message); }
      }
    };
    divBotoes.appendChild(btnExcluir);

    // --- LISTAGEM DE CATEGORIAS (PRINCIPAL) ---
    async function listAll() {
      try {
        const response = await fetch(`${API_URL}/categorias`);
        if (!response.ok) throw new Error("Erro ao buscar categorias.");
        API_DATA_CATEGORIAS = await response.json();
        renderTable(API_DATA_CATEGORIAS);
      } catch (error) {
        exibirErro(error.message);
      }
    }

    // Tabela PRINCIPAL
    function renderTable(categorias) {
      divTabela.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped table-hover";
      table.innerHTML = `
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>A√ß√µes</th> </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if (categorias && categorias.length > 0) {
        categorias.forEach(cat => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${cat.id}</td>
            <td>${cat.nome}</td>
            <td>
              <button class="btn btn-sm btn-info btn-selecionar">Selecionar</button>
              <button class="btn btn-sm btn-secondary btn-ver-sub">Subcategorias</button>
            </td>
          `;
          tr.querySelector('.btn-selecionar').addEventListener('click', () => {
            txtId.value = cat.id;
            txtNomeCategoria.value = cat.nome || '';
            divResposta.innerHTML = "";
          });
          tr.querySelector('.btn-ver-sub').addEventListener('click', () => {
            abrirModalSubcategorias(cat.id, cat.nome);
          });
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma categoria encontrada.</td></tr>';
      }
      divTabela.appendChild(table);
    }

    // --- FILTRO DE CATEGORIAS (PRINCIPAL) ---
    function filterData() {
      if (!API_DATA_CATEGORIAS) return;
      const nomeFiltro = txtFiltroCategoria.value.trim().toLowerCase();
      const dadosFiltrados = API_DATA_CATEGORIAS.filter(cat => {
        let match = true;
        if (nomeFiltro) {
          match = match && cat.nome.toLowerCase().includes(nomeFiltro);
        }
        return match;
      });
      renderTable(dadosFiltrados);
    }
    

    // ---
    // ==================================================================
    // ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† L√ìGICA DO MODAL ATUALIZADA
    // ==================================================================
    // ---

    // 1. Fun√ß√£o para abrir o modal
    async function abrirModalSubcategorias(id, nome) {
      idCategoriaPaiAtual = id; 
      modalTitulo.textContent = `Subcategorias de: ${nome}`;
      limparFormularioSub(); 
      await carregarSubcategoriasNoModal(id); 
      modalSubcategoria.show(); 
    }

    // 2. Fun√ß√£o para buscar e RENDERIZAR A TABELA DENTRO do modal
    async function carregarSubcategoriasNoModal(idCategoriaPai) {
      divTabelaModal.innerHTML = "<p>Carregando...</p>";
      
      try {
        const response = await fetch(`${API_URL}/subcategorias`);
        if (!response.ok) throw new Error("Erro ao buscar subcategorias.");
        
        const todasSubcategorias = await response.json();
        const subcategoriasFilhas = todasSubcategorias.filter(sub => sub.id_categoria === idCategoriaPai);

        divTabelaModal.innerHTML = "";
        
        const table = document.createElement("table");
        table.className = "table table-bordered table-striped table-hover table-sm";
        table.innerHTML = `
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        if (subcategoriasFilhas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma subcategoria encontrada.</td></tr>';
        } else {
          subcategoriasFilhas.forEach(sub => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${sub.id}</td>
              <td>${sub.nome}</td>
              <td><button class="btn btn-sm btn-info btn-selecionar-sub">Selecionar</button></td>
            `;
            
            // --- ESTA √â A CORRE√á√ÉO ---
            // Event listener para preencher o formul√°rio DO MODAL
            tr.querySelector('.btn-selecionar-sub').addEventListener('click', () => {
              txtIdSub.value = sub.id;
              txtNomeSub.value = sub.nome;
              // Limpa apenas a mensagem de erro, n√£o o formul√°rio
              divRespostaModal.innerHTML = ""; 
              divRespostaModal.className = "";
            });
            // --- FIM DA CORRE√á√ÉO ---
            
            tbody.appendChild(tr);
          });
        }
        divTabelaModal.appendChild(table);
        
      } catch (error) {
        divTabelaModal.innerHTML = `<p class='text-danger'>${error.message}</p>`;
      }
    }

    // 3. CRIANDO OS BOT√ïES DO MODAL (s√≥ precisa fazer isso uma vez)
    const btnCriarSub = createButton("Criar", "btnCriarSub", "btn-success");
    const btnAtualizarSub = createButton("Atualizar", "btnAtualizarSub", "btn-warning");
    const btnExcluirSub = createButton("Excluir", "btnExcluirSub", "btn-danger");
    divBotoesModal.append(btnCriarSub, btnAtualizarSub, btnExcluirSub);

    // 4. Event listener para o bot√£o CRIAR DENTRO do modal
    btnCriarSub.addEventListener('click', async () => {
      const nomeNovaSub = txtNomeSub.value.trim();
      if (nomeNovaSub === "") {
        exibirErroModal("O nome √© obrigat√≥rio.");
        return;
      }
      
      const dadosCadastro = {
        subcategoria: {
          nome: nomeNovaSub,
          id_categoria: idCategoriaPaiAtual 
        }
      };

      try {
        const response = await fetch(`${API_URL}/subcategorias`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosCadastro)
        });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro");

        limparFormularioSub("Subcategoria criada com sucesso!");
        await carregarSubcategoriasNoModal(idCategoriaPaiAtual);

      } catch (error) {
        exibirErroModal(error.message);
      }
    });
    
    // 5. Event listener para o bot√£o ATUALIZAR DENTRO do modal
    btnAtualizarSub.addEventListener('click', async () => {
      const idSub = txtIdSub.value;
      if (!idSub) {
        exibirErroModal("Selecione uma subcategoria da lista para atualizar.");
        return;
      }
      
      const nomeSub = txtNomeSub.value.trim();
      if (nomeSub === "") {
        exibirErroModal("O nome √© obrigat√≥rio.");
        return;
      }

      const dadosAtualizar = {
        subcategoria: {
          nome: nomeSub,
          id_categoria: idCategoriaPaiAtual
        }
      };

      try {
        const response = await fetch(`${API_URL}/subcategorias/${idSub}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dadosAtualizar)
        });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro");

        limparFormularioSub("Subcategoria atualizada com sucesso!");
        await carregarSubcategoriasNoModal(idCategoriaPaiAtual);

      } catch (error) {
        exibirErroModal(error.message);
      }
    });

    // 6. Event listener para o bot√£o EXCLUIR DENTRO do modal
    btnExcluirSub.addEventListener('click', async () => {
      const idSub = txtIdSub.value;
      if (!idSub) {
        exibirErroModal("Selecione uma subcategoria da lista para excluir.");
        return;
      }

      if (confirm(`Tem certeza que deseja excluir esta subcategoria?`)) {
        try {
          const response = await fetch(`${API_URL}/subcategorias/${idSub}`, { method: 'DELETE' });
          const respostaAPI = await response.json();
          if (!response.ok) throw new Error(respostaAPI.message || "Erro");

          limparFormularioSub("Subcategoria exclu√≠da com sucesso!");
          await carregarSubcategoriasNoModal(idCategoriaPaiAtual);

        } catch (error) {
          exibirErroModal(error.message);
        }
      }
    });


    // --- INICIALIZA√á√ÉO ---
    if (txtFiltroCategoria) txtFiltroCategoria.addEventListener("input", filterData);
    if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

    async function init() {
      await listAll(); // Carrega a tabela principal de categorias
    }

    init();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>