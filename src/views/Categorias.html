<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Categorias - Portal Supermercado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>
    const userDataString = localStorage.getItem("userData");
    if (!userDataString) {
      window.location.replace("Login.html");
      throw new Error("Usu√°rio n√£o autenticado.");
    }
    try {
      const userData = JSON.parse(userDataString);
      if (!userData?.data?.id) {
        throw new Error("Dados de usu√°rio inv√°lidos.");
      }
    } catch (error) {
      console.error("Sess√£o inv√°lida:", error.message);
      localStorage.removeItem("userData");
      window.location.replace("Login.html");
      throw new Error("Sess√£o inv√°lida.");
    }
  </script>
  <link href="css/dashboard.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/logo.png">

  <style>
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
    .logo { font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
    .search-bar { margin-left: 2rem; margin-right: 2rem; width: 100%; max-width: 450px; }
    .search-bar input { width: 100%; padding: 0.6rem 1rem; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.95rem; }
    .search-bar input:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); outline: none; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
    .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
    .btn-logout:hover { background-color: #bb2d3b; }
    .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
    .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
    .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { height: 30px; width: auto; }

    /* --- CORES DAS PRIORIDADES --- */
    .badge-prioridade { 
        padding: 5px 10px; 
        border-radius: 12px; 
        font-size: 0.8rem; 
        font-weight: 700; 
        color: #fff; 
        text-transform: uppercase; 
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    /* Verde para Baixa */
    .badge-baixa { background-color: #28a745; }    
    /* Amarelo para M√©dia (texto escuro para contraste) */
    .badge-media { background-color: #ffc107; color: #333; }
    /* Laranja para Alta */
    .badge-alta { background-color: #fd7e14; }     
    /* Vermelho para Urgente/Planejado */
    .badge-urgente, .badge-planejado { background-color: #dc3545; }  
  </style>
</head>

<body>
  <div class="dashboard-container">
    <header class="header">
      <div class="logo">
            <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
      
      <div class="header-actions">
        <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
        <span id="userNameDisplay"></span>
        <button id="logoutButton" class="btn-logout">Sair</button>
      </div>
    </header>
    <aside class="sidebar">
      <nav>
        <ul>
          <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
          <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
          <li class="ticket-item" id="menu-link-chamado"><a href="Chamado.html" title="Abrir Chamado (Airus)"><span class="icon">‚ûï</span><span class="text">Chamado</span></a></li>
          <li><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
          <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
          <li class="active"><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content container-fluid">
      <h2>Gerenciamento de Categorias</h2>
      <hr>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm widget">
            <div class="card-header">
              <strong>Cadastro / Edi√ß√£o</strong>
            </div>
            <div class="card-body">
              <form id="formCategoria">
                <div class="mb-3">
                  <label for="txtId" class="form-label">ID</label>
                  <input type="text" id="txtId" class="form-control" disabled>
                </div>
                <div class="mb-3">
                  <label for="txtNomeCategoria" class="form-label">Nome da Categoria</label>
                  <input type="text" id="txtNomeCategoria" class="form-control" required>
                </div>
                
                <div class="mb-3">
                  <label for="cboParent" class="form-label">Categoria Pai</label>
                  <select id="cboParent" class="form-select">
                    <option value="">-- Nenhuma (Categoria Principal) --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="cboPrioridade" class="form-label">Prioridade Padr√£o</label>
                  <select id="cboPrioridade" class="form-select">
                    <option value="BAIXA">Baixa</option>
                    <option value="M√©dia">M√©dia</option>
                    <option value="Alta">Alta</option>
                    <option value="Planejado">Planejado / Urgente</option>
                  </select>
                  <div class="form-text text-muted" style="font-size: 0.8rem;">Chamados desta categoria iniciar√£o com esta prioridade.</div>
                </div>
                
              </form>
              <div id="divBotoes" class="d-grid gap-2 d-md-flex"></div>
              <div id="divResposta" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm mb-4 widget">
            <div class="card-header"><strong>Filtros</strong></div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-12">
                  <label for="txtFiltroCategoria" class="form-label">Filtrar por Nome (em ambas as tabelas)</label>
                  <input type="text" id="txtFiltroCategoria" class="form-control" placeholder="Digite o nome da categoria...">
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm widget">
            <div class="card-header"><strong>Gerenciamento (Todas as Categorias)</strong></div>
            <div class="card-body">
              <div id="divTabela" class="table-responsive">
                <p>Carregando...</p>
              </div>
            </div>
          </div>

          <div class="card shadow-sm widget mt-4">
            <div class="card-header"><strong>Relat√≥rio de Subcategorias</strong></div>
            <div class="card-body">
              <div id="divSubTabela" class="table-responsive">
                <p>Carregando...</p>
              </div>
            </div>
          </div>
          </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script src="js/globalNotification.js"></script>

  <script type="module">
    const API_URL = "";

    function fazerLogout() { localStorage.removeItem("userData"); window.location.href = "Login.html"; }
    
    const btnThemeToggle = document.getElementById("themeToggle");
    const linkThemeToggle = document.getElementById("themeToggleLink");
    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        let isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        if (btnThemeToggle) btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    }
    function loadTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è";
        } else {
            document.body.classList.remove("dark-mode");
            if (btnThemeToggle) btnThemeToggle.textContent = "üåô";
        }
    }
    if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
    if (linkThemeToggle) linkThemeToggle.addEventListener('click', toggleTheme);
    loadTheme();
    try {
      const userData = JSON.parse(userDataString);
      const userNameDisplay = document.getElementById('userNameDisplay');
      if (userNameDisplay && userData?.data?.nomeFuncionario) {
        userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
      }
      const userPerfil = userData?.data?.perfil;
      const linkChamadoLi = document.getElementById("menu-link-chamado");
      if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
        const a = linkChamadoLi.querySelector('a');
        const textSpan = a.querySelector('.text');
        a.href = "GerenciarChamados.html";
        a.title = "Gerenciar Chamados";
        a.querySelector('.icon').textContent = "‚úîÔ∏è";
        textSpan.innerHTML = "Gerenciar<br>Chamados";
      }
    } catch (error) { console.error("Erro ao exibir usuario", error); }

    let API_DATA_CATEGORIAS = []; 

    const txtId = document.getElementById("txtId");
    const txtNomeCategoria = document.getElementById("txtNomeCategoria");
    const cboParent = document.getElementById("cboParent");
    const cboPrioridade = document.getElementById("cboPrioridade");
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");
    const divTabela = document.getElementById("divTabela");
    const btnLogout = document.getElementById("logoutButton");
    const txtFiltroCategoria = document.getElementById("txtFiltroCategoria");
    const divSubTabela = document.getElementById("divSubTabela"); 

    function createButton(text, id, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.id = id;
      btn.className = `btn ${className} flex-fill`;
      return btn;
    }

    function limparFormulario(message = "") {
      if (message) {
        divResposta.textContent = message;
        divResposta.className = "alert alert-success mt-3";
      } else {
        divResposta.textContent = "";
        divResposta.className = "";
      }
      txtId.value = "";
      txtNomeCategoria.value = "";
      cboParent.value = "";
      cboPrioridade.value = "BAIXA"; // Reset para o padr√£o
    }

    function exibirErro(mensagem) {
      divResposta.textContent = mensagem;
      divResposta.className = 'alert alert-danger mt-3';
    }

    // --- HELPER PARA GERAR O HTML DA BADGE ---
    function getBadgeHtml(prioridade) {
        const p = prioridade || 'BAIXA';
        const pLower = p.toLowerCase();
        let badgeClass = 'badge-baixa'; // Padr√£o Verde

        if(pLower === 'm√©dia' || pLower === 'media') badgeClass = 'badge-media'; // Amarelo
        if(pLower === 'alta') badgeClass = 'badge-alta'; // Laranja
        if(pLower === 'planejado' || pLower === 'urgente') badgeClass = 'badge-planejado'; // Vermelho

        return `<span class="badge-prioridade ${badgeClass}">${p}</span>`;
    }

    // --- CRUD DE CATEGORIAS ---
    const btnCriar = createButton("Criar", "btnCriar", "btn-success");
    btnCriar.onclick = async () => {
      if (txtNomeCategoria.value.trim() === "") {
        exibirErro("Por favor, preencha o nome da categoria.");
        return;
      }
      const dadosCadastro = { 
        categoria: { 
          nome: txtNomeCategoria.value.trim(),
          parent_id: cboParent.value ? parseInt(cboParent.value) : null,
          prioridade_padrao: cboPrioridade.value // Envia a prioridade
        } 
      };
      
      try {
        const response = await fetch(`${API_URL}/categorias`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosCadastro) });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
        
        limparFormulario("Categoria criada com sucesso!");
        await listAll(); 
      } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnCriar);

    const btnAtualizar = createButton("Atualizar", "btnAtualizar", "btn-warning");
    btnAtualizar.onclick = async () => {
      const id = txtId.value;
      if (!id) { exibirErro("Selecione uma categoria da lista para atualizar."); return; }
      
      if (txtNomeCategoria.value.trim() === "") { exibirErro("O nome da categoria √© obrigat√≥rio para atualizar."); return; }
      
      const dadosAtualizar = { 
        categoria: { 
          nome: txtNomeCategoria.value.trim(),
          parent_id: cboParent.value ? parseInt(cboParent.value) : null,
          prioridade_padrao: cboPrioridade.value // Envia a prioridade
        } 
      };
      
      if (parseInt(id) === parseInt(dadosAtualizar.categoria.parent_id)) {
        exibirErro("Uma categoria n√£o pode ser pai de si mesma.");
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAtualizar) });
        const respostaAPI = await response.json();
        if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
        
        limparFormulario("Categoria atualizada com sucesso!");
        await listAll();
      } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnAtualizar);

    const btnExcluir = createButton("Excluir", "btnExcluir", "btn-danger");
    btnExcluir.onclick = async () => {
      const id = txtId.value;
      if (!id) { exibirErro("Selecione uma categoria da lista para excluir."); return; }
      if (confirm("Tem certeza que deseja excluir?")) {
        try {
          const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'DELETE' });
          const respostaAPI = await response.json();
          if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
          
          limparFormulario("Categoria exclu√≠da com sucesso!");
          await listAll();
        } catch (error) { exibirErro(error.message); }
      }
    };
    divBotoes.appendChild(btnExcluir);

    // --- LISTAGEM ---
    async function listAll() {
      try {
        const response = await fetch(`${API_URL}/categorias`, { method: 'GET', cache: 'no-store' });
        if (!response.ok) throw new Error("Erro ao buscar categorias.");
        API_DATA_CATEGORIAS = await response.json();
        
        renderTable(API_DATA_CATEGORIAS);
        const subcategorias = API_DATA_CATEGORIAS.filter(cat => cat.parent_id !== null);
        renderSubCategoriaTable(subcategorias); 
        preencherSelectPai(API_DATA_CATEGORIAS); 
        
      } catch (error) { exibirErro(error.message); }
    }
    
    function preencherSelectPai(categorias) {
        const idAtual = txtId.value; 
        cboParent.innerHTML = '<option value="">-- Nenhuma (Categoria Principal) --</option>';
        categorias.forEach(cat => {
            if (cat.id.toString() === idAtual) return; 
            const option = document.createElement("option");
            option.value = cat.id;
            if (cat.parent_id) {
                option.textContent = `... ${cat.nome} (Filha de: ${cat.nome_pai || '?'})`;
            } else {
                option.textContent = `${cat.nome} (Principal)`;
            }
            cboParent.appendChild(option);
        });
    }

    function renderTable(categorias) {
      divTabela.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped table-hover";
      table.innerHTML = `
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Categoria Pai</th>
            <th>Prioridade</th>
            <th>A√ß√µes</th> 
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if (categorias && categorias.length > 0) {
        categorias.forEach(cat => {
          const tr = document.createElement("tr");
          
          // Usa a fun√ß√£o helper para gerar a badge
          const badgeHtml = getBadgeHtml(cat.prioridade_padrao);

          tr.innerHTML = `
            <td>${cat.id}</td>
            <td>${cat.nome}</td>
            <td>${cat.nome_pai || '--'}</td> 
            <td>${badgeHtml}</td>
            <td>
              <button class="btn btn-sm btn-info btn-selecionar">Selecionar</button>
            </td>
          `;
          tr.querySelector('.btn-selecionar').addEventListener('click', () => {
            txtId.value = cat.id;
            txtNomeCategoria.value = cat.nome || '';
            cboPrioridade.value = cat.prioridade_padrao || "BAIXA"; 
            
            preencherSelectPai(API_DATA_CATEGORIAS); 
            cboParent.value = cat.parent_id || ""; 
            divResposta.innerHTML = "";
          });
          
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma categoria encontrada.</td></tr>';
      }
      divTabela.appendChild(table);
    }
    
    function renderSubCategoriaTable(subcategorias) {
      divSubTabela.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped"; 
      table.innerHTML = `
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome da Subcategoria</th>
            <th>Categoria Pai</th>
            <th>Prioridade</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if (subcategorias && subcategorias.length > 0) {
        subcategorias.forEach(cat => {
          // --- CORRE√á√ÉO APLICADA: Criando o TR antes de usar ---
          const tr = document.createElement("tr"); 
          
          // Usa a fun√ß√£o helper para gerar a badge
          const badgeHtml = getBadgeHtml(cat.prioridade_padrao);

          tr.innerHTML = `
            <td>${cat.id}</td>
            <td>${cat.nome}</td>
            <td>${cat.nome_pai || '(Pai n√£o encontrado)'}</td> 
            <td>${badgeHtml}</td> 
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhuma subcategoria encontrada.</td></tr>';
      }
      divSubTabela.appendChild(table);
    }

    function filterData() {
      if (!API_DATA_CATEGORIAS) return;
      const nomeFiltro = txtFiltroCategoria.value.trim().toLowerCase();
      
      const dadosFiltrados = API_DATA_CATEGORIAS.filter(cat => {
        let match = true;
        if (nomeFiltro) {
          match = (
            cat.nome.toLowerCase().includes(nomeFiltro) ||
            (cat.nome_pai && cat.nome_pai.toLowerCase().includes(nomeFiltro))
          );
        }
        return match;
      });
      
      renderTable(dadosFiltrados);
      const subCategoriasFiltradas = dadosFiltrados.filter(cat => cat.parent_id !== null);
      renderSubCategoriaTable(subCategoriasFiltradas);
    }
    
    if (txtFiltroCategoria) txtFiltroCategoria.addEventListener("input", filterData);
    if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

    async function init() {
      await listAll(); 
    }

    init();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>