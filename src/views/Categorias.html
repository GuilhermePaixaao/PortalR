<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Categorias - Portal Supermercado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script>
    // --- PROTETOR DE P√ÅGINA (Permanece igual) ---
    const userDataString = localStorage.getItem("userData");
    if (!userDataString) {
      window.location.replace("Login.html"); 
      throw new Error("Usu√°rio n√£o autenticado.");
    }
    try {
      const userData = JSON.parse(userDataString);
      if (!userData?.data?.id) {
        throw new Error("Dados de usu√°rio inv√°lidos.");
      }
    } catch (error) {
      console.error("Sess√£o inv√°lida:", error.message);
      localStorage.removeItem("userData"); 
      window.location.replace("Login.html"); 
      throw new Error("Sess√£o inv√°lida.");
    }
  </script>
  <link href="css/dashboard.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/logo.png">
  
  <style>
    /* (Seus estilos .header, .logo, etc. permanecem os mesmos) */
    .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1030; }
    .logo { font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
    .search-bar { margin-left: 2rem; margin-right: 2rem; width: 100%; max-width: 450px; }
    .search-bar input { width: 100%; padding: 0.6rem 1rem; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.95rem; }
    .search-bar input:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); outline: none; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
    .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
    .btn-logout:hover { background-color: #bb2d3b; }
    .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
    .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
    .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }
    
    /* Estilo para a lista de subcategorias dentro do modal */
    .subcategoria-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <header class="header">
        <div class="logo">PORTAL SUPERMERCADO</div>
        <div class="search-bar">
          <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
        </div>
        <div class="header-actions">
          <span id="userNameDisplay"></span>
          <button id="logoutButton" class="btn-logout">Sair</button>
        </div>
    </header>

    <aside class="sidebar">
        <nav>
            <ul>
              <li><a href="Dashboard.html" title="In√≠cio"><span class="icon">üè†</span><span class="text">In√≠cio</span></a></li>
              <li><a href="Imprimir.html" title="Impress√£o de Pre√ßos"><span class="icon">üñ®Ô∏è</span><span class="text">Imprimir</span></a></li>
              <li class="ticket-item" id="menu-link-chamado"><a href="Chamado.html" title="Abrir Chamado (Airus)"><span class="icon">‚ûï</span><span class="text">Chamado</span></a></li>
              <li><a href="Chatbot.html" title="Chatbot"><span class="icon">ü§ñ</span><span class="text">Chatbot</span></a></li>
              <li><a href="Funcionarios.html" title="Funcion√°rios"><span class="icon">üíº</span><span class="text">Funcion√°rios</span></a></li>
              <li class="active"><a href="Categorias.html" title="Categorias"><span class="icon">üè∑Ô∏è</span><span class="text">Categorias</span></a></li>
              <li style="margin-top: 30px;"><a href="#" title="Configura√ß√µes"><span class="icon">‚öôÔ∏è</span><span class="text">Ajustes</span></a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content container-fluid">
      <h2>Gerenciamento de Categorias</h2>
      <hr>

      <div class="row g-4">
        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header">
              <strong>Cadastro / Edi√ß√£o (Categoria Pai)</strong>
            </div>
            <div class="card-body">
              <form id="formCategoria">
                <div class="mb-3">
                  <label for="txtId" class="form-label">ID</label>
                  <input type="text" id="txtId" class="form-control" disabled>
                </div>
                <div class="mb-3">
                  <label for="txtNomeCategoria" class="form-label">Nome da Categoria</label>
                  <input type="text" id="txtNomeCategoria" class="form-control" required>
                </div>
              </form>
              <div id="divBotoes" class="d-grid gap-2 d-md-flex"></div>
              <div id="divResposta" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm mb-4">
            <div class="card-header"><strong>Filtros</strong></div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-12">
                  <label for="txtFiltroCategoria" class="form-label">Filtrar por Nome</label>
                  <input type="text" id="txtFiltroCategoria" class="form-control" placeholder="Digite o nome da categoria...">
                </div>
              </div>
            </div>
          </div>
          <div class="card shadow-sm">
            <div class="card-header"><strong>Categorias Cadastradas</strong></div>
            <div class="card-body">
              <div id="divTabela" class="table-responsive">
                <p>Carregando...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>


  <div class="modal fade" id="modalSubcategoria" tabindex="-1" aria-labelledby="modalSubcategoriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="modalSubcategoriaLabel">Subcategorias</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <div id="listaSubcategorias" class="mb-3">
            </div>

          <hr>
          
          <label class="form-label"><strong>Adicionar Nova Subcategoria</strong></label>
          <div id="divRespostaModal" class="mt-2"></div>
          <div class="input-group">
            <input type="text" id="txtNomeNovaSub" class="form-control" placeholder="Nome da nova subcategoria...">
            <button class="btn btn-success" type="button" id="btnSalvarNovaSub">Salvar</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script type="module">
    const API_URL = "";

    // --- FUN√á√ïES DE LOGOUT E NOME/MENU (Permanece igual) ---
    function fazerLogout() {
      localStorage.removeItem("userData"); 
      window.location.href = "Login.html"; 
    }
    try {
      const userData = JSON.parse(userDataString);
      const userNameDisplay = document.getElementById('userNameDisplay');
      if (userNameDisplay && userData?.data?.nomeFuncionario) {
        userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
      }
      const userPerfil = userData?.data?.perfil; 
      const linkChamadoLi = document.getElementById("menu-link-chamado"); 
      if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
        const a = linkChamadoLi.querySelector('a');
        const textSpan = a.querySelector('.text');
        a.href = "GerenciarChamados.html"; 
        a.title = "Gerenciar Chamados";
        a.querySelector('.icon').textContent = "‚úîÔ∏è"; 
        textSpan.innerHTML = "Gerenciar<br>Chamados";
      }
    } catch (error) {
      console.error("Erro ao tentar exibir o nome do usu√°rio:", error);
    }
    
    // --- VARI√ÅVEIS GLOBAIS ---
    let API_DATA_CATEGORIAS; 
    let idCategoriaPaiAtual = null; // NOVO: Guarda o ID da Categoria Pai clicada

    // --- REFER√äNCIAS DE ELEMENTOS (CATEGORIA) ---
    const txtId = document.getElementById("txtId");
    const txtNomeCategoria = document.getElementById("txtNomeCategoria");
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");
    const divTabela = document.getElementById("divTabela");
    const btnLogout = document.getElementById("logoutButton");
    const txtFiltroCategoria = document.getElementById("txtFiltroCategoria");

    // --- NOVO: REFER√äNCIAS DE ELEMENTOS (MODAL) ---
    const modalSubcategoria = new bootstrap.Modal('#modalSubcategoria');
    const modalTitulo = document.getElementById('modalSubcategoriaLabel');
    const modalListaBody = document.getElementById('listaSubcategorias');
    const txtNomeNovaSub = document.getElementById('txtNomeNovaSub');
    const btnSalvarNovaSub = document.getElementById('btnSalvarNovaSub');
    const divRespostaModal = document.getElementById('divRespostaModal');

    // --- FUN√á√ïES DE HELPER (limpar, erro, etc.) ---
    function createButton(text, id, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.id = id;
      btn.className = `btn ${className} flex-fill`;
      return btn;
    }

    function limparFormulario(message = "") {
      if (message) {
        divResposta.textContent = message;
        divResposta.className = "alert alert-success mt-3";
      } else {
        divResposta.textContent = "";
        divResposta.className = "";
      }
      txtId.value = "";
      txtNomeCategoria.value = "";
    }

    function exibirErro(mensagem) {
      divResposta.textContent = mensagem;
      divResposta.className = 'alert alert-danger mt-3';
    }
    
    // NOVO: Fun√ß√£o para exibir erro DENTRO do modal
    function exibirErroModal(mensagem) {
        divRespostaModal.textContent = mensagem;
        divRespostaModal.className = 'alert alert-danger mt-2 p-2';
    }
    function limparErroModal() {
        divRespostaModal.textContent = '';
        divRespostaModal.className = '';
    }


    // --- CRUD DE CATEGORIAS (PRINCIPAL) ---
    // (L√≥gica de Criar, Atualizar, Excluir Categoria permanece a mesma)
    const btnCriar = createButton("Criar", "btnCriar", "btn-success");
    btnCriar.onclick = async () => { /* ...l√≥gica de criar categoria... */ 
        if (txtNomeCategoria.value.trim() === "") {
            exibirErro("Por favor, preencha o nome da categoria.");
            return;
        }
        const dadosCadastro = { categoria: { nome: txtNomeCategoria.value.trim() } };
        try {
            const response = await fetch(`${API_URL}/categorias`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosCadastro) });
            const respostaAPI = await response.json();
            if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
            limparFormulario("Categoria criada com sucesso!");
            listAll();
        } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnCriar);

    const btnAtualizar = createButton("Atualizar", "btnAtualizar", "btn-warning");
    btnAtualizar.onclick = async () => { /* ...l√≥gica de atualizar categoria... */ 
        const id = txtId.value;
        if (!id) { exibirErro("Selecione uma categoria da lista para atualizar."); return; }
        if (txtNomeCategoria.value.trim() === "") { exibirErro("O nome da categoria √© obrigat√≥rio para atualizar."); return; }
        const dadosAtualizar = { categoria: { nome: txtNomeCategoria.value.trim() } };
        try {
            const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dadosAtualizar) });
            const respostaAPI = await response.json();
            if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
            limparFormulario("Categoria atualizada com sucesso!");
            listAll();
        } catch (error) { exibirErro(error.message); }
    };
    divBotoes.appendChild(btnAtualizar);

    const btnExcluir = createButton("Excluir", "btnExcluir", "btn-danger");
    btnExcluir.onclick = async () => { /* ...l√≥gica de excluir categoria... */ 
        const id = txtId.value;
        if (!id) { exibirErro("Selecione uma categoria da lista para excluir."); return; }
        if (confirm("Tem certeza que deseja excluir esta categoria? Isso pode afetar subcategorias.")) {
            try {
                const response = await fetch(`${API_URL}/categorias/${id}`, { method: 'DELETE' });
                const respostaAPI = await response.json();
                if (!response.ok) throw new Error(respostaAPI.message || "Erro desconhecido");
                limparFormulario("Categoria exclu√≠da com sucesso!");
                listAll();
            } catch (error) { exibirErro(error.message); }
        }
    };
    divBotoes.appendChild(btnExcluir);

    // --- LISTAGEM DE CATEGORIAS (PRINCIPAL) ---
    async function listAll() {
      try {
        const response = await fetch(`${API_URL}/categorias`);
        if (!response.ok) throw new Error("Erro ao buscar categorias.");
        API_DATA_CATEGORIAS = await response.json();
        renderTable(API_DATA_CATEGORIAS);
      } catch (error) {
        exibirErro(error.message);
      }
    }

    //
    // ETAPA 2: ATUALIZAR RENDERTABLE
    //
    function renderTable(categorias) {
      divTabela.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped table-hover";
      table.innerHTML = `
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>A√ß√µes</th> </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      if (categorias && categorias.length > 0) {
        categorias.forEach(cat => {
          const tr = document.createElement("tr");
          
          // NOVO BOT√ÉO ADICIONADO AQUI
          tr.innerHTML = `
            <td>${cat.id}</td>
            <td>${cat.nome}</td>
            <td>
              <button class="btn btn-sm btn-info btn-selecionar">Selecionar</button>
              <button class="btn btn-sm btn-secondary btn-ver-sub">Subcategorias</button>
            </td>
          `;

          // Event listener do bot√£o "Selecionar" (igual)
          tr.querySelector('.btn-selecionar').addEventListener('click', () => {
            txtId.value = cat.id;
            txtNomeCategoria.value = cat.nome || '';
            divResposta.innerHTML = "";
          });

          // NOVO EVENT LISTENER para o bot√£o "Subcategorias"
          tr.querySelector('.btn-ver-sub').addEventListener('click', () => {
            abrirModalSubcategorias(cat.id, cat.nome);
          });

          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhuma categoria encontrada.</td></tr>';
      }
      divTabela.appendChild(table);
    }

    // --- FILTRO DE CATEGORIAS (PRINCIPAL) ---
    function filterData() {
      if (!API_DATA_CATEGORIAS) return;
      const nomeFiltro = txtFiltroCategoria.value.trim().toLowerCase();
      const dadosFiltrados = API_DATA_CATEGORIAS.filter(cat => {
        let match = true;
        if (nomeFiltro) {
          match = match && cat.nome.toLowerCase().includes(nomeFiltro);
        }
        return match;
      });
      renderTable(dadosFiltrados);
    }
    

    // ---
    // ETAPA 3: NOVAS FUN√á√ïES JAVASCRIPT PARA O MODAL
    // ---

    // 1. Fun√ß√£o para abrir o modal e carregar os dados
    async function abrirModalSubcategorias(id, nome) {
      idCategoriaPaiAtual = id; // Salva o ID do pai
      modalTitulo.textContent = `Subcategorias de: ${nome}`; // Define o t√≠tulo
      limparErroModal();
      txtNomeNovaSub.value = "";
      
      await carregarSubcategoriasNoModal(id); // Puxa os dados
      
      modalSubcategoria.show(); // Abre o modal
    }

    // 2. Fun√ß√£o para buscar e renderizar a lista DENTRO do modal
    async function carregarSubcategoriasNoModal(idCategoriaPai) {
      modalListaBody.innerHTML = "<p>Carregando...</p>"; // Placeholder
      
      try {
        const response = await fetch(`${API_URL}/subcategorias`);
        if (!response.ok) throw new Error("Erro ao buscar subcategorias.");
        
        const todasSubcategorias = await response.json();
        
        // Filtra a lista para mostrar apenas as filhas da categoria pai
        const subcategoriasFilhas = todasSubcategorias.filter(sub => sub.id_categoria === idCategoriaPai);

        modalListaBody.innerHTML = ""; // Limpa o "Carregando..."
        
        if (subcategoriasFilhas.length === 0) {
            modalListaBody.innerHTML = "<p class='text-center'>Nenhuma subcategoria encontrada.</p>";
            return;
        }

        // Renderiza cada item da lista
        subcategoriasFilhas.forEach(sub => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'subcategoria-item';
            itemDiv.innerHTML = `
                <span>${sub.nome}</span>
                <button class="btn btn-sm btn-outline-danger btn-excluir-sub" data-id="${sub.id}">Excluir</button>
            `;
            modalListaBody.appendChild(itemDiv);
        });
        
      } catch (error) {
        modalListaBody.innerHTML = `<p class='text-danger'>${error.message}</p>`;
      }
    }

    // 3. Event listener para o bot√£o SALVAR DENTRO do modal
    btnSalvarNovaSub.addEventListener('click', async () => {
        const nomeNovaSub = txtNomeNovaSub.value.trim();
        if (nomeNovaSub === "") {
            exibirErroModal("O nome √© obrigat√≥rio.");
            return;
        }
        
        const dadosCadastro = {
            subcategoria: {
                nome: nomeNovaSub,
                id_categoria: idCategoriaPaiAtual // Usa o ID pai que salvamos
            }
        };

        try {
            const response = await fetch(`${API_URL}/subcategorias`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosCadastro)
            });
            const respostaAPI = await response.json();
            if (!response.ok) throw new Error(respostaAPI.message || "Erro");

            // Sucesso! Limpa o campo e recarrega a lista do modal
            txtNomeNovaSub.value = "";
            limparErroModal();
            await carregarSubcategoriasNoModal(idCategoriaPaiAtual);

        } catch (error) {
            exibirErroModal(error.message);
        }
    });
    
    // 4. Event listener para os bot√µes EXCLUIR DENTRO do modal
    // Usamos "event delegation" pois os bot√µes s√£o criados dinamicamente
    modalListaBody.addEventListener('click', async (e) => {
        if (e.target && e.target.classList.contains('btn-excluir-sub')) {
            const idSub = e.target.getAttribute('data-id');
            
            if (confirm(`Tem certeza que deseja excluir esta subcategoria?`)) {
                try {
                    const response = await fetch(`${API_URL}/subcategorias/${idSub}`, { method: 'DELETE' });
                    const respostaAPI = await response.json();
                    if (!response.ok) throw new Error(respostaAPI.message || "Erro");

                    // Sucesso! Recarrega a lista do modal
                    await carregarSubcategoriasNoModal(idCategoriaPaiAtual);

                } catch (error) {
                    exibirErroModal(error.message);
                }
            }
        }
    });


    // --- INICIALIZA√á√ÉO ---
    if (txtFiltroCategoria) txtFiltroCategoria.addEventListener("input", filterData);
    if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

    async function init() {
      await listAll(); // Carrega a tabela principal de categorias
    }

    init();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>