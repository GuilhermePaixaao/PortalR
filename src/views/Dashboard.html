<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Supermercado - Dashboard</title>

    <script>
        // --- IN√çCIO DO PROTETOR DE P√ÅGINA (ANTI-FLICKER E AUTH) ---
        const userDataString = localStorage.getItem("userData");
        
        if (!userDataString) {
            window.location.replace("Login.html"); 
            throw new Error("Usu√°rio n√£o autenticado.");
        }

        try {
            const userData = JSON.parse(userDataString);
            if (!userData?.data?.id) {
                throw new Error("Dados de usu√°rio inv√°lidos.");
            }
        } catch (error) {
            console.error("Sess√£o inv√°lida:", error.message);
            localStorage.removeItem("userData"); 
            window.location.replace("Login.html"); 
            throw new Error("Sess√£o inv√°lida.");
        }

        // --- (NOVO) APLICAR TEMA IMEDIATAMENTE PARA EVITAR PISCAR ---
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
            document.documentElement.classList.add("dark-mode");
            document.body?.classList.add("dark-mode"); // Caso body j√° exista
        }
        // --- FIM DO PROTETOR ---
    </script>
    
    <link rel="icon" type="image/png" href="/logo.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- DEFINI√á√ÉO DE CORES E VARI√ÅVEIS (SUPORTE DARK MODE) --- */
        :root {
            --primary-green: #00cba9;
            --primary-green-hover: #00b395;
            
            /* Vari√°veis do Modal (Tema Claro Padr√£o) */
            --modal-bg: #ffffff;
            --modal-text: #212529;
            --modal-header-border: #eee;
            --input-bg: #ffffff;
            --input-border: #dee2e6;
            --input-text: #212529;
            --label-color: #555;
            --btn-cancel-bg: #f1f3f5;
            --btn-cancel-text: #495057;
            --btn-cancel-hover: #e9ecef;
        }

        /* Sobrescrita para Tema Escuro */
        body.dark-mode {
            --modal-bg: #2b3035;
            --modal-text: #f8f9fa;
            --modal-header-border: #495057;
            --input-bg: #212529;
            --input-border: #495057;
            --input-text: #f8f9fa;
            --label-color: #ced4da;
            --btn-cancel-bg: #343a40;
            --btn-cancel-text: #e9ecef;
            --btn-cancel-hover: #495057;
        }

        /* --- Estilos do Header --- */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0.75rem 2rem;
            background-color: var(--modal-bg); /* Adapta o fundo do header se necess√°rio, ou manter fixo */
            border-bottom: 1px solid var(--modal-header-border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1030;
            transition: background-color 0.3s, border-color 0.3s;
        }
        /* Ajuste espec√≠fico se o header do dashboard.css for fixo branco, aqui for√ßamos a vari√°vel se quiser */
        body.dark-mode .header {
            background-color: #1e1e1e; /* Cor t√≠pica de header dark */
            border-bottom-color: #333;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem; 
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            font-weight: 700;
            color: #0d6efd;
            text-transform: uppercase;
            margin: 0;
        }
        .logo-icon {
            height: 30px;
            width: auto;
        }

        /* --- BOT√ÉO DE NOVO TICKET NO HEADER --- */
        .btn-new-ticket {
            background-color: var(--primary-green);
            color: white;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 1.3rem;
            padding: 0;
        }
        .btn-new-ticket:hover {
            background-color: var(--primary-green-hover);
            transform: scale(1.1);
        }

        /* Bot√£o Logout e Outros */
        #userNameDisplay { font-weight: 500; color: inherit; white-space: nowrap; }
        .btn-logout {
            background-color: #dc3545; color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-logout:hover { background-color: #bb2d3b; }
        
        /* Ajustes Sidebar */
        .sidebar nav ul li a { display: flex; align-items: center; text-decoration: none; padding: 10px 15px; width: 100%; height: auto; }
        .sidebar .icon { margin-right: 10px; min-width: 20px; text-align: center; flex-shrink: 0; align-self: center; }
        .sidebar .text { flex-grow: 1; white-space: normal; line-height: 1.2; }

        /* Cards e Layout Dashboard */
        .stat-card { padding: 0.8rem 1rem; background-color: var(--modal-bg); color: var(--modal-text); border: 1px solid var(--modal-header-border); }
        .stat-card h3 { font-size: 1.05rem; margin-bottom: 2px; }
        .stat-card .stat-value { font-size: 1.75rem; }
        .stat-card .icon { font-size: 2.2rem; }
        
        /* Cores das Bordas dos Status */
        .stat-card.open { border-left: 5px solid #ffc107; }
        .stat-card.in-progress { border-left: 5px solid #0d6efd; }
        .stat-card.completed { border-left: 5px solid #198754; }
        
        .stat-card.open .stat-value { color: #ffc107; }
        .stat-card.in-progress .stat-value { color: #0d6efd; }
        .stat-card.completed .stat-value { color: #198754; }

        .dashboard-flex-container {
            display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;
        }
        .dashboard-stack {
            display: flex; flex-direction: column; gap: 15px; width: 260px; flex-shrink: 0;
        }
        .chart-container {
            flex: 1; min-width: 250px;
        }
        .chart-container .widget { padding: 15px; background-color: var(--modal-bg); border-radius: 8px; border: 1px solid var(--modal-header-border); }
        .chart-container h3 { 
            margin-top: 0; margin-bottom: 10px; 
            border-bottom: 1px solid var(--modal-header-border); 
            padding-bottom: 8px; font-size: 1.1rem; color: var(--modal-text);
        }
        #chamadosPieChart { position: relative; max-height: 280px; width: 100% !important; }

        /* --- MODAL / DIALOG ADAPT√ÅVEL --- */
        dialog { 
            border: none; border-radius: 10px; padding: 0; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            width: 100%; max-width: 750px; 
            margin: auto; 
            background: var(--modal-bg); /* Usa vari√°vel */
            color: var(--modal-text);    /* Usa vari√°vel */
            transition: background-color 0.3s, color 0.3s;
        }
        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        
        .modal-content-wrapper { padding: 2rem; }
        .modal-header-custom { 
            margin-bottom: 1.5rem; 
            border-bottom: 1px solid var(--modal-header-border); /* Usa vari√°vel */
            padding-bottom: 1rem; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .modal-header-custom h2 { 
            font-size: 1.4rem; font-weight: 700; margin: 0; 
            color: var(--modal-text); /* Usa vari√°vel */
        }

        /* Formul√°rio no Modal */
        .grupo-form { margin-bottom: 1rem; }
        .grupo-form label { 
            font-size: 0.85rem; font-weight: 600; margin-bottom: 0.4rem; display: block; 
            color: var(--label-color); /* Usa vari√°vel */
        }
        .grupo-form .form-select, .grupo-form input, .grupo-form textarea { 
            font-size: 0.95rem; padding: 0.6rem; border-radius: 6px; 
            width: 100%; box-sizing: border-box; 
            /* Vari√°veis de Input */
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--input-text);
        }
        .grupo-form .form-select:focus, .grupo-form input:focus, .grupo-form textarea:focus { 
            border-color: #86b7fe; outline: none; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.15); 
        }

        .form-actions { 
            display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; 
            padding-top: 1rem; border-top: 1px solid var(--modal-header-border); 
        }
        .form-actions button { padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; }
        
        #fecharModal { 
            background: var(--btn-cancel-bg); 
            color: var(--btn-cancel-text); 
        }
        #fecharModal:hover { background: var(--btn-cancel-hover); }
        
        #criarTicket { background: #198754; color: white; }
        #criarTicket:hover { background: #157347; }

        .alert { padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.9rem; }
        .alert-success { background-color: #d1e7dd; color: #0f5132; }
        .alert-danger { background-color: #f8d7da; color: #842029; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        
        <header class="header">
           <div class="logo">
                <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
            
            <div class="header-actions">
                <button id="newTicketButton" class="btn-new-ticket" title="Novo Chamado">
                    <i class="bi bi-plus-lg"></i>
                </button>

                <button id="themeToggle" class="btn-theme-toggle" title="Alternar Tema">üåô</button>
                <span id="userNameDisplay"></span>
                <button id="logoutButton" class="btn-logout">Sair</button>
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li class="active">
                        <a href="Dashboard.html" title="In√≠cio">
                            <span class="icon">üè†</span>
                            <span class="text">In√≠cio</span>
                        </a>
                    </li>
                    <li>
                        <a href="Imprimir.html" title="Impress√£o de Pre√ßos">
                            <span class="icon">üñ®Ô∏è</span>
                            <span class="text">Imprimir</span>
                        </a>
                    </li>
                    <li class="ticket-item" id="menu-link-chamado">
                        <a href="Chamado.html" title="Abrir Chamado (Airus)">
                            <span class="icon">‚ûï</span>
                            <span class="text">Chamado</span>
                        </a>
                    </li>
                    <li><a href="AtendimentoWhatsApp.html" title="Atendimento WhatsApp"><span class="icon">üí¨</span><span class="text">WhatsApp</span></a></li>
                    <li>
                        <a href="Funcionarios.html" title="Funcion√°rios">
                            <span class="icon">üíº</span>
                            <span class="text">Funcion√°rios</span>
                        </a>
                    </li>
                    <li>
                        <a href="Categorias.html" title="Categorias">
                            <span class="icon">üè∑Ô∏è</span>
                            <span class="text">Categorias</span>
                        </a>
                    </li>    
                    <li><a href="GerenciarLojas.html"><span class="icon">üè¢</span> Lojas e Deptos</a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="dashboard-flex-container">
            
                <div class="dashboard-stack">
                    <div class="widget stat-card open">
                        <div class="stat-info">
                            <h3>Chamados Abertos</h3>
                            <span class="stat-value" id="abertoCount">0</span>
                        </div>
                        <div class="icon" style="color: #ffc107;">üö®</div>
                    </div>

                    <div class="widget stat-card in-progress">
                        <div class="stat-info">
                            <h3>Em Andamento</h3>
                            <span class="stat-value" id="andamentoCount">0</span>
                        </div>
                        <div class="icon" style="color: #0d6efd;">üõ†Ô∏è</div>
                    </div>

                    <div class="widget stat-card completed">
                        <div class="stat-info">
                            <h3>Conclu√≠dos</h3>
                            <span class="stat-value" id="concluidoCount">0</span>
                        </div>
                        <div class="icon" style="color: #198754;">‚úÖ</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="widget">
                        <h3>Chamados por Status</h3>
                        <canvas id="chamadosPieChart"></canvas>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <dialog id="modalTicket" aria-labelledby="modalTitle">
        <div class="modal-content-wrapper">
            <div class="modal-header-custom">
                <h2 id="modalTitle">Novo Chamado</h2>
            </div>
            <form id="ticketForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="nomeRequisitante">Seu Nome <span style="color:red;">*</span></label>
                            <input type="text" id="nomeRequisitante" name="nomeRequisitante" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="emailRequisitante">Seu Email (Opcional)</label>
                            <input type="email" id="emailRequisitante" name="emailRequisitante">
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="telefoneRequisitante">Seu Telefone <span style="color:red;">*</span></label>
                    <input type="tel" id="telefoneRequisitante" name="telefoneRequisitante" placeholder="(XX) XXXXX-XXXX" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="loja">Loja <span style="color:red;">*</span></label>
                            <select id="loja" name="loja" class="form-select" required>
                                <option value="">-- Carregando... --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="departamento">Departamento <span style="color:red;">*</span></label>
                            <select id="departamento" name="departamento" class="form-select" disabled required>
                                <option value="">-- Selecione Loja Primeiro --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <hr style="margin: 1.5rem 0; opacity: 0.1; border-color: var(--modal-header-border);">

                <div class="grupo-form">
                    <label for="assunto">Assunto <span style="color:red;">*</span></label>
                    <input type="text" id="assunto" name="assunto" required>
                </div>

                <div class="grupo-form">
                    <label for="descricao">Descri√ß√£o <span style="color:red;">*</span></label>
                    <textarea id="descricao" name="descricao" rows="4" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="M√©dia" selected>M√©dia</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="categoriaCascataWrapper">
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="anexo">Anexar Arquivos (Opcional - M√°x 20MB)</label>
                    <input type="file" id="anexo" name="anexos" multiple>
                </div>

                <div id="modalResposta"></div>

                <div class="form-actions">
                    <button type="button" id="fecharModal">Cancelar</button>
                    <button type="submit" id="criarTicket">Criar Chamado</button>
                </div>
            </form>
        </div>
    </dialog>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = ""; 
            let myPieChart = null;
            let userId = 1;
            let allCategories = [];

            // Refer√™ncias
            const btnThemeToggle = document.getElementById("themeToggle");
            const btnLogout = document.getElementById("logoutButton");
            
            // Refer√™ncias do Modal
            const modal = document.getElementById("modalTicket");
            const btnAbrir = document.getElementById("newTicketButton");
            const btnFechar = document.getElementById("fecharModal");
            const ticketForm = document.getElementById("ticketForm");
            const modalResposta = document.getElementById("modalResposta");
            const cascataWrapper = document.getElementById("categoriaCascataWrapper");
            const selectLoja = document.getElementById("loja");
            const selectDepartamento = document.getElementById("departamento");
            const selectPrioridade = document.getElementById("prioridade");
            const inputTelefone = document.getElementById("telefoneRequisitante");

            // --- Inicializa√ß√£o ---
            try {
                const userDataString = localStorage.getItem("userData");
                const userData = JSON.parse(userDataString); 
                const userNameDisplay = document.getElementById('userNameDisplay'); 
                
                if (userData?.data?.id) userId = userData.data.id;

                if (userNameDisplay && userData?.data?.nomeFuncionario) {
                    userNameDisplay.textContent = `Ol√°, ${userData.data.nomeFuncionario.split(' ')[0]}`;
                }

                const userPerfil = userData?.data?.perfil; 
                const linkChamadoLi = document.getElementById("menu-link-chamado"); 

                if (linkChamadoLi && (userPerfil === 'AGENTE' || userPerfil === 'ADMIN')) {
                    const a = linkChamadoLi.querySelector('a');
                    const textSpan = a.querySelector('.text');
                    a.href = "GerenciarChamados.html"; 
                    a.title = "Gerenciar Chamados";
                    a.querySelector('.icon').textContent = "‚úîÔ∏è"; 
                    textSpan.innerHTML = "Gerenciar<br>Chamados";
                    linkChamadoLi.classList.remove('active');
                }
            } catch (error) {
                console.error("Erro ao configurar p√°gina:", error.message);
            }
            
            function fazerLogout() {
                localStorage.removeItem("userData"); 
                window.location.href = "Login.html"; 
            }
            if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

            // --- L√≥gica de Tema Escuro ---
            function toggleTheme() {
                document.body.classList.toggle("dark-mode");
                // Verifica se tem a classe
                let isDark = document.body.classList.contains("dark-mode");
                localStorage.setItem("theme", isDark ? "dark" : "light");
                
                if (btnThemeToggle) btnThemeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem("theme");
                if (savedTheme === "dark") {
                    document.body.classList.add("dark-mode");
                    if (btnThemeToggle) btnThemeToggle.textContent = "‚òÄÔ∏è";
                } else {
                    document.body.classList.remove("dark-mode");
                    if (btnThemeToggle) btnThemeToggle.textContent = "üåô";
                }
            }
            
            if (btnThemeToggle) btnThemeToggle.addEventListener('click', toggleTheme);
            loadTheme(); // Carrega o tema tamb√©m no DOMContentLoaded para garantir bot√µes corretos

            // --- Dashboard Gr√°ficos ---
            function renderPieChart(counts) {
                const ctx = document.getElementById('chamadosPieChart');
                if (!ctx) return; 
                if (myPieChart) myPieChart.destroy();

                const data = {
                    labels: ['Chamados Abertos', 'Em Andamento', 'Conclu√≠dos'],
                    datasets: [{
                        label: 'Chamados',
                        data: [counts['Aberto'] || 0, counts['Em Andamento'] || 0, counts['Conclu√≠do'] || 0],
                        backgroundColor: ['#ffc107', '#0d6efd', '#198754'],
                        hoverOffset: 4
                    }]
                };

                // Pega a cor do texto do body para usar na legenda
                const computedStyle = getComputedStyle(document.body);
                const textColor = computedStyle.color;

                myPieChart = new Chart(ctx, {
                    type: 'pie', 
                    data: data,
                    options: {
                        responsive: true, maintainAspectRatio: false, 
                        plugins: {
                            legend: { 
                                position: 'right', 
                                labels: { 
                                    font: { size: 11 }, 
                                    padding: 10,
                                    color: textColor // Adapta a cor da legenda
                                } 
                            },
                            tooltip: { bodyFont: { size: 12 } }
                        }
                    }
                });
            }

            async function fetchChamadoCounts() {
                try {
                    const response = await fetch(`${API_URL}/chamados/contagem`);
                    if (!response.ok) return;
                    const counts = await response.json();
                    
                    const abertoEl = document.getElementById('abertoCount');
                    const andamentoEl = document.getElementById('andamentoCount');
                    const concluidoEl = document.getElementById('concluidoCount');
                    
                    if (abertoEl) abertoEl.textContent = counts['Aberto'] || 0;
                    if (andamentoEl) andamentoEl.textContent = counts['Em Andamento'] || 0;
                    if (concluidoEl) concluidoEl.textContent = counts['Conclu√≠do'] || 0;
                    
                    renderPieChart(counts);
                } catch (error) { console.error("Erro contagens:", error); }
            }

            // --- L√≥gica de Chamado ---
            function exibirMensagem(elemento, mensagem, sucesso = true) {
                elemento.textContent = mensagem;
                elemento.className = sucesso ? 'alert alert-success' : 'alert alert-danger';
            }
            function limparMensagem(elemento) {
                elemento.textContent = '';
                elemento.className = '';
            }
            function aplicarMascaraTelefone(input) {
                let valor = input.value.replace(/\D/g, "").substring(0, 11);
                if (valor.length > 6) valor = valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
                else if (valor.length > 2) valor = valor.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
                else if (valor.length > 0) valor = valor.replace(/^(\d{0,2}).*/, '($1');
                input.value = valor;
            }

            async function carregarLojasSelect() {
                try {
                    const response = await fetch(`${API_URL}/chamados/dados/lojas`);
                    if (!response.ok) throw new Error("Erro lojas");
                    const lojas = await response.json();
                    selectLoja.innerHTML = '<option value="">-- Selecione a Loja --</option>';
                    lojas.forEach(loja => selectLoja.add(new Option(loja.nome, loja.id)));
                } catch (error) { selectLoja.innerHTML = '<option value="">Erro ao carregar</option>'; }
            }

            async function carregarDepartamentosSelect(lojaId) {
                selectDepartamento.innerHTML = '<option value="">Carregando...</option>';
                selectDepartamento.disabled = true;
                if (!lojaId) {
                    selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/chamados/dados/lojas/${lojaId}/departamentos`);
                    if (!response.ok) throw new Error("Erro deptos");
                    const departamentos = await response.json();
                    selectDepartamento.innerHTML = '<option value="">-- Selecione o Departamento --</option>';
                    if (departamentos.length === 0) selectDepartamento.add(new Option("Nenhum vinculado", ""));
                    else departamentos.forEach(dept => selectDepartamento.add(new Option(dept.nome, dept.id)));
                    selectDepartamento.disabled = false; 
                } catch (error) { selectDepartamento.innerHTML = '<option value="">Erro ao carregar</option>'; }
            }

            async function carregarDadosIniciais() {
                try {
                    const response = await fetch(`${API_URL}/categorias`);
                    if (!response.ok) throw new Error("Erro categorias");
                    allCategories = await response.json(); 
                    cascataWrapper.innerHTML = ''; 
                    criarProximoDropdown(null, 0); 
                } catch (error) { cascataWrapper.innerHTML = '<p class="text-danger">Erro ao carregar categorias.</p>'; }
            }

            function criarProximoDropdown(parentId, level) {
                const children = allCategories.filter(c => c.parent_id == parentId);
                if (children.length === 0) return;
                const div = document.createElement('div');
                div.className = 'grupo-form';
                const label = document.createElement('label');
                label.textContent = level === 0 ? 'Categoria' : 'Subcategoria';
                const select = document.createElement('select');
                select.className = 'form-select';
                select.dataset.level = level; 
                select.add(new Option(level === 0 ? '-- Selecione uma Categoria --' : '-- Selecione uma Subcategoria --', ""));
                children.forEach(cat => select.add(new Option(cat.nome, cat.id)));
                div.appendChild(label);
                div.appendChild(select);
                cascataWrapper.appendChild(div);
            }

            function handleCascataChange(event) {
                const select = event.target;
                if (select.tagName !== 'SELECT') return;
                const selectedId = select.value;
                const level = parseInt(select.dataset.level);
                cascataWrapper.querySelectorAll('.grupo-form').forEach(div => {
                    if (parseInt(div.querySelector('select').dataset.level) > level) div.remove();
                });
                if (selectedId) {
                    criarProximoDropdown(selectedId, level + 1);
                    const cat = allCategories.find(c => c.id == selectedId);
                    if (cat && cat.prioridade_padrao) {
                        let p = cat.prioridade_padrao.toUpperCase();
                        let valor = 'M√©dia';
                        if (p === 'URGENTE' || p === 'ALTA') valor = 'Alta';
                        if (p === 'BAIXA') valor = 'Baixa';
                        if (p === 'MEDIA') valor = 'M√©dia';
                        
                        Array.from(selectPrioridade.options).forEach((opt, i) => {
                            if(opt.value === valor) selectPrioridade.selectedIndex = i;
                        });
                    }
                }
            }

            async function criarChamado(event) {
                event.preventDefault();
                limparMensagem(modalResposta);

                const nome = ticketForm.nomeRequisitante.value.trim();
                const tel = ticketForm.telefoneRequisitante.value.trim();
                const assunto = ticketForm.assunto.value.trim();
                const desc = ticketForm.descricao.value.trim();
                const loja = selectLoja.value;
                const depto = selectDepartamento.value;

                let categoriaUnificadaId = null;
                const allSelects = cascataWrapper.querySelectorAll('select');
                for (const select of allSelects) {
                    if (select.value) categoriaUnificadaId = select.value;
                    else break;
                }
                
                if (!nome || !tel || !loja || !depto || !assunto || !desc) {
                    exibirMensagem(modalResposta, 'Preencha os campos obrigat√≥rios (*).', false);
                    return;
                }
                if (!categoriaUnificadaId) {
                    exibirMensagem(modalResposta, 'Selecione a categoria final.', false);
                    return;
                }

                const files = document.getElementById('anexo').files;
                let totalSize = 0;
                for (let i = 0; i < files.length; i++) totalSize += files[i].size;
                if (totalSize > 20 * 1024 * 1024) {
                    exibirMensagem(modalResposta, 'Tamanho total excede 20MB.', false);
                    return;
                }

                const formData = new FormData();
                const dados = {
                    chamado: {
                        nome_requisitante_manual: nome,
                        email_requisitante_manual: ticketForm.emailRequisitante.value,
                        telefone_requisitante_manual: tel,
                        assunto: assunto,
                        descricao: desc,
                        prioridade: ticketForm.prioridade.value,
                        requisitante_id: userId,
                        categoria_unificada_id: parseInt(categoriaUnificadaId),
                        loja: loja,
                        departamento: depto
                    }
                };
                formData.append('chamado', JSON.stringify(dados.chamado));
                for (let i = 0; i < files.length; i++) formData.append('anexos', files[i]);

                try {
                    const response = await fetch(`${API_URL}/chamados`, { method: 'POST', body: formData });
                    const resAPI = await response.json();
                    if (!response.ok) throw new Error(resAPI.message || "Erro ao criar.");

                    alert("Chamado criado com sucesso!");
                    modal.close();
                    fetchChamadoCounts();
                } catch (error) {
                    exibirMensagem(modalResposta, error.message, false);
                }
            }

            function resetarModalForm() {
                ticketForm.reset();
                limparMensagem(modalResposta);
                cascataWrapper.innerHTML = '';
                criarProximoDropdown(null, 0); 
                selectLoja.value = "";
                selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
                selectDepartamento.disabled = true;
                try {
                    const uStr = localStorage.getItem("userData");
                    const u = JSON.parse(uStr);
                    if(u?.data?.nomeFuncionario) document.getElementById('nomeRequisitante').value = u.data.nomeFuncionario;
                    if(u?.data?.email) document.getElementById('emailRequisitante').value = u.data.email;
                } catch(e){}
            }

            // Listeners
            btnAbrir.addEventListener('click', () => {
                resetarModalForm();
                if (typeof modal.showModal === 'function') modal.showModal();
                else modal.setAttribute('open', '');
            });
            btnFechar.addEventListener('click', () => modal.close());
            ticketForm.addEventListener('submit', criarChamado);
            selectLoja.addEventListener('change', () => carregarDepartamentosSelect(selectLoja.value));
            cascataWrapper.addEventListener('change', handleCascataChange);
            if(inputTelefone) inputTelefone.addEventListener('input', () => aplicarMascaraTelefone(inputTelefone));

            // Inits
            fetchChamadoCounts(); 
            carregarDadosIniciais().catch(console.error);
            carregarLojasSelect().catch(console.error);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>