<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamados - Portal Supermercado</title>
    
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* --- ESTILO VISUAL NOVO (COMPACTO E CLEAN) --- */
        :root {
            --bg-body: #f4f6f8;
            --text-main: #212529;
            --text-muted: #6c757d;
            --primary-green: #00cba9; /* Verde do botão da imagem */
            --primary-green-hover: #00b395;
            --ticket-id-color: #00dbb5;
        }

        body { background-color: var(--bg-body); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.85rem; color: var(--text-main); }
        
        /* Layout Geral */
        .dashboard-container { padding: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
        
        /* Header */
        .header { 
            background: #fff; padding: 12px 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .logo { font-size: 1.1rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .logo-icon { height: 30px; width: auto; }

        /* Card de Filtros */
        .filters-card { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .form-control-sm, .form-select-sm, .btn-sm { font-size: 0.85rem; }

        /* Card da Tabela Principal */
        .card-table { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; display: flex; flex-direction: column; }
        
        /* --- GRID DA TABELA --- */
        .ticket-list { width: 100%; display: flex; flex-direction: column; }
        
        /* Definição das Colunas: ID | Prioridade | Assunto (largo) | Categoria | Status | Operador | Criado | Ação */
        .ticket-row { 
            display: grid; 
            grid-template-columns: 70px 100px 2fr 1.5fr 60px 140px 110px 50px; 
            align-items: center; 
            border-bottom: 1px solid #f0f0f0; 
            padding: 10px 15px; 
            transition: background 0.2s; 
            gap: 10px;
        }
        .ticket-row:hover:not(.header) { background-color: #fcfcfc; }
        
        /* Header da Tabela */
        .ticket-row.header { 
            background: #fff; border-bottom: 2px solid #f0f0f0; 
            font-weight: 700; color: #000; font-size: 0.8rem; 
            padding-top: 15px; padding-bottom: 15px;
        }
        
        /* Tipografia da Tabela */
        .t-cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .text-center { text-align: center; }
        .t-id { color: var(--ticket-id-color); font-weight: 700; font-size: 0.9rem; }
        
        /* Assunto e Descrição Empilhados */
        .t-subject-wrapper { display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .t-subject { font-weight: 700; font-size: 0.9rem; color: #000; margin-bottom: 1px; }
        .t-desc { font-size: 0.75rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Categoria (ATUALIZADO: white-space normal para exibir tudo) */
        .t-category { 
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            color: #000; 
            letter-spacing: 0.5px;
            white-space: normal; /* Permite quebra de linha para ver tudo */
            line-height: 1.2;
        }

        /* Operador/Requisitante */
        .t-operator { display: flex; flex-direction: column; line-height: 1.1; font-size: 0.8rem; }
        .op-name { font-weight: 700; color: #000; }
        .op-role { font-size: 0.7rem; color: #999; }

        /* Data */
        .t-date { font-weight: 600; font-size: 0.8rem; color: #000; }

        /* --- BADGES --- */
        .badge-outline {
            display: inline-block; padding: 3px 0; border-radius: 50px; 
            font-size: 0.7rem; font-weight: 700; text-align: center;
            background: #fff; border: 1px solid #ccc; width: 100%;
        }
        .bdg-planejado { border-color: #55b0b0; color: #55b0b0; }
        .bdg-medio, .bdg-media, .bdg-média { border-color: #ffaa00; color: #ffaa00; }
        .bdg-alta { border-color: #dc3545; color: #dc3545; }
        .bdg-baixa { border-color: #0d6efd; color: #0d6efd; }

        /* --- ÍCONES DE STATUS --- */
        .status-icon {
            width: 28px; height: 28px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            margin: 0 auto; font-size: 0.9rem;
        }
        .st-pausado { background-color: #ffda00; color: #fff; } /* Amarelo */
        .st-concluido, .st-concluído { background-color: #000; color: #fff; } /* Preto */
        .st-aberto { background-color: #ccc; color: #fff; }
        .st-andamento, .st-em-andamento { background-color: #0d6efd; color: #fff; }

        /* Ações */
        .btn-view { color: #999; cursor: pointer; font-size: 1.2rem; border: none; background: none; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 100%; }
        .btn-view:hover { color: #000; transform: scale(1.1); }

        /* Footer e Paginação */
        .table-footer { padding: 10px 25px; display: flex; justify-content: flex-end; align-items: center; border-top: 1px solid #f0f0f0; margin-top: auto; background-color: #fff; }
        .pagination-controls { display: flex; gap: 4px; }
        .pagination-controls button {
            border: 1px solid #eee; background: #fff; color: #0d6efd; 
            width: 30px; height: 30px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; font-size: 0.8rem;
        }
        .pagination-controls button.active { background-color: #0d6efd; color: #fff; border-color: #0d6efd; }
        .pagination-controls button:disabled { color: #ccc; cursor: default; }
        .pagination-controls button:hover:not(:disabled):not(.active) { background-color: #f9f9f9; }

        /* Botão Novo Ticket (Verde Flutuante) */
        .page-actions { position: fixed; bottom: 30px; right: 30px; z-index: 100; }
        .btn-new-ticket {
            background-color: var(--primary-green); color: white; border: none; 
            padding: 12px 30px; border-radius: 6px; font-weight: 700; font-size: 1rem; 
            box-shadow: 0 4px 12px rgba(0,203,169, 0.4); transition: 0.2s; cursor: pointer;
        }
        .btn-new-ticket:hover { background-color: var(--primary-green-hover); transform: translateY(-2px); }

        /* Loading */
        #loadingIndicator { padding: 3rem; text-align: center; color: #ccc; font-style: italic; }

        /* --- MODAIS ESTILIZADOS --- */
        dialog { border: none; border-radius: 10px; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 750px; background: #fff; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content-wrapper { padding: 2rem; }
        .modal-header { margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.4rem; font-weight: 700; margin: 0; color: #333; }
        
        /* Estilos de Formulário no Modal */
        .grupo-form { margin-bottom: 1rem; }
        .grupo-form label { font-size: 0.85rem; font-weight: 600; color: #555; margin-bottom: 0.4rem; display: block; }
        .grupo-form .form-select, .grupo-form input, .grupo-form textarea { font-size: 0.95rem; padding: 0.6rem; border-radius: 6px; border: 1px solid #dee2e6; width: 100%; box-sizing: border-box; }
        .grupo-form .form-select:focus, .grupo-form input:focus { border-color: #86b7fe; outline: none; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.15); }

        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .form-actions button { padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; }
        #fecharModal, #fecharModalDetalhes { background: #f1f3f5; color: #495057; }
        #fecharModal:hover, #fecharModalDetalhes:hover { background: #e9ecef; }
        #criarTicket { background: #198754; color: white; }
        #criarTicket:hover { background: #157347; }

        /* Estilos do Modal de Detalhes */
        .detalhe-grupo { margin-bottom: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 6px; }
        .detalhe-label { font-size: 0.75rem; text-transform: uppercase; color: #888; font-weight: 700; display: block; margin-bottom: 2px; }
        .detalhe-valor { font-weight: 500; color: #212529; font-size: 0.95rem; }
        .detalhe-descricao { white-space: pre-wrap; font-size: 0.95rem; line-height: 1.5; color: #444; }

        /* Comentários */
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .comment-header { font-weight: 700; font-size: 0.85rem; color: #333; margin-bottom: 4px; }
        .comment-date { font-weight: 400; color: #999; font-size: 0.75rem; margin-left: 5px; }
        .comment-body { font-size: 0.9rem; color: #555; }
        .comment-empty-state { color: #999; font-style: italic; text-align: center; padding: 10px; }
        
        /* Alertas */
        .alert { padding: 10px; margin-top: 10px; border-radius: 6px; font-size: 0.9rem; }
        .alert-success { background-color: #d1e7dd; color: #0f5132; }
        .alert-danger { background-color: #f8d7da; color: #842029; }
    </style>
</head>
<body>

    <div class="dashboard-container">

        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
        </header>

        <div class="filters-card">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label for="filtroAssunto" class="form-label small fw-bold text-muted mb-1">Buscar Assunto</label>
                    <input type="text" id="filtroAssunto" class="form-control form-control-sm" placeholder="Digite o assunto...">
                </div>
                <div class="col-md-3">
                    <label for="filtroPrioridade" class="form-label small fw-bold text-muted mb-1">Prioridade</label>
                    <select id="filtroPrioridade" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        <option value="Alta">Alta</option>
                        <option value="Média">Média</option>
                        <option value="Baixa">Baixa</option>
                        <option value="Planejado">Planejado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroStatus" class="form-label small fw-bold text-muted mb-1">Status</label>
                    <select id="filtroStatus" class="form-select form-select-sm">
                        <option value="">Todos</option>
                        <option value="Aberto">Aberto</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Pausado">Pausado</option> 
                        <option value="Concluído">Concluído</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button id="btnFiltrar" class="btn btn-sm btn-primary w-100 fw-bold">Filtrar</button>
                </div>
            </div>
        </div>

        <div id="divRespostaGeral"></div>

        <div class="card-table">
            <div id="ticketList" class="ticket-list">
                <div class="ticket-row header">
                    <div class="t-cell text-center">Ticket</div>
                    <div class="t-cell text-center">Prioridade</div>
                    <div class="t-cell">Assunto <span style="font-weight:400; color:#999; font-size:0.75rem;">/ Descrição</span></div>
                    <div class="t-cell">Categorias</div>
                    <div class="t-cell text-center">St.</div>
                    <div class="t-cell">Operador</div>
                    <div class="t-cell">Criado</div>
                    <div class="t-cell text-center"><i class="bi bi-gear-fill text-muted"></i></div>
                </div>
                
                <div id="loadingIndicator">Carregando chamados...</div>
            </div>
            
            <div class="table-footer">
                <div id="paginationControls" class="pagination-controls"></div>
            </div>
        </div>

        <div class="page-actions">
            <button id="newTicketButton" class="btn-new-ticket">
                Novo Ticket
            </button>
        </div>

    </div>

    <dialog id="modalTicket" aria-labelledby="modalTitle">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h2 id="modalTitle">Novo Chamado</h2>
            </div>
            <form id="ticketForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="nomeRequisitante">Seu Nome <span style="color:red;">*</span></label>
                            <input type="text" id="nomeRequisitante" name="nomeRequisitante" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="emailRequisitante">Seu Email (Opcional)</label>
                            <input type="email" id="emailRequisitante" name="emailRequisitante">
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="telefoneRequisitante">Seu Telefone <span style="color:red;">*</span></label>
                    <input type="tel" id="telefoneRequisitante" name="telefoneRequisitante" placeholder="(XX) XXXXX-XXXX" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="loja">Loja <span style="color:red;">*</span></label>
                            <select id="loja" name="loja" class="form-select" required>
                                <option value="">-- Carregando... --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="departamento">Departamento <span style="color:red;">*</span></label>
                            <select id="departamento" name="departamento" class="form-select" disabled required>
                                <option value="">-- Selecione Loja Primeiro --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <hr style="margin: 1.5rem 0; opacity: 0.1;">

                <div class="grupo-form">
                    <label for="assunto">Assunto <span style="color:red;">*</span></label>
                    <input type="text" id="assunto" name="assunto" required>
                </div>

                <div class="grupo-form">
                    <label for="descricao">Descrição <span style="color:red;">*</span></label>
                    <textarea id="descricao" name="descricao" rows="4" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="Média" selected>Média</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="categoriaCascataWrapper">
                            </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="anexo">Anexar Arquivos (Opcional - Máx 20MB)</label>
                    <input type="file" id="anexo" name="anexos" multiple>
                </div>

                <div id="modalResposta"></div>

                <div class="form-actions">
                    <button type="button" id="fecharModal">Cancelar</button>
                    <button type="submit" id="criarTicket">Criar Chamado</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="modalDetalhes" aria-labelledby="modalDetalhesTitle">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h2 id="modalDetalhesTitle">DETALHES DO CHAMADO</h2>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="detalhe-grupo">
                        <span class="detalhe-label">Assunto</span>
                        <div id="detalheAssunto" class="detalhe-valor">...</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="detalhe-grupo">
                        <span class="detalhe-label">Categoria</span>
                        <div id="detalheCategoria" class="detalhe-valor">...</div>
                    </div>
                </div>
            </div>

            <div class="detalhe-grupo">
                <span class="detalhe-label">Descrição</span>
                <div id="detalheDescricao" class="detalhe-descricao">...</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">Loja</span><div id="detalheLoja" class="detalhe-valor">...</div></div>
                </div>
                <div class="col-md-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">Departamento</span><div id="detalheDepartamento" class="detalhe-valor">...</div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <div class="detalhe-grupo"><span class="detalhe-label">Contato</span><span id="detalheRequisitante" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-4">
                    <div class="detalhe-grupo"><span class="detalhe-label">Status</span><span id="detalheStatus" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-4">
                    <div class="detalhe-grupo"><span class="detalhe-label">Prioridade</span><span id="detalhePrioridade" class="detalhe-valor">...</span></div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">ID do Ticket</span><span id="detalheId" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">Data Criação</span><span id="detalheData" class="detalhe-valor">...</span></div>
                </div>
            </div>

            <hr style="margin: 1.5rem 0; opacity: 0.1;">
            <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: #555;">HISTÓRICO DE COMENTÁRIOS</h3>
            
            <div id="listaComentariosContainer" style="max-height: 250px; overflow-y: auto;">
                <span class="comment-empty-state">Carregando comentários...</span>
            </div>
            
            <div class="form-actions">
                <button type="button" id="fecharModalDetalhes">Fechar</button>
            </div>
        </div>
    </dialog>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
        const API_URL = ""; 
        let userId = 1; 
        try {
            const userDataString = localStorage.getItem("userData");
            const userData = JSON.parse(userDataString);
            const idLogado = userData?.data?.id || userData?.id;
            if (idLogado) userId = idLogado;
            if (userData?.data?.nomeFuncionario) {
                const el = document.getElementById('userNameDisplay');
                if(el) el.innerHTML = `<strong>${userData.data.nomeFuncionario}</strong>`;
            }
        } catch (e) {
            console.error("Erro ao ler localStorage. Usando ID=1 padrão.", e);
        }

        let allTickets = [];
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        let allCategories = [];

        // Referências DOM
        const modal = document.getElementById("modalTicket");
        const btnAbrir = document.getElementById("newTicketButton");
        const btnFechar = document.getElementById("fecharModal");
        const ticketForm = document.getElementById("ticketForm");
        const ticketList = document.getElementById("ticketList");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const modalResposta = document.getElementById("modalResposta");
        const divRespostaGeral = document.getElementById("divRespostaGeral");
        const modalDetalhes = document.getElementById("modalDetalhes");
        const btnFecharModalDetalhes = document.getElementById("fecharModalDetalhes");
        
        // Filtros
        const filtroAssunto = document.getElementById("filtroAssunto");
        const filtroPrioridade = document.getElementById("filtroPrioridade");
        const filtroStatus = document.getElementById("filtroStatus");
        const btnFiltrar = document.getElementById("btnFiltrar");
        
        // Inputs
        const inputTelefone = document.getElementById("telefoneRequisitante");
        const listaComentariosContainer = document.getElementById("listaComentariosContainer");
        const paginationControls = document.getElementById("paginationControls");
        const selectPrioridade = document.getElementById("prioridade"); 
        const cascataWrapper = document.getElementById("categoriaCascataWrapper");
        const selectLoja = document.getElementById("loja");
        const selectDepartamento = document.getElementById("departamento");

        // --- Helpers Visuais ---
        const timeAgo = (dateStr) => {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000; 
            if(diff < 60) return 'agora';
            if(diff < 3600) return `há ${Math.floor(diff/60)} min`;
            if(diff < 86400) return `há ${Math.floor(diff/3600)} h`;
            return `há ${Math.floor(diff/86400)} dias`;
        };

        const getStatusIcon = (status) => {
            const s = (status || '').toLowerCase();
            if(s.includes('pausa')) return `<div class="status-icon st-pausado" title="Pausado"><i class="bi bi-pause-fill"></i></div>`;
            if(s.includes('conclu')) return `<div class="status-icon st-concluido" title="Concluído"><i class="bi bi-check-lg"></i></div>`;
            if(s.includes('aberto')) return `<div class="status-icon st-aberto" title="Aberto"><i class="bi bi-three-dots"></i></div>`;
            return `<div class="status-icon st-andamento" title="Em Andamento"><i class="bi bi-play-fill"></i></div>`;
        };

        const getBadgeClass = (prio) => {
            const p = (prio || 'Media').toLowerCase();
            if(p.includes('planej')) return 'bdg-planejado';
            if(p.includes('alta')) return 'bdg-alta';
            if(p.includes('baixa')) return 'bdg-baixa';
            return 'bdg-medio';
        };

        // --- Funções Auxiliares ---
        function exibirMensagem(elemento, mensagem, sucesso = true) {
            elemento.textContent = mensagem;
            elemento.className = sucesso ? 'alert alert-success' : 'alert alert-danger';
        }
        function limparMensagem(elemento) {
            elemento.textContent = '';
            elemento.className = '';
        }
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]);
        }
        function formatarData(isoString) {
            if (!isoString) return 'Aguardando...';
            try {
                const dt = new Date(isoString);
                const data = dt.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
                const hora = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
                return `${data} ${hora}`;
            } catch (e) { return 'Data inválida'; }
        }
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, "").substring(0, 11);
            if (valor.length > 6) valor = valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            else if (valor.length > 2) valor = valor.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
            else if (valor.length > 0) valor = valor.replace(/^(\d{0,2}).*/, '($1');
            input.value = valor;
        }

        // --- Lógica de Dados ---

        async function carregarLojasSelect() {
            try {
                const response = await fetch(`${API_URL}/chamados/dados/lojas`);
                if (!response.ok) throw new Error("Erro ao carregar lojas.");
                const lojas = await response.json();
                selectLoja.innerHTML = '<option value="">-- Selecione a Loja --</option>';
                lojas.forEach(loja => selectLoja.add(new Option(loja.nome, loja.id)));
            } catch (error) {
                console.error(error);
                selectLoja.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarDepartamentosSelect(lojaId) {
            selectDepartamento.innerHTML = '<option value="">Carregando...</option>';
            selectDepartamento.disabled = true;
            if (!lojaId) {
                selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
                return;
            }
            try {
                const response = await fetch(`${API_URL}/chamados/dados/lojas/${lojaId}/departamentos`);
                if (!response.ok) throw new Error("Erro ao carregar departamentos.");
                const departamentos = await response.json();
                selectDepartamento.innerHTML = '<option value="">-- Selecione o Departamento --</option>';
                if (departamentos.length === 0) selectDepartamento.add(new Option("Nenhum vinculado", ""));
                else departamentos.forEach(dept => selectDepartamento.add(new Option(dept.nome, dept.id)));
                selectDepartamento.disabled = false; 
            } catch (error) {
                console.error(error);
                selectDepartamento.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        selectLoja.addEventListener('change', () => carregarDepartamentosSelect(selectLoja.value));

        async function carregarDadosIniciais() {
            try {
                const response = await fetch(`${API_URL}/categorias`);
                if (!response.ok) throw new Error("Erro ao carregar categorias.");
                allCategories = await response.json(); 
                cascataWrapper.innerHTML = ''; 
                criarProximoDropdown(null, 0); 
            } catch (error) {
                console.error(error);
                cascataWrapper.innerHTML = '<p class="text-danger">Erro ao carregar categorias.</p>';
            }
        }
        
        function montarCaminhoCategoria(categoriaId) {
            if (!categoriaId) return 'N/A';
            let caminho = [];
            let currentId = categoriaId;
            let attempts = 0;
            while (currentId && attempts < 20) {
                const cat = allCategories.find(c => c.id == currentId);
                if (cat) {
                    caminho.unshift(cat.nome);
                    currentId = cat.parent_id;
                } else break;
                attempts++;
            }
            return caminho.join(' / ') || 'N/A';
        }
        
        function criarProximoDropdown(parentId, level) {
            const children = allCategories.filter(c => c.parent_id == parentId);
            if (children.length === 0) return;
            const div = document.createElement('div');
            div.className = 'grupo-form';
            const label = document.createElement('label');
            label.textContent = level === 0 ? 'Categoria' : 'Subcategoria';
            const select = document.createElement('select');
            select.className = 'form-select';
            select.dataset.level = level; 
            select.add(new Option(level === 0 ? '-- Selecione uma Categoria --' : '-- Selecione uma Subcategoria --', ""));
            children.forEach(cat => select.add(new Option(cat.nome, cat.id)));
            div.appendChild(label);
            div.appendChild(select);
            cascataWrapper.appendChild(div);
        }
        
        function handleCascataChange(event) {
            const select = event.target;
            if (select.tagName !== 'SELECT') return;
            const selectedId = select.value;
            const level = parseInt(select.dataset.level);
            cascataWrapper.querySelectorAll('.grupo-form').forEach(div => {
                if (parseInt(div.querySelector('select').dataset.level) > level) div.remove();
            });
            if (selectedId) {
                criarProximoDropdown(selectedId, level + 1);
                const categoriaSelecionada = allCategories.find(c => c.id == selectedId);
                if (categoriaSelecionada && categoriaSelecionada.prioridade_padrao) {
                    let p = categoriaSelecionada.prioridade_padrao.toUpperCase();
                    let valorSelect = 'Média';
                    if (p === 'URGENTE' || p === 'ALTA') valorSelect = 'Alta';
                    if (p === 'BAIXA') valorSelect = 'Baixa';
                    if (p === 'MEDIA') valorSelect = 'Média';
                    
                    for (let i = 0; i < selectPrioridade.options.length; i++) {
                        if (selectPrioridade.options[i].value === valorSelect) {
                            selectPrioridade.selectedIndex = i;
                            selectPrioridade.style.backgroundColor = "#fff3cd";
                            setTimeout(() => selectPrioridade.style.backgroundColor = "", 500);
                            break;
                        }
                    }
                }
            }
        }

        // --- Renderização da Tabela ---
        function renderizarChamados(chamados) {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());

            if (!chamados || chamados.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'ticket-row data-row';
                noDataRow.innerHTML = `<div class="t-cell text-center" style="grid-column: 1 / -1; padding: 2rem;">Nenhum chamado encontrado.</div>`;
                ticketList.appendChild(noDataRow);
                paginationControls.innerHTML = '';
                return;
            }

            chamados.forEach(chamado => {
                const row = document.createElement('div');
                row.className = 'ticket-row data-row';
                row.setAttribute('data-ticket-id', chamado.id);

                // Lógica de exibição da categoria
                let nomeExibicao = 'N/A';
                if (chamado.Categorias && chamado.Categorias.id) {
                    nomeExibicao = montarCaminhoCategoria(chamado.Categorias.id);
                } else if (chamado.Categorias) {
                    nomeExibicao = chamado.Categorias.nomePai ? `${chamado.Categorias.nomePai} / ${chamado.Categorias.nome}` : chamado.Categorias.nome;
                }
                
                // Sem truncamento, mas o CSS trata a quebra de linha
                
                row.innerHTML = `
                    <div class="t-cell text-center t-id">#${chamado.id}</div>
                    <div class="t-cell text-center">
                        <span class="badge-outline ${getBadgeClass(chamado.prioridade)}">${escapeHtml(chamado.prioridade)}</span>
                    </div>
                    <div class="t-cell t-subject-wrapper">
                        <div class="t-subject" title="${escapeHtml(chamado.assunto)}">${escapeHtml(chamado.assunto)}</div>
                        <div class="t-desc" title="${escapeHtml(chamado.descricao)}">${escapeHtml(chamado.descricao)}</div>
                    </div>
                    <div class="t-cell t-category" title="${escapeHtml(nomeExibicao)}">${escapeHtml(nomeExibicao)}</div>
                    <div class="t-cell text-center">${getStatusIcon(chamado.status)}</div>
                    <div class="t-cell t-operator">
                        <span class="op-name">${escapeHtml(chamado.Atendente?.nomeFuncionario || 'Pendente')}</span>
                    </div>
                    <div class="t-cell t-date">${timeAgo(chamado.created_at)}</div>
                    <div class="t-cell text-center">
                        <button class="btn-view" title="Visualizar"><i class="bi bi-eye-fill"></i></button>
                    </div>
                `;

                row.querySelector('.btn-view').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const ticketId = chamado.id; 
                    modalDetalhes.setAttribute('data-current-ticket-id', ticketId);
                    document.getElementById('detalheId').textContent = `#${ticketId}`;
                    document.getElementById('detalheStatus').textContent = chamado.status;
                    document.getElementById('detalhePrioridade').textContent = chamado.prioridade;
                    document.getElementById('detalheAssunto').textContent = chamado.assunto;
                    document.getElementById('detalheDescricao').textContent = chamado.descricao;
                    document.getElementById('detalheLoja').textContent = chamado.loja || 'N/A';
                    document.getElementById('detalheDepartamento').textContent = chamado.departamento || 'N/A';
                    document.getElementById('detalheRequisitante').textContent = chamado.Funcionario?.nomeFuncionario || 'Desconhecido';
                    
                    let catFull = 'N/A';
                    if (chamado.Categorias && chamado.Categorias.id) catFull = montarCaminhoCategoria(chamado.Categorias.id);
                    else if (chamado.Categorias) catFull = chamado.Categorias.nome;
                    document.getElementById('detalheCategoria').textContent = catFull; 
                    
                    document.getElementById('detalheData').textContent = formatarData(chamado.created_at);
                    listaComentariosContainer.innerHTML = '<span class="comment-empty-state">Carregando comentários...</span>';
                    carregarComentarios(ticketId); 
                    modalDetalhes.showModal();
                });

                ticketList.appendChild(row);
            });
        }

        // --- Paginação ---
        function renderPaginationControls(totalItems, currentPage) {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;

            const createBtn = (text, page, disabled, isActive) => {
                const btn = document.createElement('button');
                btn.innerHTML = text;
                if(disabled) btn.disabled = true;
                if(isActive) btn.classList.add('active');
                btn.onclick = () => setPage(page);
                paginationControls.appendChild(btn);
            };

            createBtn('<i class="bi bi-chevron-double-left"></i>', 1, currentPage === 1, false);
            createBtn('<i class="bi bi-chevron-left"></i>', currentPage - 1, currentPage === 1, false);
            
            for (let i = 1; i <= totalPages; i++) {
                 if(totalPages <= 7 || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                     createBtn(i, i, false, i === currentPage);
                 } else if (i === currentPage - 2 || i === currentPage + 2) {
                     const span = document.createElement('span');
                     span.textContent = '...';
                     span.style.padding = '5px';
                     span.style.color = '#ccc';
                     paginationControls.appendChild(span);
                 }
            }

            createBtn('<i class="bi bi-chevron-right"></i>', currentPage + 1, currentPage === totalPages, false);
            createBtn('<i class="bi bi-chevron-double-right"></i>', totalPages, currentPage === totalPages, false);
        }

        function setPage(page) {
            currentPage = page;
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const ticketsToRender = allTickets.slice(startIndex, endIndex);
            renderizarChamados(ticketsToRender);
            renderPaginationControls(allTickets.length, currentPage);
        }

        async function listarChamados() {
            limparMensagem(divRespostaGeral);
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());
            if (loadingIndicator) loadingIndicator.style.display = 'block';

            const params = new URLSearchParams();
            if (filtroAssunto.value.trim()) params.append('assunto', filtroAssunto.value.trim());
            if (filtroPrioridade.value) params.append('prioridade', filtroPrioridade.value);
            if (filtroStatus.value) params.append('status', filtroStatus.value);

            try {
                const url = `${API_URL}/chamados?${params.toString()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro ao buscar chamados.");
                
                allTickets = await response.json();
                allTickets.sort((a, b) => b.id - a.id);

                currentPage = 1;
                const initialTickets = allTickets.slice(0, ITEMS_PER_PAGE);

                renderizarChamados(initialTickets);
                renderPaginationControls(allTickets.length, currentPage);
            } catch (error) {
                exibirMensagem(divRespostaGeral, error.message, false);
                if (loadingIndicator) loadingIndicator.innerHTML = '<p style="color:red;">Falha ao carregar.</p>';
            }
        }

        async function criarChamado(event) {
            event.preventDefault();
            limparMensagem(modalResposta);

            const nome = ticketForm.nomeRequisitante.value.trim();
            const tel = ticketForm.telefoneRequisitante.value.trim();
            const assunto = ticketForm.assunto.value.trim();
            const desc = ticketForm.descricao.value.trim();
            const loja = selectLoja.value;
            const depto = selectDepartamento.value;

            let categoriaUnificadaId = null;
            const allSelects = cascataWrapper.querySelectorAll('select');
            for (const select of allSelects) {
                if (select.value) categoriaUnificadaId = select.value;
                else break;
            }
            
            if (!nome || !tel || !loja || !depto || !assunto || !desc) {
                exibirMensagem(modalResposta, 'Preencha os campos obrigatórios (*).', false);
                return;
            }
            if (!categoriaUnificadaId) {
                exibirMensagem(modalResposta, 'Selecione a categoria final.', false);
                return;
            }

            const files = document.getElementById('anexo').files;
            let totalSize = 0;
            for (let i = 0; i < files.length; i++) totalSize += files[i].size;
            if (totalSize > 20 * 1024 * 1024) {
                exibirMensagem(modalResposta, 'Tamanho total excede 20MB.', false);
                return;
            }

            const formData = new FormData();
            const dados = {
                chamado: {
                    nome_requisitante_manual: nome,
                    email_requisitante_manual: ticketForm.emailRequisitante.value,
                    telefone_requisitante_manual: tel,
                    assunto: assunto,
                    descricao: desc,
                    prioridade: ticketForm.prioridade.value,
                    requisitante_id: userId,
                    categoria_unificada_id: parseInt(categoriaUnificadaId),
                    loja: loja,
                    departamento: depto
                }
            };
            formData.append('chamado', JSON.stringify(dados.chamado));
            for (let i = 0; i < files.length; i++) formData.append('anexos', files[i]);

            try {
                const response = await fetch(`${API_URL}/chamados`, { method: 'POST', body: formData });
                const resAPI = await response.json();
                if (!response.ok) throw new Error(resAPI.message || "Erro ao criar.");

                exibirMensagem(divRespostaGeral, "Chamado criado com sucesso!", true);
                modal.close();
                await listarChamados(); 
            } catch (error) {
                exibirMensagem(modalResposta, error.message, false);
            }
        }

        function renderizarComentarios(comentarios) {
            listaComentariosContainer.innerHTML = ''; 
            if (!comentarios || comentarios.length === 0) {
                listaComentariosContainer.innerHTML = '<div class="comment-empty-state">Nenhum comentário.</div>';
                return;
            }
            comentarios.forEach(c => {
                const nome = escapeHtml(c.nomeFuncionario || 'Usuário');
                const html = `
                    <div class="comment-item">
                        <div class="comment-header">${nome} <span class="comment-date">${formatarData(c.created_at)}</span></div>
                        <div class="comment-body">${escapeHtml(c.texto)}</div>
                    </div>`;
                listaComentariosContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        
        async function carregarComentarios(ticketId) {
            try {
                const response = await fetch(`${API_URL}/chamados/${ticketId}/comentarios`); 
                if (!response.ok) throw new Error("Erro comentários");
                const comentarios = await response.json();
                renderizarComentarios(comentarios);
            } catch (error) {
                listaComentariosContainer.innerHTML = `<span style="color:red;">Erro: ${error.message}</span>`;
            }
        }

        function resetarModalForm() {
            ticketForm.reset();
            limparMensagem(modalResposta);
            cascataWrapper.innerHTML = '';
            criarProximoDropdown(null, 0); 
            selectLoja.value = "";
            selectDepartamento.innerHTML = '<option value="">-- Selecione Loja Primeiro --</option>';
            selectDepartamento.disabled = true;
        }

        btnAbrir.addEventListener('click', () => {
            resetarModalForm();
            try {
                const uStr = localStorage.getItem("userData");
                const u = JSON.parse(uStr);
                if(u?.data?.nomeFuncionario) document.getElementById('nomeRequisitante').value = u.data.nomeFuncionario;
                if(u?.data?.email) document.getElementById('emailRequisitante').value = u.data.email;
            } catch(e){}
            if (typeof modal.showModal === 'function') modal.showModal();
            else modal.setAttribute('open', '');
        });
        
        btnFechar.addEventListener('click', () => modal.close());
        btnFecharModalDetalhes.addEventListener('click', () => modalDetalhes.close());
        ticketForm.addEventListener('submit', criarChamado);
        btnFiltrar.addEventListener('click', () => listarChamados()); 
        if(inputTelefone) inputTelefone.addEventListener('input', () => aplicarMascaraTelefone(inputTelefone));
        cascataWrapper.addEventListener('change', handleCascataChange);
        
        async function init() {
            await Promise.all([
                carregarDadosIniciais().catch(console.error),
                carregarLojasSelect().catch(console.error) 
            ]);
            await listarChamados(); 
        }
        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>