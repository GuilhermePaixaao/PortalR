<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamados - Portal Supermercado</title>
    
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/chamado.css">
    <link rel="stylesheet" href="css/ticket.css">
    <style>
        /* (Estilos CSS originais mantidos) */
        dialog:not([open]) { display: none; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.6); }
        dialog { border: none; border-radius: 8px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); max-width: 600px; width: calc(100% - 2rem); }
        #modalDetalhes { max-width: 800px; }
        .grupo-form { margin-bottom: 1rem; }
        .grupo-form label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .grupo-form input[type="text"],
        .grupo-form input[type="tel"],
        .grupo-form input[type="email"],
        .grupo-form textarea,
        .grupo-form select,
        .grupo-form input[type="file"] { width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; }
        .form-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }
        .form-actions button { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; }
        #fecharModal, #fecharModalDetalhes { background-color: #6c757d; color: white; }
        #criarTicket { background-color: #198754; color: white; }
        #modalDetalhes .detalhe-grupo { margin-bottom: 1rem; }
        #modalDetalhes .detalhe-label { font-weight: 600; color: #495057; font-size: 0.9rem; text-transform: uppercase; margin-bottom: 0.25rem; display: block; }
        #modalDetalhes .detalhe-valor { font-size: 1rem; padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px; word-wrap: break-word; }
        #modalDetalhes .detalhe-descricao { font-size: 1rem; padding: 0.5rem; background-color: #f8f9fa; border-radius: 4px; white-space: pre-wrap; min-height: 100px; max-height: 250px; overflow-y: auto; }
        #listaComentariosContainer { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 1rem; min-height: 100px; max-height: 300px; overflow-y: auto; }
        .comment-item { border-bottom: 1px solid #dee2e6; padding-bottom: 0.75rem; margin-bottom: 0.75rem; }
        .comment-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .comment-header { font-size: 0.9rem; font-weight: 600; color: #495057; margin-bottom: 0.25rem; }
        .comment-header .comment-date { font-weight: 400; color: #6c757d; margin-left: 0.5rem; }
        .comment-body { font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }
        .comment-empty-state { color: #6c757d; font-style: italic; }
        .main-content { grid-area: main; overflow-y: auto; padding: 2rem; background-color: #f8f9fa; }
        .page-actions { position: fixed; bottom: 2rem; right: 2rem; z-index: 1050; }
        .btn-new-ticket { background-color: #0d6efd; color: white; padding: 1rem 1.5rem; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transition: background-color 0.2s ease; }
        .btn-new-ticket:hover { background-color: #0b5ed7; }
        .alert { padding: 1rem; margin-top: 1rem; border-radius: 4px; }
        .alert-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .alert-danger { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .alert-warning { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
        .ticket-list { display: flex; flex-direction: column; }
        .ticket-row { display: flex; border-bottom: 1px solid #eee; padding: 1rem 0.5rem; align-items: center; }
        .ticket-row.header { background-color: #f8f9fa; font-weight: bold; border-bottom: 2px solid #dee2e6; }
        .ticket-cell { padding: 0 0.5rem; }
        .ticket-id { flex: 0 0 80px; text-align: center; }
        .ticket-priority { flex: 0 0 100px; text-align: center; }
        .ticket-subject { flex: 1 1 auto; min-width: 200px; }
        .ticket-category { flex: 0 0 150px; }
        .ticket-status { flex: 0 0 80px; text-align: center; }
        .ticket-requisitante { flex: 0 0 120px; }
        .ticket-operator { flex: 0 0 120px; }
        .ticket-created { flex: 0 0 100px; text-align: center; }
        .ticket-actions { flex: 0 0 60px; text-align: center; cursor: pointer; }
        .priority-badge,
        .status-badge { padding: 0.2em 0.6em; border-radius: 0.25rem; font-size: 0.85em; font-weight: 600; }
        .priority-badge.alta, .priority-badge.high { background-color: #f8d7da; color: #842029; }
        .priority-badge.m√©dia, .priority-badge.medium, .priority-badge.media { background-color: #fff3cd; color: #664d03; }
        .priority-badge.baixa, .priority-badge.low { background-color: #cfe2ff; color: #084298; }
        .priority-badge.planejado { background-color: #898989; color: #000000; } 
        .status-badge.aberto, .status-badge.open { background-color: #7d7d7d; color: #3f3f3f; }
        .status-badge.conclu√≠do, .status-badge.completed { background-color: #d1e7dd; color: #0f5132; }
        .status-badge.em-andamento { background-color: #cfe2ff; color: #084298; }
        .status-badge.pausado { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
        #loadingIndicator { padding: 2rem; text-align: center; color: #6c757d; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 2rem; background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); position: sticky; top: 0; z-index: 1030; }
        .logo { font-size: 1.4rem; font-weight: 700; color: #0d6efd; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; white-space: nowrap; }
        .search-bar { margin-left: 2rem; margin-right: 2rem; width: 100%; max-width: 450px; }
        .search-bar input { width: 100%; padding: 0.6rem 1rem; border: 1px solid #ced4da; border-radius: 20px; font-size: 0.95rem; }
        .search-bar input:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25); outline: none; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        #userNameDisplay { font-weight: 500; color: #495057; white-space: nowrap; }
        .btn-logout { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .btn-logout:hover { background-color: #bb2d3b; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { height: 30px; width: auto; }
        
        #categoriaCascataWrapper .grupo-form {
            margin-bottom: 0; 
        }

        .pagination-controls {
            display: flex;
            justify-content: flex-end; 
            align-items: center;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination-controls button {
            background-color: #fff;
            color: #0d6efd;
            border: 1px solid #0d6efd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-controls button.active {
            background-color: #0d6efd;
            color: white;
        }

        .pagination-controls button:disabled {
            color: #adb5bd;
            border-color: #adb5bd;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

    <div class="dashboard-container">

        <header class="header">
            <div class="logo">
                <img src="/img.png" alt="Logo Portal Supermercado" class="logo-icon">              
                PORTAL SUPERMERCADO ROSALINA
            </div>
        </header>

        <dialog id="modalTicket" aria-labelledby="modalTitle">
            <form id="ticketForm">
                <h2 id="modalTitle">Novo Chamado</h2>
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="nomeRequisitante">Seu Nome <span aria-hidden="true" style="color:red;">*</span></label>
                            <input type="text" id="nomeRequisitante" name="nomeRequisitante" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="emailRequisitante">Seu Email (Opcional)</label>
                            <input type="email" id="emailRequisitante" name="emailRequisitante">
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="telefoneRequisitante">Seu Telefone <span aria-hidden="true" style="color:red;">*</span></label>
                    <input type="tel" id="telefoneRequisitante" name="telefoneRequisitante" placeholder="(XX) XXXXX-XXXX" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="loja">Loja <span aria-hidden="true" style="color:red;">*</span></label>
                            <select id="loja" name="loja" class="form-select" required>
                                <option value="">-- Carregando... --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="departamento">Departamento <span aria-hidden="true" style="color:red;">*</span></label>
                            <select id="departamento" name="departamento" class="form-select" disabled required>
                                <option value="">-- Selecione primeiro a Loja --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <hr>

                <div class="grupo-form">
                    <label for="assunto">Assunto <span aria-hidden="true" style="color:red;">*</span></label>
                    <input type="text" id="assunto" name="assunto" required>
                </div>

                <div class="grupo-form">
                    <label for="descricao">Descri√ß√£o <span aria-hidden="true" style="color:red;">*</span></label>
                    <textarea id="descricao" name="descricao" rows="5" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="M√©dia" selected>M√©dia</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div id="categoriaCascataWrapper">
                            </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="anexo">Anexar Arquivos (Opcional)</label>
                    <input type="file" id="anexo" name="anexos" multiple>
                    <small class="form-text text-muted">Limite m√°ximo total: 20MB.</small>
                </div>

                <div id="modalResposta" class="mt-3"></div>

                <div class="form-actions">
                    <button type="button" id="fecharModal">Cancelar</button>
                    <button type="submit" id="criarTicket">Criar Chamado</button>
                </div>
            </form>
        </dialog>
        
        <dialog id="modalDetalhes" aria-labelledby="modalDetalhesTitle">
            <h2 id="modalDetalhesTitle" style="text-transform: uppercase;">Detalhes do Chamado</h2>
            <hr>
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Dados Gerais</h3>
            <div class="detalhe-grupo">
                <span class="detalhe-label">Assunto</span>
                <div id="detalheAssunto" class="detalhe-valor">...</div>
            </div>
            <div class="detalhe-grupo">
                <span class="detalhe-label">Descri√ß√£o</span>
                <div id="detalheDescricao" class="detalhe-descricao">...</div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">Loja</span><div id="detalheLoja" class="detalhe-valor">...</div></div>
                </div>
                <div class="col-md-6">
                    <div class="detalhe-grupo"><span class="detalhe-label">Departamento</span><div id="detalheDepartamento" class="detalhe-valor">...</div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="detalhe-grupo"><span class="detalhe-label">Contato</span><span id="detalheRequisitante" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-md-3">
                    <div class="detalhe-grupo"><span class="detalhe-label">Situa√ß√£o</span><span id="detalheStatus" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-md-3">
                    <div class="detalhe-grupo"><span class="detalhe-label">Categorias</span><span id="detalheCategoria" class="detalhe-valor">...</span></div>
                </div>
                <div class="col-md-3">
                    <div class="detalhe-grupo"><span class="detalhe-label">Prioridade</span><span id="detalhePrioridade" class="detalhe-valor">...</span></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="detalhe-grupo"><span class="detalhe-label">Ticket ID</span><span id="detalheId" class="detalhe-valor">#...</span></div>
                </div>
                <div class="col-md-4">
                    <div class="detalhe-grupo"><span class="detalhe-label">Criado em</span><span id="detalheData" class="detalhe-valor">...</span></div>
                </div>
            </div>
            <hr style="margin-top: 1rem; margin-bottom: 1.25rem;">
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Hist√≥rico de Coment√°rios</h3>
            <div id="listaComentariosContainer" class="comment-empty-state">
                Carregando coment√°rios...
            </div>
            <div class="form-actions"><button type="button" id="fecharModalDetalhes">Fechar</button></div>
        </dialog>
        
        <main class="main-content">
            <img src="/imgrosa.png" height="126" width="320" >              
            <hr>
            <div id="divRespostaGeral" class="mb-3"></div>
            <div class="widget card shadow-sm">
                <div class="card-body">
                    <div class="filters mb-3 row g-2">
                        <div class="col-md-4"><label for="filtroAssunto" class="form-label">Filtrar por Assunto</label><input type="text" id="filtroAssunto" class="form-control" placeholder="Digite o assunto..."></div>
                        <div class="col-md-3"><label for="filtroPrioridade" class="form-label">Prioridade</label><select id="filtroPrioridade" class="form-select"><option value="">Todas</option><option value="Alta">Alta</option><option value="M√©dia">M√©dia</option><option value="Baixa">Baixa</option><option value="Planejado">Planejado</option></select></div>
                        <div class="col-md-3"><label for="filtroStatus" class="form-label">Status</label>
                            <select id="filtroStatus" class="form-select">
                                <option value="">Todos</option>
                                <option value="Aberto">Aberto</option>
                                <option value="Em Andamento">Em Andamento</option>
                                <option value="Pausado">Pausado</option> <option value="Conclu√≠do">Conclu√≠do</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end"><button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button></div>
                    </div>
                    <div id="ticketList" class="ticket-list">
                        <div class="ticket-row header">
                            <div class="ticket-cell ticket-id">Ticket</div>
                            <div class="ticket-cell ticket-priority">Prioridade</div>
                            <div class="ticket-cell ticket-subject">Assunto</div>
                            <div class="ticket-cell ticket-category">Categoria</div>
                            <div class="ticket-cell ticket-status">Status</div>
                            <div class="ticket-cell ticket-requisitante">Requisitante</div>
                            <div class="ticket-cell ticket-operator">Operador</div>
                            <div class="ticket-cell ticket-created">Criado em</div>
                            <div class="ticket-cell ticket-actions">A√ß√£o</div>
                        </div>
                        <div id="loadingIndicator"><p>Carregando chamados...</p></div>
                    </div>
                    
                    <div id="paginationControls" class="pagination-controls">
                        </div>
                    </div>
            </div>
        </main>

        <div class="page-actions">
            <button id="newTicketButton" class="btn-new-ticket">
                Novo Chamado
            </button>
        </div>

    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="js/globalNotification.js"></script>

    <script type="module">
        const API_URL = ""; 
        let userId = 1; 
        try {
            const userDataString = localStorage.getItem("userData");
            const userData = JSON.parse(userDataString);
            const idLogado = userData?.data?.id || userData?.id;
            if (idLogado) userId = idLogado;
        } catch (e) {
            console.error("Erro ao ler localStorage. Usando ID=1 padr√£o.", e);
        }

        // --- Vari√°veis Globais de Pagina√ß√£o ---
        let allTickets = []; // Armazena todos os tickets carregados (simula√ß√£o de frontend)
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        // ------------------------------------

        // Armazenamento local de categorias para a cascata
        let allCategories = [];

        // --- Refer√™ncias ---
        const modal = document.getElementById("modalTicket");
        const btnAbrir = document.getElementById("newTicketButton");
        const btnFechar = document.getElementById("fecharModal");
        const ticketForm = document.getElementById("ticketForm");
        const ticketList = document.getElementById("ticketList");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const modalResposta = document.getElementById("modalResposta");
        const divRespostaGeral = document.getElementById("divRespostaGeral");
        const modalDetalhes = document.getElementById("modalDetalhes");
        const btnFecharModalDetalhes = document.getElementById("fecharModalDetalhes");
        const filtroAssunto = document.getElementById("filtroAssunto");
        const filtroPrioridade = document.getElementById("filtroPrioridade");
        const filtroStatus = document.getElementById("filtroStatus");
        const btnFiltrar = document.getElementById("btnFiltrar");
        const inputTelefone = document.getElementById("telefoneRequisitante");
        const listaComentariosContainer = document.getElementById("listaComentariosContainer");
        const paginationControls = document.getElementById("paginationControls");
        const selectPrioridade = document.getElementById("prioridade"); 

        // Refer√™ncia para o container da cascata de categorias
        const cascataWrapper = document.getElementById("categoriaCascataWrapper");

        // [MUDAN√áA] Refer√™ncias para os selects de Loja e Departamento
        const selectLoja = document.getElementById("loja");
        const selectDepartamento = document.getElementById("departamento");

        // --- Fun√ß√µes Auxiliares ---
        function exibirMensagem(elemento, mensagem, sucesso = true) {
            elemento.textContent = mensagem;
            elemento.className = sucesso ? 'alert alert-success' : 'alert alert-danger';
        }
        function limparMensagem(elemento) {
            elemento.textContent = '';
            elemento.className = '';
        }
        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        function formatarData(isoString) {
            if (!isoString) return 'Aguardando...';
            try {
                const dt = new Date(isoString);
                const data = dt.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
                const hora = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
                return `${data} ${hora}`;
            } catch (e) {
                return 'Data inv√°lida';
            }
        }
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, "").substring(0, 11);
            if (valor.length > 6) {
                valor = valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            } else if (valor.length > 2) {
                valor = valor.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
            } else if (valor.length > 0) {
                valor = valor.replace(/^(\d{0,2}).*/, '($1');
            }
            input.value = valor;
        }

        // =======================================================
        // [MUDAN√áA] FUN√á√ïES PARA CARREGAR DADOS DOS SELECTS (LOJAS/DEPTOS)
        // =======================================================

        // 1. Carrega as Lojas ao iniciar a p√°gina
        async function carregarLojasSelect() {
            try {
                const response = await fetch(`${API_URL}/chamados/dados/lojas`);
                if (!response.ok) throw new Error("Erro ao carregar lojas.");
                const lojas = await response.json();

                selectLoja.innerHTML = '<option value="">-- Selecione a Loja --</option>';
                
                lojas.forEach(loja => {
                    const option = document.createElement("option");
                    option.value = loja.id; // Envia o ID
                    option.textContent = loja.nome;
                    selectLoja.appendChild(option);
                });
            } catch (error) {
                console.error("Erro lojas:", error);
                selectLoja.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // 2. Carrega Departamentos baseado na Loja escolhida
        async function carregarDepartamentosSelect(lojaId) {
            selectDepartamento.innerHTML = '<option value="">Carregando...</option>';
            selectDepartamento.disabled = true;

            if (!lojaId) {
                selectDepartamento.innerHTML = '<option value="">-- Selecione primeiro a Loja --</option>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/chamados/dados/lojas/${lojaId}/departamentos`);
                if (!response.ok) throw new Error("Erro ao carregar departamentos.");
                const departamentos = await response.json();

                selectDepartamento.innerHTML = '<option value="">-- Selecione o Departamento --</option>';
                
                if (departamentos.length === 0) {
                    const opt = document.createElement("option");
                    opt.text = "Nenhum departamento vinculado";
                    selectDepartamento.add(opt);
                } else {
                    departamentos.forEach(dept => {
                        const option = document.createElement("option");
                        option.value = dept.id; // Envia o ID
                        option.textContent = dept.nome;
                        selectDepartamento.appendChild(option);
                    });
                }
                selectDepartamento.disabled = false; 

            } catch (error) {
                console.error("Erro departamentos:", error);
                selectDepartamento.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // --- Event Listener para o efeito cascata ---
        selectLoja.addEventListener('change', () => {
            const lojaId = selectLoja.value;
            carregarDepartamentosSelect(lojaId);
        });

        // =======================================================

        async function carregarDadosIniciais() {
            try {
                const response = await fetch(`${API_URL}/categorias`);
                if (!response.ok) throw new Error("Erro ao carregar categorias.");

                allCategories = await response.json(); 
                
                cascataWrapper.innerHTML = ''; 
                criarProximoDropdown(null, 0); 

            } catch (error) {
                console.error(error);
                exibirMensagem(modal.open ? modalResposta : divRespostaGeral, error.message, false);
                cascataWrapper.innerHTML = '<p class="text-danger">Erro ao carregar categorias.</p>';
                throw error;
            }
        }
        
        // --- (NOVO) Fun√ß√£o para montar o caminho da categoria (Pai > Filho > Neto) ---
        function montarCaminhoCategoria(categoriaId) {
            if (!categoriaId) return 'N/A';
            let caminho = [];
            let currentId = categoriaId;
            let attempts = 0;

            // Percorre a √°rvore de categorias subindo pelos pais
            while (currentId && attempts < 20) {
                // Busca a categoria pelo ID no array carregado
                // Usamos '==' para evitar problemas de tipo (string vs number)
                const cat = allCategories.find(c => c.id == currentId);
                if (cat) {
                    caminho.unshift(cat.nome); // Adiciona ao in√≠cio do array
                    currentId = cat.parent_id; // Vai para o pai
                } else {
                    break;
                }
                attempts++;
            }
            return caminho.join(' / ') || 'N/A';
        }
        // ----------------------------------------------------------------------------
        
        function criarProximoDropdown(parentId, level) {
            const children = allCategories.filter(c => c.parent_id == parentId);
            if (children.length === 0) return;

            const div = document.createElement('div');
            div.className = 'grupo-form';
            const label = document.createElement('label');
            label.textContent = level === 0 ? 'Categoria' : 'Subcategoria';
            const select = document.createElement('select');
            select.className = 'form-select';
            select.dataset.level = level; 
            
            const placeholder = level === 0 ? '-- Selecione uma Categoria --' : '-- Selecione uma Subcategoria --';
            select.add(new Option(placeholder, ""));

            children.forEach(cat => {
                select.add(new Option(cat.nome, cat.id));
            });
            
            div.appendChild(label);
            div.appendChild(select);
            cascataWrapper.appendChild(div);
        }
        
        function handleCascataChange(event) {
            const select = event.target;
            if (select.tagName !== 'SELECT') return;

            const selectedId = select.value;
            const level = parseInt(select.dataset.level);

            const allDropdowns = cascataWrapper.querySelectorAll('.grupo-form');
            allDropdowns.forEach(div => {
                const sel = div.querySelector('select');
                if (parseInt(sel.dataset.level) > level) {
                    div.remove();
                }
            });

            if (selectedId) {
                criarProximoDropdown(selectedId, level + 1);

                const categoriaSelecionada = allCategories.find(c => c.id == selectedId);
                
                if (categoriaSelecionada && categoriaSelecionada.prioridade_padrao) {
                    let p = categoriaSelecionada.prioridade_padrao;
                    if (p === 'URGENTE') p = 'Alta'; 
                    if (p === 'MEDIA') p = 'M√©dia';
                    if (p === 'BAIXA') p = 'Baixa';
                    if (p === 'ALTA') p = 'Alta';

                    for (let i = 0; i < selectPrioridade.options.length; i++) {
                        if (selectPrioridade.options[i].value.toLowerCase() === p.toLowerCase()) {
                            selectPrioridade.selectedIndex = i;
                            selectPrioridade.style.backgroundColor = "#fff3cd";
                            setTimeout(() => selectPrioridade.style.backgroundColor = "", 500);
                            break;
                        }
                    }
                }
            }
        }

        // --- Pagina√ß√£o no Frontend ---
        function renderPaginationControls(totalItems, currentPage) {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

            if (totalPages <= 1) return;

            const btnFirst = document.createElement('button');
            btnFirst.textContent = '¬´';
            btnFirst.disabled = currentPage === 1;
            btnFirst.addEventListener('click', () => setPage(1));
            paginationControls.appendChild(btnFirst);

            const btnPrev = document.createElement('button');
            btnPrev.textContent = '<';
            btnPrev.disabled = currentPage === 1;
            btnPrev.addEventListener('click', () => setPage(currentPage - 1));
            paginationControls.appendChild(btnPrev);

            for (let i = 1; i <= totalPages; i++) {
                const btnPage = document.createElement('button');
                btnPage.textContent = i;
                btnPage.classList.add('page-number');
                if (i === currentPage) {
                    btnPage.classList.add('active');
                }
                btnPage.addEventListener('click', () => setPage(i));
                paginationControls.appendChild(btnPage);
            }

            const btnNext = document.createElement('button');
            btnNext.textContent = '>';
            btnNext.disabled = currentPage === totalPages;
            btnNext.addEventListener('click', () => setPage(currentPage + 1));
            paginationControls.appendChild(btnNext);

            const btnLast = document.createElement('button');
            btnLast.textContent = '¬ª';
            btnLast.disabled = currentPage === totalPages;
            btnLast.addEventListener('click', () => setPage(totalPages));
            paginationControls.appendChild(btnLast);
        }

        function setPage(page) {
            currentPage = page;
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const ticketsToRender = allTickets.slice(startIndex, endIndex);
            
            renderizarChamados(ticketsToRender);
            renderPaginationControls(allTickets.length, currentPage);
        }

        function renderizarChamados(chamados) {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());

            if (!chamados || chamados.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'ticket-row data-row';
                noDataRow.innerHTML = `<div class="ticket-cell" style="grid-column: 1 / -1; text-align: center; padding: 1rem;">Nenhum chamado encontrado.</div>`;
                ticketList.appendChild(noDataRow);
                paginationControls.innerHTML = '';
                return;
            }

            chamados.forEach(chamado => {
                const row = document.createElement('div');
                row.className = 'ticket-row data-row';
                row.setAttribute('data-ticket-id', chamado.id);

                const prioridadeClass = (chamado.prioridade || 'M√©dia').toLowerCase().replace('√©', 'e');
                const statusClass = (chamado.status || 'Aberto').toLowerCase().replace(/\s+/g, '-');

                // --- ATUALIZADO: L√≥gica de montagem da categoria com caminho completo ---
                let nomeExibicao = 'N/A';
                if (chamado.Categorias && chamado.Categorias.id) {
                    // Tenta montar o caminho usando a √°rvore carregada
                    nomeExibicao = montarCaminhoCategoria(chamado.Categorias.id);
                } else if (chamado.Categorias) {
                    // Fallback se n√£o tiver ID (exibi√ß√£o simples)
                    if (chamado.Categorias.nomePai) {
                        nomeExibicao = `${chamado.Categorias.nomePai} / ${chamado.Categorias.nome}`;
                    } else {
                        nomeExibicao = chamado.Categorias.nome;
                    }
                }
                // -----------------------------------------------------------------------
                
                row.innerHTML = `
                    <div class="ticket-cell ticket-id">#${chamado.id}</div>
                    <div class="ticket-cell ticket-priority">
                        <span class="priority-badge ${prioridadeClass}">${escapeHtml(chamado.prioridade)}</span>
                    </div>
                    <div class="ticket-cell ticket-subject">${escapeHtml(chamado.assunto)}</div>
                    <div class="ticket-cell ticket-category">${escapeHtml(nomeExibicao)}</div>
                    <div class="ticket-cell ticket-status">
                        <span class="status-badge ${statusClass}">${escapeHtml(chamado.status)}</span>
                    </div>
                    <div class="ticket-cell ticket-requisitante">${escapeHtml(chamado.Funcionario?.nomeFuncionario || 'Desconhecido')}</div>
                    <div class="ticket-cell ticket-operator">${escapeHtml(chamado.Atendente?.nomeFuncionario || 'N/A')}</div>
                    <div class="ticket-cell ticket-created">${formatarData(chamado.created_at)}</div>
                    <div class="ticket-cell ticket-actions">
                        <span class="view-icon" title="Visualizar">üëÅÔ∏è</span>
                    </div>
                `;

                row.querySelector('.view-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const ticketId = chamado.id; 
                    modalDetalhes.setAttribute('data-current-ticket-id', ticketId);
                    document.getElementById('modalDetalhesTitle').textContent = `#${ticketId} - ${chamado.assunto || 'SEM ASSUNTO'}`;
                    document.getElementById('detalheId').textContent = `#${ticketId}`;
                    document.getElementById('detalheStatus').textContent = chamado.status;
                    document.getElementById('detalhePrioridade').textContent = chamado.prioridade;
                    document.getElementById('detalheAssunto').textContent = chamado.assunto;
                    document.getElementById('detalheDescricao').textContent = chamado.descricao;
                    
                    document.getElementById('detalheLoja').textContent = chamado.loja || 'N/A';
                    document.getElementById('detalheDepartamento').textContent = chamado.departamento || 'N/A';

                    document.getElementById('detalheRequisitante').textContent = chamado.Funcionario?.nomeFuncionario || 'Desconhecido';
                    
                    // Atualizado tamb√©m no modal
                    document.getElementById('detalheCategoria').textContent = nomeExibicao; 
                    
                    document.getElementById('detalheData').textContent = formatarData(chamado.created_at);
                    listaComentariosContainer.innerHTML = '<span class="comment-empty-state">Carregando coment√°rios...</span>';
                    carregarComentarios(ticketId); 
                    modalDetalhes.showModal();
                });

                ticketList.appendChild(row);
            });
        }

        async function listarChamados() {
            limparMensagem(divRespostaGeral);
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());
            if (loadingIndicator) loadingIndicator.style.display = 'block';

            const params = new URLSearchParams();
            if (filtroAssunto.value.trim()) params.append('assunto', filtroAssunto.value.trim());
            if (filtroPrioridade.value) params.append('prioridade', filtroPrioridade.value);
            if (filtroStatus.value) params.append('status', filtroStatus.value);
            
            // if (userId) params.append('requisitante_id', userId); // Exibe todos, conforme sua solicita√ß√£o

            const url = `${API_URL}/chamados?${params.toString()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro ao buscar chamados.");
                
                allTickets = await response.json();
                
                currentPage = 1;
                const initialTickets = allTickets.slice(0, ITEMS_PER_PAGE);

                renderizarChamados(initialTickets);
                renderPaginationControls(allTickets.length, currentPage);
                
            } catch (error) {
                exibirMensagem(divRespostaGeral, error.message, false);
                if (loadingIndicator) loadingIndicator.innerHTML = '<p style="color:red;">Falha ao carregar.</p>';
            }
        }

        // --- (ATUALIZADO) Criar Novo Chamado ---
        async function criarChamado(event) {
            event.preventDefault();
            limparMensagem(modalResposta);

            const nomeRequisitante = ticketForm.nomeRequisitante.value.trim();
            const emailRequisitante = ticketForm.emailRequisitante.value.trim(); 
            const telefoneRequisitante = ticketForm.telefoneRequisitante.value.trim();
            const assunto = ticketForm.assunto.value.trim();
            const descricao = ticketForm.descricao.value.trim();
            const prioridade = ticketForm.prioridade.value || 'M√©dia';
            
            // [MUDAN√áA] Agora pegamos o valor do Select (que √© o ID)
            const loja = selectLoja.value;
            const departamento = selectDepartamento.value;

            const allSelects = cascataWrapper.querySelectorAll('select');
            let categoriaUnificadaId = null;
            
            for (const select of allSelects) {
                if (select.value) {
                    categoriaUnificadaId = select.value;
                } else {
                    break;
                }
            }
            
            // [MUDAN√áA] Valida√ß√£o ajustada para os novos Selects e Campos Obrigat√≥rios
            if (!nomeRequisitante || !telefoneRequisitante || !loja || !departamento || !assunto || !descricao) {
                exibirMensagem(modalResposta, 'Preencha os campos obrigat√≥rios: Nome, Telefone, Loja, Departamento, Assunto e Descri√ß√£o.', false);
                return;
            }
            
            if (!categoriaUnificadaId) {
                exibirMensagem(modalResposta, 'Por favor, selecione uma Categoria.', false);
                return;
            }

            const anexoInput = document.getElementById('anexo');
            const files = anexoInput.files;
            let totalSize = 0;
            const maxSize = 20 * 1024 * 1024; // 20 MB
            for (let i = 0; i < files.length; i++) { totalSize += files[i].size; }
            if (totalSize > maxSize) {
                exibirMensagem(modalResposta, `Erro: O tamanho total dos arquivos (${(totalSize / 1024 / 1024).toFixed(2)} MB) excede o limite de 20 MB.`, false);
                return;
            }

            const formData = new FormData();
            const dadosChamado = {
                chamado: {
                    nome_requisitante_manual: nomeRequisitante,
                    email_requisitante_manual: emailRequisitante, 
                    telefone_requisitante_manual: telefoneRequisitante,
                    assunto: assunto,
                    descricao: descricao,
                    prioridade: prioridade,
                    requisitante_id: userId,
                    categoria_unificada_id: parseInt(categoriaUnificadaId),
                    loja: loja,               
                    departamento: departamento 
                }
            };
            
            formData.append('chamado', JSON.stringify(dadosChamado.chamado));
            for (let i = 0; i < files.length; i++) {
                formData.append('anexos', files[i]);
            }

            try {
                const response = await fetch(`${API_URL}/chamados`, {
                    method: 'POST',
                    body: formData 
                });
                
                const respostaAPI = await response.json();
                if (!response.ok) {
                    throw new Error(respostaAPI.message || "Erro ao criar chamado.");
                }

                exibirMensagem(divRespostaGeral, "Chamado criado com sucesso!", true);
                modal.close();
                await listarChamados(); 
            } catch (error) {
                exibirMensagem(modalResposta, error.message, false);
            }
        }
        
        function renderizarComentarios(comentarios) {
            listaComentariosContainer.innerHTML = ''; 
            listaComentariosContainer.classList.remove('comment-empty-state');
            if (!comentarios || comentarios.length === 0) {
                listaComentariosContainer.classList.add('comment-empty-state');
                listaComentariosContainer.innerHTML = '<span>Nenhum coment√°rio encontrado.</span>';
                return;
            }
            comentarios.forEach(comentario => {
                const nome = comentario.nomeFuncionario || 'Usu√°rio desconhecido'; 
                const data = formatarData(comentario.created_at);
                const texto = escapeHtml(comentario.texto);
                const commentHtml = `
                    <div class="comment-item">
                        <div class="comment-header">
                            ${escapeHtml(nome)}
                            <span class="comment-date">em ${data}</span>
                        </div>
                        <div class="comment-body">
                            ${texto}
                        </div>
                    </div>
                `;
                listaComentariosContainer.insertAdjacentHTML('beforeend', commentHtml);
            });
        }
        async function carregarComentarios(ticketId) {
            try {
                const response = await fetch(`${API_URL}/chamados/${ticketId}/comentarios`); 
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || "Falha ao carregar coment√°rios.");
                }
                const comentarios = await response.json();
                renderizarComentarios(comentarios);
            } catch (error) {
                 listaComentariosContainer.innerHTML = `<span class="comment-empty-state" style="color: red;">${error.message}</span>`;
            }
        }
        
        function resetarModalForm() {
            ticketForm.reset();
            limparMensagem(modalResposta);
            cascataWrapper.innerHTML = '';
            criarProximoDropdown(null, 0); 
            
            // [MUDAN√áA] Reseta os selects de Loja e Departamento
            selectLoja.value = "";
            selectDepartamento.innerHTML = '<option value="">-- Selecione primeiro a Loja --</option>';
            selectDepartamento.disabled = true;
        }

        btnAbrir.addEventListener('click', () => {
            resetarModalForm();
            
            try {
                const userDataString = localStorage.getItem("userData");
                const userData = JSON.parse(userDataString);
                document.getElementById('nomeRequisitante').value = userData?.data?.nomeFuncionario || ''; 
                document.getElementById('emailRequisitante').value = userData?.data?.email || ''; 
            } catch(e) {
                console.warn("N√£o foi poss√≠vel pr√©-preencher dados do usu√°rio.");
                document.getElementById('nomeRequisitante').value = ''; 
                document.getElementById('emailRequisitante').value = ''; 
            }

            if (typeof modal.showModal === 'function') modal.showModal();
            else modal.setAttribute('open', '');
            document.getElementById('assunto').focus();
        });
        
        btnFechar.addEventListener('click', () => { modal.close(); });
        modal.addEventListener('close', () => { resetarModalForm(); }); 
        
        btnFecharModalDetalhes.addEventListener('click', () => {
            listaComentariosContainer.innerHTML = '';
            modalDetalhes.removeAttribute('data-current-ticket-id');
            modalDetalhes.close();
        });

        ticketForm.addEventListener('submit', criarChamado);
        btnFiltrar.addEventListener('click', () => listarChamados(1)); 
        if(inputTelefone) {
            inputTelefone.addEventListener('input', () => aplicarMascaraTelefone(inputTelefone));
        }
        
        cascataWrapper.addEventListener('change', handleCascataChange);
        
        // --- (MUDAN√áA) Inicializa√ß√£o ---
        async function init() {
            // Carrega dados iniciais em paralelo (Categorias e Lojas)
            await Promise.all([
                carregarDadosIniciais().catch(e => console.error(e)),
                carregarLojasSelect().catch(e => console.error(e)) 
            ]);
            
            await listarChamados(); 
        }
        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>