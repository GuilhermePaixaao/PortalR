<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamados - Portal Supermercado</title>

    <script>
        // (Script de proteÃ§Ã£o anti-flicker, se houver, iria aqui)
    </script>
    
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/chamado.css">
    <link rel="stylesheet" href="css/ticket.css">
    <style>
        /* Estilos do Modal (Dialog) */
        dialog:not([open]) {
            display: none;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.6);
        }

        dialog {
            border: none;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: calc(100% - 2rem);
        }

        .grupo-form {
            margin-bottom: 1rem;
        }

        .grupo-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .grupo-form input[type="text"],
        .grupo-form input[type="tel"],
        .grupo-form input[type="email"],
        .grupo-form textarea,
        .grupo-form select,
        .grupo-form input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .form-actions button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #fecharModal, #fecharModalDetalhes {
            background-color: #6c757d;
            color: white;
        }

        #criarTicket {
            background-color: #198754;
            color: white;
        }
        
        /* --- ESTILOS DO NOVO MODAL DE DETALHES --- */
        #modalDetalhes .detalhe-grupo {
            margin-bottom: 1rem;
        }
        #modalDetalhes .detalhe-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: block;
        }
        #modalDetalhes .detalhe-valor {
            font-size: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            word-wrap: break-word;
        }
        #modalDetalhes .detalhe-descricao {
            font-size: 1rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap; /* Preserva quebras de linha da descriÃ§Ã£o */
            min-height: 100px;
            max-height: 250px;
            overflow-y: auto;
        }
        /* --- FIM ESTILOS MODAL DETALHES --- */


        /* Ajuste Main Content */
        .main-content {
            grid-area: main;
            overflow-y: auto;
            padding: 2rem;
            background-color: #f8f9fa;
        }

        .page-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1050;
        }

        .btn-new-ticket {
            background-color: #0d6efd;
            color: white;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: background-color 0.2s ease;
        }

        .btn-new-ticket:hover {
            background-color: #0b5ed7;
        }

        /* Alertas */
        .alert {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 4px;
        }
        .alert-success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .alert-danger { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .alert-warning { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }

        /* Lista de Tickets */
        .ticket-list { display: flex; flex-direction: column; }
        .ticket-row { display: flex; border-bottom: 1px solid #eee; padding: 1rem 0.5rem; align-items: center; }
        .ticket-row.header { background-color: #f8f9fa; font-weight: bold; border-bottom: 2px solid #dee2e6; }
        .ticket-cell { padding: 0 0.5rem; }
        .ticket-id { flex: 0 0 80px; text-align: center; }
        .ticket-priority { flex: 0 0 100px; text-align: center; }
        .ticket-subject { flex: 1 1 auto; min-width: 200px; }
        .ticket-category { flex: 0 0 150px; }
        .ticket-status { flex: 0 0 80px; text-align: center; }
        .ticket-operator { flex: 0 0 120px; }
        .ticket-created { flex: 0 0 100px; text-align: center; }
        .ticket-actions { flex: 0 0 60px; text-align: center; cursor: pointer; }

        /* Badges */
        .priority-badge,
        .status-badge {
            padding: 0.2em 0.6em;
            border-radius: 0.25rem;
            font-size: 0.85em;
            font-weight: 600;
        }
        .priority-badge.alta, .priority-badge.high { background-color: #f8d7da; color: #842029; }
        .priority-badge.mÃ©dia, .priority-badge.medium, .priority-badge.media { background-color: #fff3cd; color: #664d03; }
        .priority-badge.baixa, .priority-badge.low { background-color: #cfe2ff; color: #084298; }
        .priority-badge.planejado { background-color: #e2d1e7; color: #510f32; } 

        .status-badge.aberto, .status-badge.open { background-color: #ffc107; color: #000; }
        .status-badge.concluÃ­do, .status-badge.completed { background-color: #d1e7dd; color: #0f5132; }
        .status-badge.em-andamento { background-color: #cfe2ff; color: #084298; }

        #loadingIndicator { padding: 2rem; text-align: center; color: #6c757d; }

        /* --- ESTILOS DO HEADER ATUALIZADOS --- */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0.75rem 2rem;
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0d6efd;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
            white-space: nowrap;
        }
        .search-bar {
            margin-left: 2rem;
            margin-right: 2rem; 
            width: 100%;
            max-width: 450px;
        }
        .search-bar input {
            width: 100%;
            padding: 0.6rem 1rem;
            border: 1px solid #ced4da;
            border-radius: 20px;
            font-size: 0.95rem;
        }
        .search-bar input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
            outline: none;
        }
        
        /* Estilos para Logout */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem; 
        }
        #userNameDisplay {
            font-weight: 500;
            color: #495057;
            white-space: nowrap; 
        }
        .btn-logout {
            background-color: #dc3545; 
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-logout:hover {
            background-color: #bb2d3b;
        }
        /* --- FIM ESTILOS HEADER --- */
    </style>
</head>
<body>

    <div class="dashboard-container">

        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO</div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar produtos, relatÃ³rios, chamados...">
            </div>
            </header>

        <dialog id="modalTicket" aria-labelledby="modalTitle">
            <form id="ticketForm">
                <h2 id="modalTitle">Novo Chamado</h2>
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="nomeRequisitante">Seu Nome <span aria-hidden="true" style="color:red;">*</span></label>
                            <input type="text" id="nomeRequisitante" name="nomeRequisitante" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="emailRequisitante">Seu Email <span aria-hidden="true" style="color:red;">*</span></label>
                            <input type="email" id="emailRequisitante" name="emailRequisitante" required>
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="telefoneRequisitante">Seu Telefone (Opcional)</label>
                    <input type="tel" id="telefoneRequisitante" name="telefoneRequisitante" placeholder="(XX) XXXXX-XXXX">
                </div>
                <hr>

                <div class="grupo-form">
                    <label for="assunto">Assunto <span aria-hidden="true" style="color:red;">*</span></label>
                    <input type="text" id="assunto" name="assunto" required>
                </div>

                <div class="grupo-form">
                    <label for="descricao">DescriÃ§Ã£o <span aria-hidden="true" style="color:red;">*</span></label>
                    <textarea id="descricao" name="descricao" rows="5" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade" name="prioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="MÃ©dia" selected>MÃ©dia</option>
                                <option value="Baixa">Baixa</option>
                                <option value="Planejado">Planejado</option> 
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="grupo-form">
                            <label for="categoria">Categoria</label>
                            <select id="categoria" name="categoria" class="form-select">
                                <option value="">-- Selecionar --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="grupo-form" id="grupoSubcategoria" style="display: none;">
                            <label for="subcategoria">Subcategoria</label>
                            <select id="subcategoria" name="subcategoria" class="form-select">
                                </select>
                        </div>
                    </div>
                </div>
                <div class="grupo-form">
                    <label for="anexo">Anexar Arquivos (Opcional)</label>
                    <input type="file" id="anexo" name="anexos" multiple>
                    <small class="form-text text-muted">Limite mÃ¡ximo total: 20MB.</small>
                </div>

                <div id="modalResposta" class="mt-3"></div>

                <div class="form-actions">
                    <button type="button" id="fecharModal">Cancelar</button>
                    <button type="submit" id="criarTicket">Criar Chamado</button>
                </div>
            </form>
        </dialog>
        
        <dialog id="modalDetalhes" aria-labelledby="modalDetalhesTitle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="modalDetalhesTitle" style="text-transform: uppercase;">Detalhes do Chamado</h2> 
Â  Â  Â  Â  Â  Â  <hr>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">Dados Gerais</h3>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="detalhe-label">Assunto</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="detalheAssunto" class="detalhe-valor">...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="detalhe-label">DescriÃ§Ã£o</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="detalheDescricao" class="detalhe-descricao">...</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">Contato</span><span id="detalheRequisitante" class="detalhe-valor">...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">SituaÃ§Ã£o</span><span id="detalheStatus" class="detalhe-valor">...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">Categorias</span><span id="detalheCategoria" class="detalhe-valor">...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">Prioridade</span><span id="detalhePrioridade" class="detalhe-valor">...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">Ticket ID</span><span id="detalheId" class="detalhe-valor">#...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="detalhe-grupo"><span class="detalhe-label">Criado em</span><span id="detalheData" class="detalhe-valor">...</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-actions"><button type="button" id="fecharModalDetalhes">Fechar</button></div>
Â  Â  Â  Â  </dialog>
        
        <main class="main-content">
            <h1>Meus Chamados</h1> 
            <hr>
            <div id="divRespostaGeral" class="mb-3"></div>
            <div class="widget card shadow-sm">
                <div class="card-body">
                    <div class="filters mb-3 row g-2">
                        <div class="col-md-4"><label for="filtroAssunto" class="form-label">Filtrar por Assunto</label><input type="text" id="filtroAssunto" class="form-control" placeholder="Digite o assunto..."></div>
                        <div class="col-md-3"><label for="filtroPrioridade" class="form-label">Prioridade</label><select id="filtroPrioridade" class="form-select"><option value="">Todas</option><option value="Alta">Alta</option><option value="MÃ©dia">MÃ©dia</option><option value="Baixa">Baixa</option><option value="Planejado">Planejado</option></select></div>
                        <div class="col-md-3"><label for="filtroStatus" class="form-label">Status</label><select id="filtroStatus" class="form-select"><option value="">Todos</option><option value="Aberto">Aberto</option><option value="Em Andamento">Em Andamento</option><option value="ConcluÃ­do">ConcluÃ­do</option></select></div>
                        <div class="col-md-2 d-flex align-items-end"><button id="btnFiltrar" class="btn btn-primary w-100">Filtrar</button></div>
                    </div>
                    <div id="ticketList" class="ticket-list">
                        <div class="ticket-row header">
                            <div class="ticket-cell ticket-id">Ticket</div>
                            <div class="ticket-cell ticket-priority">Prioridade</div>
                            <div class="ticket-cell ticket-subject">Assunto</div>
                            <div class="ticket-cell ticket-category">Categoria</div>
                            <div class="ticket-cell ticket-status">Status</div>
                            <div class="ticket-cell ticket-operator">Requisitante</div>
                            <div class="ticket-cell ticket-created">Criado em</div>
                            <div class="ticket-cell ticket-actions">AÃ§Ã£o</div>
                        </div>
                        <div id="loadingIndicator"><p>Carregando chamados...</p></div>
                    </div>
                </div>
            </div>
        </main>

        <div class="page-actions">
            <button id="newTicketButton" class="btn-new-ticket">
                Novo Chamado
            </button>
        </div>

    </div>

    <script type="module">
        const API_URL = "";

        // --- AutenticaÃ§Ã£o (MODO STANDALONE/DEV) ---
        let userData = null;
        let userId = 1; // <-- ID Fixo para desenvolvimento

        // --- VariÃ¡veis Globais de Dados ---
        let listaSubcategorias = []; // NOVA VARIÃVEL GLOBAL

        // --- ReferÃªncias ---
        const modal = document.getElementById("modalTicket");
        const btnAbrir = document.getElementById("newTicketButton");
        const btnFechar = document.getElementById("fecharModal");
        const ticketForm = document.getElementById("ticketForm");
        const ticketList = document.getElementById("ticketList");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const selectCategoriaModal = document.getElementById("categoria");
        const modalResposta = document.getElementById("modalResposta");
        const divRespostaGeral = document.getElementById("divRespostaGeral");
        // const btnLogout = document.getElementById("logoutButton"); // Removido, pois nÃ£o existe no HTML
        const modalDetalhes = document.getElementById("modalDetalhes");
        const btnFecharModalDetalhes = document.getElementById("fecharModalDetalhes");
        const filtroAssunto = document.getElementById("filtroAssunto");
        const filtroPrioridade = document.getElementById("filtroPrioridade");
        const filtroStatus = document.getElementById("filtroStatus");
        const btnFiltrar = document.getElementById("btnFiltrar");
        const inputTelefone = document.getElementById("telefoneRequisitante");

        // --- NOVAS REFERÃŠNCIAS DE SUBCATEGORIA ---
        const selectSubcategoriaModal = document.getElementById("subcategoria");
        const grupoSubcategoria = document.getElementById("grupoSubcategoria");

        // --- FunÃ§Ãµes Auxiliares ---
        function exibirMensagem(elemento, mensagem, sucesso = true) {
            elemento.textContent = mensagem;
            elemento.className = sucesso ? 'alert alert-success' : 'alert alert-danger';
        }
        function limparMensagem(elemento) {
            elemento.textContent = '';
            elemento.className = '';
        }
        function escapeHtml(text) {
            if (!text) return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        function formatarData(isoString) {
            if (!isoString) return 'N/A';
            try {
                const dt = new Date(isoString);
                const data = dt.toLocaleDateString('pt-BR');
                const hora = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                return `${data} ${hora}`;
            } catch (e) {
                return 'Data invÃ¡lida';
            }
        }
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, "").substring(0, 11);
            if (valor.length > 6) {
                valor = valor.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
            } else if (valor.length > 2) {
                valor = valor.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
            } else if (valor.length > 0) {
                valor = valor.replace(/^(\d{0,2}).*/, '($1');
            }
            input.value = valor;
        }

        // --- ATUALIZADO: Carregar Categorias e Subcategorias ---
        async function carregarDadosIniciais() {
            try {
                // 1. Busca Categorias e Subcategorias em paralelo
                const [catResponse, subCatResponse] = await Promise.all([
                    fetch(`${API_URL}/categorias`),
                    fetch(`${API_URL}/subcategorias`)
                ]);

                if (!catResponse.ok) throw new Error("Erro ao carregar categorias.");
                if (!subCatResponse.ok) throw new Error("Erro ao carregar subcategorias.");

                const categorias = await catResponse.json();
                listaSubcategorias = await subCatResponse.json(); // Salva na variÃ¡vel global

                // 2. Popula o dropdown de Categorias (como antes)
                selectCategoriaModal.innerHTML = '<option value="">-- Selecionar --</option>';
                categorias.forEach(cat => {
                    const option = document.createElement("option");
                    option.value = cat.id; 
                    option.textContent = cat.nome;
                    selectCategoriaModal.appendChild(option);
                });

            } catch (error) {
                console.error(error);
                // Mostra o erro no modal se ele estiver aberto, ou na pÃ¡gina principal
                exibirMensagem(modal.open ? modalResposta : divRespostaGeral, error.message, false);
            }
        }

        // --- Renderizar Lista de Chamados (ATUALIZADO) ---
        function renderizarChamados(chamados) {
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());

            if (!chamados || chamados.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'ticket-row data-row';
                noDataRow.innerHTML = `<div class="ticket-cell" style="grid-column: 1 / -1; text-align: center; padding: 1rem;">Nenhum chamado encontrado.</div>`;
                ticketList.appendChild(noDataRow);
                return;
            }

            chamados.forEach(chamado => {
                const row = document.createElement('div');
                row.className = 'ticket-row data-row';
                row.setAttribute('data-ticket-id', chamado.id);

                const prioridadeClass = (chamado.prioridade || 'MÃ©dia').toLowerCase().replace('Ã©', 'e');
                const statusClass = (chamado.status || 'Aberto').toLowerCase().replace(/\s+/g, '-');

                // LÃ³gica para exibir a categoria mais especÃ­fica
                // Agora lÃª os objetos Categorias e Subcategoria formatados pelo Controller
                let nomeExibicao = 'N/A';
                if (chamado.Subcategoria && chamado.Subcategoria.nome) {
                    nomeExibicao = `${chamado.Categorias?.nome || '?'} / ${chamado.Subcategoria.nome}`;
                } else if (chamado.Categorias && chamado.Categorias.nome) {
                    nomeExibicao = chamado.Categorias.nome;
                }

                row.innerHTML = `
                    <div class="ticket-cell ticket-id">#${chamado.id}</div>
                    <div class="ticket-cell ticket-priority">
                        <span class="priority-badge ${prioridadeClass}">${escapeHtml(chamado.prioridade)}</span>
                    </div>
                    <div class="ticket-cell ticket-subject">${escapeHtml(chamado.assunto)}</div>
                    <div class="ticket-cell ticket-category">${escapeHtml(nomeExibicao)}</div>
                    <div class="ticket-cell ticket-status">
                        <span class="status-badge ${statusClass}">${escapeHtml(chamado.status)}</span>
                    </div>
                    <div class="ticket-cell ticket-operator">${escapeHtml(chamado.Funcionario?.nomeFuncionario || 'Desconhecido')}</div>
                    <div class="ticket-cell ticket-created">${formatarData(chamado.created_at)}</div>
                    <div class="ticket-cell ticket-actions">
                        <span class="view-icon" title="Visualizar">ğŸ‘ï¸</span>
                    </div>
                `;

                row.querySelector('.view-icon').addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    document.getElementById('detalheId').textContent = `#${chamado.id}`;
                    document.getElementById('detalheStatus').textContent = chamado.status;
                    document.getElementById('detalhePrioridade').textContent = chamado.prioridade;
                    document.getElementById('detalheAssunto').textContent = chamado.assunto;
                    document.getElementById('detalheDescricao').textContent = chamado.descricao;
                    document.getElementById('detalheRequisitante').textContent = chamado.Funcionario?.nomeFuncionario || 'Desconhecido';
                    document.getElementById('detalheCategoria').textContent = nomeExibicao; // Usa o nome formatado
                    document.getElementById('detalheData').textContent = formatarData(chamado.created_at);

                    modalDetalhes.showModal();
                });
                ticketList.appendChild(row);
            });
        }

        // --- Listar Chamados (LÃ³gica de filtro permanece a mesma) ---
        async function listarChamados() {
            limparMensagem(divRespostaGeral);
            ticketList.querySelectorAll('.data-row').forEach(row => row.remove());
            if (loadingIndicator) loadingIndicator.style.display = 'block';

            const params = new URLSearchParams();
            if (filtroAssunto.value.trim()) {
                params.append('assunto', filtroAssunto.value.trim());
            }
            if (filtroPrioridade.value) {
                params.append('prioridade', filtroPrioridade.value);
            }
            if (filtroStatus.value) {
                params.append('status', filtroStatus.value);
            }
            params.append('requisitante_id', userId); 

            const url = `${API_URL}/chamados?${params.toString()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Erro ao buscar chamados.");
                const chamados = await response.json();
                renderizarChamados(chamados);
            } catch (error) {
                exibirMensagem(divRespostaGeral, error.message, false);
                if (loadingIndicator) loadingIndicator.innerHTML = '<p style="color:red;">Falha ao carregar.</p>';
            }
        }

        // --- ATUALIZADO: Criar Novo Chamado ---
        async function criarChamado(event) {
            event.preventDefault();
            limparMensagem(modalResposta);

            // 1. Coletar dados de texto
            const nomeRequisitante = ticketForm.nomeRequisitante.value.trim();
            const emailRequisitante = ticketForm.emailRequisitante.value.trim();
            const telefoneRequisitante = ticketForm.telefoneRequisitante.value.trim();
            const assunto = ticketForm.assunto.value.trim();
            const descricao = ticketForm.descricao.value.trim();
            const prioridade = ticketForm.prioridade.value || 'MÃ©dia';
            const categoriaId = ticketForm.categoria.value || null;
            
            // 1b. COLETAR O NOVO CAMPO DE SUBCATEGORIA
            const subcategoriaId = ticketForm.subcategoria.value || null;

            if (!nomeRequisitante || !emailRequisitante || !assunto || !descricao) {
                exibirMensagem(modalResposta, 'Nome, Email, Assunto e DescriÃ§Ã£o sÃ£o obrigatÃ³rios.', false);
                return;
            }

            // 2. Coletar arquivos e validar tamanho (sem mudanÃ§as)
            const anexoInput = document.getElementById('anexo');
            const files = anexoInput.files;
            let totalSize = 0;
            const maxSize = 20 * 1024 * 1024; // 20 MB

            for (let i = 0; i < files.length; i++) {
                totalSize += files[i].size;
            }

            if (totalSize > maxSize) {
                exibirMensagem(modalResposta, `Erro: O tamanho total dos arquivos (${(totalSize / 1024 / 1024).toFixed(2)} MB) excede o limite de 20 MB.`, false);
                return;
            }

            // 3. ATUALIZADO: Montar o FormData
            const formData = new FormData();
            const dadosChamado = {
                chamado: {
                    nome_requisitante_manual: nomeRequisitante,
                    email_requisitante_manual: emailRequisitante,
                    telefone_requisitante_manual: telefoneRequisitante,
                    assunto: assunto,
                    descricao: descricao,
                    prioridade: prioridade,
                    requisitante_id: userId, // ID Fixo
                    categoria_id: categoriaId ? parseInt(categoriaId) : null,
                    subcategoria_id: subcategoriaId ? parseInt(subcategoriaId) : null // ENVIAR O NOVO ID
                }
            };
            
            formData.append('chamado', JSON.stringify(dadosChamado.chamado));

            for (let i = 0; i < files.length; i++) {
                formData.append('anexos', files[i]);
            }

            // 4. Enviar a requisiÃ§Ã£o fetch (sem mudanÃ§as)
            try {
                const response = await fetch(`${API_URL}/chamados`, {
                    method: 'POST',
                    body: formData 
                });
                
                // O backend agora retorna o chamado criado e formatado
                const respostaAPI = await response.json();
                if (!response.ok) {
                    throw new Error(respostaAPI.message || "Erro ao criar chamado.");
                }

                exibirMensagem(divRespostaGeral, "Chamado criado com sucesso!", true);
                modal.close();
                // ticketForm.reset() Ã© chamado no 'close'
                await listarChamados(); // Recarrega a lista
            } catch (error) {
                exibirMensagem(modalResposta, error.message, false);
            }
        }
        
        // --- ATUALIZADO: LÃ³gica do Modal "Novo Chamado" ---
        function resetarModalForm() {
            ticketForm.reset();
            limparMensagem(modalResposta);
            // Esconde e reseta o dropdown de subcategoria
            grupoSubcategoria.style.display = 'none';
            selectSubcategoriaModal.innerHTML = '';
            selectSubcategoriaModal.required = false;
        }

        btnAbrir.addEventListener('click', () => {
            resetarModalForm();
            
            // PrÃ©-preenche os dados (se houver)
            document.getElementById('nomeRequisitante').value = ''; // Ajuste se precisar buscar dados do usuÃ¡rio logado
            document.getElementById('emailRequisitante').value = ''; 

            if (typeof modal.showModal === 'function') modal.showModal();
            else modal.setAttribute('open', '');
            document.getElementById('assunto').focus();
        });
        
        btnFechar.addEventListener('click', () => { modal.close(); });
        modal.addEventListener('close', () => { resetarModalForm(); }); // Garante o reset ao fechar
        
        // --- LÃ³gica do Modal "Detalhes" (sem mudanÃ§as) ---
        btnFecharModalDetalhes.addEventListener('click', () => {
            modalDetalhes.close();
        });

        // --- Event Listeners ---
        ticketForm.addEventListener('submit', criarChamado);
        btnFiltrar.addEventListener('click', listarChamados);
        if(inputTelefone) {
            inputTelefone.addEventListener('input', () => aplicarMascaraTelefone(inputTelefone));
        }

        // ---
        // ==================================================================
        // Â  Â  Â  Â  Â  Â  Â  Â  Â  LÃ“GICA DO DROPDOWN EM CASCATA
        // ==================================================================
        // ---
        selectCategoriaModal.addEventListener('change', () => {
            const categoriaId = parseInt(selectCategoriaModal.value, 10);
            
            // 1. Limpa o dropdown de subcategoria
            selectSubcategoriaModal.innerHTML = '<option value="">-- Selecionar Subcategoria --</option>';

            // 2. Se a categoria for invÃ¡lida (ex: "-- Selecionar --"), esconde o dropdown
            if (isNaN(categoriaId) || !categoriaId) {
                grupoSubcategoria.style.display = 'none'; 
                selectSubcategoriaModal.required = false;
                return;
            }

            // 3. Filtra a lista global de subcategorias
            const subcategoriasFilhas = listaSubcategorias.filter(sub => sub.id_categoria === categoriaId);

            // 4. Se encontrou subcategorias, popula o dropdown e o exibe
            if (subcategoriasFilhas.length > 0) {
                subcategoriasFilhas.forEach(sub => {
                    const option = document.createElement("option");
                    option.value = sub.id;
                    option.textContent = sub.nome;
                    selectSubcategoriaModal.appendChild(option);
                });
                grupoSubcategoria.style.display = 'block'; // Mostra o dropdown
                selectSubcategoriaModal.required = true; // Torna obrigatÃ³rio (se quiser)
            } else {
                // 5. Se nÃ£o encontrou, mantÃ©m o dropdown escondido
                grupoSubcategoria.style.display = 'none';
                selectSubcategoriaModal.required = false;
            }
        });


        // --- InicializaÃ§Ã£o ---
        async function init() {
            // Renomeei a funÃ§Ã£o de carregamento
            await carregarDadosIniciais(); 
            await listarChamados(); 
        }
        init();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>