<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Chatbot - Portal Supermercado</title>
Â  Â  <link rel="stylesheet" href="css/dashboard.css">
Â  Â  <link rel="stylesheet" href="css/chatbot.css">
Â  Â  <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
Â  Â  <div class="dashboard-container">
Â  Â  Â  Â  <header class="header">
Â  Â  Â  Â  Â  Â  <div class="logo">PORTAL SUPERMERCADO</div>
Â  Â  Â  Â  Â  Â  <div class="search-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Buscar produtos, relatÃ³rios, chamados...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="user-profile">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">ğŸ””</span> <span id="userNameDisplay" class="icon">ğŸ‘¤</span> 
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  
Â  Â  Â  Â  <aside class="sidebar">
Â  Â  Â  Â  Â  Â  <nav>
Â  Â  Â  Â  Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="Dashboard.html" title="InÃ­cio"><span class="icon">ğŸ </span><span class="text">InÃ­cio</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="Imprimir.html" title="ImpressÃ£o de PreÃ§os"><span class="icon">ğŸ–¨ï¸</span><span class="text">Imprimir</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="ticket-item"><a href="Chamado.html" title="Abrir Chamado"><span class="icon">â•</span><span class="text">Chamado</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="active"><a href="Chatbot.html" title="Chatbot"><span class="icon">ğŸ¤–</span><span class="text">Chatbot</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><a href="Funcionarios.html" title="funcionario"><span class="icon">ğŸ’¼</span><span class="text">FuncionÃ¡rios</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li style="margin-top: 30px;"><a href="#" title="ConfiguraÃ§Ãµes"><span class="icon">âš™ï¸</span><span class="text">Ajustes</span></a></li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </nav>
Â  Â  Â  Â  </aside>
Â  Â  Â  Â  
Â  Â  Â  Â  <main class="main-content">
Â  Â  Â  Â  Â  Â  <h1>Chatbot - Assistente Virtual</h1>
Â  Â  Â  Â  Â  Â  <div class="chat-widget">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-history" id="chatHistory">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-message message-bot">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar">ğŸ¤–</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>OlÃ¡! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar vocÃª hoje?</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="timestamp">9:00 AM</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="suggestion-area" id="suggestionArea">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="suggestion-btn" data-message="Status de um ticket">Status de um ticket</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="suggestion-btn" data-message="Imprimir etiquetas">Imprimir etiquetas</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="suggestion-btn" data-message="Abrir um chamado">Abrir um chamado</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="typing-indicator" id="typingIndicator">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar">ğŸ¤–</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="dot"></span><span class="dot"></span><span class="dot"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chat-input-area">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="sendButton" class="send-btn" title="Enviar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">â¤</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>

<script type="module">
    document.addEventListener('DOMContentLoaded', () => {

        // --- AUTENTICAÃ‡ÃƒO E NOME DE USUÃRIO ---
        let userDataString = localStorage.getItem("userData");
        if (!userDataString) {
            window.location.href = "Login.html"; 
            return;
        }
        try {
            const userData = JSON.parse(userDataString); 
            const userNameDisplay = document.getElementById('userNameDisplay'); 
            if (userNameDisplay && userData?.data?.nomeFuncionario) {
                userNameDisplay.textContent = `ğŸ‘¤ ${userData.data.nomeFuncionario.split(' ')[0]}`;
            }
        } catch (error) {
            console.error("Erro ao exibir nome do usuÃ¡rio:", error);
            window.location.href = "Login.html";
        }

        // --- LÃ“GICA DO CHATBOT ---
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const suggestionArea = document.getElementById('suggestionArea');

        if (!chatHistory || !chatInput || !sendButton || !typingIndicator || !suggestionArea) {
            console.error("ERRO: Elementos do chat nÃ£o encontrados. Verifique os IDs.");
            return;
        }

        // Guarda o ID da "conversa" (Thread)
        let currentThreadId = null;

        // --- PASSO 1: CARREGAR (LOAD) O ESTADO --- // <-- NOVO
        function loadChatState() {
            // Carrega o ID da Thread
            const savedThreadId = sessionStorage.getItem('chatThreadId');
            if (savedThreadId) {
                currentThreadId = savedThreadId;
            }

            // Carrega o HistÃ³rico de HTML
            const savedHistoryHTML = sessionStorage.getItem('chatHistoryHTML');
            if (savedHistoryHTML) {
                chatHistory.innerHTML = savedHistoryHTML; // Restaura o HTML
                suggestionArea.style.display = 'none'; // Esconde sugestÃµes se jÃ¡ hÃ¡ histÃ³rico
            }
            
            // Sempre role para o final ao carregar
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        // --- FIM DO PASSO 1 ---

        function showTyping() {
            typingIndicator.style.display = 'flex';
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function addMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message');
            const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            if (sender === 'bot') {
                messageWrapper.classList.add('message-bot');
                messageWrapper.innerHTML = `
                    <span class="avatar">ğŸ¤–</span>
                    <div class="message-bubble">
                        <p>${message}</p>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                `;
            } else { // 'user'
                messageWrapper.classList.add('message-user');
                messageWrapper.innerHTML = `
                    <span class="avatar">ğŸ‘¤</span>
                    <div class="message-bubble">
                        <p>${message}</p>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                `;
            }
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // --- PASSO 2: SALVAR (SAVE) AS MENSAGENS --- // <-- NOVO
            // Salva o HTML atual do chat no sessionStorage
            sessionStorage.setItem('chatHistoryHTML', chatHistory.innerHTML);
            // --- FIM DO PASSO 2 ---
        }

        // FunÃ§Ã£o principal
        async function handleSendMessage(message) {
            const userMessage = message.trim();
            if (userMessage === '') return;

            suggestionArea.style.display = 'none';
            addMessage(userMessage, 'user');
            if (chatInput) chatInput.value = ''; 
            showTyping();

            try {
                // Envia os dados no formato (message + threadId)
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: userMessage,        // A MENSAGEM ATUAL
                        threadId: currentThreadId    // O ID da Thread (null na 1Âª vez)
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const botReply = data.reply;
                
                // Salva o ID da Thread para lembrar da conversa
                currentThreadId = data.threadId; 

                // --- PASSO 3: SALVAR (SAVE) O THREAD ID --- // <-- NOVO
                sessionStorage.setItem('chatThreadId', currentThreadId);
                // --- FIM DO PASSO 3 ---

                hideTyping();
                addMessage(botReply, 'bot');

            } catch (error) {
                console.error('Erro ao contatar o bot:', error);
                hideTyping();
                addMessage('Desculpe, nÃ£o foi possÃ­vel conectar ao assistente.', 'bot');
            }
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', () => {
            handleSendMessage(chatInput.value);
        });
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage(chatInput.value);
            }
        });
        suggestionArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                const message = e.target.dataset.message;
                handleSendMessage(message);
            }
        });

        // --- EXECUÃ‡ÃƒO INICIAL ---
        hideTyping();
        loadChatState(); // <-- MODIFICADO (Executa o carregamento)
    });
</script>


</body>
</html>
