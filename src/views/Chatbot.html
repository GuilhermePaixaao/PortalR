<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Portal Supermercado</title>
    
    <link rel="stylesheet" href="css/dashboard.css">
    
    <link rel="stylesheet" href="css/chatbot.css">
</head>
<body>

    <div class="dashboard-container">
        
        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO</div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
            </div>
            <div class="user-profile">
                <span class="icon">üîî</span> <span id="userNameDisplay" class="icon">üë§</span> 
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li>
                        <a href="Dashboard.html" title="In√≠cio">
                            <span class="icon">üè†</span>
                            <span class="text">In√≠cio</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="Imprimir.html" title="Impress√£o de Pre√ßos">
                            <span class="icon">üñ®Ô∏è</span>
                            <span class="text">Imprimir</span>
                        </a>
                    </li>

                    <li class="ticket-item">
                        <a href="Chamado.html" title="Abrir Chamado">
                            <span class="icon">‚ûï</span>
                            <span class="text">Chamado</span>
                        </a>
                    </li>

                    <li class="active">
                        <a href="Chatbot.html" title="Chatbot">
                            <span class="icon">ü§ñ</span>
                            <span class="text">Chatbot</span>
                        </a>
                    </li>

                    <li>
                        <a href="Funcionarios.html" title="funcionario">
                            <span class="icon">üíº</span>
                            <span class="text">Funcion√°rios</span>
                        </a>
                    </li>

                    <li style="margin-top: 30px;">
                        <a href="#" title="Configura√ß√µes">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="text">Ajustes</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <h1>Chatbot - Assistente Virtual</h1>
            
            <div class="chat-widget">
                
                <div class="chat-history" id="chatHistory">
                    
                    <div class="chat-message message-bot">
                        <span class="avatar">ü§ñ</span>
                        <div class="message-bubble">
                            <p>Ol√°! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar voc√™ hoje?</p>
                            <span class="timestamp">9:00 AM</span>
                        </div>
                    </div>
                    
                    </div>
                
                <div class="suggestion-area" id="suggestionArea">
                    <button class="suggestion-btn" data-message="Status de um ticket">Status de um ticket</button>
                    <button class="suggestion-btn" data-message="Imprimir etiquetas">Imprimir etiquetas</button>
                    <button class="suggestion-btn" data-message="Abrir um chamado">Abrir um chamado</button>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span class="avatar">ü§ñ</span>
                    <div class="message-bubble">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
                    <button id="sendButton" class="send-btn" title="Enviar">
                        <span class="icon">‚û§</span>
                    </button>
                </div>

            </div>
        </main>
        
    </div>

<script type="module">
    // Espera o conte√∫do da p√°gina carregar
    document.addEventListener('DOMContentLoaded', () => {

        // =======================================================
        // --- L√ìGICA DE AUTENTICA√á√ÉO E NOME DE USU√ÅRIO ---
        // =======================================================
        let userDataString = localStorage.getItem("userData");
        if (!userDataString) {
            // Se n√£o estiver logado, volta para o login.
            window.location.href = "Login.html"; 
            return; // Para a execu√ß√£o do script
        }

        try {
            // Converte a string do localStorage em um objeto
            const userData = JSON.parse(userDataString); 
            // Procura o elemento <span> no HTML
            const userNameDisplay = document.getElementById('userNameDisplay'); 

            // Verifica se o elemento existe e se temos o nome nos dados
            if (userNameDisplay && userData?.data?.nomeFuncionario) {
                // Atualiza o texto com o √≠cone e o primeiro nome
                userNameDisplay.textContent = `üë§ ${userData.data.nomeFuncionario.split(' ')[0]}`;
            }
        } catch (error) {
            console.error("Erro ao exibir nome do usu√°rio:", error);
            // Se o JSON for inv√°lido, tamb√©m redireciona
            window.location.href = "Login.html";
        }
        // =======================================================
        // --- FIM DA L√ìGICA DE AUTENTICA√á√ÉO ---
        // =======================================================


        // 1. Pegar todos os elementos do HTML
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const suggestionArea = document.getElementById('suggestionArea');

        // Valida√ß√£o para garantir que tudo foi encontrado
        if (!chatHistory || !chatInput || !sendButton || !typingIndicator || !suggestionArea) {
            console.error("ERRO: N√£o foi poss√≠vel encontrar um ou mais elementos do chat no HTML. Verifique os IDs.");
            return;
        }

        // 2. Hist√≥rico da conversa (para enviar √† OpenAI)
        let conversationHistory = [
            { role: 'system', content: 'Voc√™ √© um assistente prestativo do Portal Supermercado. Responda de forma breve e direta sobre chamados, impress√£o de etiquetas e status de funcion√°rios.' }
        ];

        // 3. Adicionar a mensagem inicial (que j√° est√° no HTML) ao hist√≥rico
        const initialBotMessage = chatHistory.querySelector('.message-bot p');
        if (initialBotMessage) {
            conversationHistory.push({ role: 'assistant', content: initialBotMessage.textContent });
        }

        // 4. Fun√ß√µes de ajuda
        function showTyping() {
            typingIndicator.style.display = 'flex'; // 'flex' pois √© assim no seu HTML
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        // 5. Fun√ß√£o para ADICIONAR uma nova mensagem na tela (replicando sua estrutura HTML)
        function addMessage(message, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message');
            
            const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            if (sender === 'bot') {
                messageWrapper.classList.add('message-bot');
                messageWrapper.innerHTML = `
                    <span class="avatar">ü§ñ</span>
                    <div class="message-bubble">
                        <p>${message}</p>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                `;
            } else { // 'user'
                messageWrapper.classList.add('message-user'); // Adiciona classe para alinhar √† direita
                messageWrapper.innerHTML = `
                    <span class="avatar">üë§</span>
                    <div class="message-bubble">
                        <p>${message}</p>
                        <span class="timestamp">${timestamp}</span>
                    </div>
                `;
            }

            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Rola para o fim
        }

        // 6. Fun√ß√£o principal para ENVIAR a mensagem
        async function handleSendMessage(message) {
            const userMessage = message.trim();
            if (userMessage === '') return;

            // Esconde sugest√µes e mostra a mensagem do usu√°rio
            suggestionArea.style.display = 'none';
            addMessage(userMessage, 'user');
            conversationHistory.push({ role: 'user', content: userMessage });
            
            if (chatInput) chatInput.value = ''; // Limpa o input se a mensagem veio de l√°

            // Mostra "digitando..."
            showTyping();

            try {
                // Envia o hist√≥rico para o SEU backend (a rota /api/chat)
                // Usamos "" como URL base para funcionar no Railway
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ history: conversationHistory })
                });

                if (!response.ok) {
                    // Se a resposta n√£o for OK (ex: 404, 500), joga um erro
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const botReply = data.reply;

                // Esconde "digitando..." e mostra a resposta do bot
                hideTyping();
                addMessage(botReply, 'bot');
                conversationHistory.push({ role: 'assistant', content: botReply });

            } catch (error) {
                console.error('Erro ao contatar o bot:', error);
                hideTyping();
                // Mensagem de erro mais clara para o usu√°rio
                addMessage('Desculpe, n√£o foi poss√≠vel conectar ao assistente. Verifique os logs do servidor (Erro 500 ou 404).', 'bot');
            }
        }

        // 7. Ligar os bot√µes (Event Listeners)
        
        // Bot√£o de Enviar
        sendButton.addEventListener('click', () => {
            handleSendMessage(chatInput.value);
        });

        // Tecla Enter no input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage(chatInput.value);
            }
        });

        // Bot√µes de Sugest√£o
        suggestionArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                const message = e.target.dataset.message;
                handleSendMessage(message);
            }
        });

        // Esconder o "digitando..." no in√≠cio
        hideTyping();
    });
</script>

</body>
</html>