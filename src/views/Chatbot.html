<!DOCTYPE html>
<html lang="pt-br">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Chatbot - Portal Supermercado</title>
ย ย <link rel="stylesheet" href="css/dashboard.css">
ย ย <link rel="stylesheet" href="css/chatbot.css">
ย ย <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
ย ย <div class="dashboard-container">
ย ย ย ย <header class="header">
ย ย ย ย ย ย <div class="logo">PORTAL SUPERMERCADO</div>
ย ย ย ย ย ย <div class="search-bar">
ย ย ย ย ย ย ย ย <input type="text" placeholder="Buscar produtos, relatรณrios, chamados...">
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="user-profile">
ย ย ย ย ย ย ย ย <span class="icon">๐</span> <span id="userNameDisplay" class="icon">๐ค</span> 
ย ย ย ย ย ย </div>
ย ย ย ย </header>
ย ย ย ย 
ย ย ย ย <aside class="sidebar">
ย ย ย ย ย ย <nav>
ย ย ย ย ย ย ย ย <ul>
ย ย ย ย ย ย ย ย ย ย <li><a href="Dashboard.html" title="Inรญcio"><span class="icon">๐</span><span class="text">Inรญcio</span></a></li>
ย ย ย ย ย ย ย ย ย ย <li><a href="Imprimir.html" title="Impressรฃo de Preรงos"><span class="icon">๐จ๏ธ</span><span class="text">Imprimir</span></a></li>
ย ย ย ย ย ย ย ย ย ย <li class="ticket-item"><a href="Chamado.html" title="Abrir Chamado"><span class="icon">โ</span><span class="text">Chamado</span></a></li>
ย ย ย ย ย ย ย ย ย ย <li class="active"><a href="Chatbot.html" title="Chatbot"><span class="icon">๐ค</span><span class="text">Chatbot</span></a></li>
ย ย ย ย ย ย ย ย ย ย <li><a href="Funcionarios.html" title="funcionario"><span class="icon">๐ผ</span><span class="text">Funcionรกrios</span></a></li>
ย ย ย ย ย ย ย ย ย ย <li style="margin-top: 30px;"><a href="#" title="Configuraรงรตes"><span class="icon">โ๏ธ</span><span class="text">Ajustes</span></a></li>
ย ย ย ย ย ย ย ย </ul>
ย ย ย ย ย ย </nav>
ย ย ย ย </aside>
ย ย ย ย 
ย ย ย ย ย ย ย ย <main class="main-content">
ย ย ย ย ย ย <h1>Chatbot - Assistente Virtual</h1>
ย ย ย ย ย ย <div class="chat-widget">
ย ย ย ย ย ย ย ย <div class="chat-history" id="chatHistory">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="suggestion-area" id="suggestionArea">
ย ย ย ย ย ย ย ย ย ย <button class="suggestion-btn" data-message="Status de um ticket">Status de um ticket</button>
ย ย ย ย ย ย ย ย ย ย <button class="suggestion-btn" data-message="Imprimir etiquetas">Imprimir etiquetas</button>
ย ย ย ย ย ย ย ย ย ย <button class="suggestion-btn" data-message="Abrir um chamado">Abrir um chamado</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="typing-indicator" id="typingIndicator">
ย ย ย ย ย ย ย ย ย ย <span class="avatar">๐ค</span>
ย ย ย ย ย ย ย ย ย ย <div class="message-bubble">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="dot"></span><span class="dot"></span><span class="dot"></span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="chat-input-area">
ย ย ย ย ย ย ย ย ย ย <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
ย ย ย ย ย ย ย ย ย ย <button id="sendButton" class="send-btn" title="Enviar">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="icon">โค</span>
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </main>
ย ย ย ย ย ย </div>

<script type="module">
ย ย document.addEventListener('DOMContentLoaded', () => {

ย ย ย ย // --- AUTENTICAรรO E NOME DE USUรRIO ---
ย ย ย ย let userDataString = localStorage.getItem("userData");
ย ย ย ย if (!userDataString) {
ย ย ย ย ย ย window.location.href = "Login.html"; 
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย ย ย try {
ย ย ย ย ย ย const userData = JSON.parse(userDataString); 
ย ย ย ย ย ย const userNameDisplay = document.getElementById('userNameDisplay'); 
ย ย ย ย ย ย if (userNameDisplay && userData?.data?.nomeFuncionario) {
ย ย ย ย ย ย ย ย userNameDisplay.textContent = `๐ค ${userData.data.nomeFuncionario.split(' ')[0]}`;
ย ย ย ย ย ย }
ย ย ย ย } catch (error) {
ย ย ย ย ย ย console.error("Erro ao exibir nome do usuรกrio:", error);
ย ย ย ย ย ย window.location.href = "Login.html";
ย ย ย ย }

ย ย ย ย // --- LรGICA DO CHATBOT ---
ย ย ย ย const chatHistory = document.getElementById('chatHistory');
ย ย ย ย const chatInput = document.getElementById('chatInput');
ย ย ย ย const sendButton = document.getElementById('sendButton');
ย ย ย ย const typingIndicator = document.getElementById('typingIndicator');
ย ย ย ย const suggestionArea = document.getElementById('suggestionArea');

ย ย ย ย if (!chatHistory || !chatInput || !sendButton || !typingIndicator || !suggestionArea) {
ย ย ย ย ย ย console.error("ERRO: Elementos do chat nรฃo encontrados. Verifique os IDs.");
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // Guarda o ID da "conversa" (Thread)
ย ย ย ย let currentThreadId = null;

        // --- FUNรรO PARA CARREGAR O ESTADO DO CHAT ---
ย ย ย ย function loadChatState() {
ย ย ย ย ย ย const savedThreadId = sessionStorage.getItem('chatThreadId');
ย ย ย ย ย ย if (savedThreadId) {
ย ย ย ย ย ย ย ย currentThreadId = savedThreadId;
ย ย ย ย ย ย }

ย ย ย ย ย ย const savedHistoryHTML = sessionStorage.getItem('chatHistoryHTML');
ย ย ย ย ย ย if (savedHistoryHTML) {
ย ย ย ย ย ย ย ย chatHistory.innerHTML = savedHistoryHTML;
ย ย ย ย ย ย ย ย suggestionArea.style.display = 'none'; // Esconde sugestรตes se jรก houver histรณrico
ย ย ย ย ย ย } else {
                // Se nรฃo houver histรณrico, adiciona a mensagem inicial
                // (O 'false' evita que essa msg inicial seja salva no storage antes da hora)
                addMessage('Olรก! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar vocรช hoje?', 'bot', false); 
            }

ย ย ย ย ย ย chatHistory.scrollTop = chatHistory.scrollHeight;
ย ย ย ย }

ย ย ย ย function showTyping() {
ย ย ย ย ย ย typingIndicator.style.display = 'flex';
ย ย ย ย ย ย chatHistory.scrollTop = chatHistory.scrollHeight;
ย ย ย ย }
ย ย ย ย function hideTyping() {
ย ย ย ย ย ย typingIndicator.style.display = 'none';
ย ย ย ย }

        // Adicionado 'saveHistory = true'
ย ย ย ย function addMessage(message, sender, saveHistory = true) { 
ย ย ย ย ย ย const messageWrapper = document.createElement('div');
ย ย ย ย ย ย messageWrapper.classList.add('chat-message');
ย ย ย ย ย ย const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
ย ย ย ย ย ย 
ย ย ย ย ย ย if (sender === 'bot') {
ย ย ย ย ย ย ย ย messageWrapper.classList.add('message-bot');
ย ย ย ย ย ย ย ย messageWrapper.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <span class="avatar">๐ค</span>
ย ย ย ย ย ย ย ย ย ย <div class="message-bubble">
ย ย ย ย ย ย ย ย ย ย ย ย <p>${message}</p>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="timestamp">${timestamp}</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย } else { // 'user'
ย ย ย ย ย ย ย ย messageWrapper.classList.add('message-user');
ย ย ย ย ย ย ย ย messageWrapper.innerHTML = `
ย ย ย ย ย ย ย ย ย ย <span class="avatar">๐ค</span>
ย ย ย ย ย ย ย ย ย ย <div class="message-bubble">
ย ย ย ย ย ย ย ย ย ย ย ย <p>${message}</p>
ย ย ย ย ย ย ย ย ย ย ย ย <span class="timestamp">${timestamp}</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย }
ย ย ย ย ย ย chatHistory.appendChild(messageWrapper);
ย ย ย ย ย ย chatHistory.scrollTop = chatHistory.scrollHeight;

            // --- FUNรรO PARA SALVAR HISTรRICO ---
            if (saveHistory) {
ย ย ย ย ย ย     sessionStorage.setItem('chatHistoryHTML', chatHistory.innerHTML);
            }
ย ย ย ย }

ย ย ย ย // Funรงรฃo principal
ย ย ย ย async function handleSendMessage(message) {
ย ย ย ย ย ย const userMessage = message.trim();
ย ย ย ย ย ย if (userMessage === '') return;

ย ย ย ย ย ย suggestionArea.style.display = 'none';
ย ย ย ย ย ย addMessage(userMessage, 'user'); // Salva automaticamente
ย ย ย ย ย if (chatInput) chatInput.value = ''; 
ย ย ย ย ย ย showTyping();

ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย // Envia os dados no formato (message + threadId)
ย ย ย ย ย ย ย ย const response = await fetch('/api/chat', {
ย ย ย ย ย ย ย ย ย ย method: 'POST',
ย ย ย ย ย ย ย ย ย ย headers: { 'Content-Type': 'application/json' },
ย ย ย ย ย ย ย ย ย ย body: JSON.stringify({ 
ย ย ย ย ย ย ย ย ย ย ย ย message: userMessage, ย ย ย// A MENSAGEM ATUAL
ย ย ย ย ย ย ย ย ย ย ย ย threadId: currentThreadId ย// O ID da Thread (null na 1ยช vez)
ย ย ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย if (!response.ok) {
ย ย ย ย ย ย ย ย ย ย throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย ย ย const botReply = data.reply;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Salva o ID da Thread para lembrar da conversa
ย ย ย ย ย ย ย currentThreadId = data.threadId; 

                // --- FUNรรO PARA SALVAR THREAD ID ---
ย ย ย ย ย ย ย ย sessionStorage.setItem('chatThreadId', currentThreadId);

ย ย ย ย ย ย ย ย hideTyping();
ย ย ย ย ย ย ย ย addMessage(botReply, 'bot'); // Salva automaticamente

ย ย ย ย ย ย } catch (error) {
 ย ย ย ย ย ย ย console.error('Erro ao contatar o bot:', error);
 ย ย ย ย ย ย hideTyping();
ย ย ย ย ย ย ย ย addMessage('Desculpe, nรฃo foi possรญvel conectar ao assistente.', 'bot');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // --- Event Listeners ---
ย ย ย ย sendButton.addEventListener('click', () => {
ย ย ย ย ย ย handleSendMessage(chatInput.value);
ย ย ย ย });
ย ย ย ย chatInput.addEventListener('keypress', (e) => {
ย ย ย ย ย ย if (e.key === 'Enter') {
ย ย ย ย ย ย ย ย handleSendMessage(chatInput.value);
 ย ย ย ย }
ย ย ย ย });
ย ย ย ย suggestionArea.addEventListener('click', (e) => {
ย ย ย ย ย ย if (e.target.classList.contains('suggestion-btn')) {
ย ย ย ย ย ย ย ย const message = e.target.dataset.message;
ย ย ย ย ย ย ย handleSendMessage(message);
ย ย ย ย ย ย }
ย ย ย ย });

        // --- INICIALIZAรรO DO CHAT ---
ย ย ย ย hideTyping();
        loadChatState(); // Carrega o histรณrico e o threadId salvos
ย ย });
</script>
</body>
</html>