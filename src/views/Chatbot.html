<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Portal Supermercado</title>
    
    <link rel="stylesheet" href="css/dashboard.css">
    
    <link rel="stylesheet" href="css/chatbot.css">
</head>
<body>

    <div class="dashboard-container">
        
        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO</div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar produtos, relat√≥rios, chamados...">
            </div>
            <div class="user-profile">
                <span class="icon">üîî</span> <span id="userNameDisplay" class="icon">üë§</span> 
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li>
                        <a href="Dashboard.html" title="In√≠cio">
                            <span class="icon">üè†</span>
                            <span class="text">In√≠cio</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="Imprimir.html" title="Impress√£o de Pre√ßos">
                            <span class="icon">üñ®Ô∏è</span>
                            <span class="text">Imprimir</span>
                        </a>
                    </li>

                    <li class="ticket-item">
                        <a href="Chamado.html" title="Abrir Chamado">
                            <span class="icon">‚ûï</span>
                            <span class="text">Chamado</span>
                        </a>
                    </li>

                    <li class="active">
                        <a href="Chatbot.html" title="Chatbot">
                            <span class="icon">ü§ñ</span>
                            <span class="text">Chatbot</span>
                        </a>
                    </li>

                    <li>
                        <a href="Funcionarios.html" title="funcionario">
                            <span class="icon">üíº</span>
                            <span class="text">Funcion√°rios</span>
                        </a>
                    </li>

                    <li style="margin-top: 30px;">
                        <a href="#" title="Configura√ß√µes">
                            <span class="icon">‚öôÔ∏è</span>
                            <span class="text">Ajustes</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <h1>Chatbot - Assistente Virtual</h1>
            
            <div class="chat-widget">
                
                <div class="chat-history" id="chatHistory">
                    
                    <div class="chat-message message-bot">
                        <span class="avatar">ü§ñ</span>
                        <div class="message-bubble">
                            <p>Ol√°! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar voc√™ hoje?</p>
                            <span class="timestamp">9:00 AM</span>
                        </div>
                    </div>
                    
                    </div>
                
                <div class="suggestion-area" id="suggestionArea">
                    <button class="suggestion-btn" data-message="Status de um ticket">Status de um ticket</button>
                    <button class="suggestion-btn" data-message="Imprimir etiquetas">Imprimir etiquetas</button>
                    <button class="suggestion-btn" data-message="Abrir um chamado">Abrir um chamado</button>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span class="avatar">ü§ñ</span>
                    <div class="message-bubble">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
                    <button id="sendButton" class="send-btn" title="Enviar">
                        <span class="icon">‚û§</span>
                    </button>
                </div>

            </div>
        </main>
        
    </div>

<script type="module">
    // Espera o conte√∫do da p√°gina carregar
    // Dentro do seu <script type="module"> no Chatbot.html

document.addEventListener('DOMContentLoaded', () => {

    // ... (toda a l√≥gica de autentica√ß√£o e nome de usu√°rio fica igual) ...

    // 1. Pegar todos os elementos (igual)
    const chatHistory = document.getElementById('chatHistory');
    const chatInput = document.getElementById('chatInput');
    // ... (etc. igual)

    // --- MUDAN√áA AQUI ---
    // N√£o precisamos mais do hist√≥rico, mas sim do ID da conversa (Thread)
    let currentThreadId = null; // Come√ßa como nulo

    // 2. Hist√≥rico (N√£o precisamos mais)
    // 3. Msg Inicial (N√£o precisamos mais)
    // 4. Fun√ß√µes (showTyping, hideTyping, addMessage - tudo igual)

    // ... (fun√ß√µes showTyping, hideTyping, addMessage s√£o iguais) ...


    // 6. Fun√ß√£o principal para ENVIAR a mensagem (MODIFICADA)
    async function handleSendMessage(message) {
        const userMessage = message.trim();
        if (userMessage === '') return;

        suggestionArea.style.display = 'none';
        addMessage(userMessage, 'user');
        // N√£o precisamos mais de 'conversationHistory.push()'
        
        if (chatInput) chatInput.value = ''; 

        showTyping();

        try {
            // Envia os dados no NOVO formato
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: userMessage,      // Envia a MENSAGEM ATUAL
                    threadId: currentThreadId  // Envia o ID da Thread (null na 1¬™ vez)
                })
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            const botReply = data.reply;
            
            // --- IMPORTANTE ---
            // Salva o ID da Thread que o backend retornou
            // Na pr√≥xima vez, enviaremos este ID para o assistente
            // lembrar da conversa.
            currentThreadId = data.threadId; 

            hideTyping();
            addMessage(botReply, 'bot');
            // N√£o precisamos mais de 'conversationHistory.push()'

        } catch (error) {
            console.error('Erro ao contatar o bot:', error);
            hideTyping();
            addMessage('Desculpe, n√£o foi poss√≠vel conectar ao assistente.', 'bot');
        }
    }

    // 7. Ligar os bot√µes (Event Listeners) - (Tudo igual)
    // ... (c√≥digo do sendButton.addEventListener √© igual)
    // ... (c√≥digo do chatInput.addEventListener √© igual)
    // ... (c√≥digo do suggestionArea.addEventListener √© igual)
    
    hideTyping();
});
</script>

</body>
</html>