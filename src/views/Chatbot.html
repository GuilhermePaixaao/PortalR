<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - Portal Supermercado</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/chatbot.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <div class="logo">PORTAL SUPERMERCADO</div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar produtos, relatÃ³rios, chamados...">
            </div>
            <div class="user-profile">
                <span class="icon">ğŸ””</span> <span id="userNameDisplay" class="icon">ğŸ‘¤</span> 
            </div>
        </header>
        
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="Dashboard.html" title="InÃ­cio"><span class="icon">ğŸ </span><span class="text">InÃ­cio</span></a></li>
                    <li><a href="Imprimir.html" title="ImpressÃ£o de PreÃ§os"><span class="icon">ğŸ–¨ï¸</span><span class="text">Imprimir</span></a></li>
                    <li class="ticket-item"><a href="Chamado.html" title="Abrir Chamado"><span class="icon">â•</span><span class="text">Chamado</span></a></li>
                    <li class="active"><a href="Chatbot.html" title="Chatbot"><span class="icon">ğŸ¤–</span><span class="text">Chatbot</span></a></li>
                    <li><a href="Funcionarios.html" title="funcionario"><span class="icon">ğŸ’¼</span><span class="text">FuncionÃ¡rios</span></a></li>
                    <li style="margin-top: 30px;"><a href="#" title="ConfiguraÃ§Ãµes"><span class="icon">âš™ï¸</span><span class="text">Ajustes</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="main-content">
            <h1>Chatbot - Assistente Virtual</h1>
            <div class="chat-widget">
                <div class="chat-history" id="chatHistory">
                    <div class="chat-message message-bot">
                        <span class="avatar">ğŸ¤–</span>
                        <div class="message-bubble">
                            <p>OlÃ¡! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar vocÃª hoje?</p>
                            <span class="timestamp">9:00 AM</span>
                        </div>
                    </div>
                </div>
                <div class="suggestion-area" id="suggestionArea">
                    <button class="suggestion-btn" data-message="Status de um ticket">Status de um ticket</button>
                    <button class="suggestion-btn" data-message="Imprimir etiquetas">Imprimir etiquetas</button>
                    <button class="suggestion-btn" data-message="Abrir um chamado">Abrir um chamado</button>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <span class="avatar">ğŸ¤–</span>
                    <div class="message-bubble">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
                    <button id="sendButton" class="send-btn" title="Enviar">
                        <span class="icon">â¤</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

<script type="module">
Â  Â  document.addEventListener('DOMContentLoaded', () => {

Â  Â  Â  Â  // --- AUTENTICAÃ‡ÃƒO E NOME DE USUÃRIO ---
Â  Â  Â  Â  let userDataString = localStorage.getItem("userData");
Â  Â  Â  Â  if (!userDataString) {
Â  Â  Â  Â  Â  Â  window.location.href = "Login.html"; 
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const userData = JSON.parse(userDataString); 
Â  Â  Â  Â  Â  Â  const userNameDisplay = document.getElementById('userNameDisplay'); 
Â  Â  Â  Â  Â  Â  if (userNameDisplay && userData?.data?.nomeFuncionario) {
Â  Â  Â  Â  Â  Â  Â  Â  userNameDisplay.textContent = `ğŸ‘¤ ${userData.data.nomeFuncionario.split(' ')[0]}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Erro ao exibir nome do usuÃ¡rio:", error);
Â  Â  Â  Â  Â  Â  window.location.href = "Login.html";
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- LÃ“GICA DO CHATBOT ---
Â  Â  Â  Â  const chatHistory = document.getElementById('chatHistory');
Â  Â  Â  Â  const chatInput = document.getElementById('chatInput');
Â  Â  Â  Â  const sendButton = document.getElementById('sendButton');
Â  Â  Â  Â  const typingIndicator = document.getElementById('typingIndicator');
Â  Â  Â  Â  const suggestionArea = document.getElementById('suggestionArea');

Â  Â  Â  Â  if (!chatHistory || !chatInput || !sendButton || !typingIndicator || !suggestionArea) {
Â  Â  Â  Â  Â  Â  console.error("ERRO: Elementos do chat nÃ£o encontrados. Verifique os IDs.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Guarda o ID da "conversa" (Thread)
Â  Â  Â  Â  let currentThreadId = null;

        // --- FUNÃ‡ÃƒO PARA CARREGAR O ESTADO DO CHAT --- // <-- NOVO
Â  Â  Â  Â  function loadChatState() {
Â  Â  Â  Â  Â  Â  const savedThreadId = sessionStorage.getItem('chatThreadId');
Â  Â  Â  Â  Â  Â  if (savedThreadId) {
Â  Â  Â  Â  Â  Â  Â  Â  currentThreadId = savedThreadId;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const savedHistoryHTML = sessionStorage.getItem('chatHistoryHTML');
Â  Â  Â  Â  Â  Â  if (savedHistoryHTML) {
Â  Â  Â  Â  Â  Â  Â  Â  chatHistory.innerHTML = savedHistoryHTML;
Â  Â  Â  Â  Â  Â  Â  Â  suggestionArea.style.display = 'none'; // Esconde sugestÃµes se jÃ¡ houver histÃ³rico
Â  Â  Â  Â  Â  Â  } else {
                // Se nÃ£o houver histÃ³rico, adiciona a mensagem inicial
                // (O 'false' evita que essa msg inicial seja salva no storage antes da hora)
                addMessage('OlÃ¡! Eu sou o assistente virtual do Portal Supermercado. Como posso ajudar vocÃª hoje?', 'bot', false); 
            }

Â  Â  Â  Â  Â  Â  chatHistory.scrollTop = chatHistory.scrollHeight;
Â  Â  Â  Â  }

Â  Â  Â  Â  function showTyping() {
Â  Â  Â  Â  Â  Â  typingIndicator.style.display = 'flex';
Â  Â  Â  Â  Â  Â  chatHistory.scrollTop = chatHistory.scrollHeight;
Â  Â  Â  Â  }
Â  Â  Â  Â  function hideTyping() {
Â  Â  Â  Â  Â  Â  typingIndicator.style.display = 'none';
Â  Â  Â  Â  }

        // <-- MODIFICADO: Adicionado 'saveHistory = true'
Â  Â  Â  Â  function addMessage(message, sender, saveHistory = true) { 
Â  Â  Â  Â  Â  Â  const messageWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  messageWrapper.classList.add('chat-message');
Â  Â  Â  Â  Â  Â  const timestamp = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (sender === 'bot') {
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.classList.add('message-bot');
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar">ğŸ¤–</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="timestamp">${timestamp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  } else { // 'user'
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.classList.add('message-user');
Â  Â  Â  Â  Â  Â  Â  Â  messageWrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar">ğŸ‘¤</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="timestamp">${timestamp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  chatHistory.appendChild(messageWrapper);
Â  Â  Â  Â  Â  Â  chatHistory.scrollTop = chatHistory.scrollHeight;

            // --- FUNÃ‡ÃƒO PARA SALVAR HISTÃ“RICO --- // <-- NOVO
            if (saveHistory) {
Â  Â  Â  Â  Â  Â      sessionStorage.setItem('chatHistoryHTML', chatHistory.innerHTML);
            }
Â  Â  Â  Â  }

Â  Â  Â  Â  // FunÃ§Ã£o principal
Â  Â  Â  Â  async function handleSendMessage(message) {
Â  Â  Â  Â  Â  Â  const userMessage = message.trim();
Â  Â  Â  Â  Â  Â  if (userMessage === '') return;

Â  Â  Â  Â  Â  Â  suggestionArea.style.display = 'none';
Â  Â  Â  Â  Â  Â  addMessage(userMessage, 'user'); // Salva automaticamente
Â  Â  Â  Â  Â  Â  if (chatInput) chatInput.value = ''; 
Â  Â  Â  Â  Â  Â  showTyping();

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Envia os dados no formato (message + threadId)
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/chat', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  message: userMessage, Â  Â  Â // A MENSAGEM ATUAL
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  threadId: currentThreadId Â // O ID da Thread (null na 1Âª vez)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const botReply = data.reply;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Salva o ID da Thread para lembrar da conversa
Â  Â  Â  Â  Â  Â  Â  Â  currentThreadId = data.threadId; 

                // --- FUNÃ‡ÃƒO PARA SALVAR THREAD ID --- // <-- NOVO
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('chatThreadId', currentThreadId);

Â  Â  Â  Â  Â  Â  Â  Â  hideTyping();
Â  Â  Â  Â  Â  Â  Â  Â  addMessage(botReply, 'bot'); // Salva automaticamente

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Erro ao contatar o bot:', error);
Â  Â  Â  Â  Â  Â  Â  Â  hideTyping();
Â  Â  Â  Â  Â  Â  Â  Â  addMessage('Desculpe, nÃ£o foi possÃ­vel conectar ao assistente.', 'bot');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â  sendButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  handleSendMessage(chatInput.value);
Â  Â  Â  Â  });
Â  Â  Â  Â  chatInput.addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  handleSendMessage(chatInput.value);
a Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  suggestionArea.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.classList.contains('suggestion-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  const message = e.target.dataset.message;
Â  Â  Â  Â  Â  Â  Â  Â  handleSendMessage(message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

        // --- INICIALIZAÃ‡ÃƒO DO CHAT --- // <-- MODIFICADO
Â  Â  Â  Â  hideTyping();
        loadChatState(); // Carrega o histÃ³rico e o threadId salvos
Â  Â  });
</script>

</body>
</html>